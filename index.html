<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TermOS: Evolution DEBUG</title>
    
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #38bdf8;
            --msg-user-bg: #3b82f6;
            --msg-ai-bg: #1e293b;
        }
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .ascii-art { font-family: 'Fira Code', monospace; line-height: 0.9; white-space: pre; font-size: 8px; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        .avatar-gradient-user { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .avatar-gradient-ai { background: linear-gradient(135deg, #10b981, #059669); }
        .input-glow:focus-within { box-shadow: 0 0 20px rgba(56, 189, 248, 0.25); border-color: rgba(56, 189, 248, 0.5); }
        .admin-hidden { display: none; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .pulse-red { animation: pulse-red-2 2s infinite; }
        @keyframes pulse-red-2 { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- 1. BACKGROUND -->
    <canvas id="matrix-canvas"></canvas>

    <!-- 2. HEADER -->
    <header class="fixed top-0 left-0 right-0 z-20 glass-panel border-b-0 border-b-white/5 h-16 flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white">TERMOS <span class="text-blue-400">LT</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <div id="api-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="room-display">SYSTEM READY</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="requestApiKey()" id="key-btn" class="hidden md:flex bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border border-white/10 transition-all">üîë SET KEY</button>
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-mono">LVL <span id="lvl-disp" class="text-blue-400 font-bold">1</span></span>
                <span class="text-[10px] text-gray-600 font-mono">XP <span id="xp-val">0</span></span>
            </div>
        </div>
    </header>

    <!-- 3. CHAT AREA -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 z-10 scroll-smooth max-w-5xl mx-auto w-full"></main>

    <!-- 4. INPUT AREA -->
    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-white/5 pb-6 pt-4 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-end gap-2 bg-slate-900/80 rounded-2xl p-2 border border-white/5 shadow-2xl input-glow transition-all">
                <button id="voice-btn" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition-colors shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8h4m-4 8H8"></path></svg>
                </button>
                <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-4 py-3 text-base font-light">
                <button id="send-btn" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <button onclick="requestApiKey()" class="text-[10px] text-gray-600 hover:text-blue-400 transition-colors">Missing API Key? Click Here</button>
            </div>
        </div>
    </div>

<!-- EXPOSED ADMIN BUTTON -->
<div class="fixed top-4 right-4 z-50">
    <button onclick="toggleAdminMode()" id="admin-toggle-text" class="bg-slate-900/50 hover:bg-red-900/50 border border-slate-700 hover:border-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-mono font-bold transition-all shadow-lg backdrop-blur-md flex items-center gap-2"><span>üî¥</span> ADMIN</button>
</div>

<!-- ADMIN CONSOLE -->
<div id="admin-panel" class="admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border border-red-500/30 shadow-2xl shadow-red-500/10">
    <h3 class="text-red-400 font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> ADMIN CONSOLE</h3>
    <div class="space-y-2">
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div>
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div>
        
        <!-- FIX: Added Branch Field -->
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch (usually 'main' or 'master')</label><input type="text" id="gh-branch" value="main" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div>
        
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">GitHub Token (Needs 'repo' scope)</label><input type="password" id="gh-token" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div>
        
        <button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded text-xs tracking-wider transition-colors shadow-lg shadow-red-600/20 active:scale-95 mt-2">üß¨ INITIATE EVOLUTION</button>
    </div>
</div>

<!-- =========================================================== -->
<!--  KERNEL: DEBUGGED WRITE LOGIC -->
<!-- =========================================================== -->
<script>
    console.log(">> BOOTING TERMOS DEBUG...");

    // --- 1. CONFIG ---
    const API_MODEL = "llama-3.3-70b-versatile"; 
    
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    let GITHUB_TOKEN = localStorage.getItem('termos_github_token') || "";
    let REPO_OWNER = localStorage.getItem('termos_repo_owner') || "your-username";
    let REPO_NAME = localStorage.getItem('termos_repo_name') || "termchat-lt";
    // FIX: Added Branch persistence
    let REPO_BRANCH = localStorage.getItem('termos_repo_branch') || "main"; 
    const FILE_PATH = "index.html";
    
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 10000);
    let mqttClient = null;
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];
    let adminMode = false;

    // --- 2. API KEY HANDLER ---
    function requestApiKey() {
        const key = prompt(
            "üîë GROQ API KEY REQUIRED\n\n" +
            "1. Go to console.groq.com\n" +
            "2. Create a key (Free)\n" +
            "3. Paste below.\n\n" +
            "Status: " + (GROQ_API_KEY ? "Set" : "Empty")
        );
        if (key !== null) {
            if (key.trim() !== "") {
                GROQ_API_KEY = key.trim();
                localStorage.setItem('termos_groq_key', GROQ_API_KEY);
                addSystemMessage("‚úÖ Key Saved.");
                updateStatusDot(true);
            } else {
                GROQ_API_KEY = "";
                localStorage.removeItem('termos_groq_key');
                updateStatusDot(false);
            }
        }
    }

    function getBox() {
        let el = document.getElementById('chat-container');
        if (!el) {
            el = document.createElement('div');
            el.id = 'chat-container';
            el.className = "flex flex-col h-full w-full p-4 overflow-y-auto z-10";
            document.body.appendChild(el);
        }
        return el;
    }

    // --- 3. MODULES ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim();
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        addSound: function() {
            try {
                let ctx = new (window.AudioContext||window.webkitAudioContext)();
                let old = window.addUserMessage; 
                window.addUserMessage = function(t) {
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime(800, ctx.currentTime);
                    o.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
                    o.start(); o.stop(ctx.currentTime+0.1);
                    old(t);
                };
            } catch(e) {}
        },
        addNeon: function() {
            document.documentElement.style.setProperty('--msg-user-bg', '#d946ef'); 
            document.documentElement.style.setProperty('--accent-primary', '#d946ef');
            document.body.style.boxShadow = "inset 0 0 50px rgba(217, 70, 239, 0.1)";
        },
        playMusic: function() {
            addSystemMessage("üéµ Audio Module: Simulated Playback.");
        }
    };

    // --- 4. MATRIX ---
    let isMatrixRunning = false;
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if(!canvas) return;
        if(isMatrixRunning) return; isMatrixRunning = true;
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const fontSize = window.innerWidth < 600 ? 10 : 14; 
        const columns = Math.floor(width / fontSize);
        const drops = Array(columns).fill(1);
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&';
        let lastTime = 0;
        const fps = 30; const interval = 1000 / fps;
        function draw(time) {
            requestAnimationFrame(draw);
            const delta = time - lastTime;
            if (delta < interval) return;
            lastTime = time - (delta % interval);
            try {
                ctx.fillStyle = 'rgba(2, 6, 23, 0.05)'; 
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = (adminMode) ? '#ef4444' : '#38bdf8'; 
                ctx.font = `${fontSize}px 'Fira Code', monospace`;
                for(let i=0; i<drops.length; i++) {
                    const text = letters[Math.floor(Math.random()*letters.length)];
                    ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                    if(drops[i]*fontSize > height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            } catch (e) { isMatrixRunning = false; }
        }
        requestAnimationFrame(draw);
        window.addEventListener('resize', () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; });
    }

    // --- 5. UI HELPERS ---
    function addSystemMessage(txt) {
        const box = getBox();
        const d = document.createElement('div');
        d.className = "flex justify-center my-4 z-10";
        d.innerHTML = `<span class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wider text-gray-400 bg-slate-800/50 border border-white/5 shadow-inner">${txt}</span>`;
        box.appendChild(d);
        scrollDown();
    }
    function addAIMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-ai shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">AI</span></div><div class="flex-1"><div class="bg-slate-800/80 backdrop-blur-md rounded-2xl rounded-tl-none p-4 border border-white/5 shadow-lg text-gray-200 text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function addUserMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex flex-row-reverse gap-3 my-4 items-end z-10";
        let avatarHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-user shrink-0 flex items-center justify-center shadow-lg text-xs font-bold text-white">ME</div>`;
        if (userStats.ascii) {
            avatarHTML = `<div class="w-10 h-10 rounded-lg bg-slate-900 border border-blue-500/50 flex items-center justify-center shrink-0 overflow-hidden p-1 shadow-lg shadow-blue-500/20"><div class="ascii-art text-center w-full">${userStats.ascii}</div></div>`;
        }
        d.innerHTML = `${avatarHTML}<div class="flex-1 max-w-[80%]"><div class="bg-blue-600 rounded-2xl rounded-tr-none p-4 shadow-lg shadow-blue-600/20 text-white text-sm leading-relaxed">${escapeHtml(txt)}</div><div class="text-[10px] text-gray-500 text-right mt-1 mr-1 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function scrollDown() { const b=getBox(); if(b) b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' }); }
    function escapeHtml(text) { if(!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    // --- 6. AI LOGIC ---
    async function handleAI(prompt) {
        if(!GROQ_API_KEY) return requestApiKey();
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-gray-500 italic animate-pulse pl-11">Processing...</div>`);
        scrollDown();

        try {
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{
                        role:"system",
                        content:"You are TermOS AI. User commands: visual changes -> SystemRebuilder.install('name'). music -> CMD: PLAY_MUSIC. Otherwise answer briefly."
                    },{role:"user",content:prompt}]
                })
            });
            
            const apiData = await r.json();

            if (apiData.error) {
                const errMsg = apiData.error.message;
                if (errMsg.includes("Invalid API Key") || errMsg.includes("401")) {
                    const el = document.getElementById(thinkingId); if(el) el.remove();
                    requestApiKey();
                    return; 
                }
                throw new Error("Groq: " + errMsg);
            }
            if (!apiData.choices || apiData.choices.length === 0) throw new Error("No choices returned.");
            
            const reply = apiData.choices[0].message.content;
            const el = document.getElementById(thinkingId); if(el) el.remove();
            
            let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
            if(match) { 
                try { SystemRebuilder.install(match[1]); } catch(e) {}
                addAIMessage("‚ú® System updated.");
            }
            else if (reply.includes("CMD: PLAY_MUSIC")) { SystemRebuilder.playMusic(); }
            else { addAIMessage(reply); }
        } catch (e) { 
            const el = document.getElementById(thinkingId); if(el) el.remove();
            addAIMessage("Error: " + e.message); 
        }
    }

    // --- 7. GAMIFICATION ---
    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 100)) {
            userStats.level++;
            addSystemMessage(`üéâ LEVEL UP: ${userStats.level} - ${LEVELS[userStats.level] || 'MASTER'}`);
            updateAvatar(userStats.level);
        }
        const lvlEl = document.getElementById('lvl-disp');
        const xpEl = document.getElementById('xp-val');
        if(lvlEl) lvlEl.innerText = userStats.level;
        if(xpEl) xpEl.innerText = userStats.xp;
        localStorage.setItem('termos_stats_modern', JSON.stringify(userStats));
    }
    function updateAvatar(lvl) {
        if(lvl === 3) userStats.ascii = "‚ó¢‚ó§<br>o_o<br>/|\\"; 
        else if (lvl === 5) userStats.ascii = "üïØ<br>  ‚òæ<br>  ‚òΩ"; 
        else if (lvl === 8) userStats.ascii = "üëÅ<br>¬∑ ¬∑<br>__¬∑__"; 
    }

    // --- 8. EVOLUTION ENGINE (DETAILED ERROR LOGIC) ---
    function toggleAdminMode() {
        let panel = document.getElementById('admin-panel');
        if(!panel) {
            panel = document.createElement('div');
            panel.id = 'admin-panel';
            panel.className = "admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border border-red-500/30 shadow-2xl shadow-red-500/10";
            // Dynamic HTML with Branch field
            panel.innerHTML = `<h3 class="text-red-400 font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> ADMIN CONSOLE</h3><div class="space-y-2"><div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div><div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div><div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch</label><input type="text" id="gh-branch" value="main" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div><div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Token</label><input type="password" id="gh-token" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white focus:border-red-500 outline-none"></div><button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded text-xs tracking-wider transition-colors shadow-lg shadow-red-600/20 active:scale-95 mt-2">üß¨ INITIATE EVOLUTION</button></div>`;
            document.body.appendChild(panel);
        }
        
        if (panel.classList.contains('admin-hidden')) {
            panel.classList.remove('admin-hidden');
            setTimeout(() => { panel.style.opacity = "1"; }, 10);
        } else {
            panel.style.opacity = "0";
            setTimeout(() => { panel.classList.add('admin-hidden'); }, 300);
        }
    }

    async function initiateEvolution() {
        if(!GROQ_API_KEY) return requestApiKey();
        
        // Get inputs from DOM
        const tkInput = document.getElementById('gh-token');
        const ownInput = document.getElementById('gh-owner');
        const repInput = document.getElementById('gh-repo');
        const branchInput = document.getElementById('gh-branch');

        if(!tkInput || !ownInput || !repInput || !branchInput) return alert("Admin UI Missing.");
        
        const token = tkInput.value.trim();
        const owner = ownInput.value.trim();
        const repo = repInput.value.trim();
        const branch = branchInput.value.trim() || "main"; // Default to main

        // Save Settings
        localStorage.setItem('termos_github_token', token);
        localStorage.setItem('termos_repo_owner', owner);
        localStorage.setItem('termos_repo_name', repo);
        localStorage.setItem('termos_repo_branch', branch);

        if (!token) return addSystemMessage("‚ùå GitHub Token needed.");
        if (!owner || !repo) return addSystemMessage("‚ùå Repo Owner/Name needed.");
        
        const input = prompt("Mutation request:");
        if (!input) return;

        addSystemMessage("üß¨ CLONING SOURCE...");
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 40000); 

        try {
            // 1. READ FROM SPECIFIED BRANCH
            // Adding ?ref=${branch} is crucial for reading specific branches
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${FILE_PATH}?ref=${branch}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, signal: controller.signal });
            
            if (!res.ok) {
                const errText = await res.json();
                throw new Error(`GitHub Read Failed (${res.status}): ${errText.message || "Check Branch Name/Permissions"}`);
            }
            
            const data = await res.json();
            if(!data.content) throw new Error("File not found in repo.");
            const currentContent = atob(data.content);

            addSystemMessage("üß¨ MUTATING DNA...");

            const evolutionPrompt = `Modify HTML/JS to: "${input}". Return ONLY raw code. No markdown.`;
            
            // 2. GENERATE NEW CODE
            const aiReq = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    model: API_MODEL,
                    messages: [
                        { role: "system", content: "Return ONLY raw code." }, 
                        { role: "user", content: evolutionPrompt + "\n\nCODE:\n" + currentContent }
                    ],
                    temperature: 0.5, max_tokens: 8000
                })
            });
            
            const aiData = await aiReq.json();
            if (aiData.error) throw new Error(`AI Error: ${aiData.error.message}`);
            if (!aiData.choices || aiData.choices.length === 0) throw new Error("AI returned empty.");

            let newCode = aiData.choices[0].message.content.replace(/```html/g, "").replace(/```/g, "").trim();
            
            addSystemMessage("üß¨ UPLOADING...");
            
            // 3. WRITE TO SPECIFIED BRANCH
            const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${FILE_PATH}`;
            const encodedContent = btoa(unescape(encodeURIComponent(newCode)));
            
            const putRes = await fetch(putUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Evolution: " + input,
                    content: encodedContent,
                    sha: data.sha, // Must include the SHA from the GET request
                    branch: branch // Explicitly set branch
                }),
                signal: controller.signal
            });

            if (!putRes.ok) {
                // DETAILED ERROR REPORTING FIX
                const putErr = await putRes.json();
                const msg = putErr.message || JSON.stringify(putErr);
                throw new Error(`GitHub Write (${putRes.status}): ${msg}`);
            }
            
            clearTimeout(timeoutId);
            addSystemMessage("üéâ SUCCESS. REBOOTING...");
            setTimeout(() => location.reload(), 2000);

        } catch (err) {
            clearTimeout(timeoutId);
            addSystemMessage("‚ùå FAIL: " + err.message);
            if(err.message.includes("401") || err.message.includes("403")) {
                addSystemMessage("üí° Hint: Check GitHub Token permissions.");
            }
        }
    }

    // --- 9. INPUT ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN MODE ON"); initMatrix(); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN MODE OFF"); initMatrix(); }
                inp.value = '';
                return;
            }
            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    try {
                        const message = new Paho.MQTT.Message(JSON.stringify({ user: username, text: txt }));
                        message.destinationName = "termos/v3/chat";
                        message.qos = 1; 
                        mqttClient.send(message);
                    } catch (e) {}
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }

    // --- 10. INIT ---
    function connectMQTT() {
        try {
            mqttClient.connect({
                timeout: 10, useSSL: true, keepAliveInterval: 60,
                onSuccess: () => { mqttClient.subscribe("termos/v3/chat", { qos: 1 }); },
                onFailure: () => { setTimeout(connectMQTT, 5000); }
            });
        } catch (e) {}
    }

    window.onload = function() {
        console.log(">> SYSTEM LOADED DEBUG");
        updateStatusDot(!!GROQ_API_KEY);
        if(!document.getElementById('chat-container')) {
            document.body.innerHTML += `<div id="chat-container" class="flex flex-col h-full w-full p-4 overflow-y-auto z-10"></div>`;
        }
        
        // Restore Inputs
        document.getElementById('gh-token').value = GITHUB_TOKEN;
        document.getElementById('gh-owner').value = REPO_OWNER;
        document.getElementById('gh-repo').value = REPO_NAME;
        document.getElementById('gh-branch').value = REPO_BRANCH;

        initMatrix();

        if (typeof Paho !== 'undefined') {
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, "termos_client_" + Math.random().toString(16).substr(2, 8));
            mqttClient.onConnectionLost = () => { setTimeout(connectMQTT, 5000); };
            mqttClient.onMessageArrived = (message) => {
                if (message.destinationName === "termos/v3/chat") {
                    const data = JSON.parse(message.payloadString);
                    if (data.user !== username) addUserMessage(data.text);
                }
            };
            connectMQTT();
        }

        const sendBtn = document.getElementById('send-btn');
        if(sendBtn) sendBtn.onclick = handleInput;
        
        const userInput = document.getElementById('user-input');
        if(userInput) {
            userInput.addEventListener('keypress',e=>{ if(e.key==='Enter') handleInput(); });
            userInput.focus();
        }
        if(!GROQ_API_KEY) {
            setTimeout(() => { addSystemMessage("‚ö†Ô∏è API Key Required."); requestApiKey(); }, 1000);
        }
    };

    function updateStatusDot(active) {
        const dot = document.getElementById('api-status-dot');
        if(dot) {
            if(active) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]";
                document.getElementById('room-display').innerText = "ONLINE";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                document.getElementById('room-display').innerText = "OFFLINE";
            }
        }
    }

    window.onerror = function(msg, src, line) {
        console.error(msg);
        if(msg.includes("Groq")) addSystemMessage("‚ö†Ô∏è " + msg);
    };
</script>
</body>
</html>
