<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TermOS: Neural Link</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --neon-green: #00ff41;
            --neon-cyan: #00f3ff;
            --neon-red: #ff003c;
            --bg-dark: #050505;
        }
        body {
            background-color: var(--bg-dark);
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
        }
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 50; display: none; /* Hidden by default */
        }
        .crt-flicker {
            animation: flicker 0.15s infinite;
            pointer-events: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 16, 16, 0.1); z-index: 49; opacity: 0.1; display: none;
        }
        @keyframes flicker { 0% { opacity: 0.1; } 50% { opacity: 0.2; } 100% { opacity: 0.1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--neon-green); border-radius: 3px; }
        
        /* Animations */
        .msg-bubble {
            max-width: 85%; word-wrap: break-word;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
            backdrop-filter: blur(4px);
        }
        .ai-bubble {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        }
        .install-prompt { animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- VISUAL OVERLAYS -->
    <div id="scanline-layer" class="scanlines"></div>
    <div id="flicker-layer" class="crt-flicker"></div>

    <!-- BOOT LOADER -->
    <div id="boot-screen" class="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center p-4 hidden">
        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-green-500 tracking-widest">TERMOS</h1>
        <div class="w-64 h-2 border border-green-500/50 mt-4 relative overflow-hidden">
            <div id="boot-bar" class="absolute top-0 left-0 h-full bg-green-500 w-0 shadow-[0_0_10px_#00ff41]"></div>
        </div>
        <div id="boot-text" class="mt-2 text-xs text-green-400 font-mono h-4">INITIALIZING KERNEL...</div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="flex flex-col h-full w-full opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="h-14 border-b border-green-500/30 flex items-center justify-between px-4 bg-black/80 backdrop-blur-md shrink-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="font-bold text-lg tracking-widest" id="room-display">LOBBY</span>
            </div>
            <div class="flex items-center gap-3 text-xs md:text-sm">
                <span class="text-cyan-400 hidden md:inline">VER: 3.5 (LIVE)</span>
                <span class="border border-green-500/50 px-2 py-1 rounded">LVL <span id="lvl-disp" class="font-bold text-white">1</span></span>
            </div>
        </header>

        <!-- CHAT SCREEN -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 scroll-smooth"></main>

        <!-- INPUT AREA -->
        <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black via-black/90 to-transparent z-30">
            <div class="max-w-4xl mx-auto flex gap-2 items-center bg-black/60 border border-green-500/50 rounded-lg p-1 shadow-[0_0_15px_rgba(0,255,65,0.1)]">
                <button id="install-btn" class="hidden bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold px-3 py-2 rounded transition-colors shrink-0">INSTALL</button>
                <button id="voice-btn" class="text-green-500 hover:text-white transition-colors px-2 text-xl">üéôÔ∏è</button>
                <input type="text" id="user-input" placeholder="Type /sys install [module]..." class="bg-transparent border-none outline-none text-green-400 flex-1 px-2 font-mono placeholder-green-800">
                <button id="send-btn" class="bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white border border-green-600 px-4 py-2 rounded text-sm font-bold transition-all">SEND</button>
            </div>
        </div>

        <!-- INSTALL MODAL -->
        <div id="custom-install-modal" class="hidden absolute bottom-24 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-gray-900 border border-cyan-500 p-4 rounded-lg shadow-[0_0_20px_rgba(0,243,255,0.2)] z-40 install-prompt">
            <h3 class="text-cyan-400 font-bold mb-2">üì≤ INSTALL TERMOS</h3>
            <p class="text-xs text-gray-400 mb-3">Add TermOS to your home screen for the full experience.</p>
            <div class="flex gap-2">
                <button id="modal-install-confirm" class="flex-1 bg-cyan-600 text-white text-xs font-bold py-2 rounded hover:bg-cyan-500">INSTALL</button>
                <button id="modal-install-cancel" class="flex-1 border border-gray-600 text-gray-400 text-xs font-bold py-2 rounded hover:bg-gray-800">LATER</button>
            </div>
        </div>
    </div>

<script>
/**
 * TERMOS: LIVING KERNEL
 * Features: Self-Healing, Dynamic Modules, AI Integration
 */

// --- CONFIG ---
const CONFIG = {
    mqttBroker: "broker.emqx.io",
    mqttPort: 8084,
    mqttTopic: "termos/v3/chat",
    groqKey: localStorage.getItem('termos_groq_key') || "", 
    username: "Anon_" + Math.floor(Math.random() * 1000)
};

const STATE = {
    level: 1, xp: 0, room: "lobby", deferredPrompt: null,
    audioContext: null
};

// --- SYSTEM REBUILDER KERNEL (The Magic Part) ---
const SystemRebuilder = {
    installedModules: [],
    
    install: function(featureName) {
        if (this.installedModules.includes(featureName)) {
            addMessage(`Module [${featureName}] already active.`, 'system');
            return;
        }
        
        addMessage(`[KERNEL] Installing: ${featureName.toUpperCase()}...`, 'system');
        
        try {
            switch(featureName) {
                case 'matrix': this.injectMatrix(); break;
                case 'crt': this.injectCRT(); break;
                case 'sound': this.injectSound(); break;
                case 'neon': this.injectNeon(); break;
                case 'god': this.injectGodMode(); break;
                default: throw new Error("Unknown Module");
            }
            this.installedModules.push(featureName);
            addMessage(`[SUCCESS] ${featureName.toUpperCase()} INSTALLED.`, 'system');
            if (STATE.audioContext) playSystemSound(880, 'sine', 0.1); // Success sound
        } catch (e) {
            addMessage(`[ERROR] ${e.message}`, 'system');
        }
    },

    injectMatrix: function() {
        // Intense Green Rain
        const canvas = document.createElement('canvas');
        canvas.id = 'matrix-overlay';
        canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.3;pointer-events:none;';
        document.body.prepend(canvas);
        const ctx = canvas.getContext('2d');
        
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.addEventListener('resize', resize); resize();
        
        const cols = Math.floor(canvas.width / 20);
        const ypos = Array(cols).fill(0);
        
        const draw = () => {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0f0';
            ctx.font = '15pt monospace';
            ypos.forEach((y, i) => {
                const text = String.fromCharCode(Math.random() * 128);
                ctx.fillText(text, i * 20, y);
                if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20;
            });
        };
        setInterval(draw, 33);
    },

    injectCRT: function() {
        document.getElementById('scanline-layer').style.display = 'block';
        document.getElementById('flicker-layer').style.display = 'block';
    },

    injectSound: function() {
        // Initialize audio context on first user interaction if needed
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!STATE.audioContext) STATE.audioContext = new AudioContext();
        
        // Hook into addMessage globally
        const originalAdd = addMessage;
        window.addMessage = function(text, type, sender) {
            if (type !== 'system' && STATE.audioContext) {
                playSystemSound(600, 'square', 0.05);
            }
            originalAdd(text, type, sender);
        };
    },

    injectNeon: function() {
        const style = document.createElement('style');
        style.id = 'neon-styles';
        style.innerHTML = `body { text-shadow: 0 0 8px var(--neon-green); } .msg-bubble { box-shadow: 0 0 15px rgba(0,255,65,0.2); }`;
        document.head.appendChild(style);
    },

    injectGodMode: function() {
        const btn = document.createElement('button');
        btn.innerText = "GOD_MODE";
        btn.className = "fixed top-14 right-2 z-50 bg-red-900 text-red-100 text-[10px] border border-red-500 px-2 py-1 font-mono cursor-pointer hover:bg-red-700";
        btn.onclick = () => {
            const cmd = prompt("ROOT COMMAND:");
            if(cmd) handleSend(cmd);
        };
        document.body.appendChild(btn);
    }
};

// --- AUDIO HELPER ---
function playSystemSound(freq, type, duration) {
    if (!STATE.audioContext) return;
    const osc = STATE.audioContext.createOscillator();
    const gain = STATE.audioContext.createGain();
    osc.connect(gain);
    gain.connect(STATE.audioContext.destination);
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.1, STATE.audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, STATE.audioContext.currentTime + duration);
    osc.start();
    osc.stop(STATE.audioContext.currentTime + duration);
}

// --- CORE UI FUNCTIONS ---
function ensureElement(id, tag, parent = document.body) {
    let el = document.getElementById(id);
    if (!el) { el = document.createElement(tag); el.id = id; parent.appendChild(el); }
    return el;
}

function addMessage(text, type = 'user', sender = 'SYS') {
    const container = ensureElement('chat-container', 'main');
    const div = document.createElement('div');
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    if (type === 'system') {
        div.className = "text-center text-xs text-gray-500 my-2 border-t border-b border-gray-800 py-1 uppercase tracking-widest";
        div.innerText = text;
    } else if (type === 'ai') {
        div.className = "flex items-start gap-2 animate-[fadeIn_0.3s_ease-out]";
        div.innerHTML = `<div class="w-8 h-8 rounded bg-black border border-cyan-500 flex items-center justify-center text-cyan-400 shrink-0 text-xs">AI</div><div class="msg-bubble ai-bubble bg-black/50 p-3 rounded-tr-lg rounded-br-lg rounded-bl-lg text-sm"><div class="text-[10px] text-cyan-600 mb-1">AI CORE // ${time}</div>${text}</div>`;
    } else {
        div.className = "flex items-start gap-2 flex-row-reverse animate-[fadeIn_0.3s_ease-out]";
        div.innerHTML = `<div class="w-8 h-8 rounded bg-green-900 border border-green-500 flex items-center justify-center text-green-100 shrink-0 text-xs">ME</div><div class="msg-bubble bg-green-900/20 p-3 rounded-tl-lg rounded-bl-lg rounded-br-lg text-sm text-right"><div class="text-[10px] text-green-600 mb-1">${time} // ${sender}</div><div class="text-left">${text}</div></div>`;
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// --- INPUT & PARSING ---
function handleSend() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text) return;

    // 1. SYSTEM INSTALLER COMMAND
    if (text.startsWith('/sys install ')) {
        const mod = text.split(' ')[2];
        SystemRebuilder.install(mod);
    }
    // 2. SET KEY
    else if (text.startsWith('/setkey ')) {
        CONFIG.groqKey = text.substring(8);
        localStorage.setItem('termos_groq_key', CONFIG.groqKey);
        addMessage("API KEY ENCRYPTED.", 'system');
    }
    // 3. AI COMMAND
    else if (text.startsWith('/ai ')) {
        handleAI(text.substring(4));
    }
    // 4. CLEAR
    else if (text === '/clear') {
        document.getElementById('chat-container').innerHTML = '';
    }
    // 5. CHAT
    else {
        addMessage(text, 'user', CONFIG.username);
        STATE.xp += 5;
        if (STATE.xp > STATE.level * 100) {
            STATE.level++; addMessage(`LEVEL UP: LVL ${STATE.level}`, 'system');
        }
        document.getElementById('lvl-disp').innerText = STATE.level;
        
        // MQTT Publish
        if (window.mqttClient && window.mqttClient.isConnected()) {
            const msg = new Paho.MQTT.Message(JSON.stringify({ sender: CONFIG.username, text: text }));
            msg.destinationName = CONFIG.mqttTopic;
            window.mqttClient.send(msg);
        }
    }
    input.value = '';
}

// --- AI INTEGRATION WITH SYSTEM POWERS ---
async function handleAI(prompt) {
    if (!CONFIG.groqKey) {
        addMessage("ERROR: Missing Key. Type /setkey [key]", 'ai');
        return;
    }
    
    addMessage("Processing...", 'ai');
    
    // System Prompt: Tells AI it can install modules
    const systemPrompt = `You are TermOS AI. You can install visual modules using the function SystemRebuilder.install('name').
    Available modules: 'matrix' (matrix rain), 'crt' (retro effects), 'sound' (beeps), 'neon' (glow effects), 'god' (admin button).
    If the user asks to change the look, enable sound, or make it cool, use the install function.
    Otherwise, answer concisely in a cyberpunk style.`;

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${CONFIG.groqKey}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: prompt }],
                model: "llama3-8b-8192"
            })
        });
        const data = await res.json();
        const reply = data.choices[0].message.content;
        
        // PARSE AI RESPONSE FOR FUNCTION CALLS
        // Regex to find: SystemRebuilder.install('matrix')
        const installRegex = /SystemRebuilder\.install\(['"](.*?)['"]\)/g;
        let match;
        let actionsTaken = false;
        
        while ((match = installRegex.exec(reply)) !== null) {
            SystemRebuilder.install(match[1]);
            actionsTaken = true;
        }

        if (!actionsTaken) {
            addMessage(reply, 'ai');
        } else {
            addMessage("Modules updated by AI.", 'ai');
        }

    } catch (e) {
        addMessage("AI CONNECTION FAILED.", 'ai');
    }
}

// --- BOOT & INIT ---
async function runBoot() {
    const boot = document.getElementById('boot-screen');
    const bar = document.getElementById('boot-bar');
    const main = document.getElementById('main-interface');
    const txt = document.getElementById('boot-text');
    
    boot.classList.remove('hidden');
    
    for(let i=0; i<=100; i+=4) {
        bar.style.width = i + '%';
        if(i%20===0) txt.innerText = ["LOADING KERNEL...", "MOUNTING SYSTEM...", "READY"][i/20] || "OK";
        await new Promise(r => setTimeout(r, 20));
    }
    
    boot.classList.add('hidden');
    main.classList.remove('opacity-0');
    addMessage("SYSTEM ONLINE. TYPE /HELP FOR COMMANDS.", "system");
    
    // Connect MQTT
    try {
        const client = new Paho.MQTT.Client(CONFIG.mqttBroker, CONFIG.mqttPort, "termos_"+Math.random());
        client.onConnectionLost = () => addMessage("MQTT LOST", "system");
        client.onMessageArrived = (msg) => {
            const d = JSON.parse(msg.payloadString);
            if(d.sender !== CONFIG.username) addMessage(d.text, 'user', d.sender);
        };
        client.connect({ onSuccess: () => {
            client.subscribe(CONFIG.mqttTopic);
            addMessage("LINK ESTABLISHED.", "system");
        }, useSSL: true });
        window.mqttClient = client;
    } catch(e) { console.error(e); }
}

// PWA Logic
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    STATE.deferredPrompt = e;
    document.getElementById('install-btn').classList.remove('hidden');
    setTimeout(() => document.getElementById('custom-install-modal').classList.remove('hidden'), 5000);
});
document.getElementById('modal-install-confirm').onclick = async () => {
    document.getElementById('custom-install-modal').classList.add('hidden');
    STATE.deferredPrompt.prompt();
    STATE.deferredPrompt = null;
};

// Listeners
window.onload = runBoot;
document.getElementById('send-btn').onclick = handleSend;
document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key==='Enter') handleSend(); });

// Voice
if ('webkitSpeechRecognition' in window) {
    const r = new webkitSpeechRecognition(); r.continuous = false;
    document.getElementById('voice-btn').onclick = () => { r.start(); };
    r.onresult = (e) => { document.getElementById('user-input').value = e.results[0][0].transcript; };
}
</script>
</body>
</html>
