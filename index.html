<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Multi-Device Viewport Fix (Handles iPhone Notch & Zoom) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TermOS: Modern Neural Link</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS (Modern Styling Engine) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: 'Inter' (Clean UI) + 'Fira Code' (Code) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">

    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <!-- Custom CSS for Modern Aesthetics -->
    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #38bdf8; /* Sky Blue */
            --accent-secondary: #818cf8; /* Indigo */
            --msg-user-bg: #3b82f6;
            --msg-ai-bg: #1e293b;
        }

        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- BACKGROUND MATRIX (Optimized & Subtle) --- */
        #matrix-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.15; /* Very subtle background */
            pointer-events: none;
        }

        /* --- SCROLLBAR HIDDEN (Clean Look) --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* --- GLASSMORPHISM UTILS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        /* --- MESSAGE BUBBLES --- */
        .msg-bubble {
            max-width: 85%;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            word-wrap: break-word;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- ASCII ART STYLING --- */
        .ascii-art {
            font-family: 'Fira Code', monospace;
            line-height: 0.8;
            white-space: pre;
            font-size: 9px;
            text-shadow: 0 0 2px rgba(255,255,255,0.5);
        }

        /* --- AVATAR GRADIENTS --- */
        .avatar-gradient-user { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .avatar-gradient-ai { background: linear-gradient(135deg, #10b981, #059669); }

        /* --- INPUT GLOW --- */
        .input-glow:focus-within {
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
            border-color: rgba(56, 189, 248, 0.5);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- 1. BACKGROUND: Subtle Matrix Rain -->
    <canvas id="matrix-canvas"></canvas>

    <!-- 2. HEADER: Floating Glass Bar -->
    <header class="fixed top-0 left-0 right-0 z-20 glass-panel border-b-0 border-b-white/5 h-16 flex items-center justify-between px-4 lg:px-8 safe-area-top">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white">TERMOS <span class="text-blue-400">LT</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="room-display">GLOBAL LOBBY</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-mono">LVL <span id="lvl-disp" class="text-blue-400 font-bold">1</span></span>
                <span class="text-[10px] text-gray-600 font-mono">XP <span id="xp-val">0</span></span>
            </div>
            <button id="install-btn" class="hidden bg-white/10 hover:bg-white/20 text-white text-xs font-bold px-4 py-2 rounded-lg transition-all backdrop-blur-md">
                Install App
            </button>
        </div>
    </header>

    <!-- 3. CHAT AREA: Centered & Safe -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 z-10 scroll-smooth max-w-5xl mx-auto w-full">
        <!-- Messages injected here -->
    </main>

    <!-- 4. INPUT AREA: Floating Modern Pill -->
    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-white/5 safe-area-bottom">
        <div class="max-w-4xl mx-auto p-4 pb-6">
            <div class="flex items-end gap-2 bg-slate-900/80 rounded-2xl p-2 border border-white/5 shadow-2xl input-glow transition-all">
                <!-- Voice Button -->
                <button id="voice-btn" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition-colors shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8h4m-4 8H8"></path></svg>
                </button>
                
                <!-- Text Input -->
                <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-4 py-3 text-base font-light">
                
                <!-- Send Button -->
                <button id="send-btn" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <button id="sys-install-btn" class="text-[10px] text-gray-600 hover:text-gray-400 transition-colors">
                    System: Normal
                </button>
            </div>
        </div>
    </div>

<!-- HIDDEN AUDIO -->
<audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112762.mp3" type="audio/mpeg">
</audio>

<!-- =========================================================== -->
<!--  FINAL OPTIMIZED SCRIPT (Visuals + Robust MQTT) -->
<!-- =========================================================== -->
<script>
    // --- 1. CONFIG ---
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 1000);
    let mqttClient = null;
    let currentRoom = 'global';
    
    // Enhanced Stats
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];

    // --- 2. PERFORMANCE OPTIMIZED MATRIX (requestAnimationFrame) ---
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        
        // Lower density for mobile performance
        const fontSize = window.innerWidth < 600 ? 10 : 14; 
        const columns = Math.floor(width / fontSize);
        const drops = Array(columns).fill(1);
        
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&';
        
        let animationFrameId;
        let lastTime = 0;
        const fps = 30;
        const interval = 1000 / fps;

        function draw(time) {
            requestAnimationFrame(draw);
            const delta = time - lastTime;
            if (delta < interval) return;
            lastTime = time - (delta % interval);

            ctx.fillStyle = 'rgba(2, 6, 23, 0.05)'; // Fade out trails
            ctx.fillRect(0, 0, width, height);
            
            ctx.fillStyle = '#1e40af'; // Modern Blue Matrix
            ctx.font = `${fontSize}px 'Fira Code', monospace`;
            
            for(let i=0; i<drops.length; i++) {
                const text = letters[Math.floor(Math.random()*letters.length)];
                ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                
                if(drops[i]*fontSize > height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        
        requestAnimationFrame(draw);
        
        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });
    }

    // --- 3. MODERN SYSTEM INSTALLER ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim();
            if (installedModules.includes(name)) return addSystemMessage(`Module ${name} active.`);
            
            const btn = document.getElementById('sys-install-btn');
            
            switch(name) {
                case 'matrix': 
                    initMatrix(); 
                    btn.innerText = "System: Matrix Active";
                    break;
                case 'sound': case 'beep': this.addSound(); break;
                case 'neon': this.addNeon(); break;
                case 'music': this.playMusic(); break;
                default: return addSystemMessage("Unknown: " + name);
            }
            installedModules.push(name);
            addSystemMessage("Installed: " + name.toUpperCase());
        },
        addSound: function() {
            let ctx = new (window.AudioContext||window.webkitAudioContext)();
            let old = window.addUserMessage; 
            window.addUserMessage = function(t) {
                const o = ctx.createOscillator(), g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.value = 600; o.start(); o.stop(ctx.currentTime+0.05);
                old(t);
            };
        },
        addNeon: function() {
            document.documentElement.style.setProperty('--msg-user-bg', '#ec4899'); 
            document.documentElement.style.setProperty('--accent-primary', '#ec4899');
        },
        playMusic: function() {
            const audio = document.getElementById('bg-music');
            audio.play().then(() => addSystemMessage("üéµ Ambient Stream Active")).catch(e => addSystemMessage("Interaction required first"));
        }
    };

    // --- 4. UI HELPERS ---
    function getBox() { return document.getElementById('chat-container'); }
    
    function addSystemMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex justify-center my-4";
        d.innerHTML = `<span class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wider text-gray-400 bg-slate-800/50 border border-white/5 shadow-inner">${txt}</span>`;
        getBox().appendChild(d);
        scrollDown();
    }

    function addAIMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4";
        d.innerHTML = `
            <div class="w-8 h-8 rounded-full avatar-gradient-ai shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800">
                <span class="text-xs font-bold text-white">AI</span>
            </div>
            <div class="flex-1">
                <div class="bg-slate-800/80 backdrop-blur-md rounded-2xl rounded-tl-none p-4 border border-white/5 shadow-lg text-gray-200 text-sm leading-relaxed">
                    ${escapeHtml(txt)}
                </div>
            </div>`;
        getBox().appendChild(d);
        scrollDown();
    }

    function addUserMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex flex-row-reverse gap-3 my-4 items-end";
        
        // Avatar Logic
        let avatarHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-user shrink-0 flex items-center justify-center shadow-lg text-xs font-bold text-white">ME</div>`;
        
        if (userStats.ascii) {
            avatarHTML = `<div class="w-10 h-10 rounded-lg bg-slate-900 border border-blue-500/50 flex items-center justify-center shrink-0 overflow-hidden p-1 shadow-lg shadow-blue-500/20">
                <div class="ascii-art text-center w-full">${userStats.ascii}</div>
            </div>`;
        }

        d.innerHTML = `
            ${avatarHTML}
            <div class="flex-1 max-w-[80%]">
                <div class="bg-blue-600 rounded-2xl rounded-tr-none p-4 shadow-lg shadow-blue-600/20 text-white text-sm leading-relaxed">
                    ${escapeHtml(txt)}
                </div>
                <div class="text-[10px] text-gray-500 text-right mt-1 mr-1 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            </div>`;
        getBox().appendChild(d);
        scrollDown();
    }

    function scrollDown() { const b=getBox(); b.scrollTop=b.scrollHeight; }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // --- 5. AI LOGIC ---
    async function handleAI(prompt) {
        if(!GROQ_API_KEY) return addAIMessage("‚ùå API Key Missing. Type /setkey [key]");
        
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-gray-500 italic animate-pulse">AI is typing...</div>`);
        scrollDown();

        try {
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model:"llama3-8b-8192",
                    messages:[{
                        role:"system",
                        content:"You are TermOS AI. If user asks for visual changes, return: SystemRebuilder.install('name'). If user asks for music, return: CMD: PLAY_MUSIC. Otherwise answer normally."
                    },{role:"user",content:prompt}]
                })
            });
            const reply = (await r.json()).choices[0].message.content;
            
            const el = document.getElementById(thinkingId);
            if(el) el.remove();

            let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
            if(match) { SystemRebuilder.install(match[1]); addAIMessage("‚ú® System updated."); }
            else if (reply.includes("CMD: PLAY_MUSIC")) {
                const audio = document.getElementById('bg-music');
                if(audio) { audio.play(); addAIMessage("üéµ Stream active."); }
            }
            else { addAIMessage(reply); }

        } catch(e) { addAIMessage("Connection failed."); }
    }

    // --- 6. GAMIFICATION ---
    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 100)) {
            userStats.level++;
            addSystemMessage(`üéâ LEVEL UP: ${userStats.level} - ${LEVELS[userStats.level] || 'MASTER'}`);
            updateAvatar(userStats.level);
        }
        document.getElementById('lvl-disp').innerText = userStats.level;
        document.getElementById('xp-val').innerText = userStats.xp;
        localStorage.setItem('termos_stats_modern', JSON.stringify(userStats));
    }

    function updateAvatar(lvl) {
        if(lvl === 3) userStats.ascii = "‚ó¢‚ó§<br>o_o<br>/|\\"; 
        else if (lvl === 5) userStats.ascii = "üïØ<br>  ‚òæ<br>  ‚òΩ"; 
        else if (lvl === 8) userStats.ascii = "üëÅ<br>¬∑ ¬∑<br>__¬∑__"; 
    }

    // --- 7. ROBUST CONNECT FUNCTION (FIX FOR ONLINE CHAT) ---
    function connectMQTT() {
        const options = {
            timeout: 10,
            useSSL: true,
            keepAliveInterval: 60,
            onSuccess: () => {
                console.log("[MQTT] Connected Successfully");
                addSystemMessage("üü¢ Neural Link Online.");
                
                // Subscribe with QoS 1 to ensure we get messages
                mqttClient.subscribe("termos/v3/chat", { qos: 1 });
            },
            onFailure: (message) => {
                console.log("[MQTT] Connection Failed: " + message.errorMessage);
                addSystemMessage("üî¥ Connection Failed. Retrying...");
                setTimeout(connectMQTT, 5000);
            }
        };
        mqttClient.connect(options);
    }

    // --- 8. INPUT HANDLER (WITH QoS 1 FIX) ---
    function handleInput() {
        let inp = document.getElementById('user-input');
        let txt = inp.value.trim();
        if(!txt) return;

        if(txt.startsWith('/sys install ')) {
            SystemRebuilder.install(txt.split(' ')[2]);
        }
        else if(txt.startsWith('/setkey ')) {
            GROQ_API_KEY = txt.substring(8);
            localStorage.setItem('termos_groq_key', GROQ_API_KEY);
            addSystemMessage("Key Encrypted.");
        }
        else if(txt.startsWith('/ai ')) {
            handleAI(txt.substring(4));
        }
        else {
            addUserMessage(txt);
            addXP(1);
            
            // --- ROBUST SEND LOGIC ---
            if(mqttClient && mqttClient.isConnected()) {
                const message = new Paho.MQTT.Message(JSON.stringify({ user: username, text: txt }));
                message.destinationName = "termos/v3/chat";
                message.qos = 1; // CRITICAL: Ensures delivery on public internet
                
                try {
                    mqttClient.send(message);
                    console.log("[MQTT TX] Sent:", txt);
                } catch (e) {
                    console.error("[MQTT TX] Send Failed:", e);
                    addSystemMessage("‚ö†Ô∏è Message failed to send.");
                }
            }
        }
        inp.value = '';
    }

    // --- 9. INIT & EVENT LISTENERS ---
    window.onload = function() {
        // 1. Load Stats
        let saved = localStorage.getItem('termos_stats_modern');
        if(saved) { userStats = JSON.parse(saved); if(userStats.ascii) updateAvatar(userStats.level); }

        // 2. Start Background
        initMatrix();

        // 3. MQTT CONNECTION
        if(typeof Paho !== 'undefined') {
            // Unique ID prevents kicking other users
            const clientId = "termos_client_" + Math.random().toString(16).substr(2, 8);
            
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, clientId);
            
            mqttClient.onConnectionLost = (responseObject) => {
                console.log("MQTT Connection Lost:", responseObject.errorMessage);
                addSystemMessage("‚ö†Ô∏è Connection Lost. Attempting Reconnect...");
                setTimeout(connectMQTT, 5000);
            };

            mqttClient.onMessageArrived = (message) => {
                try {
                    const topic = message.destinationName;
                    const payloadString = message.payloadString;
                    
                    // Debug: Check console to see incoming messages
                    console.log(`[MQTT RX] Topic: ${topic}`);

                    if (topic === "termos/v3/chat") {
                        const data = JSON.parse(payloadString);
                        // Don't show own messages
                        if (data.user !== username) {
                            addUserMessage(data.text);
                        }
                    }
                } catch (e) {
                    console.error("Error parsing MQTT message:", e);
                }
            };
            
            connectMQTT();
        }

        // 4. Listeners
        document.getElementById('send-btn').onclick = handleInput;
        document.getElementById('user-input').addEventListener('keypress',e=>{ if(e.key==='Enter') handleInput(); });
        
        // Voice
        if ('webkitSpeechRecognition' in window) {
            const r = new webkitSpeechRecognition();
            document.getElementById('voice-btn').onclick = () => { r.start(); };
            r.onresult = (e) => { document.getElementById('user-input').value = e.results[0][0].transcript; };
        }
    };
</script>
</body>
</html>
