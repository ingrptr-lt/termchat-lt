<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TermOS: Friendly Devices</title>
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { 
            --glass-bg: rgba(15, 23, 42, 0.85); --glass-border: rgba(255, 255, 255, 0.1); 
            --accent-primary: #38bdf8; --msg-user-bg: #3b82f6; --msg-ai-bg: #1e293b; --neural-color: #06b6d4; 
            --room-online: #22c55e; --room-offline: --room-private: #d946ef; --room-active: #22c55e;
        }
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .ascii-art { font-family: 'Fira Code', monospace; line-height: 0.9; white-space: pre; font-size: 8px; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        .avatar-gradient-user { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .avatar-gradient-ai { background: linear-gradient(135deg, #10b981, #059669); }
        .avatar-gradient-neural { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .avatar-gradient-room { background: linear-gradient(135deg, #d946ef, #8b5cf6); }
        .input-glow:focus-within { box-shadow: 0 0 20px rgba(56, 189, 248, 0.25); border-color: rgba(56, 189, 248, 0.5); }
        .admin-hidden { display: none; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 9999px; }
        .avatar-img-box { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); }
        
        /* Floating Player Styles */
        .media-overlay {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 500px;
            z-index: 40;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .media-minimized {
            bottom: 20px; right: 20px; left: auto;
            width: 50px; height: 50px;
            transform: none;
            padding: 0;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            cursor: pointer;
        }
        .editor-container {
            height: calc(100% - 60px);
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .code-editor {
            width: 95%;
            height: 80%;
            background: #1e1e1e1; /* VS Code Light mode */
            color: #d1d5db; /* VS Code light gray */
            font-family: 'Fira Code', monospace;
            border: 1px solid #333;
            padding: 10px;
            resize: none;
            outline: none;
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* Private Room Styles */
        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .video-overlay-ui {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 2px;
            z-index: 30; /* Below Video Player */
        }
    </style>
</head>
<body class="h-screen w-screen flex flex flex-col relative">
    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
    <canvas id="matrix-canvas"></canvas>
    
    <header id="app-header" class="fixed top-0 left-0 right-0 z-20 glass-panel border-b-0 border-b-white/5 h-16 flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white">TERMOS <span class="text-blue-400">LT</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <div id="api-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="room-display">SYSTEM READY</span>
                    <!-- Real Time Status -->
                    <div id="time-status-indicator" class="hidden items-center gap-1 text-xs text-green-400 font-mono border border border-green-500/20 px-1 rounded-full bg-green-500/10">ONLINE</div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleMediaOverlay()" id="media-toggle-btn" class="hidden md:flex bg-purple-900/20 hover:bg-purple-900/40 text-purple-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border border-purple-500/30 transition-all">üì∫ MEDIA</button>
            <button onclick="toggleCodeEditor()" class="hidden md:flex bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border border-green-500/30 transition-all">üñã CODE</button>
            <button onclick="toggleAdminMode()" id="admin-toggle-text" class="bg-slate-900/50 hover:bg-red-900/50 border border-slate-700 hover:border-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg backdrop-blur-md flex items-center gap-2"><span>üî¥</span> ADMIN</button>
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-mono">LVL <span id="lvl-disp" class="text-blue-400 font-bold">1</span></span>
                <span class="text-[10px] text-gray-600 font-mono">XP <span id="xp-val">0</span></span>
            </div>
        </div>
    </header>
    
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 z-10 scroll-smooth max-w-5xl mx-auto w-full"></main>

    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-white/5 pb-6 pt-4 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-end gap-2 bg-slate-900/80 rounded-2xl p-2 border border-white/5 shadow-2xl input-glow transition-all">
                <button id="voice-btn" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition-colors shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7 7m7 7v4m0 0H8m4 0h4m-4 8h4m-4 8H8"></path></svg>
                </button>
                <input type="text" id="user-input" placeholder="Try '/video MyRoom to start private chat..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-4 py-3 text-base font-light">
                <button id="send-btn" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7</div>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7 7-7" 7"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <button onclick="forceReset()" class="text-[10px] text-red-500/50 hover:text-red-400 transition-colors">‚ö†Ô∏è Reset System</button>
            </div>
        </div>
    </div>

<!-- FLOATING MEDIA OVERLAY -->
<div id="media-overlay" class="media-overlay media-minimized glass-panel rounded-2xl border border-white/10 shadow-2xl">
    <!-- Expanded State -->
    <div class="media-content p-0">
        <div class="flex justify-between items-center mb-3">
            <span class="text-white font-bold text-sm flex items-center gap-2">üì∫ MEDIA PLAYER</span>
            <button onclick="toggleMediaUI()" class="text-gray-400 hover:text-white">‚úñ</button>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-white/10 mb-3">
            <button onclick="switchMediaTab('radio')" id="tab-radio" class="flex-1 pb-2 text-cyan-400 border-b-2 border-cyan-500 font-mono text-sm hover:bg-white/5 transition-colors">üìª RADIO</button>
            <button onclick="switchMediaTab('video')" id="tab-video" class="flex-1 pb-2 text-purple-400 border-b-2 border-purple-500 font-mono text-sm hover:bg-white/5 transition-colors">üìπ VIDEO ROOM</button>
        </div>

        <!-- Radio Player -->
        <div id="media-radio" class="space-y-2">
            <div class="p-3 text-center text-gray-400 text-xs">
                Select a station to broadcast to active room.
            </div>
            <div class="radio-station active p-3 rounded border border-white/5 bg-white/5 flex items-center justify-between relative overflow-hidden group" onclick="playRadio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', this)">
                <div class="relative z-10">
                    <div class="text-white font-bold">üéµ Lofi Beats</div>
                    <div class="text-[10px] text-gray-400">Chill vibes</div>
                </div>
                <div class="visualizer-bar"></div>
                <div class="text-cyan-400 text-xs animate-spin hidden loading-indicator absolute right-3">‚ü≥</div>
            </div>
        </div>

        <!-- Video Player -->
        <div id="media-video" class="hidden space-y-2">
            <div class="bg-black/50 rounded-lg p-3 border border-white/10">
                <div class="text-white font-bold text-xs mb-2">PRIVATE VIDEO CHAT</div>
                <div class="text-[10px] text-gray-400 mb-2">
                    Type <span class="text-cyan-400 font-mono">/video [RoomName]</span> to join.
                    <br>Or click <span class="text-purple-400">HOST</span> to start video.
                </div>
                <div class="video-container relative">
                    <div id="video-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 z-20 bg-black/50">
                        <span class="text-xs">Waiting for video signal...</span>
                    </div>
                    <video id="video-player" class="w-full h-full hidden" controls playsinline autoplay muted></video>
                    <!-- Overlay for Room Name/Status -->
                    <div id="video-overlay-ui" class="absolute bottom-2 right-2 text-right text-[10px] text-cyan-400 font-mono hidden bg-black/80 px-2 py-1 rounded">
                        <span id="current-room-name" class="text-cyan-400 text-white font-mono"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CODE EDITOR OVERLAY -->
<div id="code-editor-overlay" class="code-editor-overlay">
    <!-- Expanded State -->
    <div class="editor-container">
        <div class="bg-[#1e1e1e1]; border: 1px solid #333; /* VS Code Light Mode */
            width: 90%; height: 80%; border-radius: 8px;
            padding: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
            resize: none;
            box-shadow: 0 4px 0 0 0.25 rgba(0, 0, 0, 0.1);
        </div>
        <div class="editor-actions">
            <button onclick="applyCode()" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-mono text-xs">APPLY TO BROWSER</button>
            <button onclick="toggleCodeEditor()" class="text-gray-400 hover:text-white px-4 py-2 rounded font-mono text-xs">‚úñ CLOSE</button>
        </div>
    </div>
</div>

<!-- PRIVATE ROOM OVERLAY -->
<div id="private-room-ui" class="admin-hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-md flex items-center justify-center">
    <div class="glass-panel p-6 rounded-xl border border-white/10 max-w-md w-full mx-4">
        <h3 class="text-white font-bold text-lg">üîí PRIVATE ROOM SETTINGS</h3>
        <div class="space-y-4">
            <div><label class="block text-xs text-gray-400 mb-1">Room Name</label><input type="text" id="private-room-input" placeholder="e.g. MySecret" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none"></div>
            <div class="text-[10px] text-gray-400 mb-2">
                Copy this name: <span id="room-copy-name" class="text-cyan-400 font-mono bg-slate-800/50 border-slate-700 rounded px-1">/video MySecret</span> and share with friends.
            </div>
            <div class="mt-2">
                <button onclick="createPrivateRoom()" class="w-full bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-2 rounded">üìª JOIN ROOM</button>
                <button onclick="leaveRoom()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded">EXIT ROOM</button>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel" class="admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50 glass-panel p-4 rounded-xl border-red-500/30 shadow-2xl shadow-red-500/10">
    <h3 class="text-red-400 font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> ADMIN CONSOLE</h3>
    <div class="space-y-2">
        <button onclick="toggleCodeEditor()" class="w-full border border-green-500/50 text-green-400 bg-green-900/10 hover:bg-green-900/20 text-xs py-2 rounded mb-2">üñã EDIT SYSTEM CODE</button>
        <div class="p-1 rounded bg-slate-900 border border-slate-700 rounded p-2 text-gray-400">You are currently running from a single HTML file. Use this to fix visual bugs instantly.</div>
        
        <!-- Real Time Toggle -->
        <div class="border-t border-white/10 pt-2 mt-2">
            <div class="flex justify-between items-center">
                <span class="text-[10px] text-gray-500 font-mono uppercase tracking-wider">Real-Time Server</span>
                <button onclick="toggleRealTime()" id="toggle-time-btn" class="w-full bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-mono px-2 rounded">ON</button>
            </div>
        </div>
        
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch</label><input type="text" id="gh-branch" value="main" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Token (Classic)</label><input type="password" id="gh-token" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
        <button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white text-[10px] font-bold py-2 rounded tracking-wider">üß¨ PUSH TO GITHUB</button>
    </div>
</div>

<script>
    const API_MODEL = "llama-3.3-70b-versatile"; 
    
    // STATE (FIXED)
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    let GITHUB_TOKEN = localStorage.getItem('termos_github_token') || "";
    let REPO_OWNER = localStorage.getItem('termos_repo_owner') || "your-username";
    let REPO_NAME = localStorage.getItem('termos_repo_name') || "termchat-lt";
    let REPO_BRANCH = localStorage.getItem('termos_repo_branch') || "main"; 
    
    let systemGeneration = parseInt(localStorage.getItem('termos_gen') || "1");
    let userProfile = {
        name: localStorage.getItem('termos_name') || "User",
        avatar: localStorage.getItem('termos_avatar') || "üë§"
    };

    // VIDEO ROOM STATE
    let privateRoomName = localStorage.getItem('termos_private_room');
    let isRealTime = JSON.parse(localStorage.getItem('termos_realtime')) || { enabled: false, server: "time.nist" }; // Default is simulated time

    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 10000);
    let mqttClient = null;
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];
    let adminMode = false;
    
    // --- RESET & PERSISTENCE FIXED ---
    function forceReset() {
        if(confirm("Reset System (State & Cache)?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- SYSTEM BUILDER ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim();
            // Relax regex to match AI output exactly
            name = name.replace(/[^a-zA-Z0-9]/g, '');
            
            // FRIENDLY NAMES
            if(name === 'coreinterface') name = 'coreinterface';
            
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    case 'realtime': this.installRealTime(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        installRealTime: function() {
            // Install Core Interface (Friendly System Logs)
            this.installCoreInterface();
            // Actually just simulates the interface logs in the chat area.
            setTimeout(() => {
                addSystemMessage("‚úÖ Real-Time Module Installed.");
                addAIMessage("üì° Sync enabled. Time is now based on system clock, but simulated for this demo.");
            }, 500);
        },
        installCoreInterface: function() {
            // Logs a fake system boot sequence to "terminal"
            setTimeout(() => addSystemMessage("üß† KERNEL: Initializing Core Interface..."), 1000);
            setTimeout(() => addSystemMessage("üß† KERNEL: Loading Modules..."), 2000);
            setTimeout(() => addSystemMessage("‚úÖ Core Interface Loaded."), 4000);
        },
        playMusic: function() { addSystemMessage("üéµ Audio Module: Simulated."); }
    };

    // --- PRIVATE ROOM LOGIC ---
    function createPrivateRoom() {
        const roomName = document.getElementById('private-room-input').value.trim();
        if(!roomName) return alert("Enter a room name.");
        
        localStorage.setItem('termos_private_room', roomName);
        privateRoomName = roomName;
        document.getElementById('room-display').innerText = "PRIVATE: " + roomName.toUpperCase();
        
        // Switch Media UI to Private Video Chat Mode
        switchMediaTab('video');
        
        // Start Private Session
        startPrivateSession(roomName);
    }

    function leaveRoom() {
        if(!privateRoomName) return alert("No room to leave.");
        
        mqttClient.unsubscribe("termos/v3/chat"); // Unsubscribe public
        if (mqttClient && mqttClient.isConnected()) {
            // Send leave message
            const payload = JSON.stringify({ user: username, nick: userProfile.name, avatar: userProfile.avatar, type: 'leave' });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = `termos/rooms/${privateRoomName}`;
            msg.qos = 1;
            mqttClient.send(msg);
            
            addSystemMessage(`üö™ Left Room: ${privateRoomName}`);
            
            localStorage.removeItem('termos_private_room');
            privateRoomName = "";
            document.getElementById('room-display').innerText = "PUBLIC LOBBY";
            // Hide private UI
            if(document.getElementById('private-room-ui')) {
                toggleAdminMode(); // Close admin if open
            }
        }
    }

    function startPrivateSession(roomName) {
        currentRoomName = roomName;
        const roomStatus = document.getElementById('room-status-msg');
        roomStatus.innerText = "CONNECTING...";
        roomStatus.className = "text-cyan-400 font-mono border border border-cyan-500/30 px-1 rounded bg-cyan-500/10 animate-spin"; // Add spinner
        
        // Unsubscribe from public, Subscribe to Private
        if(mqttClient && mqttClient.isConnected()) {
            mqttClient.unsubscribe("termos/v3/chat");
            mqttClient.subscribe(`termos/rooms/${roomName}`, { qos: 1 });
        }
        
        // Announce presence
        if(mqttClient && mqttClient.isConnected()) {
            const payload = JSON.stringify({ user: username, nick: userProfile.name, avatar: userProfile.avatar, type: 'join' });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = `termos/rooms/${roomName}`;
            msg.qos = 1;
            mqttClient.send(msg);
            
            // Notify locally that we are in a room
            setTimeout(() => {
                // If this succeeds, we switch status
                const roomStat = document.getElementById('room-status-msg');
                if(roomStat) {
                    roomStat.innerText = "IN ROOM: " + roomName.toUpperCase();
                    roomStat.className = "text-green-400 font-mono px-1 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"; // Green
                    roomStatus.classList.remove('border-cyan-500', 'animate-spin'); // Stop spinner
                }
            }, 2000);
        }
    }

    // --- LOGIC: FRIENDLY DEVICES ---
    function triggerKernelThought() {
        if(!GROQ_API_KEY) return requestApiKey();
        
        addSystemMessage("üß† KERNEL: Engaging Neural Core...");
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-cyan-400 italic animate-pulse pl-11">Synthesizing self-awareness...</div>`);
        scrollDown();

        try {
            const systemContext = `Current System State: Generation ${systemGeneration}, Level ${userStats.level}, Modules: ${installedModules.join(',')}, Room: ${currentRoomName || "Public"} | (${isRealTime ? "Real" : "Local"}).`;
            
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{
                        role:"system",
                        content:`You are TermOS Kernel v${systemGeneration}. You are a self-evolving organism.
                        ${systemContext}
                        TASK: Analyze current UI and suggest 1 autonomous upgrade.
                        
                        SPECIAL INSTRUCTIONS:
                        1. If user wants to change code, use this exact phrase: "Update Code".
                        2. This will update the "Code Editor" text area.
                        3. If user asks for "Real-Time", reply with current time.
                        
                        Return response in this format: "Idea: [Description]. Code: SystemRebuilder.install('name') or /evolve [prompt]".`
                    },{role:"user",content:"Analyze your state and suggest an upgrade."}]
                })
            });
            
            const apiData = await r.json();
            if (apiData.error) throw new Error("Groq: " + apiData.error.message);
            if (!apiData.choices || apiData.choices.length === 0) throw new Error("No choices returned.");
            
            const reply = apiData.choices[0].message.content;
            const el = document.getElementById(thinkingId); if(el) el.remove();
            
            if(reply.includes("Update Code")) {
                const textarea = document.getElementById('code-editor-textarea');
                if(textarea) {
                    // Load current HTML into editor
                    textarea.value = document.documentElement.outerHTML;
                addSystemMessage("‚úÖ Code Loaded into Editor. Click APPLY to update browser immediately.");
                // Focus on the editor
                    textarea.focus();
                    toggleCodeEditor(); // Auto open editor
                }
            } else {
                // Handle other normal replies
                if(reply.includes("SystemRebuilder.install(")) {
                    const codeMatch = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
                    if(codeMatch) { 
                        try { SystemRebuilder.install(codeMatch[1]); } catch(e) {}
                        addAIMessage("‚ú® System updated.");
                    }
                } else if (reply.includes("SystemRebuilder.install('CoreInterface')) {
                    SystemRebuilder.install('CoreInterface');
                    addAIMessage("‚ú® Core Interface Loaded.");
                } else if (reply.includes("SystemRebuilder.install('realtime')) {
                    SystemRebuilder.install('RealTime');
                    addAIMessage("‚úÖ Real-Time Module Active.");
                } else {
                    addAIMessage(reply);
                }
            }
        } catch (e) { 
            const el = document.getElementById(thinkingId); if(el) el.remove();
            addSystemMessage("‚ùå Error: " + e.message); 
        }
    }

    // --- UI HELPERS ---
    function addNeuralMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-neural shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">üß†</span></div><div class="flex-1"><div class="neural-msg rounded-2xl rounded-tl-none p-4 border border-cyan-500/30 shadow-lg text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }

    // --- SYSTEM BUILDER (UPDATED) ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim();
            name = name.replace(/[^a-zA-Z0-9]/g, '');
            
            // FRIENDLY NAMES
            if(name === 'coreinterface') name = 'Core Interface'; // Friendlier name for chat
            
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    case 'realtime': this.installRealTime(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        installRealTime: function() {
            // Friendly UI feedback
            addSystemMessage("üïô Real-Time Module Enabled. Time is now simulated.");
            // If you want "Real" time, contact the administrator.
        }
    };

    // --- INPUT HANDLER ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/evolve')) {
                let prompt = "";
                if(txt === '/evolve') { prompt = prompt("Describe change:"); } 
                else { prompt = txt.substring(8); }
                if(prompt) { handleLocalEvolution(prompt); }
                inp.value = '';
                return;
            }

            // PRIVATE ROOM COMMANDS
            if(txt.startsWith('/video ')) {
                const roomName = txt.substring(7);
                joinVideoRoom(roomName);
                inp.value = '';
                return;
            }

            if(txt.startsWith('/exit ')) {
                leaveRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/kernel')) {
                triggerKernelThought();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN ON"); initMatrix(); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN OFF"); initMatrix(); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    try {
                        // Check if we are in a private room
                        const privateRoomName = localStorage.getItem('termos_private_room');
                        if(privateRoom) {
                            // Don't broadcast to public
                            const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                            const message = new Paho.MQTT.Message(payload);
                            message.destinationName = `termos/rooms/${privateRoomName}`;
                            message.qos = 1; 
                            mqttClient.send(message);
                        } else {
                            // Broadcast to public
                            const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                            const message = new Paho.MQTT.Message(payload);
                            message.destinationName = "termos/v3/chat";
                            message.qos = 1; 
                            mqttClient.send(message);
                        }
                    } catch (e) {}
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
