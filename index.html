<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TermOS v3.0 - Integrated</title>
    
    <!-- PHASE 5: PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Paho MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        /* PHASE 1: CORE UNIFICATION (v3.0 CSS + AI CRT Effects) */
        :root {
            --term-green: #00ff00;
            --term-amber: #ffb000;
            --term-cyan: #00ffff;
            --bg-color: #050505;
            --scanline-color: rgba(0, 255, 0, 0.05);
            --glow: 0 0 10px var(--term-green);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--term-green);
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            text-shadow: 0 0 2px var(--term-green);
        }

        /* CRT Overlay (Deep Retro Feel) */
        #crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% { opacity: 0.95; }
            50% { opacity: 1; }
            100% { opacity: 0.98; }
        }

        /* UI Layout */
        #terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        header {
            border-bottom: 2px solid var(--term-green);
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-box { font-size: 0.8rem; }
        .highlight { color: var(--term-cyan); font-weight: bold; }

        #screen {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            font-size: 1rem;
            line-height: 1.4;
            scroll-behavior: smooth;
        }

        /* Scrollbar styling */
        #screen::-webkit-scrollbar { width: 8px; }
        #screen::-webkit-scrollbar-thumb { background: var(--term-green); }

        /* Message Styles */
        .msg { margin-bottom: 8px; word-wrap: break-word; }
        .msg .meta { font-size: 0.75rem; opacity: 0.8; display: inline-block; margin-right: 5px; }
        .sys-msg { color: var(--term-amber); }
        .ai-msg { color: #ff00ff; text-shadow: 0 0 5px #ff00ff; }
        .user-msg { color: var(--term-green); }
        .lvl-up { 
            color: #fff; 
            background: var(--term-green); 
            color: #000; 
            padding: 2px 5px; 
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; } }

        /* Input Area */
        #input-area {
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--term-green);
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--term-green);
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
        }

        button {
            background: transparent;
            border: 1px solid var(--term-green);
            color: var(--term-green);
            cursor: pointer;
            font-family: inherit;
            padding: 5px 10px;
            text-transform: uppercase;
        }

        button:hover { background: var(--term-green); color: black; }

        /* Voice Button */
        #mic-btn { color: var(--term-cyan); border-color: var(--term-cyan); }
        #mic-btn.listening { background: red; color: white; border-color: red; animation: pulse 1s infinite; }

    </style>
</head>
<body>

    <div id="crt-overlay"></div>

    <div id="terminal-container">
        <!-- Header displays Room & Stats -->
        <header>
            <div id="location-display">LOC: LOBBY</div>
            <div class="stat-box">LVL: <span id="lvl-disp" class="highlight">1</span> | XP: <span id="xp-disp">0</span></div>
        </header>

        <!-- Main Chat Screen -->
        <div id="screen">
            <div class="msg sys-msg">SYSTEM INITIALIZED... v3.0 KERNEL LOADED.</div>
            <div class="msg sys-msg">Type /help for commands. /join [room] to travel.</div>
        </div>

        <!-- Input Area with Voice Support -->
        <div id="input-area">
            <button id="mic-btn" title="Voice Command">üéôÔ∏è</button>
            <input type="text" id="cmd-input" placeholder="Enter command or message..." autocomplete="off">
            <button id="send-btn">SEND</button>
        </div>
    </div>

<script>
    /**
     * TERMOS INTEGRATED BUILD
     * Merges Phase 1 (Core), Phase 2 (Rooms), Phase 3 (Gamification), Phase 4 (AI), Phase 5 (Voice)
     */

    // --- CONFIGURATION ---
    const CONFIG = {
        broker: "broker.emqx.io",
        port: 8084, // WSS Port
        baseTopic: "termos/v3/", 
        aiKey: "YOUR_API_KEY_HERE", // REPLACE THIS OR USE /setkey COMMAND
        rooms: {
            "lobby": { color: "#00ff00" },
            "lounge": { color: "#00ffff" },
            "studio": { color: "#ff00ff" },
            "radio":  { color: "#ffff00" }
        }
    };

    // --- STATE MANAGEMENT ---
    let client = null;
    let isConnected = false;
    let USER_ID = "USR_" + Math.floor(Math.random() * 10000);
    let currentRoom = "lobby";
    
    // Check URL Params for Room (Phase 2)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('room')) {
        currentRoom = urlParams.get('room').toLowerCase();
    }

    // --- PHASE 3: GAMIFICATION ENGINE ---
    const GAMIFICATION = {
        xp: 0,
        level: 1,
        title: "Newbie",
        
        init: function() {
            const saved = localStorage.getItem('termos_profile');
            if (saved) {
                const data = JSON.parse(saved);
                this.xp = data.xp || 0;
                this.level = data.level || 1;
                this.title = data.title || "Newbie";
                this.updateUI();
            }
        },

        addXP: function(amount) {
            this.xp += amount;
            log(`XP GAINED: +${amount}`, 'system');
            
            // Level Logic
            const nextLevelXP = this.level * 100; 
            if (this.xp >= nextLevelXP) {
                this.xp -= nextLevelXP;
                this.level++;
                log(`LEVEL UP! YOU ARE NOW LEVEL ${this.level}`, 'special');
                // Unlock Avatar logic could go here
            }

            this.save();
            this.updateUI();
        },

        save: function() {
            const data = { xp: this.xp, level: this.level, title: this.title };
            localStorage.setItem('termos_profile', JSON.stringify(data));
        },

        updateUI: function() {
            document.getElementById('xp-disp').innerText = this.xp;
            document.getElementById('lvl-disp').innerText = this.level;
        }
    };

    // --- UI UTILITIES ---
    const screen = document.getElementById('screen');
    const input = document.getElementById('cmd-input');
    const sendBtn = document.getElementById('send-btn');
    const micBtn = document.getElementById('mic-btn');

    function log(text, type = 'user-msg', sender = 'SYS') {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        
        let meta = '';
        if (type !== 'system') {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            meta = `<span class="meta">[${time}] <${sender}></span>`;
        }

        if (type === 'special') {
            div.innerHTML = `<span class="lvl-up">${text}</span>`;
        } else {
            div.innerHTML = `${meta}${text}`;
        }

        screen.appendChild(div);
        screen.scrollTop = screen.scrollHeight; // Auto scroll
    }

    // --- PHASE 2: MQTT & ROOM LOGIC ---
    function initMQTT() {
        const clientId = "termos_" + USER_ID;
        client = new Paho.MQTT.Client(CONFIG.broker, CONFIG.port, clientId);

        client.onConnectionLost = (responseObject) => {
            isConnected = false;
            log("CONNECTION LOST. RETRYING...", "sys-msg");
            setTimeout(initMQTT, 5000); // Retry loop
        };

        client.onMessageArrived = (message) => {
            const topic = message.destinationName;
            const payload = JSON.parse(message.payloadString);
            
            // Route message based on room
            const roomTopic = CONFIG.baseTopic + currentRoom;
            if (topic === roomTopic) {
                log(payload.msg, 'user-msg', payload.id);
                // SFX Hook here
            }
        };

        const options = {
            useSSL: true,
            timeout: 3,
            onSuccess: () => {
                isConnected = true;
                log("CONNECTED TO NEXUS.", "sys-msg");
                GAMIFICATION.addXP(5); // Hook: Connection XP
                joinRoom(currentRoom, false); // Join initial room
            },
            onFailure: () => {
                log("CONN FAILED.", "sys-msg");
            }
        };

        client.connect(options);
    }

    function joinRoom(roomName, clearScreen = true) {
        if (!CONFIG.rooms[roomName]) {
            log("ROOM NOT FOUND. TRY: lobby, lounge, studio, radio", "sys-msg");
            return;
        }

        // Unsubscribe old
        if (isConnected) {
            client.unsubscribe(CONFIG.baseTopic + currentRoom);
            
            // Subscribe new
            currentRoom = roomName;
            client.subscribe(CONFIG.baseTopic + currentRoom);
            
            // Update UI
            document.getElementById('location-display').innerText = `LOC: ${roomName.toUpperCase()}`;
            document.documentElement.style.setProperty('--term-green', CONFIG.rooms[roomName].color);
            
            log(`ENTERED ROOM: ${roomName.toUpperCase()}`, "sys-msg");
            
            if (clearScreen) {
                screen.innerHTML = ''; // Clear chat
                log(`--- JOINED ${roomName.toUpperCase()} ---`, "system");
                GAMIFICATION.addXP(5); // Hook: Exploration XP
            }
        }
    }

    function sendMessage(text) {
        if (!isConnected) return log("OFFLINE. MESSAGE QUEUED (NOT IMPLEMENTED)", "sys-msg");
        
        const message = new Paho.MQTT.Message(JSON.stringify({
            id: USER_ID,
            msg: text,
            type: 'chat'
        }));
        message.destinationName = CONFIG.baseTopic + currentRoom;
        client.send(message);
    }

    // --- PHASE 4: AI INTEGRATION ---
    async function processAIRequest(instruction) {
        log(`PROCESSING AI REQUEST...`, "sys-msg");

        // Context Injection
        const systemPrompt = `You are TermOS AI. You are in the [${currentRoom}] room. 
        User Level: ${GAMIFICATION.level}. 
        Available functions: playRadio (plays lofi), changeColor (hex code), setTopic (string).
        Respond concisely in a terminal style. If user asks for a function, return JSON format: {"action": "functionName", "value": "param"}.`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.aiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: instruction }
                    ]
                })
            });

            const data = await response.json();
            const aiContent = data.choices[0].message.content;

            // Try to parse JSON action from AI
            try {
                const actionObj = JSON.parse(aiContent);
                executeAIAction(actionObj);
                log(`AI EXECUTED: ${actionObj.action}`, "ai-msg");
            } catch (e) {
                // Normal text response
                log(aiContent, "ai-msg", "AI_CORE");
            }

        } catch (error) {
            log("AI LINK ERROR: CHECK API KEY.", "sys-msg");
            console.error(error);
        }
    }

    function executeAIAction(action) {
        switch(action.action) {
            case 'playRadio':
                log("STARTING AUDIO STREAM...", "sys-msg");
                // Trigger v3.0 audio player logic here
                break;
            case 'changeColor':
                document.documentElement.style.setProperty('--term-green', action.value);
                log(`THEME UPDATED: ${action.value}`, "sys-msg");
                break;
            case 'setTopic':
                log(`TOPIC SET BY AI: ${action.value}`, "ai-msg");
                // Send a message as AI
                const msg = new Paho.MQTT.Message(JSON.stringify({
                    id: "AI_CORE",
                    msg: action.value,
                    type: 'chat'
                }));
                msg.destinationName = CONFIG.baseTopic + currentRoom;
                client.send(msg);
                break;
        }
    }

    // --- INPUT HANDLING (The Parser) ---
    function handleInput() {
        const text = input.value.trim();
        if (!text) return;

        // 1. AI Command
        if (text.startsWith('/ai ')) {
            processAIRequest(text.substring(4));
        }
        // 2. Room Switching
        else if (text.startsWith('/join ')) {
            const room = text.split(' ')[1];
            joinRoom(room);
        }
        // 3. API Key Setter
        else if (text.startsWith('/setkey ')) {
            CONFIG.aiKey = text.substring(8);
            log("API KEY UPDATED FOR SESSION.", "sys-msg");
        }
        // 4. System Help
        else if (text === '/help') {
            log("COMMANDS: /ai [prompt], /join [room], /setkey [key]", "sys-msg");
        }
        // 5. Default Chat
        else {
            sendMessage(text);
            GAMIFICATION.addXP(1); // Hook: Chat XP
        }

        input.value = '';
    }

    // --- PHASE 5: VOICE INTERFACE ---
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';

        micBtn.addEventListener('click', () => {
            recognition.start();
            micBtn.classList.add('listening');
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            input.value = transcript;
            micBtn.classList.remove('listening');
            // Optional: Auto send
            // handleInput(); 
        };

        recognition.onerror = () => micBtn.classList.remove('listening');
        recognition.onend = () => micBtn.classList.remove('listening');
    } else {
        micBtn.style.display = 'none'; // Hide if not supported
    }

    // Event Listeners
    sendBtn.addEventListener('click', handleInput);
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleInput(); });

    // BOOT SEQUENCE
    window.onload = () => {
        GAMIFICATION.init();
        initMQTT();
    };

</script>
</body>
</html>
