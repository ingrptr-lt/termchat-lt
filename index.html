<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-bust" content="v1.0.1">
    <meta name="theme-color" content="#33ff00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TermOS">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.svg">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <title>TermChat LT</title>
    <style>
        :root {
            --term-color: #33ff00;
            --term-font: 'Courier New', 'Monaco', 'Menlo', monospace;
            --bg-color: #000;
            --panel-bg: #0a0a0a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-color);
            color: var(--term-color);
            font-family: var(--term-font);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* MONITOR BEZEL EFFECT */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 20px solid #222;
            border-radius: 15px;
            box-shadow: 
                inset 0 0 50px rgba(0,0,0,0.8),
                0 0 20px rgba(51,255,0,0.1);
            pointer-events: none;
            z-index: 1000;
        }

        /* MAIN LAYOUT GRID */
        #main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            padding: 25px;
            gap: 2px;
        }

        /* RESPONSIVE & MOBILE FIXES */
        @media (max-width: 768px) {
            body::before {
                border: 10px solid #222; /* Thinner bezel on mobile */
            }
            
            #main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                padding: 15px 5px;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }
            
            .side-panel {
                display: none;
            }
            
            /* iOS Safari keyboard fix */
            .input-line {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0,0,0,0.95);
                backdrop-filter: blur(10px);
                z-index: 100;
            }
            
            #terminal-body {
                padding-bottom: 60px; /* Space for fixed input */
                height: calc(100vh - 120px);
                height: calc(100dvh - 120px);
            }
        }
        
        /* Desktop specific */
        @media (min-width: 769px) {
            #main-layout {
                grid-template-columns: 1fr 350px;
            }
            
            #multiverse-panel.active {
                display: block;
            }
        }

        /* HEADER (ASCII) */
        #room-header {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--term-color);
            padding: 10px;
            white-space: pre;
            font-size: 0.8em;
            text-shadow: 0 0 5px var(--term-color);
        }

        /* CHAT AREA */
        #terminal-body {
            grid-column: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid var(--term-color);
            background: rgba(0,0,0,0.8);
        }

        /* DYNAMIC PANELS */
        #multiverse-panel {
            grid-column: 2;
            border-left: 2px solid var(--term-color);
            background: var(--panel-bg);
            padding: 10px;
            overflow-y: auto;
            display: none;
        }

        #multiverse-panel.active { display: block; }

        /* INPUT AREA */
        .input-line {
            grid-column: 1 / -1;
            display: flex;
            border-top: 2px solid var(--term-color);
            padding: 10px;
            background: rgba(0,0,0,0.9);
        }

        #chatInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--term-color);
            font-family: var(--term-font);
            font-size: 16px; /* Prevents iOS zoom */
            outline: none;
            padding: 5px;
            -webkit-appearance: none; /* Remove iOS styling */
            border-radius: 0; /* Remove iOS rounded corners */
        }
        
        /* iOS Safari specific fixes */
        #chatInput:focus {
            transform: translateZ(0); /* Force hardware acceleration */
        }

        /* THEMES */
        .theme-living { --term-color: #33ff00; }
        .theme-library { --term-color: #ffb000; }
        .theme-studio { --term-color: #ff00ff; }
        .theme-workshop { --term-color: #00ffff; }
        .theme-think { --term-color: #00ff41; }
        .theme-lounge { --term-color: #ff3333; }

        /* MULTIVERSE OS ENHANCEMENTS */
        .voice-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid var(--term-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 500;
            display: none;
        }
        
        .voice-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .image-placeholder {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--term-color);
            padding: 20px;
            margin: 5px 0;
            text-align: center;
            border-radius: 5px;
        }

        /* LOGIN SCREEN */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .login-box {
            border: 2px solid var(--term-color);
            padding: 40px;
            background: rgba(0,20,0,0.9);
            text-align: center;
        }

        .login-box input {
            background: var(--bg-color);
            border: 1px solid var(--term-color);
            color: var(--term-color);
            width: 100%;
            padding: 10px;
            margin: 20px 0;
            font-family: var(--term-font);
            font-size: 16px;
        }

        .login-box button {
            background: var(--term-color);
            color: var(--bg-color);
            width: 100%;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-family: var(--term-font);
            font-size: 16px;
        }
    </style>
</head>
<body class="theme-living">
    
    <!-- Voice Indicator -->
    <div id="voice-indicator" class="voice-indicator">ðŸ”Š Speaking...</div>
    
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2>TERMOS LT</h2>
            <input type="text" id="usernameInput" placeholder="Username" maxlength="20">
            <button onclick="login()">ENTER</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-layout" style="display: none;">
        <div id="room-header">TERMCHAT LT - LIVING ROOM<span class="cursor"></span></div>
        
        <div id="terminal-body"></div>
        
        <div id="multiverse-panel" class="side-panel"></div>
        
        <div class="input-line">
            <span style="margin-right: 10px;">&gt;</span>
            <input id="chatInput" type="text" placeholder="Type message..." autocomplete="off">
            <button id="sendButton" style="margin-left: 10px; background: var(--term-color); color: #000; border: none; padding: 5px 10px; cursor: pointer;">Send</button>
        </div>
    </div>
    <script>
        // --- GLOBAL STATE ---
        let currentState = "chat"; // chat, app, game, video, tunnel, admin
        let currentRoom = 'living_room';
        let username = '';
        let mqttClient = null;
        let appData = null;
        let gameData = null;
        let messageHistory = [];
        let isOnline = navigator.onLine;
        let userStats = {
            level: 1,
            xp: 0,
            linesOfCode: 0,
            questsCompleted: 0,
            avatar: 'default'
        };
        let roomId = null;

        // ASCII Avatars
        const AVATARS = {
            'default': `
  o_o
  /|\\
  / \\
`,
            'admin': `
 â™”â™”â™”
  o_o
  /|\\
  / \\
`,
            'hacker': `
 /\\_/\\
( o.o )
 =^.^=
`,
            'wizard': `
   /\\
  /  \\
  \\__/
  o_o
  /|\\
`,
            'robot': `
 [===]
  o_o
  /|\\
  / \\
`,
            'ninja': `
   â—¢â—¤
  o_o
  /|\\
  / \\
`
        };

        // Level system
        const LEVEL_THRESHOLDS = [0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500, 5500];
        const LEVEL_TITLES = [
            'Newbie', 'Apprentice', 'Coder', 'Hacker', 'Architect', 
            'Wizard', 'Master', 'Guru', 'Legend', 'Arch-Mage'
        ];

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Offline/Online detection
        window.addEventListener('online', function() {
            isOnline = true;
            addMessage('SYSTEM', 'Connection restored - syncing messages...');
            syncOfflineMessages();
        });
        
        window.addEventListener('offline', function() {
            isOnline = false;
            addMessage('SYSTEM', 'Connection lost - messages will be queued');
        });

        // --- MESSAGE PERSISTENCE ---
        function saveMessageToLocal(user, text, room = currentRoom) {
            const message = {
                id: Date.now() + Math.random(),
                user: user,
                text: text,
                room: room,
                timestamp: new Date().toISOString(),
                synced: isOnline
            };
            
            messageHistory.push(message);
            
            // Save to localStorage for persistence
            try {
                const stored = JSON.parse(localStorage.getItem('termchat_messages') || '[]');
                stored.push(message);
                // Keep only last 1000 messages
                if (stored.length > 1000) stored.splice(0, stored.length - 1000);
                localStorage.setItem('termchat_messages', JSON.stringify(stored));
            } catch (e) {
                console.warn('Failed to save message to localStorage:', e);
            }
        }
        
        function loadMessageHistory() {
            try {
                const stored = JSON.parse(localStorage.getItem('termchat_messages') || '[]');
                const roomMessages = stored.filter(msg => msg.room === currentRoom);
                const recent = roomMessages.slice(-50); // Show last 50 messages
                
                recent.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '5px';
                    div.style.opacity = '0.7'; // Indicate historical message
                    div.style.color = msg.user === 'TERMAI' ? '#00ff41' : 'var(--term-color)';
                    div.textContent = `[${msg.user}] ${msg.text}`;
                    const terminalBody = document.getElementById('terminal-body');
                    if (terminalBody) {
                        terminalBody.appendChild(div);
                    }
                });
                
                if (recent.length > 0) {
                    addMessage('SYSTEM', `Loaded ${recent.length} previous messages`);
                }
            } catch (e) {
                console.warn('Failed to load message history:', e);
            }
        }
        
        function syncOfflineMessages() {
            // Sync any unsynced messages when back online
            const unsynced = messageHistory.filter(msg => !msg.synced);
            unsynced.forEach(msg => {
                if (mqttClient && mqttClient.isConnected()) {
                    const payload = { user: msg.user, text: msg.text, timestamp: msg.timestamp };
                    mqttClient.publish('termchat/messages', JSON.stringify(payload));
                    msg.synced = true;
                }
            });
        }

        // Boot sequence
        document.addEventListener('DOMContentLoaded', function() {
            // Check for room sharing URL
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            
            if (roomId) {
                addMessage('SYSTEM', `Joining shared room: ${roomId}`);
            }
            
            // Load user stats
            loadUserStats();
            
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.focus();
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            }
        });

        // --- USER STATS & GAMIFICATION ---
        function loadUserStats() {
            try {
                const saved = localStorage.getItem('termchat_stats');
                if (saved) {
                    userStats = {...userStats, ...JSON.parse(saved)};
                }
            } catch (e) {
                console.warn('Failed to load user stats:', e);
            }
        }
        
        function saveUserStats() {
            try {
                localStorage.setItem('termchat_stats', JSON.stringify(userStats));
            } catch (e) {
                console.warn('Failed to save user stats:', e);
            }
        }
        
        function addXP(amount, reason) {
            userStats.xp += amount;
            const oldLevel = userStats.level;
            userStats.level = calculateLevel(userStats.xp);
            
            if (userStats.level > oldLevel) {
                addMessage('ACHIEVEMENT', `ðŸŽ‰ Level up! You are now ${LEVEL_TITLES[userStats.level - 1]} (Level ${userStats.level})`);
                unlockAvatar();
            }
            
            addMessage('XP', `+${amount} XP (${reason})`);
            saveUserStats();
            updateUserDisplay();
        }
        
        function calculateLevel(xp) {
            for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (xp >= LEVEL_THRESHOLDS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }
        
        function unlockAvatar() {
            const level = userStats.level;
            if (level >= 3 && userStats.avatar === 'default') {
                userStats.avatar = 'hacker';
                addMessage('ACHIEVEMENT', 'ðŸŽ­ New avatar unlocked: Hacker!');
            } else if (level >= 5) {
                userStats.avatar = 'wizard';
                addMessage('ACHIEVEMENT', 'ðŸ§™ New avatar unlocked: Wizard!');
            } else if (level >= 8) {
                userStats.avatar = 'ninja';
                addMessage('ACHIEVEMENT', 'ðŸ¥· New avatar unlocked: Ninja!');
            }
        }
        
        function updateUserDisplay() {
            const header = document.getElementById('room-header');
            if (header) {
                const levelTitle = LEVEL_TITLES[userStats.level - 1] || 'Unknown';
                header.innerHTML = `TERMCHAT LT - ${currentRoom.toUpperCase()} | ${username} (Lvl ${userStats.level} ${levelTitle})<span class="cursor"></span>`;
            }
        }
        function login() {
            const input = document.getElementById('usernameInput');
            const user = input.value.trim();
            if (user.length >= 3) {
                username = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('main-layout').style.display = 'grid';
                
                // Load message history first
                loadMessageHistory();
                
                connectMQTT();
                document.getElementById('chatInput').focus();
                
                // Setup input handler
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') sendMessage();
                    });
                }
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.addEventListener('click', sendMessage);
                }
            } else {
                alert('Username must be at least 3 characters');
            }
        }

        // --- PANEL MANAGER ---
        function switchMode(mode, data) {
            currentState = mode;
            const panel = document.getElementById('multiverse-panel');
            // Hide all content first
            panel.innerHTML = '';
            panel.classList.add('active');

            if (mode === 'chat') {
                panel.classList.remove('active'); // Hide panel, show full chat
            }
            else if (mode === 'app') {
                renderAppBuilder(data);
            }
            else if (mode === 'game') {
                renderGame(data);
            }
            else if (mode === 'video') {
                renderVideo();
            }
            else if (mode === 'admin') {
                renderAdmin();
            }
        }

        // --- 1. APP BUILDER (Workshop) ---
        function renderAppBuilder(data) {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3 style="border-bottom:1px dashed var(--term-color)">IDE: ${data.title}</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="showFile('index.html')">HTML</button>
                    <button onclick="showFile('style.css')">CSS</button>
                    <button onclick="previewApp()">PREVIEW</button>
                    <button onclick="switchMode('chat')">CLOSE</button>
                </div>
                <textarea id="code-area" style="width:100%; height:400px; background:#000; color:var(--term-color); border:1px solid var(--term-color); font-family:monospace;">${data.content}</textarea>
                <div id="preview-frame" style="display:none; width:100%; height:400px; background:#fff;"></div>
            `;
            appData = data;
            
            // Award XP for app creation
            addXP(50, 'Creating app');
            userStats.linesOfCode += (data.content || '').split('\n').length;
            saveUserStats();
        }

        function showFile(filename) {
            const codeArea = document.getElementById('code-area');
            if (appData && appData.content) {
                codeArea.value = appData.content;
            }
        }

        function previewApp() {
            const codeArea = document.getElementById('code-area');
            const previewFrame = document.getElementById('preview-frame');
            previewFrame.style.display = 'block';
            previewFrame.innerHTML = `<iframe srcdoc="${codeArea.value.replace(/"/g, '&quot;')}" style="width:100%; height:100%; border:none;"></iframe>`;
        }

        // --- 2. GAME CONSOLE (Lounge) ---
        function renderGame(data) {
            const panel = document.getElementById('multiverse-panel');
            const options = data.options || ['Continue', 'Inventory', 'Help', 'Quit'];
            const stats = data.stats || {hp: 100, max_hp: 100, inventory: ['Sword']};
            
            panel.innerHTML = `
                <h3 style="color:red; border-bottom:1px solid red;">GAME CONSOLE</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="font-size:1.2em; margin:20px 0;">${data.content || 'Welcome to the adventure!'}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    ${options.map(opt => `<button onclick="sendGameAction('${opt}')" style="background:var(--term-color); color:#000; padding:10px;">${opt}</button>`).join('')}
                </div>
                <div style="margin-top:20px;">
                    HP: <span style="color:red">${stats.hp}</span> / ${stats.max_hp} | INV: ${stats.inventory.join(', ')}
                </div>
            `;
            gameData = data;
            
            // Award XP for game activities
            addXP(30, 'Starting game');
            userStats.questsCompleted += 1;
            saveUserStats();
        }

        function sendGameAction(action) {
            if (mqttClient) {
                const msg = {
                    id: username,
                    msg: `game action: ${action}`,
                    timestamp: Date.now()
                };
                mqttClient.publish('termchat/input', JSON.stringify(msg));
            }
        }

        // --- 3. VIDEO CALL (Private Cabin) ---
        function renderVideo() {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3>VIDEO CALL</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="display:flex; gap:10px; margin:20px 0;">
                    <div style="flex:1; border:1px solid var(--term-color); height:200px;">
                        <video id="localVid" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                    </div>
                    <div style="flex:1; border:1px solid var(--term-color); height:200px;">
                        <video id="remoteVid" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                    </div>
                </div>
                <button onclick="startCam()">CAMERA ON</button>
                <button onclick="stopCam()">CAMERA OFF</button>
            `;
        }

        function startCam() {
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    document.getElementById('localVid').srcObject = stream;
                })
                .catch(err => addMessage('ERROR', 'Camera access denied'));
        }

        function stopCam() {
            const video = document.getElementById('localVid');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // --- 4. ADMIN DASHBOARD ---
        function renderAdmin() {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3>ROOT ACCESS</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="margin-bottom:20px;">
                    <h4>Plugin Manager</h4>
                    <textarea id="plugin-code" placeholder="Enter Python plugin code..." style="width:100%; height:200px; background:#000; color:var(--term-color); border:1px solid var(--term-color); font-family:monospace;"></textarea>
                    <div style="margin:10px 0;">
                        <input id="plugin-name" placeholder="Plugin name" style="background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                        <input id="plugin-triggers" placeholder="Triggers (comma-separated)" style="background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                        <button onclick="uploadPlugin()">UPLOAD PLUGIN</button>
                    </div>
                </div>
                <div id="admin-log" style="height:200px; overflow-y:scroll; background:#000; border:1px solid var(--term-color); margin:20px 0; padding:5px;"></div>
                <div style="display:flex; gap:10px;">
                    <input id="admin-cmd" placeholder="Enter admin command..." style="flex:1; background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                    <button onclick="sendAdmin()">EXEC</button>
                </div>
            `;
        }

        function sendAdmin() {
            const input = document.getElementById('admin-cmd');
            const cmd = input.value.trim();
            if (cmd && mqttClient && mqttClient.isConnected()) {
                mqttClient.publish('termchat/admin', cmd);
                input.value = '';
                addAdminLog(`> ${cmd}`);
            }
        }

        function addAdminLog(text) {
            const log = document.getElementById('admin-log');
            if (log) {
                const div = document.createElement('div');
                div.textContent = text;
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            }
        }
        
        function uploadPlugin() {
            const name = document.getElementById('plugin-name').value.trim();
            const code = document.getElementById('plugin-code').value.trim();
            const triggers = document.getElementById('plugin-triggers').value.trim().split(',').map(t => t.trim()).filter(t => t);
            
            if (!name || !code) {
                addMessage('ERROR', 'Plugin name and code are required');
                return;
            }
            
            if (mqttClient && mqttClient.isConnected()) {
                const pluginData = {
                    action: 'upload_plugin',
                    name: name,
                    code: code,
                    triggers: triggers,
                    user: username
                };
                
                mqttClient.publish('termchat/admin', JSON.stringify(pluginData));
                addMessage('SYSTEM', `Uploading plugin: ${name}`);
                
                // Clear form
                document.getElementById('plugin-name').value = '';
                document.getElementById('plugin-code').value = '';
                document.getElementById('plugin-triggers').value = '';
                
                // Award XP for plugin creation
                addXP(100, 'Creating plugin');
            }
        }

        function connectMQTT() {
            console.log("[DIAG] Initializing Paho Client...");
            // âœ… CHECK IF PAHO EXISTS
            if (typeof Paho === 'undefined') {
                console.error("[DIAG] âŒ Paho library failed to load!");
                alert("Failed to load MQTT library. Check internet connection.");
                addMessage('ERROR', 'Paho MQTT library failed to load. Please refresh the page.');
                return; // STOP EXECUTION
            }
            try {
                addMessage('SYSTEM', 'Connecting to MQTT broker...');
                
                // Enhanced WebSocket connection with fallback
                const clientId = "client-" + username + "-" + Math.floor(Math.random() * 1000);
                mqttClient = new Paho.Client("broker.emqx.io", 8084, clientId);
                
                // Connection options with enhanced reliability
                const connectOptions = {
                    onSuccess: function() {
                        addMessage('SYSTEM', 'âœ… Connected to TermOS LT Multiverse!');
                        
                        // Subscribe to channels (including room-specific if shared)
                        const topics = ['termchat/messages', 'termchat/output', 'termchat/admin', 'termchat/tunnel/+', 'termchat/webrtc/+'];
                        
                        if (roomId) {
                            topics.push(`termchat/room/${roomId}`);
                            addMessage('SYSTEM', `Joined shared room: ${roomId}`);
                        }
                        
                        topics.forEach(topic => {
                            mqttClient.subscribe(topic);
                            console.log('[DIAG] Subscribed to:', topic);
                        });
                        
                        // Send connection announcement
                        const connectMsg = {
                            user: 'SYSTEM',
                            text: `${username} joined the multiverse`,
                            timestamp: Date.now()
                        };
                        
                        const publishTopic = roomId ? `termchat/room/${roomId}` : 'termchat/messages';
                        mqttClient.publish(publishTopic, JSON.stringify(connectMsg));
                        
                        // Test message
                        addMessage('SYSTEM', 'Connection established. Try typing "ai hello" to test AI.');
                    },
                    onFailure: function(error) {
                        console.error('MQTT Connection failed:', error);
                        addMessage('ERROR', `âŒ Connection failed: ${error.errorMessage || 'WebSocket blocked or broker unavailable'}`);
                        addMessage('SYSTEM', 'Check: 1) Network connection 2) Firewall/proxy blocking WebSocket 3) Try different network');
                        
                        // Retry connection after 5 seconds
                        setTimeout(() => {
                            addMessage('SYSTEM', 'ðŸ”„ Retrying connection...');
                            connectMQTT();
                        }, 5000);
                    },
                    useSSL: true,
                    timeout: 15,
                    keepAliveInterval: 30,
                    cleanSession: true
                };
                
                // Connection lost handler
                mqttClient.onConnectionLost = function(responseObject) {
                    if (responseObject.errorCode !== 0) {
                        console.error('MQTT Connection lost:', responseObject);
                        addMessage('ERROR', `âŒ Connection lost: ${responseObject.errorMessage}`);
                        addMessage('SYSTEM', 'ðŸ”„ Attempting to reconnect...');
                        setTimeout(() => connectMQTT(), 3000);
                    }
                };
                mqttClient.onMessageArrived = function(message) {
                    const payload = message.payloadString;
                    const topic = message.destinationName;
                    console.log(`[DIAG] ðŸ“© Message from ${topic}: ${payload.substring(0, 100)}...`);
                    
                    // --- SMART ROUTER: ATTEMPT TO PARSE JSON ---
                    try {
                        const data = JSON.parse(payload);
                        
                        // --- APP DETECTED ---
                        if (data.type === 'creation' && data.creation && data.creation.type === 'app') {
                            switchMode('app', data.creation);
                            addMessage('TERMAI', 'Created app for you!');
                            return; // Stop processing
                        }
                        
                        // --- GAME DETECTED ---
                        if (data.type === 'creation' && data.creation && data.creation.type === 'game') {
                            switchMode('game', data.creation);
                            addMessage('TERMAI', 'Started game for you!');
                            return; // Stop processing
                        }
                        
                        // --- DIRECT APP/GAME (Legacy format) ---
                        if (data.app_name && data.files) {
                            switchMode('app', data);
                            return; // Stop processing
                        }
                        if (data.scene && data.options) {
                            switchMode('game', data);
                            return; // Stop processing
                        }
                        
                        // --- TUNNEL DETECTED ---
                        if (data.sender && data.data) {
                            acceptTunnel(data);
                            return; // Stop processing
                        }
                        
                        // --- VIDEO SIGNAL ---
                        if (data.type === 'webrtc') {
                            handleWebRTC(data);
                            return; // Stop processing
                        }
                        
                        // --- NAVIGATION ---
                        if (data.type === 'navigation') {
                            switchRoom(data.room);
                            addMessage('TERMOS', data.msg);
                            return; // Stop processing
                        }
                        
                        // --- ADMIN RESPONSE ---
                        if (data.type === 'admin') {
                            addMessage('ADMIN', data.msg);
                            addAdminLog(data.msg);
                            return; // Stop processing
                        }
                        
                        // --- REGULAR CHAT MESSAGES ---
                        if (data.user && data.text) {
                            addMessage(data.user, data.text);
                            return; // Stop processing
                        }
                        if (data.id && data.msg) {
                            addMessage(data.id, data.msg);
                            return; // Stop processing
                        }
                        
                        // --- AI FUNCTION CALLS ---
                        if (data.action) {
                            handleAIAction(data);
                            return; // Stop processing
                        }
                        
                    } catch (e) {
                        // It's text, not JSON. Continue to text chat logic.
                    }
                    
                    // --- TEXT CHAT LOGIC (XSS Protected) ---
                    const chatBody = document.getElementById('terminal-body');
                    if (chatBody) {
                        const msgDiv = document.createElement('div');
                        msgDiv.style.marginBottom = '5px';
                        msgDiv.style.color = 'var(--term-color)';
                        msgDiv.textContent = payload; // SECURE - prevents XSS
                        chatBody.appendChild(msgDiv);
                        chatBody.scrollTop = chatBody.scrollHeight;
                        console.log('[DIAG] ðŸ’¬ Added message to terminal:', payload.substring(0, 50));
                    }
                };
                
                // Initiate connection
                console.log('Attempting MQTT connection to broker.emqx.io:8084 with SSL');
                mqttClient.connect(connectOptions);
            } catch(e) {
                console.error('MQTT Setup Error:', e);
                addMessage('ERROR', 'MQTT Setup Error: ' + e.message);
                addMessage('SYSTEM', 'This might be a browser compatibility issue. Try Chrome/Firefox.');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            const text = input.value.trim();
            if (text && mqttClient && mqttClient.isConnected()) {
                // Check for special commands
                if (text === '/share') {
                    shareRoom();
                    input.value = '';
                    return;
                } else if (text === '/stats') {
                    showStats();
                    input.value = '';
                    return;
                } else if (text === '/avatar') {
                    showAvatarMenu();
                    input.value = '';
                    return;
                } else if (text === '/mute') {
                    speechSynthesis.cancel();
                    addMessage('SYSTEM', 'Voice synthesis muted');
                    input.value = '';
                    return;
                } else if (text === '/speak') {
                    addMessage('SYSTEM', 'Voice synthesis enabled');
                    input.value = '';
                    return;
                } else if (text === '/voice') {
                    startVoiceInput();
                    input.value = '';
                    return;
                } else if (text.toLowerCase().includes('create app') || text.toLowerCase().includes('make app')) {
                    // Will trigger AI to create app and award XP
                } else if (text.toLowerCase().includes('start game') || text.toLowerCase().includes('play game')) {
                    // Will trigger AI to create game and award XP
                } else if (text.toLowerCase().includes('play music') || text.toLowerCase().includes('play radio')) {
                    // Will trigger AI function calling for music
                } else if (text.startsWith('![') && text.includes(']')) {
                    // Image generation request
                    addMessage(username, text);
                } else if (text === '/video') {
                    switchMode('video');
                    input.value = '';
                    return;
                } else if (text === '/admin') {
                    switchMode('admin');
                    input.value = '';
                    return;
                } else if (text === '/chat') {
                    switchMode('chat');
                    input.value = '';
                    return;
                } else if (text.includes('@admin') || text.includes('admin status') || text.includes('admin')) {
                    // Handle admin commands in main chat
                    mqttClient.publish('termchat/admin', text);
                    addMessage('SYSTEM', `Admin command sent: ${text}`);
                    input.value = '';
                    return;
                }
                
                const msg = { 
                    id: username, 
                    msg: text,
                    timestamp: Date.now()
                };
                
                const publishTopic = roomId ? `termchat/room/${roomId}` : 'termchat/messages';
                mqttClient.publish(publishTopic, JSON.stringify({user: username, text: text}));
                mqttClient.publish('termchat/input', JSON.stringify(msg));
                input.value = '';
                input.focus();
            } else {
                addMessage('ERROR', 'Not connected to multiverse. Please wait for connection...');
            }
        }

        function addMessage(user, text) {
            const terminal = document.getElementById('terminal-body');
            if (!terminal) return;
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            
            // Color coding
            if (user === 'SYSTEM') div.style.color = '#00ff00';
            else if (user === 'ERROR') div.style.color = '#ff0000';
            else if (user === 'ACHIEVEMENT') div.style.color = '#ffff00';
            else if (user === 'XP') div.style.color = '#00ffff';
            else if (user === 'TERMAI') {
                div.style.color = '#00ff41';
                // Auto-speak TERMAI responses
                const lang = text.includes('Ä…') || text.includes('Ä—') || text.includes('Ä¯') ? 'lt-LT' : 'en-US';
                setTimeout(() => speakText(text, lang), 500);
            }
            else if (user === 'TERMOS') div.style.color = '#ffff00';
            else div.style.color = 'var(--term-color)';
            
            // Process image markdown
            const processedText = processImageMarkdown(text);
            
            // Add avatar for regular users
            let displayText;
            if (user !== 'SYSTEM' && user !== 'ERROR' && user !== 'ACHIEVEMENT' && user !== 'XP') {
                const avatar = AVATARS[userStats.avatar] || AVATARS['default'];
                displayText = `${avatar}[${user}] ${processedText}`;
            } else {
                displayText = `[${user}] ${processedText}`;
            }
            
            div.textContent = displayText;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
            
            // Save to persistent storage (except system messages)
            if (user !== 'SYSTEM' && user !== 'ERROR') {
                saveMessageToLocal(user, processedText);
            }
            
            // Award XP for various activities
            if (user === username) {
                addXP(1, 'Sending message');
            }
        }

        // --- VOICE TO VOICE (DUPLEX) ---
        let isListening = false;
        let recognition = null;
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
                addMessage('VOICE', `Heard: "${transcript}"`);
                // Auto-send voice input
                setTimeout(() => sendMessage(), 500);
            };
            
            recognition.onerror = function(event) {
                addMessage('ERROR', `Voice recognition error: ${event.error}`);
                isListening = false;
                updateVoiceIndicator();
            };
            
            recognition.onend = function() {
                isListening = false;
                updateVoiceIndicator();
            };
        }
        
        function startVoiceInput() {
            if (recognition && !isListening) {
                isListening = true;
                recognition.start();
                updateVoiceIndicator();
                addMessage('SYSTEM', 'Listening... Speak now!');
            }
        }
        
        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                updateVoiceIndicator();
            }
        }
        
        function updateVoiceIndicator() {
            const indicator = document.getElementById('voice-indicator');
            if (isListening) {
                indicator.textContent = 'ðŸŽ¤ Listening...';
                indicator.classList.add('active');
            } else {
                indicator.textContent = 'ðŸ”Š Speaking...';
                indicator.classList.remove('active');
            }
        }
        
        // Voice Synthesis API
        function speakText(text, lang = 'en-US') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
                return true;
            }
            return false;
        }
        
        // Image Generation Support
        function processImageMarkdown(text) {
            const imageRegex = /!\[([^\]]+)\]/g;
            return text.replace(imageRegex, (match, description) => {
                const imageId = 'img_' + Math.random().toString(36).substr(2, 9);
                // Request image generation from backend
                if (mqttClient) {
                    const imageRequest = {
                        id: username,
                        msg: `generate image: ${description}`,
                        type: 'image_request',
                        timestamp: Date.now()
                    };
                    mqttClient.publish('termchat/input', JSON.stringify(imageRequest));
                }
                return `[ðŸŽ¨ Generating image: ${description}...]`;
            });
        }
        // --- VIRAL GROWTH FEATURES ---
        function shareRoom() {
            const roomCode = Math.random().toString(36).substr(2, 8).toUpperCase();
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                addMessage('SYSTEM', `ðŸ”— Room link copied! Share: ${shareUrl}`);
                addXP(25, 'Creating shareable room');
            }).catch(() => {
                addMessage('SYSTEM', `ðŸ”— Share this room: ${shareUrl}`);
            });
            
            // Switch to the new room
            roomId = roomCode;
            if (mqttClient) {
                mqttClient.subscribe(`termchat/room/${roomId}`);
            }
        }
        
        function showStats() {
            const levelTitle = LEVEL_TITLES[userStats.level - 1] || 'Unknown';
            const nextLevelXP = LEVEL_THRESHOLDS[userStats.level] || 'MAX';
            
            addMessage('STATS', `ðŸ† Your Stats:`);
            addMessage('STATS', `Level: ${userStats.level} (${levelTitle})`);
            addMessage('STATS', `XP: ${userStats.xp}/${nextLevelXP}`);
            addMessage('STATS', `Lines of Code: ${userStats.linesOfCode}`);
            addMessage('STATS', `Quests Completed: ${userStats.questsCompleted}`);
            addMessage('STATS', `Avatar: ${userStats.avatar}`);
        }
        
        function showAvatarMenu() {
            addMessage('AVATAR', 'ðŸŽ­ Available Avatars:');
            Object.keys(AVATARS).forEach(key => {
                const unlocked = (key === 'default') || 
                                (key === 'hacker' && userStats.level >= 3) ||
                                (key === 'wizard' && userStats.level >= 5) ||
                                (key === 'ninja' && userStats.level >= 8) ||
                                (key === 'admin' && userStats.level >= 10);
                
                const status = unlocked ? 'âœ…' : 'ðŸ”’';
                addMessage('AVATAR', `${status} ${key} ${unlocked ? '(type /use ' + key + ')' : '(unlock at level ' + getUnlockLevel(key) + ')'}`);
            });
        }
        
        function getUnlockLevel(avatar) {
            const levels = {'default': 1, 'hacker': 3, 'wizard': 5, 'ninja': 8, 'admin': 10};
            return levels[avatar] || 1;
        }
        function handleAIAction(action) {
            if (action.action === 'play_music') {
                playMusic(action.url, action.title);
                addXP(15, 'Playing music');
            } else if (action.action === 'open_panel') {
                switchMode(action.panel, action.data);
                addXP(10, 'Opening panel');
            } else if (action.action === 'memory_stored') {
                addMessage('SYSTEM', action.message);
                addXP(5, 'Storing memory');
            }
        }
        
        function playMusic(url, title) {
            // Create or update audio element
            let audio = document.getElementById('background-audio');
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = 'background-audio';
                audio.controls = true;
                audio.style.cssText = 'position:fixed; bottom:10px; right:10px; z-index:1001;';
                document.body.appendChild(audio);
            }
            
            audio.src = url;
            audio.play().then(() => {
                addMessage('SYSTEM', `ðŸŽµ Now playing: ${title}`);
            }).catch(err => {
                addMessage('ERROR', `Failed to play music: ${err.message}`);
            });
        }
        
        function acceptTunnel(data) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); display: flex;
                justify-content: center; align-items: center; z-index: 2000;
            `;
            modal.innerHTML = `
                <div style="background: var(--bg-color); border: 2px solid var(--term-color); padding: 20px; text-align: center;">
                    <h3>TUNNEL REQUEST</h3>
                    <p>User ${data.sender} wants to connect</p>
                    <div style="margin-top: 20px;">
                        <button onclick="acceptTunnelConnection('${data.sender}'); this.parentElement.parentElement.parentElement.remove();">ACCEPT</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();">DECLINE</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function acceptTunnelConnection(sender) {
            addMessage('SYSTEM', `Tunnel established with ${sender}`);
            // Additional tunnel logic here
        }

        // --- WEBRTC HANDLER ---
        function handleWebRTC(data) {
            if (data.action === 'offer') {
                addMessage('SYSTEM', `Video call from ${data.sender}`);
                switchMode('video');
            } else if (data.action === 'answer') {
                addMessage('SYSTEM', 'Video call answered');
            } else if (data.action === 'ice-candidate') {
                // Handle ICE candidate
                console.log('ICE candidate received:', data);
            }
        }
        function switchRoom(room) {
            currentRoom = room;
            const themes = {
                'living_room': 'theme-living',
                'library': 'theme-library', 
                'studio': 'theme-studio',
                'workshop': 'theme-workshop',
                'think_tank': 'theme-think',
                'lounge': 'theme-lounge'
            };
            
            // Update theme
            document.body.className = themes[room] || 'theme-living';
            
            // Update header
            const roomNames = {
                'living_room': 'LIVING ROOM',
                'library': 'LIBRARY',
                'studio': 'STUDIO', 
                'workshop': 'WORKSHOP',
                'think_tank': 'THINK TANK',
                'lounge': 'LOUNGE'
            };
            
            document.getElementById('room-header').innerHTML = 
                `TERMCHAT LT - ${roomNames[room] || 'UNKNOWN'}<span class="cursor"></span>`;
        }
    </script>
    <script>
/**********************************
*********************************************                          * Copyright (c) 2013, 2014 IBM Cor
p.                                  *
 * All rights reserved. This progra
m and the accompanying materials    * are made available under the ter
ms of the Eclipse Public License v1.0                                  * and Eclipse Distribution License
 v1.0 which accompany this distribution.                               *
 * The Eclipse Public License is av
ailable at                          *    http://www.eclipse.org/legal/
epl-v10.html                        * and the Eclipse Distribution Lic
ense is available at                *   http://www.eclipse.org/org/doc
uments/edl-v10.php.                 *
 **********************************
*********************************************/                        
"undefined"===typeof Paho&&(Paho={}
);                                 Paho.MQTT=function(u){function y(a,
b,c){b[c++]=a>>8;b[c++]=a%256;return c}function r(a,b,c,h){h=y(b,c,h);F(a,c,h);return h+b}function m(a){for(var b=0,c=0;c<a.length;c++){var h=a.charCodeAt(c);2047<h?(55296<=h&&56319>=h&&(c++,b++),b+=3):127<h?b+=2:b++}return b}function F(a,b,c){for(var h=0;h<a.length;h++){var e=a.charCodeAt(h);if(55296<=e&&56319>=e){var d=a.charCodeAt(++h);if(isNaN(d))throw Error(f(g.MALFORMED_UNICODE,[e,d]));e=(e-55296<<10)+(d-56320)+65536}127>=e?b[c++]=e:(2047>=e?b[c++]=e>>6&31|                       192:(65535>=e?b[c++]=e>>12&15|224:(
b[c++]=e>>18&7|240,b[c++]=e>>12&63|128),b[c++]=e>>6&63|128),b[c++]=e&63|128)}return b}function G(a,b,c){for(var h="",e,d=b;d<b+c;){e=a[d++];if(!(128>e)){var p=a[d++]-128;if(0>p)throw Error(f(g.MALFORMED_UTF,[e.toString(16),p.toString(16),""]));if(224>e)e=64*(e-192)+p;else{var t=a[d++]-128;if(0>t)throw Error(f(g.MALFORMED_UTF,[e.toString(16),p.toString(16),t.toString(16)]));if(240>e)e=4096*(e-224)+64*p+t;else{var l=a[d++]-128;if(0>l)throw Error(f(g.MALFORMED_UTF,                        [e.toString(16),p.toString(16),t.toString(16),l.toString(16)]));if(248>e)e=262144*(e-240)+4096*p+64*t+l;else throw Error(f(g.MALFORMED_UTF,[e.toString(16),p.toString(16),t.toString(16),l.toString(16)]));}}}65535<e&&(e-=65536,h+=String.fromCharCode(55296+(e>>10)),e=56320+(e&1023));h+=String.fromCharCode(e)}return h}var A=function(a,b){for(var c in a)if(a.hasOwnProperty(c))if(b.hasOwnProperty(c)){if(typeof a[c]!==b[c])throw Error(f(g.INVALID_TYPE,[typeof a[c],c]));}else{var h="Unknown property, "+c+                       ". Valid properties are:";for(c in 
b)b.hasOwnProperty(c)&&(h=h+" "+c);throw Error(h);}},q=function(a,b){return function(){return a.apply(b,arguments)}},g={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},                    CONNACK_RETURNCODE:{code:6,text:"AM
QJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},              UNSUPPORTED_OPERATION:{code:14,text
:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}},J={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",                     4:"Connection Refused: bad user nam
e or password",5:"Connection Refused: not authorized"},f=function(a,b){var c=a.text;if(b)for(var h,e,d=0;d<b.length;d++)if(h="{"+d+"}",e=c.indexOf(h),0<e)var g=c.substring(0,e),c=c.substring(e+h.length),c=g+b[d]+c;return c},B=[0,6,77,81,73,115,100,112,3],C=[0,4,77,81,84,84,4],n=function(a,b){this.type=a;for(var c in b)b.hasOwnProperty(c)&&(this[c]=b[c])};n.prototype.encode=function(){var a=(this.type&15)<<4,b=0,c=[],h=0;void 0!=this.messageIdentifier&&(b+=2);switch(this.type){case 1:switch(this.mqttVersion){case 3:b+=  B.length+3;break;case 4:b+=C.length
+3}b+=m(this.clientId)+2;if(void 0!=this.willMessage){var b=b+(m(this.willMessage.destinationName)+2),e=this.willMessage.payloadBytes;e instanceof Uint8Array||(e=new Uint8Array(g));b+=e.byteLength+2}void 0!=this.userName&&(b+=m(this.userName)+2);void 0!=this.password&&(b+=m(this.password)+2);break;case 8:for(var a=a|2,d=0;d<this.topics.length;d++)c[d]=m(this.topics[d]),b+=c[d]+2;b+=this.requestedQos.length;break;case 10:a|=2;for(d=0;d<this.topics.length;d++)c[d]=                       m(this.topics[d]),b+=c[d]+2;break;c
ase 6:a|=2;break;case 3:this.payloadMessage.duplicate&&(a|=8);a=a|=this.payloadMessage.qos<<1;this.payloadMessage.retained&&(a|=1);var h=m(this.payloadMessage.destinationName),g=this.payloadMessage.payloadBytes,b=b+(h+2)+g.byteLength;g instanceof ArrayBuffer?g=new Uint8Array(g):g instanceof Uint8Array||(g=new Uint8Array(g.buffer))}var f=b,d=Array(1),l=0;do{var z=f%128,f=f>>7;0<f&&(z|=128);d[l++]=z}while(0<f&&4>l);f=d.length+1;b=new ArrayBuffer(b+f);l=new Uint8Array(b);                 l[0]=a;l.set(d,1);if(3==this.type)f
=r(this.payloadMessage.destinationName,h,l,f);else if(1==this.type){switch(this.mqttVersion){case 3:l.set(B,f);f+=B.length;break;case 4:l.set(C,f),f+=C.length}a=0;this.cleanSession&&(a=2);void 0!=this.willMessage&&(a=a|4|this.willMessage.qos<<3,this.willMessage.retained&&(a|=32));void 0!=this.userName&&(a|=128);void 0!=this.password&&(a|=64);l[f++]=a;f=y(this.keepAliveInterval,l,f)}void 0!=this.messageIdentifier&&(f=y(this.messageIdentifier,l,f));switch(this.type){case 1:f=            r(this.clientId,m(this.clientId),l,
f);void 0!=this.willMessage&&(f=r(this.willMessage.destinationName,m(this.willMessage.destinationName),l,f),f=y(e.byteLength,l,f),l.set(e,f),f+=e.byteLength);void 0!=this.userName&&(f=r(this.userName,m(this.userName),l,f));void 0!=this.password&&r(this.password,m(this.password),l,f);break;case 3:l.set(g,f);break;case 8:for(d=0;d<this.topics.length;d++)f=r(this.topics[d],c[d],l,f),l[f++]=this.requestedQos[d];break;case 10:for(d=0;d<this.topics.length;d++)f=r(this.topics[d],             c[d],l,f)}return b};var H=function(
a,b,c,f,e){this._client=a;this._window=b;this._keepAliveInterval=1E3*c;this.isReset=!1;var h=(new n(12)).encode(),e=function(a){return function(){return d.apply(a)}},d=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(h),this.timeout=this._window.setTimeout(e(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(g.PING_TIMEOUT.code,f(g.PING_TIMEOUT)))};                this.reset=function(){this.isReset=
!0;this._window.clearTimeout(this.timeout);0<this._keepAliveInterval&&(this.timeout=setTimeout(e(this),this._keepAliveInterval))};this.cancel=function(){this._window.clearTimeout(this.timeout)}},D=function(a,b,c,h,e){this._window=b;c||(c=30);this.timeout=setTimeout(function(a,b,c){return function(){return a.apply(b,c)}}(f,a,e),1E3*c);this.cancel=function(){this._window.clearTimeout(this.timeout)}},k=function(a,b,c,h,e){if(!("WebSocket"in u&&null!==u.WebSocket))throw Error(f(g.UNSUPPORTED,                                ["WebSocket"]));if(!("localStorage"
in u&&null!==u.localStorage))throw Error(f(g.UNSUPPORTED,["localStorage"]));if(!("ArrayBuffer"in u&&null!==u.ArrayBuffer))throw Error(f(g.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.MQTT.Client",a,b,c,h,e);this.host=b;this.port=c;this.path=h;this.uri=a;this.clientId=e;this._localKey=b+":"+c+("/mqtt"!=h?":"+h:"")+":"+e+":";this._msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(var d in localStorage)0!=                                d.indexOf("Sent:"+this._localKey)&&
0!=d.indexOf("Received:"+this._localKey)||this.restore(d)};k.prototype.host;k.prototype.port;k.prototype.path;k.prototype.uri;k.prototype.clientId;k.prototype.socket;k.prototype.connected=!1;k.prototype.maxMessageIdentifier=65536;k.prototype.connectOptions;k.prototype.hostIndex;k.prototype.onConnectionLost;k.prototype.onMessageDelivered;k.prototype.onMessageArrived;k.prototype.traceFunction;k.prototype._msg_queue=null;k.prototype._connectTimeout;k.prototype.sendPinger=                 null;k.prototype.receivePinger=null
;k.prototype.receiveBuffer=null;k.prototype._traceBuffer=null;k.prototype._MAX_TRACE_ENTRIES=100;k.prototype.connect=function(a){var b=this._traceMask(a,"password");this._trace("Client.connect",b,this.socket,this.connected);if(this.connected)throw Error(f(g.INVALID_STATE,["already connected"]));if(this.socket)throw Error(f(g.INVALID_STATE,["already connected"]));this.connectOptions=a;a.uris?(this.hostIndex=0,this._doConnect(a.uris[0])):this._doConnect(this.uri)};                       k.prototype.subscribe=function(a,b)
{this._trace("Client.subscribe",a,b);if(!this.connected)throw Error(f(g.INVALID_STATE,["not connected"]));var c=new n(8);c.topics=[a];c.requestedQos=void 0!=b.qos?[b.qos]:[0];b.onSuccess&&(c.onSuccess=function(a){b.onSuccess({invocationContext:b.invocationContext,grantedQos:a})});b.onFailure&&(c.onFailure=function(a){b.onFailure({invocationContext:b.invocationContext,errorCode:a})});b.timeout&&(c.timeOut=new D(this,window,b.timeout,b.onFailure,[{invocationContext:b.invocationContext,  errorCode:g.SUBSCRIBE_TIMEOUT.code,
errorMessage:f(g.SUBSCRIBE_TIMEOUT)}]));this._requires_ack(c);this._schedule_message(c)};k.prototype.unsubscribe=function(a,b){this._trace("Client.unsubscribe",a,b);if(!this.connected)throw Error(f(g.INVALID_STATE,["not connected"]));var c=new n(10);c.topics=[a];b.onSuccess&&(c.callback=function(){b.onSuccess({invocationContext:b.invocationContext})});b.timeout&&(c.timeOut=new D(this,window,b.timeout,b.onFailure,[{invocationContext:b.invocationContext,errorCode:g.UNSUBSCRIBE_TIMEOUT.code,                                errorMessage:f(g.UNSUBSCRIBE_TIMEOU
T)}]));this._requires_ack(c);this._schedule_message(c)};k.prototype.send=function(a){this._trace("Client.send",a);if(!this.connected)throw Error(f(g.INVALID_STATE,["not connected"]));wireMessage=new n(3);wireMessage.payloadMessage=a;0<a.qos?this._requires_ack(wireMessage):this.onMessageDelivered&&(this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage));this._schedule_message(wireMessage)};k.prototype.disconnect=function(){this._trace("Client.disconnect");                                  if(!this.socket)throw Error(f(g.INV
ALID_STATE,["not connecting or connected"]));wireMessage=new n(14);this._notify_msg_sent[wireMessage]=q(this._disconnected,this);this._schedule_message(wireMessage)};k.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date);this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var a in this._sentMessages)this._trace("_sentMessages ",a,this._sentMessages[a]);for(a in this._receivedMessages)this._trace("_receivedMessages ",                      a,this._receivedMessages[a]);return
 this._traceBuffer}};k.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]);this._trace("Client.startTrace",new Date,"@VERSION@")};k.prototype.stopTrace=function(){delete this._traceBuffer};k.prototype._doConnect=function(a){this.connectOptions.useSSL&&(a=a.split(":"),a[0]="wss",a=a.join(":"));this.connected=!1;this.socket=4>this.connectOptions.mqttVersion?new WebSocket(a,["mqttv3.1"]):new WebSocket(a,["mqtt"]);this.socket.binaryType=                        "arraybuffer";this.socket.onopen=q(
this._on_socket_open,this);this.socket.onmessage=q(this._on_socket_message,this);this.socket.onerror=q(this._on_socket_error,this);this.socket.onclose=q(this._on_socket_close,this);this.sendPinger=new H(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new H(this,window,this.connectOptions.keepAliveInterval);this._connectTimeout=new D(this,window,this.connectOptions.timeout,this._disconnected,[g.CONNECT_TIMEOUT.code,f(g.CONNECT_TIMEOUT)])};k.prototype._schedule_message=                               function(a){this._msg_queue.push(a)
;this.connected&&this._process_queue()};k.prototype.store=function(a,b){var c={type:b.type,messageIdentifier:b.messageIdentifier,version:1};switch(b.type){case 3:b.pubRecReceived&&(c.pubRecReceived=!0);c.payloadMessage={};for(var h="",e=b.payloadMessage.payloadBytes,d=0;d<e.length;d++)h=15>=e[d]?h+"0"+e[d].toString(16):h+e[d].toString(16);c.payloadMessage.payloadHex=h;c.payloadMessage.qos=b.payloadMessage.qos;c.payloadMessage.destinationName=b.payloadMessage.destinationName;           b.payloadMessage.duplicate&&(c.payl
oadMessage.duplicate=!0);b.payloadMessage.retained&&(c.payloadMessage.retained=!0);0==a.indexOf("Sent:")&&(void 0===b.sequence&&(b.sequence=++this._sequence),c.sequence=b.sequence);break;default:throw Error(f(g.INVALID_STORED_DATA,[key,c]));}localStorage.setItem(a+this._localKey+b.messageIdentifier,JSON.stringify(c))};k.prototype.restore=function(a){var b=localStorage.getItem(a),c=JSON.parse(b),h=new n(c.type,c);switch(c.type){case 3:for(var b=c.payloadMessage.payloadHex,              e=new ArrayBuffer(b.length/2),e=new
 Uint8Array(e),d=0;2<=b.length;){var k=parseInt(b.substring(0,2),16),b=b.substring(2,b.length);e[d++]=k}b=new Paho.MQTT.Message(e);b.qos=c.payloadMessage.qos;b.destinationName=c.payloadMessage.destinationName;c.payloadMessage.duplicate&&(b.duplicate=!0);c.payloadMessage.retained&&(b.retained=!0);h.payloadMessage=b;break;default:throw Error(f(g.INVALID_STORED_DATA,[a,b]));}0==a.indexOf("Sent:"+this._localKey)?(h.payloadMessage.duplicate=!0,this._sentMessages[h.messageIdentifier]=       h):0==a.indexOf("Received:"+this._l
ocalKey)&&(this._receivedMessages[h.messageIdentifier]=h)};k.prototype._process_queue=function(){for(var a=null,b=this._msg_queue.reverse();a=b.pop();)this._socket_send(a),this._notify_msg_sent[a]&&(this._notify_msg_sent[a](),delete this._notify_msg_sent[a])};k.prototype._requires_ack=function(a){var b=Object.keys(this._sentMessages).length;if(b>this.maxMessageIdentifier)throw Error("Too many messages:"+b);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;                            a.messageIdentifier=this._message_i
dentifier;this._sentMessages[a.messageIdentifier]=a;3===a.type&&this.store("Sent:",a);this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)};k.prototype._on_socket_open=function(){var a=new n(1,this.connectOptions);a.clientId=this.clientId;this._socket_send(a)};k.prototype._on_socket_message=function(a){this._trace("Client._on_socket_message",a.data);this.receivePinger.reset();a=this._deframeMessages(a.data);for(var b=0;b<a.length;b+=                       1)this._handleMessage(a[b])};k.prot
otype._deframeMessages=function(a){a=new Uint8Array(a);if(this.receiveBuffer){var b=new Uint8Array(this.receiveBuffer.length+a.length);b.set(this.receiveBuffer);b.set(a,this.receiveBuffer.length);a=b;delete this.receiveBuffer}try{for(var b=0,c=[];b<a.length;){var h;a:{var e=a,d=b,k=d,t=e[d],l=t>>4,z=t&15,d=d+1,v=void 0,E=0,m=1;do{if(d==e.length){h=[null,k];break a}v=e[d++];E+=(v&127)*m;m*=128}while(0!=(v&128));v=d+E;if(v>e.length)h=[null,k];else{var w=new n(l);switch(l){case 2:e[d++]& 1&&(w.sessionPresent=!0);w.returnCo
de=e[d++];break;case 3:var k=z>>1&3,r=256*e[d]+e[d+1],d=d+2,u=G(e,d,r),d=d+r;0<k&&(w.messageIdentifier=256*e[d]+e[d+1],d+=2);var q=new Paho.MQTT.Message(e.subarray(d,v));1==(z&1)&&(q.retained=!0);8==(z&8)&&(q.duplicate=!0);q.qos=k;q.destinationName=u;w.payloadMessage=q;break;case 4:case 5:case 6:case 7:case 11:w.messageIdentifier=256*e[d]+e[d+1];break;case 9:w.messageIdentifier=256*e[d]+e[d+1],d+=2,w.returnCode=e.subarray(d,v)}h=[w,v]}}var x=h[0],b=h[1];if(null!==                      x)c.push(x);else break}b<a.length&&
(this.receiveBuffer=a.subarray(b))}catch(y){this._disconnected(g.INTERNAL_ERROR.code,f(g.INTERNAL_ERROR,[y.message,y.stack.toString()]));return}return c};k.prototype._handleMessage=function(a){this._trace("Client._handleMessage",a);try{switch(a.type){case 2:this._connectTimeout.cancel();if(this.connectOptions.cleanSession){for(var b in this._sentMessages){var c=this._sentMessages[b];localStorage.removeItem("Sent:"+this._localKey+c.messageIdentifier)}this._sentMessages=                 {};for(b in this._receivedMessages)
{var h=this._receivedMessages[b];localStorage.removeItem("Received:"+this._localKey+h.messageIdentifier)}this._receivedMessages={}}if(0===a.returnCode)this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);else{this._disconnected(g.CONNACK_RETURNCODE.code,f(g.CONNACK_RETURNCODE,[a.returnCode,J[a.returnCode]]));break}a=[];for(var e in this._sentMessages)this._sentMessages.hasOwnProperty(e)&&a.push(this._sentMessages[e]);a=a.sort(function(a,         b){return a.sequence-b.sequence});e
=0;for(var d=a.length;e<d;e++)if(c=a[e],3==c.type&&c.pubRecReceived){var k=new n(6,{messageIdentifier:c.messageIdentifier});this._schedule_message(k)}else this._schedule_message(c);if(this.connectOptions.onSuccess)this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext});this._process_queue();break;case 3:this._receivePublish(a);break;case 4:if(c=this._sentMessages[a.messageIdentifier])if(delete this._sentMessages[a.messageIdentifier],                    localStorage.removeItem("Sent:"+thi
s._localKey+a.messageIdentifier),this.onMessageDelivered)this.onMessageDelivered(c.payloadMessage);break;case 5:if(c=this._sentMessages[a.messageIdentifier])c.pubRecReceived=!0,k=new n(6,{messageIdentifier:a.messageIdentifier}),this.store("Sent:",c),this._schedule_message(k);break;case 6:h=this._receivedMessages[a.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+a.messageIdentifier);h&&(this._receiveMessage(h),delete this._receivedMessages[a.messageIdentifier]);   var m=new n(7,{messageIdentifier:a.
messageIdentifier});this._schedule_message(m);break;case 7:c=this._sentMessages[a.messageIdentifier];delete this._sentMessages[a.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+a.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(c.payloadMessage);break;case 9:if(c=this._sentMessages[a.messageIdentifier]){c.timeOut&&c.timeOut.cancel();a.returnCode.indexOf=Array.prototype.indexOf;if(-1!==a.returnCode.indexOf(128)){if(c.onFailure)c.onFailure(a.returnCode)}else if(c.onSuccess)c.onSuccess(c.returnCode);                   delete this._sentMessages[a.message
Identifier]}break;case 11:if(c=this._sentMessages[a.messageIdentifier])c.timeOut&&c.timeOut.cancel(),c.callback&&c.callback(),delete this._sentMessages[a.messageIdentifier];break;case 13:this.sendPinger.reset();break;case 14:this._disconnected(g.INVALID_MQTT_MESSAGE_TYPE.code,f(g.INVALID_MQTT_MESSAGE_TYPE,[a.type]));break;default:this._disconnected(g.INVALID_MQTT_MESSAGE_TYPE.code,f(g.INVALID_MQTT_MESSAGE_TYPE,[a.type]))}}catch(l){this._disconnected(g.INTERNAL_ERROR.code,              f(g.INTERNAL_ERROR,[l.message,l.sta
ck.toString()]))}};k.prototype._on_socket_error=function(a){this._disconnected(g.SOCKET_ERROR.code,f(g.SOCKET_ERROR,[a.data]))};k.prototype._on_socket_close=function(){this._disconnected(g.SOCKET_CLOSE.code,f(g.SOCKET_CLOSE))};k.prototype._socket_send=function(a){if(1==a.type){var b=this._traceMask(a,"password");this._trace("Client._socket_send",b)}else this._trace("Client._socket_send",a);this.socket.send(a.encode());this.sendPinger.reset()};k.prototype._receivePublish=               function(a){switch(a.payloadMessage
.qos){case "undefined":case 0:this._receiveMessage(a);break;case 1:var b=new n(4,{messageIdentifier:a.messageIdentifier});this._schedule_message(b);this._receiveMessage(a);break;case 2:this._receivedMessages[a.messageIdentifier]=a;this.store("Received:",a);a=new n(5,{messageIdentifier:a.messageIdentifier});this._schedule_message(a);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos);}};k.prototype._receiveMessage=function(a){if(this.onMessageArrived)this.onMessageArrived(a.payloadMessage)};        k.prototype._disconnected=function(
a,b){this._trace("Client._disconnected",a,b);this.sendPinger.cancel();this.receivePinger.cancel();this._connectTimeout&&this._connectTimeout.cancel();this._msg_queue=[];this._notify_msg_sent={};this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket);if(this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1)this.hostIndex++,                  this._doConnect(this.connectOptions.uris[this.hostIndex]);else if(void 0===a&&(a=g.OK.code,b=f(g.OK)),this.connected){if(this.connected=!1,this.onConnectionLost)this.onConnectionLost({errorCode:a,errorMessage:b})}else if(4===this.connectOptions.mqttVersion&&!1===this.connectOptions.mqttVersionExplicit)this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri);                else if(this.connectOptions.onFailure)this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:a,errorMessage:b})};k.prototype._trace=function(){if(this.traceFunction){for(var a in arguments)"undefined"!==typeof arguments[a]&&(arguments[a]=JSON.stringify(arguments[a]));a=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:a})}if(null!==this._traceBuffer){a=0;for(var b=arguments.length;a<b;a++)this._traceBuffer.length==                       this._MAX_TRACE_ENTRIES&&this._trac
eBuffer.shift(),0===a?this._traceBuffer.push(arguments[a]):"undefined"===typeof arguments[a]?this._traceBuffer.push(arguments[a]):this._traceBuffer.push("  "+JSON.stringify(arguments[a]))}};k.prototype._traceMask=function(a,b){var c={},f;for(f in a)a.hasOwnProperty(f)&&(c[f]=f==b?"******":a[f]);return c};var I=function(a,b,c,h){var e;if("string"!==typeof a)throw Error(f(g.INVALID_TYPE,[typeof a,"host"]));if(2==arguments.length){h=b;e=a;var d=e.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);                 if(d)a=d[4]||d[2],b=parseInt(d[7]),
c=d[8];else throw Error(f(g.INVALID_ARGUMENT,[a,"host"]));}else{3==arguments.length&&(h=c,c="/mqtt");if("number"!==typeof b||0>b)throw Error(f(g.INVALID_TYPE,[typeof b,"port"]));if("string"!==typeof c)throw Error(f(g.INVALID_ARGUMENT,[a,"path"]));e="ws://"+(-1!=a.indexOf(":")&&"["!=a.slice(0,1)&&"]"!=a.slice(-1)?"["+a+"]":a)+":"+b+c}for(var p=d=0;p<h.length;p++){var m=h.charCodeAt(p);55296<=m&&56319>=m&&p++;d++}if("string"!==typeof h||65535<d)throw Error(f(g.INVALID_ARGUMENT,       [h,"clientId"]));var l=new k(e,a,b,
c,h);this._getHost=function(){return a};this._setHost=function(){throw Error(f(g.UNSUPPORTED_OPERATION));};this._getPort=function(){return b};this._setPort=function(){throw Error(f(g.UNSUPPORTED_OPERATION));};this._getPath=function(){return c};this._setPath=function(){throw Error(f(g.UNSUPPORTED_OPERATION));};this._getURI=function(){return e};this._setURI=function(){throw Error(f(g.UNSUPPORTED_OPERATION));};this._getClientId=function(){return l.clientId};this._setClientId=             function(){throw Error(f(g.UNSUPPOR
TED_OPERATION));};this._getOnConnectionLost=function(){return l.onConnectionLost};this._setOnConnectionLost=function(a){if("function"===typeof a)l.onConnectionLost=a;else throw Error(f(g.INVALID_TYPE,[typeof a,"onConnectionLost"]));};this._getOnMessageDelivered=function(){return l.onMessageDelivered};this._setOnMessageDelivered=function(a){if("function"===typeof a)l.onMessageDelivered=a;else throw Error(f(g.INVALID_TYPE,[typeof a,"onMessageDelivered"]));};this._getOnMessageArrived=    function(){return l.onMessageArrive
d};this._setOnMessageArrived=function(a){if("function"===typeof a)l.onMessageArrived=a;else throw Error(f(g.INVALID_TYPE,[typeof a,"onMessageArrived"]));};this._getTrace=function(){return l.traceFunction};this._setTrace=function(a){if("function"===typeof a)l.traceFunction=a;else throw Error(f(g.INVALID_TYPE,[typeof a,"onTrace"]));};this.connect=function(a){a=a||{};A(a,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",                 cleanSession:"boolean",useSSL:"bool
ean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",mqttVersion:"number"});void 0===a.keepAliveInterval&&(a.keepAliveInterval=60);if(4<a.mqttVersion||3>a.mqttVersion)throw Error(f(g.INVALID_ARGUMENT,[a.mqttVersion,"connectOptions.mqttVersion"]));void 0===a.mqttVersion?(a.mqttVersionExplicit=!1,a.mqttVersion=4):a.mqttVersionExplicit=!0;if(void 0===a.password&&void 0!==a.userName)throw Error(f(g.INVALID_ARGUMENT,                        [a.password,"connectOptions.passwor
d"]));if(a.willMessage){if(!(a.willMessage instanceof x))throw Error(f(g.INVALID_TYPE,[a.willMessage,"connectOptions.willMessage"]));a.willMessage.stringPayload;if("undefined"===typeof a.willMessage.destinationName)throw Error(f(g.INVALID_TYPE,[typeof a.willMessage.destinationName,"connectOptions.willMessage.destinationName"]));}"undefined"===typeof a.cleanSession&&(a.cleanSession=!0);if(a.hosts){if(!(a.hosts instanceof Array))throw Error(f(g.INVALID_ARGUMENT,[a.hosts,                 "connectOptions.hosts"]));if(1>a.ho
sts.length)throw Error(f(g.INVALID_ARGUMENT,[a.hosts,"connectOptions.hosts"]));for(var b=!1,d=0;d<a.hosts.length;d++){if("string"!==typeof a.hosts[d])throw Error(f(g.INVALID_TYPE,[typeof a.hosts[d],"connectOptions.hosts["+d+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(a.hosts[d]))if(0==d)b=!0;else{if(!b)throw Error(f(g.INVALID_ARGUMENT,[a.hosts[d],"connectOptions.hosts["+d+"]"]));}else if(b)throw Error(f(g.INVALID_ARGUMENT,[a.hosts[d],"connectOptions.hosts["+    d+"]"]));}if(b)a.uris=a.hosts;else{
if(!a.ports)throw Error(f(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));if(!(a.ports instanceof Array))throw Error(f(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));if(a.hosts.length!=a.ports.length)throw Error(f(g.INVALID_ARGUMENT,[a.ports,"connectOptions.ports"]));a.uris=[];for(d=0;d<a.hosts.length;d++){if("number"!==typeof a.ports[d]||0>a.ports[d])throw Error(f(g.INVALID_TYPE,[typeof a.ports[d],"connectOptions.ports["+d+"]"]));var b=a.hosts[d],h=                       a.ports[d];e="ws://"+(-1!=b.indexOf
(":")?"["+b+"]":b)+":"+h+c;a.uris.push(e)}}}l.connect(a)};this.subscribe=function(a,b){if("string"!==typeof a)throw Error("Invalid argument:"+a);b=b||{};A(b,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(b.timeout&&!b.onFailure)throw Error("subscribeOptions.timeout specified with no onFailure callback.");if("undefined"!==typeof b.qos&&0!==b.qos&&1!==b.qos&&2!==b.qos)throw Error(f(g.INVALID_ARGUMENT,[b.qos,                       "subscribeOptions.qos"]));l.subscri
be(a,b)};this.unsubscribe=function(a,b){if("string"!==typeof a)throw Error("Invalid argument:"+a);b=b||{};A(b,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(b.timeout&&!b.onFailure)throw Error("unsubscribeOptions.timeout specified with no onFailure callback.");l.unsubscribe(a,b)};this.send=function(a,b,c,d){var e;if(0==arguments.length)throw Error("Invalid argument.length");if(1==arguments.length){if(!(a instanceof x)&&                      "string"!==typeof a)throw Error("In
valid argument:"+typeof a);e=a;if("undefined"===typeof e.destinationName)throw Error(f(g.INVALID_ARGUMENT,[e.destinationName,"Message.destinationName"]));}else e=new x(b),e.destinationName=a,3<=arguments.length&&(e.qos=c),4<=arguments.length&&(e.retained=d);l.send(e)};this.disconnect=function(){l.disconnect()};this.getTraceLog=function(){return l.getTraceLog()};this.startTrace=function(){l.startTrace()};this.stopTrace=function(){l.stopTrace()};this.isConnected=function(){return l.connected}};                            I.prototype={get host(){return this
._getHost()},set host(a){this._setHost(a)},get port(){return this._getPort()},set port(a){this._setPort(a)},get path(){return this._getPath()},set path(a){this._setPath(a)},get clientId(){return this._getClientId()},set clientId(a){this._setClientId(a)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(a){this._setOnConnectionLost(a)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(a){this._setOnMessageDelivered(a)},  get onMessageArrived(){return this.
_getOnMessageArrived()},set onMessageArrived(a){this._setOnMessageArrived(a)},get trace(){return this._getTrace()},set trace(a){this._setTrace(a)}};var x=function(a){var b;if("string"===typeof a||a instanceof ArrayBuffer||a instanceof Int8Array||a instanceof Uint8Array||a instanceof Int16Array||a instanceof Uint16Array||a instanceof Int32Array||a instanceof Uint32Array||a instanceof Float32Array||a instanceof Float64Array)b=a;else throw f(g.INVALID_ARGUMENT,[a,"newPayload"]);          this._getPayloadString=function(){r
eturn"string"===typeof b?b:G(b,0,b.length)};this._getPayloadBytes=function(){if("string"===typeof b){var a=new ArrayBuffer(m(b)),a=new Uint8Array(a);F(b,a,0);return a}return b};var c=void 0;this._getDestinationName=function(){return c};this._setDestinationName=function(a){if("string"===typeof a)c=a;else throw Error(f(g.INVALID_ARGUMENT,[a,"newDestinationName"]));};var h=0;this._getQos=function(){return h};this._setQos=function(a){if(0===a||1===a||2===a)h=a;else throw Error("Invalid argument:"+                           a);};var e=!1;this._getRetained=fun
ction(){return e};this._setRetained=function(a){if("boolean"===typeof a)e=a;else throw Error(f(g.INVALID_ARGUMENT,[a,"newRetained"]));};var d=!1;this._getDuplicate=function(){return d};this._setDuplicate=function(a){d=a}};x.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(a){this._setDestinationName(a)},get qos(){return this._getQos()},         set qos(a){this._setQos(a)},get ret
ained(){return this._getRetained()},set retained(a){this._setRetained(a)},get duplicate(){return this._getDuplicate()},set duplicate(a){this._setDuplicate(a)}};return{Client:I,Message:x}}(window);
    </script>
</body>
</html>