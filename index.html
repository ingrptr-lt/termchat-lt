<script>
    console.log(">> SYSTEM KERNEL STARTING...");

    // --- 1. CONFIG & STATE ---
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    let GITHUB_TOKEN = localStorage.getItem('termos_github_token') || "";
    let REPO_OWNER = localStorage.getItem('termos_repo_owner') || "your-username";
    let REPO_NAME = localStorage.getItem('termos_repo_name') || "termchat-lt";
    const FILE_PATH = "index.html";
    
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 1000);
    let mqttClient = null;
    let currentRoom = 'global';
    
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];
    let adminMode = false;

    // --- 2. SMART UI DETECTOR (THE FIX) ---
    function getBox() {
        // 1. Try the new Modern ID
        let el = document.getElementById('chat-container');
        
        // 2. If not found, try the v3.0 ID
        if (!el) {
            console.warn("‚ö†Ô∏è 'chat-container' not found. Trying 'main-app'...");
            el = document.getElementById('main-app');
        }
        
        // 3. If not found, try the v1.0 ID
        if (!el) {
            console.warn("‚ö†Ô∏è 'main-app' not found. Trying 'screen'...");
            el = document.getElementById('screen');
        }
        
        // 4. If STILL not found, CREATE ONE dynamically
        if (!el) {
            console.warn("‚ö†Ô∏è No chat container found. Forcing creation...");
            el = document.createElement('div');
            el.id = 'chat-container'; // Force the ID the script expects
            el.className = "flex flex-col h-full w-full p-4 overflow-y-auto z-10";
            document.body.appendChild(el);
            console.log("‚úÖ Dynamic container created.");
        }
        return el;
    }

    // --- 3. SYSTEM REBUILDER ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim();
            if (installedModules.includes(name)) return addSystemMessage(`Module ${name} active.`);
            try {
                switch(name) {
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("Installed: " + name.toUpperCase());
            } catch (e) {
                addSystemMessage("ERROR: " + e.message);
            }
        },
        addSound: function() {
            try {
                let ctx = new (window.AudioContext||window.webkitAudioContext)();
                let old = window.addUserMessage; 
                window.addUserMessage = function(t) {
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.frequency.value = 600; o.start(); o.stop(ctx.currentTime+0.05);
                    old(t);
                };
            } catch(e) { addSystemMessage("Audio init failed."); }
        },
        addNeon: function() {
            document.documentElement.style.setProperty('--msg-user-bg', '#ec4899'); 
            document.documentElement.style.setProperty('--accent-primary', '#ec4899');
        },
        playMusic: function() {
            const audio = document.getElementById('bg-music');
            audio.play().then(() => addSystemMessage("üéµ Stream active.")).catch(e => addSystemMessage("Interaction required first"));
        }
    };

    // --- 4. MATRIX ---
    let isMatrixRunning = false;
    let animationFrameId;

    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if(!canvas) {
            // Try to create canvas if missing
            canvas = document.createElement('canvas');
            canvas.id = 'matrix-canvas';
            canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.15;pointer-events:none;';
            document.body.prepend(canvas);
        }
        
        if(isMatrixRunning) return; 
        isMatrixRunning = true;

        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const fontSize = window.innerWidth < 600 ? 10 : 14; 
        const columns = Math.floor(width / fontSize);
        const drops = Array(columns).fill(1);
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&';
        
        let lastTime = 0;
        const fps = 30;
        const interval = 1000 / fps;

        function draw(time) {
            requestAnimationFrame(draw);
            const delta = time - lastTime;
            if (delta < interval) return;
            lastTime = time - (delta % interval);

            try {
                ctx.fillStyle = 'rgba(2, 6, 23, 0.05)'; 
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = adminMode ? '#ef4444' : '#1e40af'; 
                ctx.font = `${fontSize}px 'Fira Code', monospace`;
                
                for(let i=0; i<drops.length; i++) {
                    const text = letters[Math.floor(Math.random()*letters.length)];
                    ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                    if(drops[i]*fontSize > height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            } catch (e) {
                isMatrixRunning = false; 
            }
        }
        
        requestAnimationFrame(draw);
        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });
    }

    // --- 5. UI HELPERS ---
    function addSystemMessage(txt) {
        try {
            const box = getBox();
            const d = document.createElement('div');
            d.className = "flex justify-center my-4";
            d.innerHTML = `<span class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wider text-gray-400 bg-slate-800/50 border border-white/5 shadow-inner">${txt}</span>`;
            box.appendChild(d);
            scrollDown();
        } catch(e) { console.error("Log Error:", e); }
    }

    function addAIMessage(txt) {
        try {
            const d = document.createElement('div');
            d.className = "flex gap-3 my-4";
            d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-ai shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">AI</span></div><div class="flex-1"><div class="bg-slate-800/80 backdrop-blur-md rounded-2xl rounded-tl-none p-4 border border-white/5 shadow-lg text-gray-200 text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
            getBox().appendChild(d);
            scrollDown();
        } catch(e) { console.error("AI Msg Error:", e); }
    }

    function addUserMessage(txt) {
        try {
            const d = document.createElement('div');
            d.className = "flex flex-row-reverse gap-3 my-4 items-end";
            let avatarHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-user shrink-0 flex items-center justify-center shadow-lg text-xs font-bold text-white">ME</div>`;
            if (userStats.ascii) {
                avatarHTML = `<div class="w-10 h-10 rounded-lg bg-slate-900 border border-blue-500/50 flex items-center justify-center shrink-0 overflow-hidden p-1 shadow-lg shadow-blue-500/20"><div class="ascii-art text-center w-full">${userStats.ascii}</div></div>`;
            }
            d.innerHTML = `${avatarHTML}<div class="flex-1 max-w-[80%]"><div class="bg-blue-600 rounded-2xl rounded-tr-none p-4 shadow-lg shadow-blue-600/20 text-white text-sm leading-relaxed">${escapeHtml(txt)}</div><div class="text-[10px] text-gray-500 text-right mt-1 mr-1 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>`;
            getBox().appendChild(d);
            scrollDown();
        } catch(e) { console.error("User Msg Error:", e); }
    }

    function scrollDown() { 
        const b=getBox(); 
        if(b) b.scrollTop=b.scrollHeight; 
    }

    function escapeHtml(text) { 
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
    }

    // --- 6. AI LOGIC ---
    async function handleAI(prompt) {
        if(!GROQ_API_KEY) return addAIMessage("‚ùå API Key Missing. Type /setkey [key]");
        
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-gray-500 italic animate-pulse">AI is typing...</div>`);
        scrollDown();

        try {
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model:"llama3-8b-8192",
                    messages:[{
                        role:"system",
                        content:"You are TermOS AI. If user asks for visual changes, return: SystemRebuilder.install('name'). If user asks for music, return: CMD: PLAY_MUSIC. Otherwise answer normally."
                    },{role:"user",content:prompt}]
                })
            });
            const reply = (await r.json()).choices[0].message.content;
            const el = document.getElementById(thinkingId);
            if(el) el.remove();
            let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
            if(match) { 
                try { SystemRebuilder.install(match[1]); } catch(e) {}
                addAIMessage("‚ú® System updated."); 
            }
            else if (reply.includes("CMD: PLAY_MUSIC")) {
                const audio = document.getElementById('bg-music');
                if(audio) { audio.play().catch(e => {}); addAIMessage("üéµ Stream active."); }
            }
            else { addAIMessage(reply); }
        } catch(e) { addAIMessage("Connection failed."); }
    }

    // --- 7. GAMIFICATION ---
    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 100)) {
            userStats.level++;
            addSystemMessage(`üéâ LEVEL UP: ${userStats.level} - ${LEVELS[userStats.level] || 'MASTER'}`);
            updateAvatar(userStats.level);
        }
        const lvlEl = document.getElementById('lvl-disp');
        if(lvlEl) lvlEl.innerText = userStats.level;
        const xpEl = document.getElementById('xp-val');
        if(xpEl) xpEl.innerText = userStats.xp;
        localStorage.setItem('termos_stats_modern', JSON.stringify(userStats));
    }

    function updateAvatar(lvl) {
        if(lvl === 3) userStats.ascii = "‚ó¢‚ó§<br>o_o<br>/|\\"; 
        else if (lvl === 5) userStats.ascii = "üïØ<br>  ‚òæ<br>  ‚òΩ"; 
        else if (lvl === 8) userStats.ascii = "üëÅ<br>¬∑ ¬∑<br>__¬∑__"; 
    }

    // --- 8. EVOLUTION ENGINE ---
    function toggleAdminMode() {
        try {
            const panel = document.getElementById('admin-panel');
            if(!panel) {
                // If admin panel doesn't exist in HTML, create it dynamically
                console.log("Creating Admin Panel dynamically...");
                panel = document.createElement('div');
                panel.id = 'admin-panel';
                panel.className = "admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border border-red-500/30 shadow-2xl shadow-red-500/10";
                panel.innerHTML = `<h3 class="text-red-400 font-bold mb-3">ADMIN CONSOLE (DYNAMIC)</h3><p class="text-xs text-red-500">HTML Element was missing. Created dynamically.</p>`;
                document.body.appendChild(panel);
            }
            
            if (panel.classList.contains('admin-hidden')) {
                panel.classList.remove('admin-hidden');
                setTimeout(() => { panel.style.opacity = "1"; }, 10);
            } else {
                panel.style.opacity = "0";
                setTimeout(() => { panel.classList.add('admin-hidden'); }, 300);
            }
        } catch (e) { console.error("Admin Toggle Error:", e); }
    }

    async function initiateEvolution() {
        try {
            if (!GITHUB_TOKEN) return alert("Please enter your GitHub Token first.");
            if (!REPO_OWNER || !REPO_NAME) return alert("Please enter Repo Owner and Name.");
            
            const input = prompt("Enter your mutation request:");
            if (!input) return;

            addSystemMessage("üß¨ INITIATING EVOLUTION SEQUENCE...");
            addSystemMessage("üì° READING DNA FROM GITHUB...");
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s Timeout

            // Read Code
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
            const res = await fetch(url, { 
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                signal: controller.signal 
            });
            
            if (!res.ok) throw new Error("Failed to read repo. Check Token/Permissions.");
            const data = await res.json();
            const repoData = { content: atob(data.content), sha: data.sha };

            // AI Mutation
            const evolutionPrompt = `You are the Architect... Return ONLY the full code.`;
            const aiReq = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}` },
                signal: controller.signal,
                body: JSON.stringify({
                    model: "llama3-70b-8192",
                    messages: [{ role: "system", content: "You are a code generator. Return ONLY raw HTML code." }, { role: "user", content: evolutionPrompt + "\n\nCODE:\n" + repoData.content }]
                })
            });

            const aiData = await aiReq.json();
            let newCode = aiData.choices[0].message.content.replace(/```html/g, "").replace(/```/g, "");

            // Write Back to GitHub
            addSystemMessage("üß¨ MUTATING CODEBASE...");
            const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
            const putBody = {
                message: "Evolution Update: " + input,
                content: btoa(unescape(encodeURIComponent(newCode))),
                sha: repoData.sha,
                branch: "main"
            };

            await fetch(putUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify(putBody)
            });

            clearTimeout(timeoutId);
            addSystemMessage("üéâ EVOLUTION SUCCESS. REBOOTING...");
            setTimeout(() => location.reload(), 2000);

        } catch (err) {
            clearTimeout(timeoutId);
            let errorMsg = err.message;
            if (err.name === 'AbortError') errorMsg = "Connection Timed Out (30s). Try again.";
            addSystemMessage("‚ùå EVOLUTION FAILED: " + errorMsg);
            console.error(err);
        }
    }

    // --- 9. INPUT HANDLER ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim();
            if(!txt) return;

            // ADMIN COMMANDS
            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') {
                    adminMode = true;
                    toggleAdminMode();
                    addSystemMessage("üî¥ ADMIN MODE ENABLED.");
                } else if (cmd === 'disable') {
                    adminMode = false;
                    toggleAdminMode();
                    addSystemMessage("üü¢ ADMIN MODE DISABLED.");
                }
                inp.value = '';
                return;
            }

            // STANDARD COMMANDS
            if(txt.startsWith('/sys install ')) {
                if(SystemRebuilder) {
                    SystemRebuilder.install(txt.split(' ')[2]);
                } else {
                    addSystemMessage("SystemRebuilder module missing.");
                }
            }
            else if(txt.startsWith('/setkey ')) {
                GROQ_API_KEY = txt.substring(8);
                localStorage.setItem('termos_groq_key', GROQ_API_KEY);
                addSystemMessage("Key Encrypted.");
            }
            else if(txt.startsWith('/ai ')) {
                handleAI(txt.substring(4));
            }
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    try {
                        const message = new Paho.MQTT.Message(JSON.stringify({ user: username, text: txt }));
                        message.destinationName = "termos/v3/chat";
                        message.qos = 1;
                        mqttClient.send(message);
                    } catch(e) {
                        console.error("MQTT Send Error:", e);
                    }
                }
            }
            inp.value = '';
        } catch (e) {
            console.error("Input Handler Error:", e);
            alert("Input Error: " + e.message);
        }
    }

    // --- 10. ROBUST CONNECT ---
    function connectMQTT() {
        try {
            const options = {
                timeout: 10, useSSL: true, keepAliveInterval: 60,
                onSuccess: () => {
                    console.log("[MQTT] Connected");
                    addSystemMessage("üü¢ Neural Link Online.");
                    try {
                        mqttClient.subscribe("termos/v3/chat", { qos: 1 });
                    } catch(e) { console.error("Sub Error", e); }
                },
                onFailure: () => { addSystemMessage("üî¥ Connection Failed."); setTimeout(connectMQTT, 5000); }
            };
            mqttClient.connect(options);
        } catch (e) {
            console.error("MQTT Init Error:", e);
            addSystemMessage("‚ö†Ô∏è MQTT System Offline.");
        }
    }

    // --- 11. INITIALIZATION (Safe Boot) ---
    window.onload = function() {
        console.log(">> DOM LOADED. INITIALIZING APP...");
        
        try {
            // 1. Diagnostics
            addSystemMessage("‚úÖ SYSTEM ONLINE. DETECTING UI STRUCTURE...");
            
            // 2. Load Data & Admin Creds
            let saved = localStorage.getItem('termos_stats_modern');
            if(saved) { 
                try {
                    userStats = JSON.parse(saved); 
                    if(userStats.ascii) updateAvatar(userStats.level); 
                } catch(e) { console.warn("Stats Corrupt, resetting."); }
            }

            const tkInput = document.getElementById('gh-token');
            if(GITHUB_TOKEN) tkInput.value = GITHUB_TOKEN;
            const ownerInput = document.getElementById('gh-owner');
            if(REPO_OWNER) ownerInput.value = REPO_OWNER;
            const repoInput = document.getElementById('gh-repo');
            if(REPO_NAME) repoInput.value = REPO_NAME;

            // 3. Start Background
            initMatrix();

            // 4. Start MQTT
            if (typeof Paho !== 'undefined') {
                console.log("Paho MQTT found. Connecting...");
                const clientId = "termos_client_" + Math.random().toString(16).substr(2, 8);
                mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, clientId);
                mqttClient.onConnectionLost = () => { 
                    console.log("MQTT Lost"); 
                    addSystemMessage("‚ö†Ô∏è Lost. Reconnecting..."); 
                    setTimeout(connectMQTT, 5000); 
                };
                mqttClient.onMessageArrived = (message) => {
                    try {
                        if (message.destinationName === "termos/v3/chat") {
                            const data = JSON.parse(message.payloadString);
                            if (data.user !== username) {
                                addUserMessage(data.text);
                            }
                        }
                    } catch(e) { console.error("Msg Parse Error", e); }
                };
                connectMQTT();
            } else {
                addSystemMessage("‚ö†Ô∏è Paho MQTT Library not loaded.");
            }

            // 5. Attach Listeners
            const sendBtn = document.getElementById('send-btn');
            const userInput = document.getElementById('user-input');
            
            if(sendBtn) sendBtn.onclick = handleInput;
            else throw new Error("Send button not found.");
            
            if(userInput) {
                userInput.addEventListener('keypress',e=>{ 
                    if(e.key==='Enter') handleInput(); 
                });
            } else {
                throw new Error("User input not found.");
            }
            
            // 6. Admin Button Logic (If the HTML doesn't have the button, create it)
            const adminBtn = document.getElementById('admin-toggle-text');
            if(!adminBtn) {
                console.log("Admin button missing. Creating one dynamically...");
                const btn = document.createElement('button');
                btn.id = 'admin-toggle-text';
                btn.className = "fixed top-4 right-4 z-50 bg-slate-900/50 hover:bg-red-900/50 border border-slate-700 hover:border-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-mono font-bold transition-all shadow-lg backdrop-blur-md flex items-center gap-2";
                btn.innerHTML = '<span>üî¥</span> ADMIN';
                btn.onclick = toggleAdminMode;
                document.body.appendChild(btn);
            }

            // 7. Voice
            if ('webkitSpeechRecognition' in window) {
                const r = new webkitSpeechRecognition();
                const voiceBtn = document.getElementById('voice-btn');
                if(voiceBtn) {
                    voiceBtn.onclick = () => { r.start(); };
                    r.onresult = (e) => { 
                        if(userInput) userInput.value = e.results[0][0].transcript; 
                    };
                } else {
                    console.log("Voice button missing.");
                }
            }

        } catch (e) {
            console.error("INITIALIZATION FAILED:", e);
            alert("System Error: " + e.message + ". Check Console.");
            // Fallback UI if everything breaks
            const d = document.createElement('div');
            d.style.color = "white";
            d.innerHTML = "CRITICAL ERROR: " + e.message;
            document.body.appendChild(d);
        }
    };

    // Global Error Catcher
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("Global Error:", message);
        addSystemMessage(`JS ERROR: ${message}`);
    };

</script>
