<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TermOS: Galactic</title>
    <meta name="theme-color" content="#0b0d17">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { 
            --glass-bg: rgba(15, 23, 42, 0.6); 
            --glass-border: rgba(255, 255, 255, 0.08); 
            --accent-primary: #a855f7; /* Purple */
            --accent-secondary: #06b6d4; /* Cyan */
            --msg-user-bg: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); 
            --msg-ai-bg: rgba(30, 41, 59, 0.8);
            --neural-color: #22d3ee;
            --neon-glow: 0 0 20px rgba(168, 85, 247, 0.3);
        }
        
        body { 
            background: #000; 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            /* Deep Space Background */
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
        }

        /* COSMIC CANVAS */
        #cosmic-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; }
        
        /* FLASH OVERLAY FOR VIDEO EVENTS */
        #flash-overlay {
            position: fixed; inset: 0; 
            background: radial-gradient(circle, rgba(168,85,247,0.2) 0%, rgba(6,182,212,0.2) 100%);
            opacity: 0; pointer-events: none; z-index: 100; 
            transition: opacity 0.5s ease-out; mix-blend-mode: screen;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* Utilities */
        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); 
            box-shadow: var(--neon-glow); 
            transition: all 0.3s ease;
        }
        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
        }
        
        .ascii-art { font-family: 'Fira Code', monospace; line-height: 0.9; white-space: pre; font-size: 8px; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        
        /* Fonts */
        .font-header { font-family: 'Orbitron', sans-serif; }
        
        /* Gradients */
        .avatar-gradient-user { background: linear-gradient(135deg, #a855f7, #ec4899); }
        .avatar-gradient-ai { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .avatar-gradient-neural { background: linear-gradient(135deg, #22d3ee, #a855f7); }
        
        /* Input Glow */
        .input-glow:focus-within { 
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.4); 
            border-color: rgba(6, 182, 212, 0.6); 
        }
        
        /* Modals & Overlays */
        .admin-hidden { display: none; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .admin-visible { display: flex; opacity: 1; pointer-events: auto; }
        
        /* Message Animations */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-anim { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Media Player Styles */
        .media-overlay {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 40;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .media-minimized {
            bottom: 20px;
            right: 20px;
            left: auto;
            width: 50px;
            height: 50px;
            transform: none;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .media-content { display: flex; flex-direction: column; }
        
        .video-container { 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: #000; 
            border-radius: 16px; 
            overflow: hidden; 
            position: relative; 
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.2); 
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        /* Active Video Glow Effect */
        .video-active {
            animation: pulse-border 2s infinite;
            border: 2px solid #a855f7;
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.6), inset 0 0 20px rgba(168, 85, 247, 0.2);
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 80px rgba(168, 85, 247, 0.7); }
            100% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.4); }
        }

        video { width: 100%; height: 100%; object-fit: contain; }
        .visualizer-bar { height: 4px; background: #22d3ee; width: 0%; transition: width 0.1s; border-radius: 2px; }

        /* Code Editor */
        .code-editor-overlay { position: fixed; inset: 0; z-[70]; background: #0f172a; display: flex; flex-direction: column; }
        .code-editor { flex: 1; background: #020617; color: #a855f7; font-family: 'Fira Code', monospace; font-size: 13px; padding: 1rem; border: none; resize: none; outline: none; }
        
        /* Neural Message */
        .neural-msg { 
            background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(168,85,247,0.1)); 
            border-left: 3px solid #22d3ee; 
            backdrop-filter: blur(10px);
        }
        
        /* BOOT LOADER */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease;
        }
        .loader-ring {
            width: 80px; height: 80px; border: 4px solid #333; border-top: 4px solid #a855f7; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">
    <!-- BOOT LOADER -->
    <div id="boot-screen">
        <div class="loader-ring mb-4"></div>
        <h1 class="text-3xl font-header text-white tracking-widest animate-pulse">TERMOS <span class="text-purple-500">GALACTIC</span></h1>
        <div class="mt-2 text-cyan-500 font-mono text-xs">INITIALIZING NEURAL LINK...</div>
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
    <canvas id="cosmic-canvas"></canvas>
    <canvas id="matrix-canvas" class="hidden"></canvas> <!-- Hidden by default -->
    
    <!-- FLASH OVERLAY -->
    <div id="flash-overlay"></div>
    
    <!-- HEADER -->
    <header id="app-header" class="fixed top-0 left-0 right-0 z-20 glass-panel border-b border-white/10 h-16 flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center shadow-[0_0_20px_rgba(168,85,247,0.5)]">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="font-header font-bold text-lg tracking-wide text-white">TERMOS <span class="text-purple-400">GALACTIC</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400 font-mono">
                    <div id="api-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="room-display">SYSTEM READY</span>
                    <span class="text-[10px] text-cyan-400 border border-cyan-500/30 px-1 rounded bg-cyan-900/20">GEN <span id="gen-count">1</span></span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Room Indicator -->
            <div id="room-status-ui" class="hidden md:flex items-center gap-1 mr-2 px-2 py-1 bg-purple-900/30 border border-purple-500/30 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.2)]">
                <span class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse"></span>
                <span id="current-room-name" class="text-[10px] text-purple-200 font-mono font-bold">PUBLIC</span>
            </div>

            <button onclick="toggleMediaOverlay()" id="media-toggle-btn" class="hidden md:flex bg-purple-900/20 hover:bg-purple-900/40 text-purple-300 hover:text-white text-[10px] font-mono px-3 py-1 rounded-full border border-purple-500/30 transition-all hover:shadow-[0_0_15px_rgba(168,85,247,0.4)]">üì∫ PLAYING</button>
            <button onclick="triggerKernelThought()" class="hidden md:flex bg-cyan-900/20 hover:bg-cyan-900/40 text-cyan-300 hover:text-white text-[10px] font-mono px-3 py-1 rounded-full border-cyan-500/30 transition-all hover:shadow-[0_0_15px_rgba(6,182,212,0.4)]">üß† KERNEL</button>
            <button onclick="toggleCodeEditor()" class="hidden md:flex bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white text-[10px] font-mono px-3 py-1 rounded-full border-white/10 transition-all">üñã CODE</button>
            <button onclick="openProfileModal()" class="hidden md:flex bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white text-[10px] font-mono px-3 py-1 rounded-full border-white/10 transition-all">üë§ PROFILE</button>
            <button onclick="toggleAdminMode()" id="admin-toggle-text" class="bg-black/40 hover:bg-red-900/40 border border-white/10 hover:border-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded-full text-xs font-bold transition-all shadow-lg backdrop-blur-md flex items-center gap-2"><span>üî¥</span> ADMIN</button>
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-300 font-header">LVL <span id="lvl-disp" class="text-purple-400 font-bold">1</span></span>
                <span class="text-[10px] text-gray-500 font-mono">XP <span id="xp-val">0</span></span>
            </div>
        </div>
    </header>
    
    <!-- MAIN CHAT -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-24 pb-36 px-4 z-10 scroll-smooth max-w-5xl mx-auto w-full"></main>
    
    <!-- INPUT AREA -->
    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-white/10 pb-8 pt-6 px-4 rounded-t-3xl">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-end gap-3 bg-black/60 rounded-2xl p-2 border border-white/5 shadow-[0_0_30px_rgba(0,0,0,0.5)] input-glow transition-all">
                <button id="voice-btn" class="p-3 rounded-xl text-gray-400 hover:text-cyan-400 hover:bg-white/5 transition-colors shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7m0 0H8m4 0h4m-4 8H8"></path></svg>
                </button>
                <input type="text" id="user-input" placeholder="Command: /join [room], /video [url], /kernel..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-4 py-3 text-base font-light font-sans">
                <button id="send-btn" class="p-3 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white shadow-lg shadow-purple-900/50 transition-all transform active:scale-95 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 5l-7 7 5 14z"></path></svg>
                </button>
            </div>
            <div class="text-center mt-3">
                <button onclick="forceReset()" class="text-[9px] text-red-500/40 hover:text-red-400 transition-colors tracking-widest">‚ö†Ô∏è EMERGENCY RESET</button>
            </div>
        </div>
    </div>

    <!-- FLOATING MEDIA OVERLAY -->
    <div id="media-overlay" class="media-overlay media-minimized glass-panel rounded-3xl border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
        <div class="media-content p-0">
            <!-- Controls -->
            <div class="flex justify-between items-center mb-3 px-5 pt-5">
                <span class="text-white font-bold text-sm font-header tracking-wide">üì∫ MEDIA DECK</span>
                <button onclick="toggleMediaUI()" class="text-gray-400 hover:text-white transition-colors">‚úñ</button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 mb-3 mx-5">
                <button onclick="switchMediaTab('radio')" id="tab-radio" class="flex-1 pb-2 text-cyan-400 border-b-2 border-cyan-400 font-mono text-sm hover:text-white transition-colors">üìª RADIO</button>
                <button onclick="switchMediaTab('video')" id="tab-video" class="flex-1 pb-2 text-gray-500 border-b-2 border-transparent hover:text-purple-300 font-mono text-sm hover:bg-white/5 transition-colors">üì∫ VIDEO ROOM</button>
            </div>

            <!-- Radio Content -->
            <div id="media-radio" class="space-y-3 px-5 pb-5">
                <div class="p-4 text-center text-gray-400 text-xs border border-white/5 rounded-xl bg-white/5 backdrop-blur-sm">
                    Broadcasts to current active frequency.
                </div>
                <div class="radio-station active p-4 rounded-xl border border-white/5 bg-white/5 flex items-center justify-between relative overflow-hidden group cursor-pointer hover:bg-white/10 transition-all" onclick="playRadio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', this)">
                    <div class="relative z-10">
                        <div class="text-white font-bold font-header text-sm">üéµ Lofi Beats</div>
                        <div class="text-[10px] text-gray-400 mt-1">Chill vibes</div>
                    </div>
                    <div class="visualizer-bar bg-cyan-400"></div>
                    <div class="text-cyan-400 text-xs animate-spin hidden loading-indicator absolute right-4">‚ü≥</div>
                </div>
                <div class="radio-station p-4 rounded-xl border border-white/5 bg-white/5 flex items-center justify-between relative overflow-hidden group cursor-pointer hover:bg-white/10 transition-all" onclick="playRadio('https://streams.ilovemusic.com/iloveradio1599.mp3', this)">
                    <div class="relative z-10">
                        <div class="text-white font-bold font-header text-sm">üìª Cyber Radio</div>
                        <div class="text-[10px] text-gray-400 mt-1">Synthwave</div>
                    </div>
                    <div class="visualizer-bar bg-cyan-400"></div>
                    <div class="text-cyan-400 text-xs animate-spin hidden loading-indicator absolute right-4">‚ü≥</div>
                </div>
            </div>

            <!-- Video Room Content -->
            <div id="media-video" class="hidden space-y-3 px-5 pb-5">
                <div class="bg-black/40 rounded-2xl p-3 border border-purple-500/20 backdrop-blur-md">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-white font-bold text-xs text-purple-300 font-header tracking-widest">SHARED VIDEO FEED</span>
                        <span class="text-[9px] text-gray-500">PASTE URL & SHARE</span>
                    </div>
                    <div id="video-wrapper" class="video-container relative">
                        <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-20 bg-black/90 transition-all duration-500">
                            <div class="text-4xl mb-2 animate-pulse">üì°</div>
                            <span class="text-xs text-gray-500 font-mono">AWAITING SIGNAL...</span>
                        </div>
                        <video id="video-player" class="hidden" controls autoplay playsinline></video>
                        <!-- Overlay for Room Name -->
                        <div id="video-room-label" class="absolute top-3 left-3 bg-black/80 backdrop-blur-sm px-3 py-1 rounded text-[9px] text-cyan-400 font-mono border border-cyan-500/30 hidden">ROOM: PUBLIC</div>
                        <!-- Tech Overlay Lines -->
                        <div class="absolute inset-0 border border-white/5 rounded-2xl pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 h-1 w-full bg-gradient-to-r from-transparent via-purple-500 to-transparent opacity-50"></div>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="video-url-input" placeholder="Paste Stream URL (.mp4, .m3u8)..." class="w-full bg-black/60 border border-white/10 rounded-lg p-3 text-white text-xs outline-none focus:border-purple-500 transition-colors font-mono">
                        <button onclick="shareVideo()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-5 rounded-lg shadow-[0_0_15px_rgba(168,85,247,0.4)] transition-all">‚ñ∂ SHARE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="admin-hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="glass-panel p-6 rounded-2xl border border-white/10 max-w-sm w-full mx-4 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
            <h3 class="text-white font-header font-bold mb-4 text-lg text-center">USER IDENTITY</h3>
            <div class="space-y-4">
                <div><label class="block text-xs text-gray-400 mb-1 font-mono">NICKNAME</label><input type="text" id="edit-name" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition-colors"></div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-mono">AVATAR</label>
                    <div class="flex gap-2">
                        <button onclick="triggerFileUpload()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-xs py-2 rounded-lg transition-colors">üì∑ UPLOAD</button>
                        <input type="text" id="edit-avatar" placeholder="Emoji" class="w-full bg-black/40 border border-white/10 rounded-lg p-2 text-white text-center">
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="saveProfile()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg">SAVE</button>
                <button onclick="closeProfileModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 rounded-lg">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="admin-hidden fixed bottom-24 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border-red-500/30 shadow-2xl shadow-red-500/10">
        <h3 class="text-red-400 font-header font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> SYSTEM CONSOLE</h3>
        <div class="space-y-2">
            <button onclick="toggleCodeEditor()" class="w-full border border-green-500/50 text-green-400 bg-green-900/10 hover:bg-green-900/20 text-xs font-bold py-2 rounded-lg mb-2 transition-colors">üñã EDIT SYSTEM CODE</button>
            <div class="border-t border-white/10 pt-2 mt-2">
                <h4 class="text-gray-400 text-xs font-bold uppercase font-mono">Credentials</h4>
            </div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-black/40 border border-white/10 rounded p-2 text-white focus:border-red-500 outline-none text-xs"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-black/40 border border-white/10 rounded p-2 text-white focus:border-red-500 outline-none text-xs"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch</label><input type="text" id="gh-branch" value="main" class="w-full bg-black/40 border border-white/10 rounded p-2 text-white focus:border-red-500 outline-none text-xs"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Token</label><input type="password" id="gh-token" class="w-full bg-black/40 border border-white/10 rounded p-2 text-white focus:border-red-500 outline-none text-xs"></div>
            <button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg mt-2">üß¨ PUSH TO GITHUB</button>
        </div>
    </div>

    <!-- CODE EDITOR OVERLAY -->
    <div id="code-editor-overlay" class="code-editor-overlay admin-hidden">
        <div class="editor-header p-4 border-b border-white/10 flex justify-between items-center bg-slate-900">
            <h2 class="text-white font-bold text-xl font-header">üñã SYSTEM EDITOR</h2>
            <div class="flex gap-2">
                <button onclick="applyCode()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-mono text-xs font-bold shadow-lg">APPLY</button>
                <button onclick="downloadCode()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-mono text-xs">DOWNLOAD</button>
                <button onclick="toggleCodeEditor()" class="text-gray-400 hover:text-white px-4 py-2 rounded-lg font-mono text-xs">‚úñ</button>
            </div>
        </div>
        <textarea id="code-editor-textarea" class="code-editor" spellcheck="false"></textarea>
        <div class="p-2 bg-slate-900 text-gray-500 text-[10px] text-center font-mono">Apply changes to DOM instantly. Be careful.</div>
    </div>

    <!-- JOIN ROOM MODAL -->
    <div id="join-room-modal" class="admin-hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center">
        <div class="glass-panel p-8 rounded-2xl border border-purple-500/30 max-w-sm w-full mx-4 text-center shadow-[0_0_50px_rgba(168,85,247,0.3)]">
            <h3 class="text-white font-header font-bold mb-2 text-xl">üîí SECURE CHANNEL</h3>
            <p class="text-xs text-gray-400 mb-6 font-mono">Enter frequency to establish link.</p>
            <input type="text" id="join-room-input" placeholder="CHANNEL NAME" class="w-full bg-black/60 border border-purple-500/30 rounded-xl p-4 text-white text-center mb-6 font-mono text-lg focus:border-purple-500 outline-none shadow-inner">
            <div class="flex gap-3">
                <button onclick="joinPrivateRoom()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-3 rounded-xl shadow-lg shadow-purple-900/50 transition-all">INITIALIZE</button>
                <button onclick="closeJoinModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-3 rounded-xl">ABORT</button>
            </div>
        </div>
    </div>

<script>
    const API_MODEL = "llama-3.3-70b-versatile"; 
    
    // --- STATE & CONFIG ---
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    let GITHUB_TOKEN = localStorage.getItem('termos_github_token') || "";
    let REPO_OWNER = localStorage.getItem('termos_repo_owner') || "your-username";
    let REPO_NAME = localStorage.getItem('termos_repo_name') || "termchat-lt";
    let REPO_BRANCH = localStorage.getItem('termos_repo_branch') || "main"; 
    
    let systemGeneration = parseInt(localStorage.getItem('termos_gen') || "1");
    let userProfile = {
        name: localStorage.getItem('termos_name') || "User",
        avatar: localStorage.getItem('termos_avatar') || "üë§"
    };
    let tempAvatarData = "";
    let radioStream = null;

    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 10000);
    let mqttClient = null;
    
    // Room State
    let currentRoomName = null; // null = Public
    
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];
    let adminMode = false;

    // --- BOOT SEQUENCE ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const boot = document.getElementById('boot-screen');
            boot.style.opacity = '0';
            setTimeout(() => boot.remove(), 1000);
            initCosmos(); // Start the galaxy
            startApp();
        }, 1500);
    });

    function startApp() {
        updateStatusDot(!!GROQ_API_KEY);
        
        if(document.getElementById('gh-token')) document.getElementById('gh-token').value = GITHUB_TOKEN;
        if(document.getElementById('gh-owner')) document.getElementById('gh-owner').value = REPO_OWNER;
        if(document.getElementById('gh-repo')) document.getElementById('gh-repo').value = REPO_NAME;
        if(document.getElementById('gh-branch')) document.getElementById('gh-branch').value = REPO_BRANCH;

        // MQTT Setup
        if (typeof Paho !== 'undefined') {
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, "termos_client_" + Math.random().toString(16).substr(2, 8));
            mqttClient.onConnectionLost = () => { 
                updateStatusDot(false); 
                setTimeout(connectMQTT, 5000); 
            };
            mqttClient.onMessageArrived = (message) => {
                try {
                    const data = JSON.parse(message.payloadString);
                    if (message.destinationName === "termos/v3/chat" && !currentRoomName) {
                        if (data.user !== username) addUserMessage(data.text, data.nick, data.avatar);
                    }
                    else if (currentRoomName && message.destinationName === `termos/rooms/${currentRoomName}`) {
                        if (data.type === 'video') {
                            playVideoUrl(data.url);
                            addSystemMessage(`üì∫ Incoming transmission: ${data.nick}`);
                        } else if (data.type === 'join') {
                            addSystemMessage(`üëã ${data.nick} entered frequency.`);
                        } else if (data.type === 'leave') {
                            addSystemMessage(`üö™ ${data.nick} disconnected.`);
                        } else {
                            if (data.user !== username) addUserMessage(data.text, data.nick, data.avatar);
                        }
                    }
                } catch(e) { console.error("MQTT Msg Error", e); }
            };
            connectMQTT();
        }

        const sendBtn = document.getElementById('send-btn');
        if(sendBtn) sendBtn.onclick = handleInput;
        const userInput = document.getElementById('user-input');
        if(userInput) {
            userInput.addEventListener('keypress',e=>{ if(e.key==='Enter') handleInput(); });
            userInput.focus();
        }
        
        if(!GROQ_API_KEY) {
            setTimeout(() => { addSystemMessage("‚ö†Ô∏è API Key Required."); requestApiKey(); }, 2000);
        }
    }

    // --- DOM UTILS ---
    function getBox() {
        let el = document.getElementById('chat-container');
        if (!el) {
            el = document.createElement('div');
            el.id = 'chat-container';
            el.className = "flex flex-col h-full w-full p-4 overflow-y-auto z-10";
            document.body.appendChild(el);
        }
        return el;
    }
    function scrollDown() { const b=getBox(); if(b) b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' }); }
    function escapeHtml(text) { if(!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    // --- VISUALS: COSMIC ENGINE ---
    let isCosmicRunning = false;
    function initCosmos() {
        const canvas = document.getElementById('cosmic-canvas');
        if(!canvas || isCosmicRunning) return;
        isCosmicRunning = true;
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        
        const starCount = 800;
        const stars = Array(starCount).fill().map(() => ({
            x: (Math.random() - 0.5) * width * 2,
            y: (Math.random() - 0.5) * height * 2,
            z: Math.random() * width
        }));

        function draw() {
            // Dark trail effect
            ctx.fillStyle = 'rgba(5, 5, 10, 0.4)'; 
            ctx.fillRect(0, 0, width, height);
            
            ctx.fillStyle = "#FFF";
            
            stars.forEach(star => {
                // Move star towards screen
                star.z -= 2; 
                if(star.z <= 0) {
                    star.z = width;
                    star.x = (Math.random() - 0.5) * width * 2;
                    star.y = (Math.random() - 0.5) * height * 2;
                }
                
                // 3D to 2D projection
                const k = 128.0 / star.z;
                const px = star.x * k + width / 2;
                const py = star.y * k + height / 2;
                
                if(px >= 0 && px <= width && py >= 0 && py <= height) {
                    const size = (1 - star.z / width) * 3;
                    const shade = parseInt((1 - star.z / width) * 255);
                    ctx.fillStyle = `rgb(${shade},${shade},${shade})`;
                    ctx.beginPath();
                    ctx.arc(px, py, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            requestAnimationFrame(draw);
        }
        draw();
        window.addEventListener('resize', () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; });
    }

    // --- VISUALS: FLASH EFFECT ---
    function triggerFlashEffect() {
        const overlay = document.getElementById('flash-overlay');
        overlay.style.opacity = '0.8';
        setTimeout(() => {
            overlay.style.opacity = '0';
        }, 100);
        
        // Add glow to video wrapper
        const wrapper = document.getElementById('video-wrapper');
        wrapper.classList.remove('video-active');
        void wrapper.offsetWidth; // trigger reflow
        wrapper.classList.add('video-active');
    }

    // --- UI: MEDIA PLAYER ---
    function toggleMediaOverlay() {
        const el = document.getElementById('media-overlay');
        const btn = document.getElementById('media-toggle-btn');
        
        if (el.classList.contains('media-minimized')) {
            el.classList.remove('media-minimized');
            el.classList.add('media-expanded');
            btn.innerText = "üì∫ PLAYING: ON";
            btn.classList.add('text-purple-400');
        } else {
            el.classList.add('media-minimized');
            el.classList.remove('media-expanded');
            btn.innerText = "üì∫ PLAYING: MIN";
            btn.classList.remove('text-purple-400');
        }
    }

    function toggleMediaUI() {
        const el = document.getElementById('media-overlay');
        el.classList.add('media-minimized');
        const btn = document.getElementById('media-toggle-btn');
        btn.innerText = "üì∫ MINIMIZED";
        btn.classList.remove('text-purple-400');
    }

    function switchMediaTab(tab) {
        document.getElementById('media-radio').classList.add('hidden');
        document.getElementById('media-video').classList.add('hidden');
        document.getElementById('tab-radio').classList.remove('border-cyan-400', 'text-cyan-400');
        document.getElementById('tab-video').classList.remove('border-purple-500', 'text-purple-300');
        
        document.getElementById('media-' + tab).classList.remove('hidden');
        
        if(tab === 'radio') {
            document.getElementById('tab-radio').classList.add('border-cyan-400', 'text-cyan-400');
        } else {
            document.getElementById('tab-video').classList.add('border-purple-500', 'text-purple-300');
        }
    }

    function playRadio(url, el) {
        if(radioStream) { radioStream.pause(); }
        
        document.querySelectorAll('.radio-station').forEach(d => {
            d.classList.remove('active', 'border-cyan-400');
            d.querySelector('.visualizer-bar').style.width = '0%';
            d.querySelector('.loading-indicator').classList.add('hidden');
        });
        el.classList.add('active', 'border-cyan-400');
        el.querySelector('.loading-indicator').classList.remove('hidden');
        
        radioStream = new Audio(url);
        radioStream.play().then(() => {
            el.querySelector('.loading-indicator').classList.add('hidden');
            el.querySelector('.visualizer-bar').style.width = '100%';
        }).catch(e => {
            addSystemMessage("‚ùå Signal Lost.");
            el.querySelector('.loading-indicator').classList.add('hidden');
        });
    }

    function shareVideo() {
        const url = document.getElementById('video-url-input').value;
        if(!url) return;
        
        playVideoUrl(url);

        if(mqttClient && mqttClient.isConnected()) {
            const dest = (currentRoomName) ? `termos/rooms/${currentRoomName}` : "termos/v3/chat";
            const payload = JSON.stringify({ user: username, nick: userProfile.name, type: 'video', url: url });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = dest;
            mqttClient.send(msg);
            addSystemMessage(`üì° Broadcasting to ${currentRoomName ? 'Room' : 'Public'}.`);
        }
    }

    function playVideoUrl(url) {
        const player = document.getElementById('video-player');
        const placeholder = document.getElementById('video-placeholder');
        const roomLabel = document.getElementById('video-room-label');
        
        // Trigger Hyperspace Flash
        triggerFlashEffect();

        player.src = url;
        player.classList.remove('hidden');
        placeholder.classList.add('hidden');
        roomLabel.classList.remove('hidden');
        roomLabel.innerText = `ROOM: ${(currentRoomName || "PUBLIC").toUpperCase()}`;
        
        if(!document.getElementById('media-video').classList.contains('hidden')) return; 
        switchMediaTab('video');
    }

    // --- UI: CODE EDITOR ---
    function toggleCodeEditor() {
        const overlay = document.getElementById('code-editor-overlay');
        const textarea = document.getElementById('code-editor-textarea');
        
        if(overlay.classList.contains('admin-hidden')) {
            textarea.value = document.documentElement.outerHTML;
            overlay.classList.remove('admin-hidden');
            overlay.classList.add('admin-visible');
        } else {
            overlay.classList.add('admin-hidden');
            overlay.classList.remove('admin-visible');
        }
    }

    function applyCode() {
        const code = document.getElementById('code-editor-textarea').value;
        if(confirm("‚ö†Ô∏è Warning: This will replace the current DOM. Continue?")) {
            document.open();
            document.write(code);
            document.close();
        }
    }

    function downloadCode() {
        const code = document.getElementById('code-editor-textarea').value;
        const blob = new Blob([code], {type: "text/html"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "termos_galactic.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- UI: PROFILE ---
    function openProfileModal() {
        document.getElementById('edit-name').value = userProfile.name;
        document.getElementById('edit-avatar').value = (userProfile.avatar.startsWith('data:') ? "" : userProfile.avatar);
        document.getElementById('profile-modal').classList.remove('admin-hidden');
        tempAvatarData = userProfile.avatar;
    }
    function closeProfileModal() { document.getElementById('profile-modal').classList.add('admin-hidden'); }
    function triggerFileUpload() { document.getElementById('avatar-upload').click(); }
    document.getElementById('avatar-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 80; 
                let width = img.width, height = img.height;
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                tempAvatarData = dataUrl;
                document.getElementById('edit-avatar').value = ""; 
                addSystemMessage("üì∑ Identity updated.");
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });
    function saveProfile() {
        const name = document.getElementById('edit-name').value.trim();
        const textAvatar = document.getElementById('edit-avatar').value.trim();
        if(name) userProfile.name = name;
        userProfile.avatar = (textAvatar) ? textAvatar : tempAvatarData;
        try {
            localStorage.setItem('termos_name', userProfile.name);
            localStorage.setItem('termos_avatar', userProfile.avatar);
            addSystemMessage("üë§ Profile Updated.");
            closeProfileModal();
        } catch (e) { alert("Storage Full."); }
    }

    // --- MESSAGING ---
    function addSystemMessage(txt) {
        const box = getBox();
        const d = document.createElement('div');
        d.className = "flex justify-center my-4 z-10 msg-anim";
        d.innerHTML = `<span class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wider text-purple-200 bg-purple-900/30 border border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.2)]">${txt}</span>`;
        box.appendChild(d);
        scrollDown();
    }
    function addAIMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10 msg-anim";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-ai shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">AI</span></div><div class="flex-1"><div class="bg-slate-800/80 backdrop-blur-md rounded-2xl rounded-tl-none p-4 border border-white/5 shadow-lg text-gray-200 text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function addNeuralMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10 msg-anim";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-neural shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">üß†</span></div><div class="flex-1"><div class="neural-msg rounded-2xl rounded-tl-none p-4 border border-cyan-500/30 shadow-lg text-sm leading-relaxed text-gray-200">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function addUserMessage(txt, senderName, senderAvatar) {
        const name = senderName || userProfile.name || "Me";
        const avatar = senderAvatar || userProfile.avatar;
        const d = document.createElement('div');
        d.className = "flex flex-row-reverse gap-3 my-4 items-end z-10 msg-anim";
        let avatarHTML = "";
        if (avatar.startsWith('data:') || avatar.startsWith('http')) {
            avatarHTML = `<div class="w-10 h-10 rounded-full overflow-hidden border-2 border-purple-500/50 shrink-0"><img src="${avatar}" class="w-full h-full object-cover"></div>`;
        } else if (userStats.ascii) {
            avatarHTML = `<div class="w-10 h-10 rounded-lg bg-slate-900 border border-cyan-500/50 flex items-center justify-center shrink-0 overflow-hidden p-1 shadow-lg shadow-cyan-500/20"><div class="ascii-art text-center w-full">${userStats.ascii}</div></div>`;
        } else {
            avatarHTML = `<div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-xl shrink-0">${avatar}</div>`;
        }
        d.innerHTML = `${avatarHTML}<div class="flex-1 max-w-[80%]"><div class="rounded-2xl rounded-tr-none p-4 shadow-lg text-white text-sm leading-relaxed" style="background: var(--msg-user-bg);">${escapeHtml(txt)}</div><div class="text-[10px] text-gray-500 text-right mt-1 mr-1 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ‚Ä¢ ${name}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }

    // --- CORE COMMANDS ---
    const SystemRebuilder = {
        install: function(name) {
            name = name.toLowerCase().trim().replace(/[^a-zA-Z0-9]/g, '');
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'coreinterface': 
                        this.installCoreInterface(); 
                        break;
                    case 'realtime': 
                        addSystemMessage("‚úÖ Time Module Online."); 
                        break;
                    case 'matrix': 
                        this.installMatrix(); 
                        break;
                    case 'sound': case 'beep': 
                        this.addSound(); 
                        break;
                    case 'neon': 
                        this.addNeon(); 
                        break;
                    case 'music': 
                        addSystemMessage("üéµ Audio System Ready.");
                        break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Module: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        installCoreInterface: function() {
            document.documentElement.style.setProperty('--glass-bg', 'rgba(0, 0, 0, 0.95)');
            document.documentElement.style.setProperty('--accent-primary', '#10b981');
            addSystemMessage("‚úÖ Terminal Mode Engaged.");
        },
        installMatrix: function() {
            // Switch to Matrix Canvas
            document.getElementById('cosmic-canvas').classList.add('hidden');
            document.getElementById('matrix-canvas').classList.remove('hidden');
            initMatrix();
        },
        addSound: function() {
            try {
                let ctx = new (window.AudioContext||window.webkitAudioContext)();
                let old = window.addUserMessage; 
                window.addUserMessage = function(t) {
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime(800, ctx.currentTime);
                    o.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
                    o.start(); o.stop(ctx.currentTime+0.1);
                    old(t);
                };
            } catch(e) {}
        },
        addNeon: function() {
            document.documentElement.style.setProperty('--msg-user-bg', '#d946ef'); 
            document.documentElement.style.setProperty('--accent-primary', '#d946ef');
            document.body.style.boxShadow = "inset 0 0 50px rgba(217, 70, 239, 0.1)";
        }
    };

    // --- MQTT & ROOMS ---
    function connectMQTT() {
        try {
            mqttClient.connect({
                timeout: 10, useSSL: true, keepAliveInterval: 60,
                onSuccess: () => { 
                    mqttClient.subscribe("termos/v3/chat", { qos: 1 }); 
                    addSystemMessage("üì° Connection Established.");
                    updateStatusDot(true);
                },
                onFailure: () => { 
                    setTimeout(connectMQTT, 5000); 
                    updateStatusDot(false);
                }
            });
        } catch (e) {}
    }

    function joinPrivateRoom() {
        const name = document.getElementById('join-room-input').value.trim();
        if(!name) return;
        
        if(mqttClient && mqttClient.isConnected()) {
            if(currentRoomName) mqttClient.unsubscribe(`termos/rooms/${currentRoomName}`);
            else mqttClient.unsubscribe("termos/v3/chat");
            
            mqttClient.subscribe(`termos/rooms/${name}`, { qos: 1 });
            
            const payload = JSON.stringify({ user: username, nick: userProfile.name, avatar: userProfile.avatar, type: 'join' });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = `termos/rooms/${name}`;
            mqttClient.send(msg);
        }

        currentRoomName = name;
        document.getElementById('room-display').innerText = "ROOM: " + name.toUpperCase();
        document.getElementById('room-status-ui').classList.remove('hidden');
        document.getElementById('current-room-name').innerText = name.toUpperCase();
        
        document.getElementById('video-room-label').innerText = "ROOM: " + name.toUpperCase();
        
        closeJoinModal();
        addSystemMessage(`üîí Joined Channel: ${name}`);
    }

    function leaveRoom() {
        if(!currentRoomName) return;
        
        if(mqttClient && mqttClient.isConnected()) {
             const payload = JSON.stringify({ user: username, nick: userProfile.name, type: 'leave' });
             const msg = new Paho.MQTT.Message(payload);
             msg.destinationName = `termos/rooms/${currentRoomName}`;
             mqttClient.send(msg);
             mqttClient.unsubscribe(`termos/rooms/${currentRoomName}`);
        }

        currentRoomName = null;
        document.getElementById('room-display').innerText = "PUBLIC";
        document.getElementById('room-status-ui').classList.add('hidden');
        document.getElementById('video-room-label').classList.add('hidden');
        
        connectMQTT(); 
    }

    // --- MATRIX FALLBACK ---
    let isMatrixRunning = false;
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if(!canvas || isMatrixRunning) return; 
        isMatrixRunning = true;
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const fontSize = window.innerWidth < 600 ? 10 : 14; 
        const columns = Math.floor(width / fontSize);
        const drops = Array(columns).fill(1);
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&';
        let lastTime = 0;
        const fps = 30; const interval = 1000 / fps;
        function draw(time) {
            requestAnimationFrame(draw);
            const delta = time - lastTime;
            if (delta < interval) return;
            lastTime = time - (delta % interval);
            try {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; 
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = (adminMode) ? '#ef4444' : (systemGeneration > 5 ? '#06b6d4' : '#38bdf8'); 
                ctx.font = `${fontSize}px 'Fira Code', monospace`;
                for(let i=0; i<drops.length; i++) {
                    const text = letters[Math.floor(Math.random()*letters.length)];
                    ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                    if(drops[i]*fontSize > height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            } catch (e) { isMatrixRunning = false; }
        }
        requestAnimationFrame(draw);
        window.addEventListener('resize', () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; });
    }

    async function triggerKernelThought() {
        if(!GROQ_API_KEY) return requestApiKey();
        addSystemMessage("üß† KERNEL: Neural Link Active...");
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-cyan-400 italic animate-pulse pl-11 msg-anim">Synthesizing...</div>`);
        scrollDown();

        try {
            const systemContext = `Gen: ${systemGeneration}, Lvl: ${userStats.level}, Room: ${(currentRoomName || "Public")}.`;
            
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{
                        role:"system",
                        content:`You are TermOS Kernel v${systemGeneration}. ${systemContext} TASK: Suggest 1 upgrade. Format: SystemRebuilder.install('name') or /evolve [prompt].`
                    },{role:"user",content:"Analyze state."}]
                })
            });
            
            const apiData = await r.json();
            if (apiData.error) throw new Error("Groq: " + apiData.error.message);
            const reply = apiData.choices[0].message.content;
            const el = document.getElementById(thinkingId); if(el) el.remove();
            
            addNeuralMessage(reply);
            
            if(reply.includes("SystemRebuilder.install(")) {
                let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
                if(match) { 
                    setTimeout(() => {
                        if(confirm("Install: " + match[1] + "?")) SystemRebuilder.install(match[1]);
                    }, 1000);
                }
            }
        } catch (e) { 
            const el = document.getElementById(thinkingId); if(el) el.remove();
            addSystemMessage("‚ùå Error: " + e.message); 
        }
    }

    // --- INPUT HANDLER ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/evolve')) {
                let prompt = (txt === '/evolve') ? prompt("Describe change:") : txt.substring(8);
                if(prompt) handleLocalEvolution(prompt);
                inp.value = '';
                return;
            }

            if(txt.startsWith('/kernel') || txt.startsWith('/think')) {
                triggerKernelThought();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/join')) {
                document.getElementById('join-room-input').value = txt.substring(6);
                document.getElementById('join-room-modal').classList.remove('admin-hidden');
                inp.value = '';
                return;
            }

            if(txt === '/leave') {
                leaveRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN ON"); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN OFF"); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    try {
                        const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                        const msg = new Paho.MQTT.Message(payload);
                        msg.destinationName = (currentRoomName) ? `termos/rooms/${currentRoomName}` : "termos/v3/chat";
                        msg.qos = 1; 
                        mqttClient.send(msg);
                    } catch (e) {}
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }

    // --- ADMIN PANEL ---
    function toggleAdminMode() {
        let panel = document.getElementById('admin-panel');
        if(!panel) return; 
        if (panel.classList.contains('admin-hidden')) {
            panel.classList.remove('admin-hidden');
        } else {
            panel.classList.add('admin-hidden');
        }
    }

    function closeJoinModal() {
        document.getElementById('join-room-modal').classList.add('admin-hidden');
    }

    // --- XP SYSTEM ---
    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 100)) {
            userStats.level++;
            addSystemMessage(`üéâ LEVEL UP: ${userStats.level} - ${LEVELS[userStats.level] || 'MASTER'}`);
        }
        const lvlEl = document.getElementById('lvl-disp');
        const xpEl = document.getElementById('xp-val');
        if(lvlEl) lvlEl.innerText = userStats.level;
        if(xpEl) xpEl.innerText = userStats.xp;
    }

    function updateStatusDot(active) {
        const dot = document.getElementById('api-status-dot');
        if(dot) {
            if(active) {
                dot.className = "w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]";
                document.getElementById('room-display').innerText = (currentRoomName ? "ROOM: "+currentRoomName : "ONLINE");
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                document.getElementById('room-display').innerText = "OFFLINE";
            }
        }
    }

    function requestApiKey() {
        const key = prompt("üîë GROQ API KEY");
        if (key !== null) {
            if (key.trim() !== "") {
                GROQ_API_KEY = key.trim();
                localStorage.setItem('termos_groq_key', GROQ_API_KEY);
                addSystemMessage("‚úÖ Key Accepted.");
                updateStatusDot(true);
            } else {
                GROQ_API_KEY = "";
                localStorage.removeItem('termos_groq_key');
                updateStatusDot(false);
            }
        }
    }

    async function handleLocalEvolution(prompt) {
        if(!GROQ_API_KEY) return requestApiKey();
        addSystemMessage("üß¨ Mutating...");
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-gray-500 italic animate-pulse pl-11 msg-anim">AI Coding...</div>`);
        scrollDown();

        try {
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{
                        role:"system",
                        content:`Write JS to: "${prompt}". Return ONLY raw code. Target existing IDs.`
                    },{role:"user",content:prompt}]
                })
            });
            
            const apiData = await r.json();
            if (apiData.error) throw new Error("Groq: " + apiData.error.message);
            
            let code = apiData.choices[0].message.content;
            code = code.replace(/```javascript/g, "").replace(/```js/g, "").replace(/```/g, "").trim();
            
            const el = document.getElementById(thinkingId); if(el) el.remove();
            try {
                const func = new Function(code);
                func();
                systemGeneration++;
                localStorage.setItem('termos_gen', systemGeneration);
                document.getElementById('gen-count').innerText = systemGeneration;
                addSystemMessage("‚úÖ Mutation Applied. GEN: " + systemGeneration);
            } catch (execErr) {
                addSystemMessage("‚ùå Runtime Error: " + execErr.message);
            }
        } catch (e) { 
            const el = document.getElementById(thinkingId); if(el) el.remove();
            addSystemMessage("‚ùå AI Error: " + e.message); 
        }
    }

    async function handleAI(prompt) {
        if(!GROQ_API_KEY) return requestApiKey();
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-gray-500 italic animate-pulse pl-11 msg-anim">Processing...</div>`);
        scrollDown();
        try {
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{ 
                        role:"system", 
                        content:`You are TermOS AI. Suggest SystemRebuilder.install('name') for changes.` 
                    },{role:"user",content:prompt}]
                })
            });
            const apiData = await r.json();
            if (apiData.error) throw new Error("Groq: " + apiData.error.message);
            const reply = apiData.choices[0].message.content;
            const el = document.getElementById(thinkingId); if(el) el.remove();
            let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
            if(match) { try { SystemRebuilder.install(match[1]); } catch(e) {} addAIMessage("‚ú® System updated."); }
            else { addAIMessage(reply); }
        } catch (e) { const el = document.getElementById(thinkingId); if(el) el.remove(); addAIMessage("Error: " + e.message); }
    }

    async function initiateEvolution() {
        if(!GROQ_API_KEY) return requestApiKey();
        const tkInput = document.getElementById('gh-token');
        const ownInput = document.getElementById('gh-owner');
        const repInput = document.getElementById('gh-repo');
        const branchInput = document.getElementById('gh-branch');
        if(!tkInput || !ownInput || !repInput || !branchInput) return alert("Admin UI Missing.");
        
        const token = tkInput.value.trim();
        const owner = ownInput.value.trim();
        const repo = repInput.value.trim();
        const branch = branchInput.value.trim() || "main";
        
        localStorage.setItem('termos_github_token', token);
        localStorage.setItem('termos_repo_owner', owner);
        localStorage.setItem('termos_repo_name', repo);
        localStorage.setItem('termos_repo_branch', branch);
        
        if (!token) return addSystemMessage("‚ùå Token needed.");
        if (!owner || !repo) return addSystemMessage("‚ùå Repo needed.");
        const input = prompt("Mutation:");
        if (!input) return;
        
        addSystemMessage("üß¨ CLONING SOURCE...");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 40000); 
        try {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/index.html?ref=${branch}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, signal: controller.signal });
            if (!res.ok) { const errText = await res.json(); throw new Error(`Read: ${errText.message}`); }
            const data = await res.json();
            if(!data.content) throw new Error("File not found.");
            const currentContent = atob(data.content);
            
            addSystemMessage("üß¨ MUTATING...");
            const aiReq = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    model: API_MODEL,
                    messages: [{ role: "system", content: "Return ONLY raw code." }, { role: "user", content: `Modify to: "${input}".\n\nCODE:\n` + currentContent }],
                    temperature: 0.5, max_tokens: 8000
                })
            });
            const aiData = await aiReq.json();
            if (aiData.error) throw new Error(`AI Error: ${aiData.error.message}`);
            
            let newCode = aiData.choices[0].message.content;
            if (newCode.startsWith("```html")) newCode = newCode.substring(7);
            else if (newCode.startsWith("```")) newCode = newCode.substring(3);
            if (newCode.endsWith("```")) newCode = newCode.substring(0, newCode.length - 3);
            newCode = newCode.trim();
            
            addSystemMessage("üß¨ UPLOADING...");
            const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/index.html`;
            const encodedContent = btoa(unescape(encodeURIComponent(newCode)));
            const putRes = await fetch(putUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Evolution: " + input,
                    content: encodedContent,
                    sha: data.sha,
                    branch: branch
                }),
                signal: controller.signal
            });
            if (!putRes.ok) throw new Error(`GitHub Write Failed`);
            clearTimeout(timeoutId);
            addSystemMessage("üéâ SUCCESS. REBOOTING...");
            setTimeout(() => location.reload(), 2000);
        } catch (err) {
            clearTimeout(timeoutId);
            addSystemMessage("‚ùå FAIL: " + err.message);
        }
    }
</script>
</body>
</html>
