<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TermOS LT HYBRID üåå</title>
<meta name="theme-color" content="#050505">

<!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- MQTT Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<style>
/* --- CORE STYLES --- */
:root {
    --main-bg: rgba(5, 5, 5, 0.85);
    --term-color: #33ff00;
    --term-glow: 0 0 10px rgba(51, 255, 0, 0.5);
    --danger-color: #ff3333;
    --system-color: #ffff00;
    --user-color: #ffffff;
    --xp-color: #00ffff;
    --font-stack: 'Courier New', Courier, monospace;
    --panel-bg: rgba(10, 10, 10, 0.9);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: text; }

body {
    background-color: #000;
    color: var(--term-color);
    font-family: var(--font-stack);
    height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center;
    overflow: hidden;
    font-size: 14px;
}

/* --- MATRIX CANVAS --- */
#matrix-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* Behind everything */
    pointer-events: none;
}

/* --- LAYOUT --- */
#os-container {
    width: 100%; 
    max-width: 1000px; 
    height: 95vh;
    background-color: var(--main-bg); 
    border: 2px solid var(--term-color);
    display: grid; 
    grid-template-rows: auto 1fr auto;
    position: relative; 
    z-index: 10; /* Above canvas */
    box-shadow: var(--term-glow);
    margin: 10px;
    backdrop-filter: blur(3px);
}

/* Scanlines Overlay */
#os-container::before {
    content: " "; display: block; position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 20; 
    background-size: 100% 2px, 3px 100%; 
    pointer-events: none;
}

/* --- HEADER --- */
header {
    border-bottom: 1px solid var(--term-color); 
    padding: 10px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    z-index: 25; /* Above scanlines */
    background: var(--panel-bg);
}

.header-left, .header-right {
    display: flex;
    gap: 15px;
    align-items: center;
}

.xp-container {
    width: 100px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.xp-bar-bg { width: 100%; height: 6px; background: #333; border: 1px solid var(--term-color); }
.xp-bar-fill { height: 100%; width: 0%; background: var(--xp-color); transition: width 0.5s ease; }

.avatar-display { font-size: 1.2rem; line-height: 1rem; filter: drop-shadow(0 0 5px var(--term-color)); }
.room-badge { border: 1px solid var(--system-color); padding: 2px 8px; font-weight: bold; color: var(--system-color); }

/* --- MAIN AREA --- */
main {
    display: grid;
    grid-template-columns: 200px 1fr;
    overflow: hidden;
    z-index: 25;
}

.sidebar {
    border-right: 1px solid var(--term-color);
    padding: 10px;
    overflow-y: auto;
    background: rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.app-card {
    border: 1px dashed var(--term-color);
    padding: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background 0.2s;
    text-align: center;
}
.app-card:hover { background: rgba(51, 255, 0, 0.2); border-style: solid; }

#terminal-output {
    padding: 20px;
    overflow-y: auto;
    white-space: pre-wrap;
    scroll-behavior: smooth;
    word-wrap: break-word;
    position: relative;
    height: 100%;
}

/* --- FOOTER --- */
footer {
    border-top: 1px solid var(--term-color);
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--panel-bg);
    z-index: 25;
}

.prompt { font-weight: bold; animation: blink 1s step-end infinite; white-space: nowrap; }
input[type="text"] {
    background: transparent; border: none; color: var(--term-color);
    font-family: var(--font-stack); font-size: 1.1rem; flex-grow: 1; text-transform: uppercase;
}

.btn-icon {
    background: none; border: 1px solid var(--term-color);
    color: var(--term-color); padding: 5px 10px; cursor: pointer;
    font-family: var(--font-stack);
}
.btn-icon:hover { background: var(--term-color); color: #000; }
.btn-icon.active { background: var(--term-color); color: #000; animation: pulse 1.5s infinite; }

/* --- VIRTUAL DESKTOP GRID (Dynamic Content) --- */
.v-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    padding: 20px;
}
.v-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 10px;
    border: 1px solid transparent;
}
.v-item:hover { background: rgba(0, 255, 255, 0.1); border: 1px solid var(--xp-color); }
.v-icon { font-size: 2rem; margin-bottom: 5px; }

/* --- TEXT STYLES --- */
.system-msg { color: var(--system-color); opacity: 0.8; }
.user-msg { color: var(--user-color); font-weight: bold; }
.other-msg { color: var(--term-color); }
.ai-msg { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
.error-msg { color: var(--danger-color); font-weight: bold; }
.cmd-msg { color: #ff00ff; }

/* --- UTILS --- */
.hidden { display: none !important; }
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* --- RESPONSIVE --- */
@media (max-width: 700px) {
    #os-container { margin: 0; height: 100vh; border: none; }
    main { grid-template-columns: 1fr; }
    .sidebar { display: none; position: absolute; top: 50px; left: 0; width: 100%; height: 80%; background: #000; border-bottom: 1px solid var(--term-color); z-index: 30; }
    .sidebar.show { display: flex; }
}
</style>
</head>
<body>

<!-- Canvas for Matrix Rain -->
<canvas id="matrix-canvas"></canvas>

<div id="os-container">
    <header>
        <div class="header-left">
            <div id="avatar-box" class="avatar-display">o_o</div>
            <div class="xp-container">
                <span style="font-size:0.7rem">LVL <span id="level-display">1</span></span>
                <div class="xp-bar-bg"><div id="xp-fill" class="xp-bar-fill"></div></div>
            </div>
            <button class="btn-icon" onclick="toggleSidebar()">‚ò∞ MENU</button>
        </div>
        <div class="room-badge" id="current-room">LIBRARY</div>
        <div class="header-right">
            <span id="net-status">OFFLINE</span>
        </div>
    </header>

    <main>
        <div id="sidebar" class="sidebar">
            <div style="color:var(--system-color)">SYSTEM APPS</div>
            <div class="app-card" onclick="runSystemApp('desktop')">üñ•Ô∏è DESKTOP</div>
            <div class="app-card" onclick="runSystemApp('files')">üìÇ FILES</div>
            <div class="app-card" onclick="runSystemApp('scan')">üåê NET SCAN</div>
            
            <div style="color:var(--system-color); margin-top:10px;">ROOMS</div>
            <div class="app-card" onclick="executeSystemCommand('/room library')">üìö LIBRARY</div>
            <div class="app-card" onclick="executeSystemCommand('/room workshop')">üîß WORKSHOP</div>
            <div class="app-card" onclick="executeSystemCommand('/room lounge')">üéÆ LOUNGE</div>

            <div style="color:var(--system-color); margin-top:10px;">CONFIG</div>
            <div class="app-card" onclick="executeSystemCommand('/clear')">üßπ CLEAR</div>
        </div>
        <div id="terminal-output">
            <!-- Boot content will be injected here via JS -->
        </div>
    </main>

    <footer>
        <span class="prompt">></span>
        <input type="text" id="command-input" autocomplete="off" autofocus placeholder="Enter command...">
        <button class="btn-icon" id="voice-btn" onclick="toggleVoice()">üé§</button>
        <button class="btn-icon" onclick="sendMessage()">‚ö°</button>
    </footer>
</div>

<script>
/* =========================================================================
   TERMOS LT: HYBRID FAILSAFE EDITION
   ========================================================================= */

/* --- 1. CONFIGURATION & STATE --- */
const CONFIG = {
    mqtt: { host: "broker.hivemq.com", port: 8884, baseTopic: "termos/lt/v4" },
    // User should replace this for full AI capabilities
    apiKey: localStorage.getItem('termos_groq_key') || "", 
    models: ["llama-3.3-70b-versatile", "llama-3.1-70b-versatile", "gemma2-9b-it"],
    rooms: {
        library: { name: "LIBRARY", persona: "You are a helpful Librarian AI." },
        workshop: { name: "WORKSHOP", persona: "You are a Coder AI. Write code." },
        lounge: { name: "LOUNGE", persona: "You are a fun Gamer AI." }
    }
};

const State = {
    user: JSON.parse(localStorage.getItem('termos_user')) || { 
        nick: "Anon" + Math.floor(Math.random()*1000), 
        xp: 0, 
        level: 1, 
        room: 'library' 
    },
    client: null,
    isConnected: false,
    voiceEnabled: false,
    recognition: null,
    synthesis: window.speechSynthesis
};

/* --- 2. INITIALIZATION --- */
window.onload = () => {
    initMatrix();
    runTerminalBoot();
    updateUI();
    connectMQTT();
};

/* --- 3. MATRIX EFFECT --- */
function initMatrix() {
    const c = document.getElementById('matrix-canvas');
    const ctx = c.getContext('2d');

    function resize() {
        c.width = window.innerWidth; 
        c.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*';
    const fontSize = 14;
    const columns = c.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);

    function drawMatrixRain() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, c.width, c.height);
        
        ctx.fillStyle = '#0F0';
        ctx.font = fontSize + 'px monospace';
        
        for(let i=0; i<drops.length; i++) {
            const text = letters[Math.floor(Math.random()*letters.length)];
            
            // Random cyan highlight
            if (Math.random() > 0.98) ctx.fillStyle = '#00f3ff';
            else ctx.fillStyle = '#0F0';

            ctx.fillText(text, i*fontSize, drops[i]*fontSize);
            if(drops[i]*fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        }
    }
    setInterval(drawMatrixRain, 33);
}

/* --- 4. BOOT SEQUENCE --- */
function runTerminalBoot() {
    const term = document.getElementById('terminal-output');
    term.innerHTML = ""; // Clear previous

    const lines = [
        "INITIALIZING BIOS...",
        "LOADING KERNEL...",
        "MOUNTING VIRTUAL FILESYSTEM...",
        `[OK] MATRIX DRIVER LOADED`,
        `[OK] AUDIO ENGINE READY`,
        `[OK] NEURAL LINK STANDBY`,
        "",
        `WELCOME TO TERMOS LT HYBRID v3.0`,
        `TYPE /HELP FOR COMMANDS.`,
        "------------------------------------------------"
    ];

    let i = 0;
    function typeLine() {
        if (i < lines.length) {
            const div = document.createElement('div');
            div.textContent = lines[i];
            div.className = "system-msg";
            term.appendChild(div);
            scrollToBottom();
            i++;
            setTimeout(typeLine, Math.random() * 100 + 50);
        } else {
            // Add interactive prompt
            addSystemMessage("System Ready. Select Mode or Type Command.");
        }
    }
    typeLine();
}

/* --- 5. UI & DOM HANDLERS --- */
function updateUI() {
    document.getElementById('level-display').innerText = State.user.level;
    const totalForNext = State.user.level * 100;
    const percentage = Math.min(100, (State.user.xp / totalForNext) * 100);
    document.getElementById('xp-fill').style.width = `${percentage}%`;
    
    const avatars = ["o_o", "o.o", "(o.o)", "/\\_/\\", "üßô", "ü§ñ", "üåå"];
    document.getElementById('avatar-box').textContent = avatars[Math.min(State.user.level, avatars.length-1)];
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('show');
}

function scrollToBottom() {
    const el = document.getElementById('terminal-output');
    el.scrollTop = el.scrollHeight;
}

/* --- 6. INPUT HANDLING --- */
const inputField = document.getElementById('command-input');
inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') processInput(inputField.value);
});

async function processInput(rawText) {
    const text = rawText.trim();
    if (!text) return;
    
    inputField.value = "";
    logMessage(State.user.nick, text, "user-msg");
    playSound('type');

    // Command Parsing
    if (text.startsWith('/')) {
        executeSystemCommand(text);
        return;
    }

    // Chat Logic
    if (State.isConnected) {
        const msg = new Paho.MQTT.Message(JSON.stringify({ nick: State.user.nick, text: text }));
        msg.destinationName = `${CONFIG.mqtt.baseTopic}/${State.user.room}`;
        State.client.send(msg);
    }

    // AI Trigger
    // If text starts with AI, HELP, or is just a question
    if (/^(AI|HELP|WHAT|HOW|WHY|CODE|MAKE)/i.test(text) || text.length > 20) {
        queryAI(text);
    } else {
        addXP(1); // Small XP for chatting
    }
}

/* --- 7. COMMAND SYSTEM --- */
function executeSystemCommand(cmd) {
    const parts = cmd.split(' ');
    const command = parts[0].toLowerCase();

    switch (command) {
        case '/help':
            addSystemMessage("CMDS: /ROOM [name], /NICK [name], /CLEAR, /AI [prompt], /KEY [api_key]");
            break;
        case '/room':
            const r = parts[1]?.toLowerCase();
            if (CONFIG.rooms[r]) joinRoom(r);
            else addSystemMessage("INVALID ROOM. TRY LIBRARY, WORKSHOP.", "error-msg");
            break;
        case '/nick':
            State.user.nick = parts[1] || "Anon";
            saveState();
            addSystemMessage(`IDENTITY: ${State.user.nick}`);
            break;
        case '/clear':
            document.getElementById('terminal-output').innerHTML = "";
            break;
        case '/key':
            const key = parts.slice(1).join(' ');
            if (key.length > 10) {
                CONFIG.apiKey = key;
                localStorage.setItem('termos_groq_key', key);
                addSystemMessage("API KEY SAVED.", "system-msg");
            } else {
                addSystemMessage("INVALID KEY FORMAT.", "error-msg");
            }
            break;
        case '/ai':
            const prompt = cmd.substring(4).trim();
            if (prompt) queryAI(prompt);
            else addSystemMessage("USAGE: /AI [prompt]", "error-msg");
            break;
        case '/voice':
            toggleVoice();
            break;
        default:
            addSystemMessage(`UNKNOWN: ${command}`, "error-msg");
    }
}

/* --- 8. SYSTEM APPS (VIRTUAL DESKTOP) --- */
function runSystemApp(appName) {
    const term = document.getElementById('terminal-output');
    toggleSidebar(); // Close sidebar on mobile

    if (appName === 'desktop') {
        term.innerHTML = `
            <div class="system-msg">TERMOS VIRTUAL DESKTOP ENVIRONMENT</div>
            <div class="v-grid">
                <div class="v-item" onclick="runSystemApp('files')">
                    <div class="v-icon">üìÇ</div>
                    <div>FILES</div>
                </div>
                <div class="v-item" onclick="runSystemApp('scan')">
                    <div class="v-icon">üåê</div>
                    <div>NETWORK</div>
                </div>
                <div class="v-item" onclick="executeSystemCommand('/clear')">
                    <div class="v-icon">‚ùå</div>
                    <div>EXIT</div>
                </div>
            </div>
        `;
    } 
    else if (appName === 'files') {
        term.innerHTML = `
            <div class="system-msg">ROOT DIRECTORY: /</div>
            <div style="margin-top:10px; color:var(--term-color)">
                <div>drwxr-xr-x  root  root  4096  SYSTEM_KERNEL</div>
                <div>-rw-r--r--  user  user   520  user_data.json</div>
                <div>-rw-r--r--  user  user  12MB  secret_logs.enc</div>
                <div style="color:var(--xp-color)">[NEW] -rwxr-xr-x  ai    core   ???  neural_net.bin</div>
            </div>
            <button class="btn-icon" style="margin-top:20px" onclick="runSystemApp('desktop')">.. BACK</button>
        `;
    }
    else if (appName === 'scan') {
        addSystemMessage("INITIATING NETWORK SCAN...");
        setTimeout(() => {
            addSystemMessage("PING 192.168.0.1 ... TIMEOUT");
            addSystemMessage("PING 10.0.0.5 ... ALIVE (LATENCY: 12ms)");
            addSystemMessage("HOST DETECTED: GROQ-CLUSTER-01");
        }, 1000);
    }
}

/* --- 9. AI ENGINE (FAILSAFE) --- */
async function queryAI(prompt) {
    if (!CONFIG.apiKey) {
        addSystemMessage("API KEY MISSING. SET IT WITH /KEY [YOUR_KEY]", "error-msg");
        return;
    }

    addSystemMessage("TERMAI IS THINKING...", "ai-msg");

    let success = false;
    let lastError = null;

    // Try models in order of preference (Failsafe mechanism)
    for (const model of CONFIG.models) {
        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": `Bearer ${CONFIG.apiKey}` 
                },
                body: JSON.stringify({
                    model: model, 
                    temperature: 0.7,
                    messages: [
                        { 
                            role: "system", 
                            content: CONFIG.rooms[State.user.room].persona + " Keep answers short, concise, and use uppercase headers for emphasis."
                        }, 
                        { role: "user", content: prompt }
                    ]
                })
            });

            if (!res.ok) throw new Error(res.statusText);
            const json = await res.json();
            const reply = json.choices[0].message.content;
            
            logMessage("AI", reply, "ai-msg");
            speak(reply);
            addXP(10);
            success = true;
            break; 
        } catch (e) {
            lastError = e;
            console.warn(`Model ${model} failed:`, e);
            continue; 
        }
    }

    if (!success) {
        addSystemMessage(`NEURAL LINK FAILED: ${lastError.message}`, "error-msg");
    }
}

/* --- 10. MQTT ENGINE --- */
function connectMQTT() {
    const clientId = `termos-${State.user.nick}-${Date.now()}`;
    State.client = new Paho.MQTT.Client(CONFIG.mqtt.host, CONFIG.mqtt.port, clientId);
    
    State.client.onConnectionLost = (e) => {
        State.isConnected = false;
        document.getElementById('net-status').textContent = "OFFLINE";
        document.getElementById('net-status').style.color = "red";
        // Reconnect logic
        setTimeout(connectMQTT, 5000);
    };

    State.client.onMessageArrived = (msg) => {
        try {
            const data = JSON.parse(msg.payloadString);
            if (data.nick !== State.user.nick) {
                logMessage(data.nick, data.text, "other-msg");
                playSound('alert');
            }
        } catch (e) {}
    };

    const options = {
        timeout: 10, useSSL: true, mqttVersion: 4, cleanSession: true,
        onSuccess: () => {
            State.isConnected = true;
            document.getElementById('net-status').textContent = "ONLINE";
            document.getElementById('net-status').style.color = "#33ff00";
            joinRoom(State.user.room);
            addSystemMessage("UPLINK ESTABLISHED.", "system");
        },
        onFailure: (e) => {
            addSystemMessage("CONN FAILED: " + e.errorMessage, "error-msg");
            setTimeout(connectMQTT, 5000);
        }
    };
    State.client.connect(options);
}

function joinRoom(roomKey) {
    if (!State.isConnected) return;
    // Unsubscribe old
    try { State.client.unsubscribe(`${CONFIG.mqtt.baseTopic}/${State.user.room}`); } catch(e){}

    State.user.room = roomKey;
    const newTopic = `${CONFIG.mqtt.baseTopic}/${roomKey}`;
    State.client.subscribe(newTopic);
    
    document.getElementById('current-room').textContent = CONFIG.rooms[roomKey].name;
    saveState();
    addSystemMessage(`ENTERED: ${CONFIG.rooms[roomKey].name}`, "cmd-msg");
}

function sendMessage() {
    processInput(document.getElementById('command-input').value);
}

/* --- 11. LOGGING HELPERS --- */
function logMessage(nick, text, type) {
    const div = document.createElement('div');
    div.className = type;
    const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute:'2-digit' });
    // Allow HTML in AI messages for formatting, escape others
    const content = type === 'ai-msg' ? text : escapeHtml(text);
    div.innerHTML = `<span style="opacity:0.5">[${time}]</span> <b>&lt;${nick}&gt;</b> ${content}`;
    document.getElementById('terminal-output').appendChild(div);
    scrollToBottom();
}

function addSystemMessage(text) {
    const div = document.createElement('div');
    div.className = "system-msg";
    div.innerHTML = `[SYS] ${text}`;
    document.getElementById('terminal-output').appendChild(div);
    scrollToBottom();
}

function saveState() {
    localStorage.setItem('termos_user', JSON.stringify(State.user));
}

function addXP(amount) {
    State.user.xp += amount;
    const nextLevel = State.user.level * 100;
    if (State.user.xp >= nextLevel) {
        State.user.level++;
        State.user.xp -= nextLevel;
        addSystemMessage(`LEVEL UP! LVL ${State.user.level}`, "ai-msg");
        playSound('success');
    }
    saveState();
    updateUI();
}

/* --- 12. VOICE --- */
function initVoice() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    State.recognition = new SpeechRecognition();
    State.recognition.continuous = false;
    State.recognition.lang = 'en-US';
    State.recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        document.getElementById('command-input').value = text;
        processInput(text);
    };
    State.recognition.onend = () => {
        document.getElementById('voice-btn').classList.remove('active');
        State.voiceEnabled = false;
    };
}

function toggleVoice() {
    if (!State.recognition) initVoice();
    if (State.voiceEnabled) {
        State.recognition.stop();
    } else {
        State.recognition.start();
        document.getElementById('voice-btn').classList.add('active');
        State.voiceEnabled = true;
    }
}

function speak(text) {
    if (State.synthesis.speaking) State.synthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.pitch = 0.8; 
    utterance.rate = 1.2;
    State.synthesis.speak(utterance);
}

/* --- 13. AUDIO & UTILS --- */
const AudioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (AudioCtx.state === 'suspended') AudioCtx.resume();
    const osc = AudioCtx.createOscillator();
    const gain = AudioCtx.createGain();
    osc.connect(gain);
    gain.connect(AudioCtx.destination);
    
    if (type === 'type') {
        osc.frequency.value = 800;
        gain.gain.value = 0.05;
        osc.start(); osc.stop(AudioCtx.currentTime + 0.05);
    } else if (type === 'alert') {
        osc.frequency.setValueAtTime(150, AudioCtx.currentTime);
        gain.gain.value = 0.1;
        osc.start(); osc.stop(AudioCtx.currentTime + 0.2);
    } else if (type === 'success') {
        osc.frequency.setValueAtTime(440, AudioCtx.currentTime);
        osc.frequency.setValueAtTime(880, AudioCtx.currentTime + 0.1);
        gain.gain.value = 0.1;
        osc.start(); osc.stop(AudioCtx.currentTime + 0.3);
    }
}

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
</body>
</html>
