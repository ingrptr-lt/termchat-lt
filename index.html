<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TermChat">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00ff00">
    <meta name="msapplication-navbutton-color" content="#00ff00">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' https: data:; connect-src 'self' wss: https: ws:; font-src 'self' data:;">
    <title>TermChat LT</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#00ff00">

    <!-- MQTT Library for Real-time Chat -->
    <script src="./paho-mqtt.min.js" type="text/javascript"></script>

    <style>
        /* --- CRT & RETRO EFFECTS --- */
        :root {
            --term-color: #33ff00;
            --term-bg: #050505;
        }
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background-color: var(--term-bg);
            color: var(--term-color);
            font-family: 'Courier New', Courier, monospace;
        }
        
        body {
            overflow: hidden;
            height: 100vh;
            text-shadow: 0 0 4px var(--term-color);
            -webkit-text-size-adjust: 100%;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Scanlines Overlay */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Screen Flicker Animation */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.95; }
            10% { opacity: 0.9; }
            15% { opacity: 0.95; }
            20% { opacity: 0.99; }
            50% { opacity: 0.95; }
            100% { opacity: 0.98; }
        }
        #terminal-body { animation: flicker 0.15s infinite; }

        /* THEME COLORS (Variables) */
        .theme-living { --term-color: #33ff00; }
        .theme-library { --term-color: #ffb000; }
        .theme-studio { --term-color: #ff00ff; }
        .theme-workshop { --term-color: #00ffff; }
        .theme-think { --term-color: #00ff41; }
        .theme-lounge { --term-color: #ff3333; }

        /* Apply Variable to Elements */
        body.theme-living, body.theme-library, body.theme-studio, body.theme-workshop, body.theme-think, body.theme-lounge {
            color: var(--term-color);
            text-shadow: 0 0 5px var(--term-color);
        }
        
        /* Fix Chrome rendering */
        body {
            background: var(--term-bg) !important;
            color: var(--term-color) !important;
        }

        /* Container and Layout */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .ascii-header {
            border-bottom: 1px solid var(--term-color);
            margin-bottom: 10px;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--term-color);
            padding: 10px;
            margin-bottom: 10px;
        }

        .input-line {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-line input {
            flex: 1;
            background: #000;
            border: 1px solid var(--term-color);
            color: var(--term-color);
            padding: 10px;
            font-family: 'Courier New', monospace;
        }

        /* Boot Screen */
        #boot-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            color: #33ff00;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
        }

        .boot-text {
            font-size: 14px;
            margin: 2px 0;
            opacity: 0;
            animation: bootText 0.1s forwards;
        }

        @keyframes bootText {
            to { opacity: 1; }
        }

        .cursor {
            display: inline-block;
            background: #33ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Terminal Body */
        #terminal-body {
            display: none;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        .log-entry {
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            text-shadow: var(--term-glow);
            font-weight: bold;
            opacity: 0;
            animation: fadeInText 0.3s forwards;
            letter-spacing: 0.5px;
        }

        @keyframes fadeInText { 
            to { opacity: 1; } 
        }

        .system-msg { 
            color: var(--term-green);
            border-left: 3px solid var(--term-green);
            padding-left: 10px;
        }

        .stranger-msg { 
            color: var(--cyan); 
            text-shadow: var(--cyan-glow); 
            border-left: 3px solid var(--cyan);
            padding-left: 10px;
        }

        .error-msg { 
            color: var(--error-red); 
            text-shadow: 0 0 5px rgba(255, 50, 50, 0.7);
            border-left: 3px solid var(--error-red);
            padding-left: 10px;
        }

        .greeting-msg { 
            color: var(--success-green); 
            font-weight: 900;
            text-shadow: 0 0 8px rgba(204, 255, 204, 0.5);
            border-left: 3px solid var(--success-green);
            padding-left: 10px;
        }

        .timestamp {
            color: var(--term-dim);
            margin-right: 8px;
            font-size: 11px;
            opacity: 0.7;
            display: inline-block;
        }

        .cursor-block {
            display: inline-block;
            width: 10px;
            height: 18px;
            background-color: var(--term-green);
            vertical-align: middle;
            animation: blink 0.8s step-end infinite;
            box-shadow: var(--term-glow);
        }

        @keyframes blink { 
            50% { opacity: 0; } 
        }

        /* INPUT AREA */
        #input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), var(--term-bg));
            border-top: 2px solid var(--term-green);
            padding: 12px 15px max(10px, env(safe-area-inset-bottom));
            display: flex;
            align-items: center;
            z-index: 10;
            gap: 8px;
            box-shadow: 0 -2px 15px rgba(0, 255, 0, 0.2);
        }

        .prompt {
            font-size: 16px;
            color: var(--term-green);
            text-shadow: var(--term-glow);
            font-weight: bold;
            min-width: 20px;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--term-dim);
            color: var(--term-green);
            font-family: var(--font-stack);
            font-size: 14px;
            outline: none;
            text-shadow: var(--term-glow);
            caret-color: var(--term-green);
            text-transform: uppercase;
            padding: 8px 0;
            transition: all 0.2s;
        }

        input:focus {
            border-bottom-color: var(--term-green);
            box-shadow: 0 1px 5px var(--term-glow);
        }

        input::placeholder { 
            color: var(--term-dim); 
            text-transform: uppercase;
            opacity: 0.5;
        }

        #listen-btn {
            background: transparent;
            border: 2px solid var(--term-green);
            color: var(--term-green);
            font-family: var(--font-stack);
            font-size: 12px;
            padding: 8px 14px;
            cursor: pointer;
            text-shadow: var(--term-glow);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: 1px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        #listen-btn:hover {
            background-color: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 15px var(--term-glow), inset 0 0 15px rgba(0, 255, 0, 0.2);
            transform: scale(1.05);
        }

        #listen-btn:active {
            transform: scale(0.95);
        }

        #listen-btn.playing {
            background-color: var(--term-green);
            color: var(--term-bg);
            box-shadow: 0 0 20px var(--term-glow-strong), inset 0 0 20px rgba(0, 255, 0, 0.4);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px var(--term-glow-strong), inset 0 0 20px rgba(0, 255, 0, 0.4); }
            50% { box-shadow: 0 0 30px var(--term-glow-strong), inset 0 0 30px rgba(0, 255, 0, 0.6); }
        }

        /* Header Title */
        .header-title {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, var(--term-bg), rgba(0, 0, 0, 0));
            padding: 15px;
            z-index: 5;
            border-bottom: 1px solid var(--term-dim);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .title-text {
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: var(--term-glow);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--term-green);
            box-shadow: var(--term-glow);
            animation: pulse-dot 2s ease-in-out infinite;
        }

        .status-indicator.offline {
            background-color: var(--error-red);
            animation: pulse-dot-error 1s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-dot-error {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .user-id {
            font-size: 11px;
            color: var(--term-dim);
            letter-spacing: 1px;
        }

        /* Mobile & Device Compatibility */
        @media screen and (max-width: 768px) {
            body { font-size: 14px; }
            .container { padding: 5px; }
            input { font-size: 16px; } /* Prevent zoom on iOS */
        }
        
        @media screen and (max-height: 600px) {
            .chat-area { height: 60vh; }
        }
        
        /* Landscape mobile */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .chat-area { height: 50vh; }
        }
        
        /* Tablet */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            body { max-width: 90%; margin: 0 auto; }
        }
        
        /* Desktop */
        @media screen and (min-width: 1024px) {
            body { max-width: 800px; margin: 0 auto; }
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--term-bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-title {
            font-size: 24px;
            color: var(--term-green);
            text-shadow: var(--term-glow);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 3px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            max-width: 300px;
            width: 100%;
        }

        #username-input {
            background: transparent;
            border: 2px solid var(--term-green);
            color: var(--term-green);
            font-family: var(--font-stack);
            font-size: 16px;
            padding: 12px 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            outline: none;
            width: 100%;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        #username-input:focus {
            box-shadow: 0 0 15px var(--term-glow), inset 0 0 15px rgba(0, 255, 0, 0.2);
        }

        #login-btn {
            background: transparent;
            border: 2px solid var(--term-green);
            color: var(--term-green);
            font-family: var(--font-stack);
            font-size: 14px;
            padding: 12px 24px;
            cursor: pointer;
            text-shadow: var(--term-glow);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            min-width: 150px;
        }

        #login-btn:hover {
            background-color: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 15px var(--term-glow);
        }

        .login-error {
            color: var(--error-red);
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }

        /* Avatar and Photo Gallery */
        #photo-upload {
            display: none;
        }

        #avatar-btn {
            background: transparent;
            border: 2px solid var(--term-green);
            color: var(--term-green);
            font-family: var(--font-stack);
            font-size: 12px;
            padding: 8px 14px;
            cursor: pointer;
            text-shadow: var(--term-glow);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: 1px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
            margin-left: 5px;
        }

        #avatar-btn:hover {
            background-color: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 15px var(--term-glow), inset 0 0 15px rgba(0, 255, 0, 0.2);
            transform: scale(1.05);
        }

        #avatar-btn:active {
            transform: scale(0.95);
        }

        .avatar-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--term-green);
            object-fit: cover;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-avatar {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--term-green);
            object-fit: cover;
            margin-right: 5px;
            vertical-align: middle;
            box-shadow: 0 0 3px rgba(0, 255, 0, 0.4);
        }

        #bg-photo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
        }

        /* Adjust screen to account for background */
        #screen {
            position: relative;
            z-index: 1;
        }

        .input-area-wrapper {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="theme-living">
    <!-- Content will be dynamically generated by boot sequence -->
    <script src="./paho-mqtt.min.js" type="text/javascript"></script>

    <script>
        // Enhanced BIOS Boot Sequence with Safari compatibility
        document.addEventListener('DOMContentLoaded', function() {
            startBoot();
        });
        
        window.addEventListener('load', function() {
            if (!document.body.hasChildNodes()) {
                startBoot();
            }
        });
        
        function startBoot() {
            try {
                // Detect device type
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isTablet = /iPad|Android/i.test(navigator.userAgent) && window.innerWidth > 768;
                
                const screen = document.body;
                screen.innerHTML = ""; // Clear screen
                screen.style.backgroundColor = '#050505';
                screen.style.color = '#33ff00';
                screen.style.fontFamily = 'Courier New, monospace';
                screen.style.padding = '20px';
                
                const deviceType = isMobile ? "MOBILE" : isTablet ? "TABLET" : "DESKTOP";
                
                const bootText = [
                    "BIOS DATE 01/01/2025 15:42:00 VER 1.0",
                    `DEVICE: ${deviceType} DETECTED`,
                    "CPU: QUANTUM CORE... OK",
                    "MEMORY: 64TB DETECTED...",
                    "LOADING KERNEL...",
                    "INITIALIZING NEURAL LINK (ZHIPU AI)...",
                    "CONNECTING TO MQTT BROKER...",
                    "SYSTEM READY."
                ];

                let i = 0;
                function typeLine() {
                    if (i < bootText.length) {
                        const p = document.createElement('div');
                        p.innerText = "> " + bootText[i];
                        p.style.color = '#33ff00';
                        p.style.fontFamily = 'Courier New, monospace';
                        p.style.margin = '5px 0';
                        screen.appendChild(p);
                        window.scrollTo(0, document.body.scrollHeight);
                        setTimeout(typeLine, 400);
                        i++;
                    } else {
                        setTimeout(showLogin, 500);
                    }
                }
                typeLine();
            } catch (e) {
                console.error('Boot error:', e);
                showLogin();
            }
        };

        function showLogin() {
            try {
                const isMobile = window.innerWidth <= 768;
                const buttonStyle = isMobile ? 'padding:15px; font-size:16px;' : 'padding:10px;';
                const inputStyle = isMobile ? 'padding:15px; font-size:16px;' : 'padding:10px;';
                
                // Ensure body styling for Chrome
                document.body.style.backgroundColor = '#050505';
                document.body.style.color = '#33ff00';
                document.body.style.fontFamily = 'Courier New, monospace';
                document.body.style.margin = '0';
                document.body.style.padding = '0';
                document.body.style.height = '100vh';
                
                document.body.innerHTML = `
                    <div style="display:flex; justify-content:center; align-items:center; height:100vh; padding:20px; background:#050505; min-height:100vh;">
                        <div style="border: 2px solid #33ff00; padding: 40px; background: rgba(0,20,0,0.9); max-width:400px; width:100%; border-radius:5px;">
                            <h2 style="text-align:center; color:#33ff00; margin:0 0 20px 0; font-family: 'Courier New', monospace; font-size:24px;">TERMOS LT</h2>
                            <p style="color:#33ff00; text-align:center; margin:0 0 20px 0; font-family: 'Courier New', monospace; font-size:14px;">PRISIJUNKITE VARTOTOJU</p>
                            <input type="text" id="usernameInput" placeholder="Username" 
                                   style="background:#000; border:1px solid #33ff00; color:#33ff00; width:100%; ${inputStyle} box-sizing:border-box; margin-bottom:20px; font-family: 'Courier New', monospace; display:block;">
                            <button onclick="login()" 
                                    style="background:#33ff00; color:#000; width:100%; ${buttonStyle} font-weight:bold; cursor:pointer; border:none; box-sizing:border-box; font-family: 'Courier New', monospace; display:block;">ENTER SYSTEM</button>
                        </div>
                    </div>
                `;
                
                // Focus input after render
                setTimeout(() => {
                    const input = document.getElementById('usernameInput');
                    if (input) {
                        input.focus();
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') login();
                        });
                    }
                }, 100);
            } catch (e) {
                console.error('Login screen error:', e);
                document.body.style.backgroundColor = '#050505';
                document.body.style.color = '#33ff00';
                document.body.innerHTML = '<div style="color:#33ff00; padding:20px; font-family:monospace;">ERROR: Please refresh page</div>';
            }
        }
        // Multiverse Frontend Functions
        function initMqtt(user) {
            try {
                // Initialize MQTT connection
                const client = new Paho.MQTT.Client("broker.emqx.io", 8084, "termos_" + Math.random().toString(36).substr(2, 9));
                
                client.onConnectionLost = (responseObject) => {
                    if (responseObject.errorCode !== 0) {
                        log("[SYSTEM] Connection lost: " + responseObject.errorMessage, 'error');
                    }
                };
                
                client.onMessageArrived = (message) => {
                    const topic = message.destinationName;
                    const payload = message.payloadString;
                    
                    try {
                        const data = JSON.parse(payload);
                        
                        // Regular chat messages
                        if (data.id && data.msg) {
                            const messageType = data.id === 'TERMAI' ? 'ai' : 'user';
                            log(`[${data.id}] ${data.msg}`, messageType);
                        }
                    } catch(e) {
                        // Plain text message
                        log(payload, 'msg');
                    }
                };
                
                // Connect and subscribe
                client.connect({
                    onSuccess: () => {
                        log("[TERMOS] Connected to chat!", 'system');
                        client.subscribe("termchat/output");
                        
                        // Send join message
                        const joinMsg = {
                            id: user,
                            msg: "joined the chat",
                            timestamp: Date.now()
                        };
                        client.publish("termchat/input", JSON.stringify(joinMsg));
                    },
                    onFailure: (error) => {
                        log("[ERROR] Connection failed: " + error.errorMessage, 'error');
                    },
                    useSSL: true
                });
                
                // Store client globally
                window.mqttClient = client;
                window.currentUser = user;
                
                // Setup input handler
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            sendMessage(chatInput.value);
                            chatInput.value = '';
                        }
                    });
                }
            } catch (e) {
                log("[ERROR] MQTT initialization failed: " + e.message, 'error');
            }
        }

        // Panel Management
        function openPanel(panelId) {
            document.getElementById(panelId).style.display = 'block';
        }

        function closePanel(panelId) {
            document.getElementById(panelId).style.display = 'none';
        }

        // Messaging
        function sendMessage(text) {
            if (text.trim() && window.mqttClient && window.mqttClient.isConnected()) {
                const message = {
                    id: window.currentUser,
                    msg: text,
                    timestamp: Date.now()
                };
                
                try {
                    window.mqttClient.publish("termchat/input", JSON.stringify(message));
                    log(`[${window.currentUser}] ${text}`, 'user');
                } catch (e) {
                    log(`[ERROR] Failed to send message: ${e.message}`, 'error');
                }
            }
        }

        function log(text, type = 'msg') {
            const terminal = document.getElementById('terminal-body');
            if (!terminal) return;
            
            const div = document.createElement('div');
            div.style.color = getTypeColor(type);
            div.style.marginBottom = '5px';
            div.style.fontFamily = 'Courier New, monospace';
            div.innerHTML = text;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function getTypeColor(type) {
            const colors = {
                'system': '#33ff00',
                'user': '#00ffff',
                'error': '#ff3333',
                'ai': '#00ff00',
                'msg': '#33ff00'
            };
            return colors[type] || '#33ff00';
        }
        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username.length >= 3) {
                // Simple chat interface
                document.body.innerHTML = `
                    <div style="height:100vh; display:flex; flex-direction:column; background:#050505; color:#33ff00; font-family:monospace; padding:10px;">
                        <div style="border-bottom:1px solid #33ff00; padding:10px; text-align:center;">
                            <h3>TERMCHAT LT - ${username}</h3>
                        </div>
                        <div id="messages" style="flex:1; overflow-y:auto; padding:10px; background:#000; margin:10px 0;"></div>
                        <div style="display:flex; gap:10px;">
                            <input id="messageInput" type="text" placeholder="Type message..." 
                                   style="flex:1; background:#000; border:1px solid #33ff00; color:#33ff00; padding:10px; font-family:monospace;">
                            <button onclick="sendMsg()" style="background:#33ff00; color:#000; border:none; padding:10px 20px; cursor:pointer;">SEND</button>
                        </div>
                    </div>
                `;
                
                window.username = username;
                connectMQTT();
                
                document.getElementById('messageInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMsg();
                });
            } else {
                alert('Username must be at least 3 characters');
            }
        }
        
        function connectMQTT() {
            try {
                const client = new Paho.MQTT.Client("broker.emqx.io", 8084, "client_" + Math.random());
                
                client.onMessageArrived = function(message) {
                    const data = JSON.parse(message.payloadString);
                    addMessage(data.user, data.text);
                };
                
                client.connect({
                    onSuccess: function() {
                        addMessage('SYSTEM', 'Connected to chat!');
                        client.subscribe('termchat/messages');
                        window.mqttClient = client;
                    },
                    onFailure: function() {
                        addMessage('ERROR', 'Failed to connect');
                    },
                    useSSL: true
                });
            } catch(e) {
                addMessage('ERROR', 'MQTT Error: ' + e.message);
            }
        }
        
        function sendMsg() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (text && window.mqttClient) {
                const msg = { user: window.username, text: text };
                window.mqttClient.publish('termchat/messages', JSON.stringify(msg));
                input.value = '';
            }
        }
        
        function addMessage(user, text) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.style.color = user === 'SYSTEM' ? '#00ff00' : user === 'ERROR' ? '#ff0000' : '#33ff00';
            div.textContent = `[${user}] ${text}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // After login, inject the Main Terminal Layout
        function loadMainInterface(username) {
            document.body.style.backgroundColor = '#050505';
            document.body.style.color = '#33ff00';
            document.body.innerHTML = `
                <div style="display:flex; flex-direction:column; height:100vh; padding:10px; background:#050505; color:#33ff00; font-family:'Courier New',monospace;">
                    <!-- HEADER -->
                    <div id="room-header" style="border-bottom:1px solid #33ff00; margin-bottom:10px; padding:10px; text-align:center;">
                        <h2 style="color:#33ff00; margin:0;">üè† LIVING ROOM</h2>
                        <div style="font-size:12px; opacity:0.7;">Navigation: "biblioteka" | "studija" | "dirbtuvƒós" | "poilsio" | "laboratorija"</div>
                    </div>
                    <!-- MAIN CHAT -->
                    <div id="terminal-body" style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.8); border:1px solid #33ff00; padding:10px; margin-bottom:10px;"></div>
                    <!-- INPUT -->
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="color:#33ff00;">USER:${username}&gt;</span>
                        <input type="text" id="chatInput" autocomplete="off" autofocus 
                               style="flex:1; background:#000; border:1px solid #33ff00; color:#33ff00; padding:10px; font-family:'Courier New',monospace;">
                    </div>
                </div>
            `;

            // Initialize MQTT & Listeners
            initMqtt(username);
        }
        // Text-to-Speech for AI responses
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'lt-LT'; // Lithuanian
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                speechSynthesis.speak(utterance);
            }
        }

        // AI Graphics Generation
        function generateAIGraphics(prompt) {
            const canvas = aiCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            canvas.style.display = 'block';
            
            // Simple procedural graphics based on prompt
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Generate based on keywords
            if (prompt.includes('circle') || prompt.includes('apskritimas')) {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(200, 150, 80, 0, Math.PI * 2);
                ctx.fill();
            } else if (prompt.includes('square') || prompt.includes('kvadratas')) {
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(150, 100, 100, 100);
            } else {
                // Default: animated pattern
                for (let i = 0; i < 50; i++) {
                    ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 10, 10);
                }
            }
            
            log("AI GRAFIKA SUGENERUOTA ‚ú®", 'greeting-msg');
        }

        // Voice Recording
        let mediaRecorder;
        let audioChunks = [];
        
        function startVoiceRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        log(`BALSO ƒÆRA≈†AS BAIGTAS üé§`, 'system-msg');
                        
                        // Send audio message
                        if (client && client.isConnected()) {
                            const audioMsg = new Paho.MQTT.Message(JSON.stringify({
                                type: 'audio',
                                id: userID,
                                audio: audioUrl
                            }));
                            audioMsg.destinationName = TOPIC;
                            client.send(audioMsg);
                        }
                    };
                    
                    mediaRecorder.start();
                    voiceBtn.textContent = '‚èπ STOP';
                    voiceBtn.style.backgroundColor = '#ff3333';
                    log("BALSO ƒÆRA≈†YMAS PRASIDƒñJO üî¥", 'system-msg');
                })
                .catch(err => {
                    log("MIKROFONO KLAIDA: " + err.message, 'error-msg');
                });
        }
        
        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                voiceBtn.textContent = 'üé§ VOICE';
                voiceBtn.style.backgroundColor = '';
            }
        }

        const BROKER_HOST = "broker.emqx.io";
        const BROKER_PORT = 8084;
        const TOPIC = "term-chat/global/v3";
        let userID = null;

        const screen = document.getElementById('screen');
        const input = document.getElementById('msg-input');
        const listenBtn = document.getElementById('listen-btn');
        const radioPlayer = document.getElementById('radio-player');
        const statusDot = document.getElementById('status-dot');
        const userDisplay = document.getElementById('user-display');
        const photoUpload = document.getElementById('photo-upload');
        const avatarBtn = document.getElementById('avatar-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const videoBtn = document.getElementById('video-btn');
        const audioUpload = document.getElementById('audio-upload');
        const videoUpload = document.getElementById('video-upload');
        const ttsPlayer = document.getElementById('tts-player');
        const videoPlayer = document.getElementById('video-player');
        const aiCanvas = document.getElementById('ai-canvas');
        const bgPhoto = document.getElementById('bg-photo');
        let client = null;

        // Radio streaming URLs with fallbacks (browser-compatible)
        const RADIO_STREAMS = [
            "https://stream.zeno.fm/0r0xa792kwzuv",
            "https://stream.zeno.fm/f3wvbbqmdg8uv", 
            "https://stream.zeno.fm/dg9u758fp68uv",
            "https://radio.garden/api/ara/content/listen/rVgpPQbN/channel.mp3",
            "https://stream.rcast.net/70643"
        ];
        let currentStreamIndex = 0;
        let isPlaying = false;

        // Avatar and Photo Gallery
        let userAvatar = null; // Base64 encoded avatar
        let userPhotos = []; // Array of photo data URLs
        
        // User management
        let connectedUsers = new Set();
        let messageQueue = [];
        const MAX_MESSAGES = 100;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // --- TYPEWRITER EFFECT ---
        function typeWriter(text, element, speed = 30) {
            return new Promise(resolve => {
                let i = 0;
                const span = document.createElement('span');
                element.appendChild(span);
                const cursor = document.createElement('span');
                cursor.className = 'cursor-block';
                element.appendChild(cursor);

                function type() {
                    if (i < text.length) {
                        span.textContent += text.charAt(i);
                        i++;
                        screen.scrollTop = screen.scrollHeight;
                        setTimeout(type, speed);
                    } else {
                        cursor.style.display = 'none';
                        resolve();
                    }
                }
                type();
            });
        }

        // --- VISUAL NOTIFICATION (FLASH) ---
        function flashNotification() {
            document.body.classList.remove('notify-flash');
            void document.body.offsetWidth; // trigger reflow
            document.body.classList.add('notify-flash');
        }

        // --- MAIN BOOT SEQUENCE ---
        async function bootSystem() {
            userDisplay.textContent = userID;
            
            const div = document.createElement('div');
            div.className = 'log-entry system-msg';
            screen.appendChild(div);

            // Lithuanian Boot Messages
            await typeWriter("INICIALIZUOJAMA SISTEMA...", div);
            await typeWriter("KRAUNAMI TINKLO TVARKYKLƒñS...", div);
            await typeWriter("JUNGIAMASI PRIE SERVERIO...", div);
            initMQTT();
        }

        // --- MQTT LOGIC ---
        function initMQTT() {
            try {
                client = new Paho.MQTT.Client(BROKER_HOST, BROKER_PORT, "web_" + parseInt(Math.random() * 100000, 10));
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;
                
                // Safari-compatible connection options
                const connectOptions = {
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    useSSL: true,
                    timeout: 10,
                    keepAliveInterval: 30,
                    cleanSession: true
                };
                
                client.connect(connectOptions);
            } catch (error) {
                log("SAFARI KLAIDA: " + error.message, 'error-msg');
                setTimeout(initMQTT, 5000);
            }
        }

        function onConnect() {
            log("SISTEMA PRIJUNGTA.", 'system-msg');
            log(`NAUDOTOJAS: ${userID}`, 'system-msg');
            statusDot.classList.remove('offline');
            reconnectAttempts = 0;
            client.subscribe(TOPIC);
            input.focus();

            // Announce Join
            const announceMsg = new Paho.MQTT.Message(JSON.stringify({ type: 'join', id: userID }));
            announceMsg.destinationName = TOPIC;
            client.send(announceMsg);
        }

        function onFailure(responseObject) {
            log("KLAIDA: " + (responseObject.errorMessage || 'Ne≈æinoma klaida'), 'error-msg');
            reconnectAttempts++;
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                setTimeout(initMQTT, 3000 * reconnectAttempts);
            } else {
                log("NEPAVYKO PRISIJUNGTI. PERKRAUKITE PUSLAPƒÆ.", 'error-msg');
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                log("RY≈†YS PRARASTAS. BANDOM I≈† NAUJO...", 'error-msg');
                statusDot.classList.add('offline');
                setTimeout(initMQTT, 3000);
            }
        }

        function onMessageArrived(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                if (!payload || !payload.id) return;

                // Skip own messages except for chat messages from other users
                if (payload.id === userID && payload.type !== 'chat') return;

                // Prevent duplicate user notifications
                if (payload.type === 'join') {
                    if (payload.id === userID) return; // Skip own join messages
                    if (connectedUsers.has(payload.id)) return;
                    connectedUsers.add(payload.id);
                    
                    flashNotification();
                    log(`NAUJAS NAUDOTOJAS: ${payload.id}`, 'system-msg');

                    // Simplified greeting - no auto-fill to prevent conflicts
                    setTimeout(() => {
                        log(`PASISVEIKINIMAS: LABAS / HI / HELLO`, 'greeting-msg');
                    }, 800);

                } else if (payload.type === 'chat') {
                    // Show all chat messages including own messages echoed back
                    const sanitizedMsg = payload.msg ? escapeHtml(payload.msg.substring(0, 500)) : '';
                    let msgHTML = `<${escapeHtml(payload.id)}> ${sanitizedMsg}`;
                    if (payload.avatar && payload.avatar.startsWith('data:image/')) {
                        msgHTML = `<img src="${payload.avatar}" class="user-avatar" alt="${escapeHtml(payload.id)}"> <${escapeHtml(payload.id)}> ${sanitizedMsg}`;
                    }
                    
                    // Use different styling for own messages vs others
                    const messageType = payload.id === userID ? 'system-msg' : 
                                      payload.id === 'TERMAI' ? 'greeting-msg' : 'stranger-msg';
                    log(msgHTML, messageType);
                    
                    // AI multimedia responses
                    if (payload.id === 'TERMAI') {
                        // Text-to-Speech for AI responses
                        if (sanitizedMsg.length < 200) {
                            setTimeout(() => speakText(sanitizedMsg), 500);
                        }
                        
                        // Check for graphics commands
                        if (sanitizedMsg.includes('grafika') || sanitizedMsg.includes('graphics') || 
                            sanitizedMsg.includes('pie≈°') || sanitizedMsg.includes('draw')) {
                            setTimeout(() => generateAIGraphics(sanitizedMsg), 1000);
                        }
                    }
                    
                } else if (payload.type === 'avatar') {
                    if (payload.id === userID) return; // Skip own avatar updates
                    if (payload.avatar && payload.avatar.startsWith('data:image/')) {
                        log(`NAUDOTOJAS ${escapeHtml(payload.id)} ATNAUJINO AVATAR.`, 'system-msg');
                        localStorage.setItem('userAvatar_' + payload.id, payload.avatar);
                    }
                } else if (payload.type === 'leave') {
                    if (payload.id === userID) return; // Skip own leave messages
                    connectedUsers.delete(payload.id);
                    log(`NAUDOTOJAS ATSIJUNGƒñ: ${escapeHtml(payload.id)}`, 'system-msg');
                }
                
                // Limit message history to prevent memory issues
                limitMessages();
                
            } catch (e) { 
                console.error('Message parsing error:', e);
            }
        }

        function limitMessages() {
            const messages = screen.querySelectorAll('.log-entry');
            if (messages.length > MAX_MESSAGES) {
                for (let i = 0; i < messages.length - MAX_MESSAGES; i++) {
                    messages[i].remove();
                }
            }
        }

        function log(text, type = 'user-msg') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            const now = new Date();
            const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

            if (type === 'system-msg' || type === 'error-msg') {
                div.innerText = `[${time}] ${text}`;
            } else {
                div.innerHTML = `<span class="timestamp">[${time}]</span> ${text}`;
            }
            screen.appendChild(div);
            screen.scrollTop = screen.scrollHeight;
        }

        function sendMessage() {
            const text = input.value.trim();
            if (text && client && client.isConnected() && text.length <= 500) {
                const messageData = {
                    type: 'chat',
                    id: userID,
                    msg: text
                };
                
                // Include avatar if available
                if (userAvatar && userAvatar.startsWith('data:image/')) {
                    messageData.avatar = userAvatar;
                }
                
                try {
                    const message = new Paho.MQTT.Message(JSON.stringify(messageData));
                    message.destinationName = TOPIC;
                    client.send(message);
                } catch (e) {
                    log("KLAIDA SIUNƒåIANT ≈ΩINUTƒò", 'error-msg');
                }
                input.value = '';
            }
        }

        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        // --- RADIO LISTENER ---
        listenBtn.addEventListener('click', function () {
            if (isPlaying) {
                radioPlayer.pause();
                radioPlayer.currentTime = 0;
                listenBtn.classList.remove('playing');
                listenBtn.textContent = 'LISTEN';
                isPlaying = false;
                log("RADIJO SRAUTAS SUSTABDYTAS ‚èπ", 'system-msg');
            } else {
                tryNextRadioStream();
            }
        });

        function tryNextRadioStream() {
            if (currentStreamIndex >= RADIO_STREAMS.length) {
                log("VISI RADIJO SRAUTAI NEPASIEKIAMI", 'error-msg');
                listenBtn.textContent = 'LISTEN';
                listenBtn.disabled = false;
                return;
            }

            listenBtn.textContent = 'CONNECTING...';
            listenBtn.disabled = true;
            
            const streamUrl = RADIO_STREAMS[currentStreamIndex];
            radioPlayer.src = streamUrl;
            radioPlayer.crossOrigin = "anonymous";
            
            const playPromise = radioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        listenBtn.classList.add('playing');
                        listenBtn.textContent = 'STOP ‚è∏';
                        listenBtn.disabled = false;
                        isPlaying = true;
                        const streamName = getStreamName(streamUrl);
                        log(`RADIJAS GROJA ‚ô´ ${streamName}`, 'greeting-msg');
                    })
                    .catch(err => {
                        console.error('Radio stream failed:', streamUrl, err);
                        currentStreamIndex++;
                        setTimeout(tryNextRadioStream, 1000);
                    });
            }
        }

        function getStreamName(url) {
            if (url.includes('zeno.fm/0r0xa792kwzuv')) return 'CHILL RADIO';
            if (url.includes('zeno.fm/f3wvbbqmdg8uv')) return 'ELECTRONIC BEATS';
            if (url.includes('zeno.fm/dg9u758fp68uv')) return 'AMBIENT SOUNDS';
            if (url.includes('radio.garden')) return 'RADIO GARDEN';
            if (url.includes('rcast.net')) return 'INTERNET RADIO';
            return 'LIVE STREAM';
        }

        radioPlayer.addEventListener('error', (e) => {
            const errorCodes = {
                1: 'MEDIA_ERR_ABORTED',
                2: 'MEDIA_ERR_NETWORK',
                3: 'MEDIA_ERR_DECODE',
                4: 'MEDIA_ERR_SRC_NOT_SUPPORTED'
            };
            const errorCode = radioPlayer.error ? radioPlayer.error.code : 'unknown';
            const errorName = errorCodes[errorCode] || 'Unknown Error';
            
            console.error('Radio error:', errorName);
            
            // Try next stream on error
            if (isPlaying || listenBtn.disabled) {
                currentStreamIndex++;
                setTimeout(tryNextRadioStream, 1000);
            }
        });

        // --- AVATAR AND PHOTO GALLERY ---
        function loadAvatarFromStorage() {
            const stored = localStorage.getItem('userAvatar_' + userID);
            if (stored) {
                userAvatar = stored;
                bgPhoto.src = userAvatar;
                log("NUOTRAUKA ƒÆKRAUTA I≈† SAUGYKLOS.", 'system-msg');
            }
        }

        function createAvatarFromPhoto(dataUrl) {
            // Validate data URL format for security
            if (!dataUrl.startsWith('data:image/')) {
                log("NETINKAMAS NUOTRAUKOS FORMATAS", 'error-msg');
                return;
            }
            
            // Create a circular avatar from the photo using canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            const img = new Image();
            img.onload = function() {
                try {
                    // Draw circular avatar
                    ctx.beginPath();
                    ctx.arc(100, 100, 100, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.clip();
                    
                    // Calculate dimensions to fill circle
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width / 2) - (img.width / 2) * scale;
                    const y = (canvas.height / 2) - (img.height / 2) * scale;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    
                    // Get avatar as data URL
                    userAvatar = canvas.toDataURL('image/png');
                    localStorage.setItem('userAvatar_' + userID, userAvatar);
                    bgPhoto.src = userAvatar;
                    
                    log("AVATAR SUKURTAS IR I≈†SAUGOTAS.", 'greeting-msg');
                    flashNotification();
                } catch (e) {
                    log("KLAIDA KURIANT AVATAR", 'error-msg');
                }
            };
            img.onerror = function() {
                log("NEPAVYKO ƒÆKELTI NUOTRAUKOS", 'error-msg');
            };
            img.src = dataUrl;
        }

        avatarBtn.addEventListener('click', function() {
            photoUpload.click();
        });

        // Voice button event
        voiceBtn.addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        });

        // Video button event
        videoBtn.addEventListener('click', function() {
            videoUpload.click();
        });

        photoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type and size
                if (!file.type.startsWith('image/')) {
                    log("PASIRINKITE NUOTRAUKƒÑ (JPG, PNG, GIF)", 'error-msg');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    log("NUOTRAUKA PER DIDELƒñ (MAX 5MB)", 'error-msg');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const photoDataUrl = event.target.result;
                    userPhotos.push(photoDataUrl);
                    
                    // Create avatar from photo
                    createAvatarFromPhoto(photoDataUrl);
                    log("NUOTRAUKA PRIDƒñTA: " + escapeHtml(file.name), 'system-msg');
                    
                    // Send avatar to other users
                    if (client && client.isConnected()) {
                        const avatarMsg = new Paho.MQTT.Message(JSON.stringify({
                            type: 'avatar',
                            id: userID,
                            avatar: userAvatar
                        }));
                        avatarMsg.destinationName = TOPIC;
                        client.send(avatarMsg);
                    }
                };
                reader.onerror = function() {
                    log("KLAIDA SKAITANT FAILƒÑ", 'error-msg');
                };
                reader.readAsDataURL(file);
            }
        });

        // Login functionality
        function doLogin() {
            const username = document.getElementById('username-input').value.trim().toUpperCase();
            const errorDiv = document.getElementById('login-error');
            
            // Validate username
            if (username.length < 3 || username.length > 12) {
                errorDiv.textContent = 'VARDAS TURI B≈™TI 3-12 SIMBOLI≈≤';
                return;
            }
            
            // Check for valid characters (alphanumeric only)
            if (!/^[A-Z0-9]+$/.test(username)) {
                errorDiv.textContent = 'NAUDOKITE TIK RAIDES IR SKAIƒåIUS';
                return;
            }
            
            userID = username;
            document.getElementById('login-screen').style.display = 'none';
            loadAvatarFromStorage();
            bootSystem();
        }

        document.getElementById('login-btn').addEventListener('click', doLogin);
        document.getElementById('username-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doLogin();
        });

        // Test on page load
        window.onload = function() {
            document.getElementById('username-input').focus();
        };



        // Send leave message when user closes/refreshes page
        window.addEventListener('beforeunload', function() {
            if (client && client.isConnected()) {
                const leaveMsg = new Paho.MQTT.Message(JSON.stringify({ type: 'leave', id: userID }));
                leaveMsg.destinationName = TOPIC;
                client.send(leaveMsg);
            }
        });

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

    </script>
</body>
</html>
