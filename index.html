<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-bust" content="v1.0.1">
    <meta name="theme-color" content="#33ff00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TermOS">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.svg">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <title>TermChat LT</title>
    <style>
        :root {
            --term-color: #33ff00;
            --term-font: 'Courier New', 'Monaco', 'Menlo', monospace;
            --bg-color: #000;
            --panel-bg: #0a0a0a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-color);
            color: var(--term-color);
            font-family: var(--term-font);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* MONITOR BEZEL EFFECT */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 20px solid #222;
            border-radius: 15px;
            box-shadow: 
                inset 0 0 50px rgba(0,0,0,0.8),
                0 0 20px rgba(51,255,0,0.1);
            pointer-events: none;
            z-index: 1000;
        }

        /* MAIN LAYOUT GRID */
        #main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            padding: 25px;
            gap: 2px;
        }

        /* RESPONSIVE & MOBILE FIXES */
        @media (max-width: 768px) {
            body::before {
                border: 10px solid #222; /* Thinner bezel on mobile */
            }
            
            #main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                padding: 15px 5px;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }
            
            .side-panel {
                display: none;
            }
            
            /* iOS Safari keyboard fix */
            .input-line {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0,0,0,0.95);
                backdrop-filter: blur(10px);
                z-index: 100;
            }
            
            #terminal-body {
                padding-bottom: 60px; /* Space for fixed input */
                height: calc(100vh - 120px);
                height: calc(100dvh - 120px);
            }
        }
        
        /* Desktop specific */
        @media (min-width: 769px) {
            #main-layout {
                grid-template-columns: 1fr 350px;
            }
            
            #multiverse-panel.active {
                display: block;
            }
        }

        /* HEADER (ASCII) */
        #room-header {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--term-color);
            padding: 10px;
            white-space: pre;
            font-size: 0.8em;
            text-shadow: 0 0 5px var(--term-color);
        }

        /* CHAT AREA */
        #terminal-body {
            grid-column: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid var(--term-color);
            background: rgba(0,0,0,0.8);
        }

        /* DYNAMIC PANELS */
        #multiverse-panel {
            grid-column: 2;
            border-left: 2px solid var(--term-color);
            background: var(--panel-bg);
            padding: 10px;
            overflow-y: auto;
            display: none;
        }

        #multiverse-panel.active { display: block; }

        /* INPUT AREA */
        .input-line {
            grid-column: 1 / -1;
            display: flex;
            border-top: 2px solid var(--term-color);
            padding: 10px;
            background: rgba(0,0,0,0.9);
        }

        #chatInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--term-color);
            font-family: var(--term-font);
            font-size: 16px; /* Prevents iOS zoom */
            outline: none;
            padding: 5px;
            -webkit-appearance: none; /* Remove iOS styling */
            border-radius: 0; /* Remove iOS rounded corners */
        }
        
        /* iOS Safari specific fixes */
        #chatInput:focus {
            transform: translateZ(0); /* Force hardware acceleration */
        }

        /* THEMES */
        .theme-living { --term-color: #33ff00; }
        .theme-library { --term-color: #ffb000; }
        .theme-studio { --term-color: #ff00ff; }
        .theme-workshop { --term-color: #00ffff; }
        .theme-think { --term-color: #00ff41; }
        .theme-lounge { --term-color: #ff3333; }

        /* MULTIVERSE OS ENHANCEMENTS */
        .voice-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid var(--term-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 500;
            display: none;
        }
        
        .voice-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .image-placeholder {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--term-color);
            padding: 20px;
            margin: 5px 0;
            text-align: center;
            border-radius: 5px;
        }

        /* LOGIN SCREEN */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .login-box {
            border: 2px solid var(--term-color);
            padding: 40px;
            background: rgba(0,20,0,0.9);
            text-align: center;
        }

        .login-box input {
            background: var(--bg-color);
            border: 1px solid var(--term-color);
            color: var(--term-color);
            width: 100%;
            padding: 10px;
            margin: 20px 0;
            font-family: var(--term-font);
            font-size: 16px;
        }

        .login-box button {
            background: var(--term-color);
            color: var(--bg-color);
            width: 100%;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-family: var(--term-font);
            font-size: 16px;
        }
    </style>
    <!-- âœ… Official MQTT.js Library (Local Copy - No CDN Dependencies) -->
    <script src="./mqtt.min.js"></script>
</head>
<body class="theme-living">
    
    <!-- Voice Indicator -->
    <div id="voice-indicator" class="voice-indicator">ðŸ”Š Speaking...</div>
    
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2>TERMOS LT</h2>
            <input type="text" id="usernameInput" placeholder="Username" maxlength="20">
            <button onclick="login()">ENTER</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-layout" style="display: none;">
        <div id="room-header">TERMCHAT LT - LIVING ROOM<span class="cursor"></span></div>
        
        <div id="terminal-body"></div>
        
        <div id="multiverse-panel" class="side-panel"></div>
        
        <div class="input-line">
            <span style="margin-right: 10px;">&gt;</span>
            <input id="chatInput" type="text" placeholder="Type message..." autocomplete="off">
            <button id="sendButton" style="margin-left: 10px; background: var(--term-color); color: #000; border: none; padding: 5px 10px; cursor: pointer;">Send</button>
        </div>
    </div>
    <script>
        // --- GLOBAL STATE ---
        let currentState = "chat"; // chat, app, game, video, tunnel, admin
        let currentRoom = 'living_room';
        let username = '';
        let mqttClient = null;
        let appData = null;
        let gameData = null;
        let messageHistory = [];
        let isOnline = navigator.onLine;
        
        // âœ… DEBUG: Check if MQTT library is loaded
        console.log("[INIT] Checking MQTT library availability...");
        console.log("[INIT] window.mqtt exists?", typeof window.mqtt !== 'undefined' ? 'âœ… YES' : 'âŒ NO');
        
        // Retry loading MQTT if not available
        if (typeof mqtt === 'undefined') {
            console.warn("[INIT] MQTT not loaded yet, will attempt fallback...");
        }
        let userStats = {
            level: 1,
            xp: 0,
            linesOfCode: 0,
            questsCompleted: 0,
            avatar: 'default'
        };
        let roomId = null;

        // ASCII Avatars
        const AVATARS = {
            'default': `
  o_o
  /|\\
  / \\
`,
            'admin': `
 â™”â™”â™”
  o_o
  /|\\
  / \\
`,
            'hacker': `
 /\\_/\\
( o.o )
 =^.^=
`,
            'wizard': `
   /\\
  /  \\
  \\__/
  o_o
  /|\\
`,
            'robot': `
 [===]
  o_o
  /|\\
  / \\
`,
            'ninja': `
   â—¢â—¤
  o_o
  /|\\
  / \\
`
        };

        // Level system
        const LEVEL_THRESHOLDS = [0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500, 5500];
        const LEVEL_TITLES = [
            'Newbie', 'Apprentice', 'Coder', 'Hacker', 'Architect', 
            'Wizard', 'Master', 'Guru', 'Legend', 'Arch-Mage'
        ];

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Offline/Online detection
        window.addEventListener('online', function() {
            isOnline = true;
            addMessage('SYSTEM', 'Connection restored - syncing messages...');
            syncOfflineMessages();
        });
        
        window.addEventListener('offline', function() {
            isOnline = false;
            addMessage('SYSTEM', 'Connection lost - messages will be queued');
        });

        // --- MESSAGE PERSISTENCE ---
        function saveMessageToLocal(user, text, room = currentRoom) {
            const message = {
                id: Date.now() + Math.random(),
                user: user,
                text: text,
                room: room,
                timestamp: new Date().toISOString(),
                synced: isOnline
            };
            
            messageHistory.push(message);
            
            // Save to localStorage for persistence
            try {
                const stored = JSON.parse(localStorage.getItem('termchat_messages') || '[]');
                stored.push(message);
                // Keep only last 1000 messages
                if (stored.length > 1000) stored.splice(0, stored.length - 1000);
                localStorage.setItem('termchat_messages', JSON.stringify(stored));
            } catch (e) {
                console.warn('Failed to save message to localStorage:', e);
            }
        }
        
        function loadMessageHistory() {
            try {
                const stored = JSON.parse(localStorage.getItem('termchat_messages') || '[]');
                const roomMessages = stored.filter(msg => msg.room === currentRoom);
                const recent = roomMessages.slice(-50); // Show last 50 messages
                
                recent.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '5px';
                    div.style.opacity = '0.7'; // Indicate historical message
                    div.style.color = msg.user === 'TERMAI' ? '#00ff41' : 'var(--term-color)';
                    div.textContent = `[${msg.user}] ${msg.text}`;
                    const terminalBody = document.getElementById('terminal-body');
                    if (terminalBody) {
                        terminalBody.appendChild(div);
                    }
                });
                
                if (recent.length > 0) {
                    addMessage('SYSTEM', `Loaded ${recent.length} previous messages`);
                }
            } catch (e) {
                console.warn('Failed to load message history:', e);
            }
        }
        
        function syncOfflineMessages() {
            // Sync any unsynced messages when back online
            const unsynced = messageHistory.filter(msg => !msg.synced);
            unsynced.forEach(msg => {
                if (mqttClient && mqttClient.connected) {
                    const payload = { user: msg.user, text: msg.text, timestamp: msg.timestamp };
                    mqttClient.publish('termchat/messages', JSON.stringify(payload));
                    msg.synced = true;
                }
            });
        }

        // Boot sequence
        document.addEventListener('DOMContentLoaded', function() {
            // Check for room sharing URL
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            
            if (roomId) {
                addMessage('SYSTEM', `Joining shared room: ${roomId}`);
            }
            
            // Load user stats
            loadUserStats();
            
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.focus();
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            }
        });

        // --- USER STATS & GAMIFICATION ---
        function loadUserStats() {
            try {
                const saved = localStorage.getItem('termchat_stats');
                if (saved) {
                    userStats = {...userStats, ...JSON.parse(saved)};
                }
            } catch (e) {
                console.warn('Failed to load user stats:', e);
            }
        }
        
        function saveUserStats() {
            try {
                localStorage.setItem('termchat_stats', JSON.stringify(userStats));
            } catch (e) {
                console.warn('Failed to save user stats:', e);
            }
        }
        
        function addXP(amount, reason) {
            userStats.xp += amount;
            const oldLevel = userStats.level;
            userStats.level = calculateLevel(userStats.xp);
            
            if (userStats.level > oldLevel) {
                addMessage('ACHIEVEMENT', `ðŸŽ‰ Level up! You are now ${LEVEL_TITLES[userStats.level - 1]} (Level ${userStats.level})`);
                unlockAvatar();
            }
            
            addMessage('XP', `+${amount} XP (${reason})`);
            saveUserStats();
            updateUserDisplay();
        }
        
        function calculateLevel(xp) {
            for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (xp >= LEVEL_THRESHOLDS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }
        
        function unlockAvatar() {
            const level = userStats.level;
            if (level >= 3 && userStats.avatar === 'default') {
                userStats.avatar = 'hacker';
                addMessage('ACHIEVEMENT', 'ðŸŽ­ New avatar unlocked: Hacker!');
            } else if (level >= 5) {
                userStats.avatar = 'wizard';
                addMessage('ACHIEVEMENT', 'ðŸ§™ New avatar unlocked: Wizard!');
            } else if (level >= 8) {
                userStats.avatar = 'ninja';
                addMessage('ACHIEVEMENT', 'ðŸ¥· New avatar unlocked: Ninja!');
            }
        }
        
        function updateUserDisplay() {
            const header = document.getElementById('room-header');
            if (header) {
                const levelTitle = LEVEL_TITLES[userStats.level - 1] || 'Unknown';
                // Format room name with proper spacing
                const roomName = currentRoom.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                header.innerHTML = `TERMCHAT LT - ${roomName} | ${username} (Lvl ${userStats.level} ${levelTitle})<span class="cursor"></span>`;
            }
        }
        function login() {
            const input = document.getElementById('usernameInput');
            const user = input.value.trim();
            if (user.length >= 3) {
                username = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('main-layout').style.display = 'grid';
                
                // Load message history first
                loadMessageHistory();
                
                // Initialize room selector UI
                populateRoomSelector();
                
                // Load last room from localStorage
                const savedRoom = localStorage.getItem('lastRoom');
                if (savedRoom) {
                    switchRoom(savedRoom);
                } else {
                    switchRoom('living_room');
                }
                
                connectMQTT();
                document.getElementById('chatInput').focus();
                
                // Setup input handler
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') sendMessage();
                    });
                }
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.addEventListener('click', sendMessage);
                }
            } else {
                alert('Username must be at least 3 characters');
            }
        }

        // --- PANEL MANAGER ---
        function switchMode(mode, data) {
            currentState = mode;
            const panel = document.getElementById('multiverse-panel');
            // Hide all content first
            panel.innerHTML = '';
            panel.classList.add('active');

            if (mode === 'chat') {
                panel.classList.remove('active'); // Hide panel, show full chat
            }
            else if (mode === 'app') {
                renderAppBuilder(data);
            }
            else if (mode === 'game') {
                renderGame(data);
            }
            else if (mode === 'video') {
                renderVideo();
            }
            else if (mode === 'admin') {
                renderAdmin();
            }
        }

        // --- 1. APP BUILDER (Workshop) ---
        function renderAppBuilder(data) {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3 style="border-bottom:1px dashed var(--term-color)">IDE: ${data.title}</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="showFile('index.html')">HTML</button>
                    <button onclick="showFile('style.css')">CSS</button>
                    <button onclick="previewApp()">PREVIEW</button>
                    <button onclick="switchMode('chat')">CLOSE</button>
                </div>
                <textarea id="code-area" style="width:100%; height:400px; background:#000; color:var(--term-color); border:1px solid var(--term-color); font-family:monospace;">${data.content}</textarea>
                <div id="preview-frame" style="display:none; width:100%; height:400px; background:#fff;"></div>
            `;
            appData = data;
            
            // Award XP for app creation
            addXP(50, 'Creating app');
            userStats.linesOfCode += (data.content || '').split('\n').length;
            saveUserStats();
        }

        function showFile(filename) {
            const codeArea = document.getElementById('code-area');
            if (appData && appData.content) {
                codeArea.value = appData.content;
            }
        }

        function previewApp() {
            const codeArea = document.getElementById('code-area');
            const previewFrame = document.getElementById('preview-frame');
            previewFrame.style.display = 'block';
            previewFrame.innerHTML = `<iframe srcdoc="${codeArea.value.replace(/"/g, '&quot;')}" style="width:100%; height:100%; border:none;"></iframe>`;
        }

        // --- 2. GAME CONSOLE (Lounge) ---
        function renderGame(data) {
            const panel = document.getElementById('multiverse-panel');
            const options = data.options || ['Continue', 'Inventory', 'Help', 'Quit'];
            const stats = data.stats || {hp: 100, max_hp: 100, inventory: ['Sword']};
            
            panel.innerHTML = `
                <h3 style="color:red; border-bottom:1px solid red;">GAME CONSOLE</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="font-size:1.2em; margin:20px 0;">${data.content || 'Welcome to the adventure!'}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    ${options.map(opt => `<button onclick="sendGameAction('${opt}')" style="background:var(--term-color); color:#000; padding:10px;">${opt}</button>`).join('')}
                </div>
                <div style="margin-top:20px;">
                    HP: <span style="color:red">${stats.hp}</span> / ${stats.max_hp} | INV: ${stats.inventory.join(', ')}
                </div>
            `;
            gameData = data;
            
            // Award XP for game activities
            addXP(30, 'Starting game');
            userStats.questsCompleted += 1;
            saveUserStats();
        }

        function sendGameAction(action) {
            if (mqttClient) {
                const msg = {
                    id: username,
                    msg: `game action: ${action}`,
                    timestamp: Date.now()
                };
                mqttClient.publish('termchat/input', JSON.stringify(msg));
            }
        }

        // --- 3. VIDEO CALL (Private Cabin) ---
        function renderVideo() {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3>VIDEO CALL</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="display:flex; gap:10px; margin:20px 0;">
                    <div style="flex:1; border:1px solid var(--term-color); height:200px;">
                        <video id="localVid" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                    </div>
                    <div style="flex:1; border:1px solid var(--term-color); height:200px;">
                        <video id="remoteVid" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                    </div>
                </div>
                <button onclick="startCam()">CAMERA ON</button>
                <button onclick="stopCam()">CAMERA OFF</button>
            `;
        }

        function startCam() {
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    document.getElementById('localVid').srcObject = stream;
                })
                .catch(err => addMessage('ERROR', 'Camera access denied'));
        }

        function stopCam() {
            const video = document.getElementById('localVid');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // --- 4. ADMIN DASHBOARD ---
        function renderAdmin() {
            const panel = document.getElementById('multiverse-panel');
            panel.innerHTML = `
                <h3>ROOT ACCESS</h3>
                <button onclick="switchMode('chat')" style="float:right; background:red; color:white;">X</button>
                <div style="margin-bottom:20px;">
                    <h4>Plugin Manager</h4>
                    <textarea id="plugin-code" placeholder="Enter Python plugin code..." style="width:100%; height:200px; background:#000; color:var(--term-color); border:1px solid var(--term-color); font-family:monospace;"></textarea>
                    <div style="margin:10px 0;">
                        <input id="plugin-name" placeholder="Plugin name" style="background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                        <input id="plugin-triggers" placeholder="Triggers (comma-separated)" style="background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                        <button onclick="uploadPlugin()">UPLOAD PLUGIN</button>
                    </div>
                </div>
                <div id="admin-log" style="height:200px; overflow-y:scroll; background:#000; border:1px solid var(--term-color); margin:20px 0; padding:5px;"></div>
                <div style="display:flex; gap:10px;">
                    <input id="admin-cmd" placeholder="Enter admin command..." style="flex:1; background:#000; color:var(--term-color); border:1px solid var(--term-color); padding:5px;">
                    <button onclick="sendAdmin()">EXEC</button>
                </div>
            `;
        }

        function sendAdmin() {
            const input = document.getElementById('admin-cmd');
            const cmd = input.value.trim();
            if (cmd && mqttClient && mqttClient.connected) {
                mqttClient.publish('termchat/admin', cmd);
                input.value = '';
                addAdminLog(`> ${cmd}`);
            }
        }

        function addAdminLog(text) {
            const log = document.getElementById('admin-log');
            if (log) {
                const div = document.createElement('div');
                div.textContent = text;
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            }
        }
        
        function uploadPlugin() {
            const name = document.getElementById('plugin-name').value.trim();
            const code = document.getElementById('plugin-code').value.trim();
            const triggers = document.getElementById('plugin-triggers').value.trim().split(',').map(t => t.trim()).filter(t => t);
            
            if (!name || !code) {
                addMessage('ERROR', 'Plugin name and code are required');
                return;
            }
            
            if (mqttClient && mqttClient.connected) {
                const pluginData = {
                    action: 'upload_plugin',
                    name: name,
                    code: code,
                    triggers: triggers,
                    user: username
                };
                
                mqttClient.publish('termchat/admin', JSON.stringify(pluginData));
                addMessage('SYSTEM', `Uploading plugin: ${name}`);
                
                // Clear form
                document.getElementById('plugin-name').value = '';
                document.getElementById('plugin-code').value = '';
                document.getElementById('plugin-triggers').value = '';
                
                // Award XP for plugin creation
                addXP(100, 'Creating plugin');
            }
        }

        function connectMQTT() {
            console.log("[DIAG] Initializing MQTT.js Client...");
            console.log("[DIAG] Window.mqtt =", typeof mqtt, mqtt ? 'LOADED' : 'MISSING');
            
            // âœ… CHECK IF MQTT EXISTS
            if (typeof mqtt === 'undefined') {
                console.error("[DIAG] âŒ MQTT.js library failed to load!");
                addMessage('ERROR', 'âŒ MQTT library not loaded. Check server configuration.');
                addMessage('SYSTEM', 'Application will run in limited mode.');
                return; // STOP EXECUTION
            }
            try {
                addMessage('SYSTEM', 'Connecting to MQTT broker...');
                
                // Create MQTT.js client with WebSocket connection
                const clientId = "client-" + username + "-" + Math.floor(Math.random() * 1000);
                mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt', {
                    clientId: clientId,
                    reconnectPeriod: 3000,
                    keepalive: 30,
                    clean: true,
                    username: '',
                    password: ''
                });
                
                // Connection success handler
                mqttClient.on('connect', function() {
                    addMessage('SYSTEM', 'âœ… Connected to TermOS LT Multiverse!');
                    console.log("[DIAG] Connected via MQTT.js!");
                    
                    // Subscribe to channels (including room-specific if shared)
                    const topics = ['termchat/messages', 'termchat/output', 'termchat/admin', 'termchat/tunnel/+', 'termchat/webrtc/+'];
                    
                    if (roomId) {
                        topics.push(`termchat/room/${roomId}`);
                        addMessage('SYSTEM', `Joined shared room: ${roomId}`);
                    }
                    
                    topics.forEach(topic => {
                        mqttClient.subscribe(topic);
                        console.log('[DIAG] Subscribed to:', topic);
                    });
                    
                    // Send connection announcement
                    const connectMsg = {
                        user: 'SYSTEM',
                        text: `${username} joined the multiverse`,
                        timestamp: Date.now()
                    };
                    
                    const publishTopic = roomId ? `termchat/room/${roomId}` : 'termchat/messages';
                    mqttClient.publish(publishTopic, JSON.stringify(connectMsg));
                    
                    // Test message
                    addMessage('SYSTEM', 'Connection established. Try typing "ai hello" to test AI.');
                });
                
                // Connection error handler
                mqttClient.on('error', function(error) {
                    console.error('MQTT Connection error:', error);
                    addMessage('ERROR', `âŒ Connection error: ${error.message || 'WebSocket blocked or broker unavailable'}`);
                    addMessage('SYSTEM', 'Check: 1) Network connection 2) Firewall/proxy blocking WebSocket 3) Try different network');
                });
                
                // Connection lost handler
                mqttClient.on('close', function() {
                    console.error('MQTT Connection lost');
                    addMessage('ERROR', `âŒ Connection lost`);
                    addMessage('SYSTEM', 'ðŸ”„ Attempting to reconnect...');
                });
                
                // Message arrived handler
                mqttClient.on('message', function(topic, message) {
                    const payload = message.toString();
                    const topic_received = topic;
                    console.log(`[DIAG] ðŸ“© Message from ${topic}: ${payload.substring(0, 100)}...`);
                    
                    // --- SMART ROUTER: ATTEMPT TO PARSE JSON ---
                    try {
                        const data = JSON.parse(payload);
                        
                        // --- APP DETECTED ---
                        if (data.type === 'creation' && data.creation && data.creation.type === 'app') {
                            switchMode('app', data.creation);
                            addMessage('TERMAI', 'Created app for you!');
                            return; // Stop processing
                        }
                        
                        // --- GAME DETECTED ---
                        if (data.type === 'creation' && data.creation && data.creation.type === 'game') {
                            switchMode('game', data.creation);
                            addMessage('TERMAI', 'Started game for you!');
                            return; // Stop processing
                        }
                        
                        // --- DIRECT APP/GAME (Legacy format) ---
                        if (data.app_name && data.files) {
                            switchMode('app', data);
                            return; // Stop processing
                        }
                        if (data.scene && data.options) {
                            switchMode('game', data);
                            return; // Stop processing
                        }
                        
                        // --- TUNNEL DETECTED ---
                        if (data.sender && data.data) {
                            acceptTunnel(data);
                            return; // Stop processing
                        }
                        
                        // --- VIDEO SIGNAL ---
                        if (data.type === 'webrtc') {
                            handleWebRTC(data);
                            return; // Stop processing
                        }
                        
                        // --- NAVIGATION ---
                        if (data.type === 'navigation') {
                            switchRoom(data.room);
                            addMessage('TERMOS', data.msg);
                            return; // Stop processing
                        }
                        
                        // --- ADMIN RESPONSE ---
                        if (data.type === 'admin') {
                            addMessage('ADMIN', data.msg);
                            addAdminLog(data.msg);
                            return; // Stop processing
                        }
                        
                        // --- REGULAR CHAT MESSAGES ---
                        if (data.user && data.text) {
                            addMessage(data.user, data.text);
                            return; // Stop processing
                        }
                        if (data.id && data.msg) {
                            addMessage(data.id, data.msg);
                            return; // Stop processing
                        }
                        
                        // --- AI FUNCTION CALLS ---
                        if (data.action) {
                            handleAIAction(data);
                            return; // Stop processing
                        }
                        
                    } catch (e) {
                        // It's text, not JSON. Continue to text chat logic.
                    }
                    
                    // --- TEXT CHAT LOGIC (XSS Protected) ---
                    const chatBody = document.getElementById('terminal-body');
                    if (chatBody) {
                        const msgDiv = document.createElement('div');
                        msgDiv.style.marginBottom = '5px';
                        msgDiv.style.color = 'var(--term-color)';
                        msgDiv.textContent = payload; // SECURE - prevents XSS
                        chatBody.appendChild(msgDiv);
                        chatBody.scrollTop = chatBody.scrollHeight;
                        console.log('[DIAG] ðŸ’¬ Added message to terminal:', payload.substring(0, 50));
                    }
                });
                
                // Connection error handler with better diagnostics
                mqttClient.on('error', function(error) {
                    console.error('MQTT Connection error:', error);
                    addMessage('ERROR', `âŒ Connection failed: ${error.message || 'Broker unavailable'}`);
                    addMessage('SYSTEM', 'ðŸ’¡ Troubleshooting: Check network, try Chrome/Firefox, disable VPN');
                });
                
                // Reconnect handler
                mqttClient.on('reconnect', function() {
                    console.log('MQTT: Attempting to reconnect...');
                    addMessage('SYSTEM', 'ðŸ”„ Reconnecting to broker...');
                });
                
                console.log('MQTT.js client initialized');
            } catch(e) {
                console.error('MQTT Setup Error:', e);
                addMessage('ERROR', 'âŒ MQTT Setup Error: ' + e.message);
                addMessage('SYSTEM', 'Please reload the page and try again.');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            let text = input.value.trim();
            if (!text) return; // Exit if empty
            
            // Truncate extremely long messages (max 500 chars)
            if (text.length > 500) {
                addMessage('SYSTEM', 'âš ï¸  Message too long (max 500 characters). Truncating...');
                text = text.substring(0, 500);
            }
            
            if (mqttClient && mqttClient.connected) {
                // Check for special commands
                if (text === '/share') {
                    shareRoom();
                    input.value = '';
                    return;
                } else if (text === '/stats') {
                    showStats();
                    input.value = '';
                    return;
                } else if (text === '/avatar') {
                    showAvatarMenu();
                    input.value = '';
                    return;
                } else if (text === '/mute') {
                    speechSynthesis.cancel();
                    addMessage('SYSTEM', 'Voice synthesis muted');
                    input.value = '';
                    return;
                } else if (text === '/speak') {
                    addMessage('SYSTEM', 'Voice synthesis enabled');
                    input.value = '';
                    return;
                } else if (text.startsWith('/room ') || text.startsWith('/go ')) {
                    // Room switching commands: /room library, /go studio, etc.
                    const roomName = text.replace('/room ', '').replace('/go ', '').toLowerCase();
                    const roomMap = {
                        'living': 'living_room',
                        'library': 'library',
                        'studio': 'studio',
                        'workshop': 'workshop',
                        'think': 'think_tank',
                        'tank': 'think_tank',
                        'lounge': 'lounge'
                    };
                    
                    const targetRoom = roomMap[roomName] || roomName.replace(' ', '_');
                    const validRooms = ['living_room', 'library', 'studio', 'workshop', 'think_tank', 'lounge'];
                    
                    if (validRooms.includes(targetRoom)) {
                        switchRoomAndSave(targetRoom);
                        input.value = '';
                        return;
                    } else {
                        addMessage('ERROR', `Unknown room: ${roomName}. Available: ${validRooms.join(', ')}`);
                        input.value = '';
                        return;
                    }
                } else if (text === '/help' || text === '/?') {
                    showHelp();
                    input.value = '';
                    return;
                } else if (text === '/voice') {
                    startVoiceInput();
                    input.value = '';
                    return;
                } else if (text.toLowerCase().includes('create app') || text.toLowerCase().includes('make app')) {
                    // Will trigger AI to create app and award XP
                } else if (text.toLowerCase().includes('start game') || text.toLowerCase().includes('play game')) {
                    // Will trigger AI to create game and award XP
                } else if (text.toLowerCase().includes('play music') || text.toLowerCase().includes('play radio')) {
                    // Will trigger AI function calling for music
                } else if (text.startsWith('![') && text.includes(']')) {
                    // Image generation request
                    addMessage(username, text);
                } else if (text === '/video') {
                    switchMode('video');
                    input.value = '';
                    return;
                } else if (text === '/admin') {
                    switchMode('admin');
                    input.value = '';
                    return;
                } else if (text === '/chat') {
                    switchMode('chat');
                    input.value = '';
                    return;
                } else if (text.includes('@admin') || text.includes('admin status') || text.includes('admin')) {
                    // Handle admin commands in main chat
                    mqttClient.publish('termchat/admin', text);
                    addMessage('SYSTEM', `Admin command sent: ${text}`);
                    input.value = '';
                    return;
                }
                
                const msg = { 
                    id: username, 
                    msg: text,
                    timestamp: Date.now()
                };
                
                const publishTopic = roomId ? `termchat/room/${roomId}` : 'termchat/messages';
                mqttClient.publish(publishTopic, JSON.stringify({user: username, text: text}));
                mqttClient.publish('termchat/input', JSON.stringify(msg));
                input.value = '';
                input.focus();
            } else {
                addMessage('ERROR', 'Not connected to multiverse. Please wait for connection...');
            }
        }

        function addMessage(user, text) {
            if (!user || !text) return; // Validate inputs
            
            const terminal = document.getElementById('terminal-body');
            if (!terminal) {
                console.warn('Terminal body not found');
                return;
            }
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            
            // Color coding
            if (user === 'SYSTEM') div.style.color = '#00ff00';
            else if (user === 'ERROR') div.style.color = '#ff0000';
            else if (user === 'ACHIEVEMENT') div.style.color = '#ffff00';
            else if (user === 'XP') div.style.color = '#00ffff';
            else if (user === 'TERMAI') {
                div.style.color = '#00ff41';
                // Auto-speak TERMAI responses
                const lang = text.includes('Ä…') || text.includes('Ä—') || text.includes('Ä¯') ? 'lt-LT' : 'en-US';
                setTimeout(() => speakText(text, lang), 500);
            }
            else if (user === 'TERMOS') div.style.color = '#ffff00';
            else div.style.color = 'var(--term-color)';
            
            // Process image markdown
            const processedText = processImageMarkdown(text);
            
            // Add avatar for regular users
            let displayText;
            if (user !== 'SYSTEM' && user !== 'ERROR' && user !== 'ACHIEVEMENT' && user !== 'XP') {
                const avatar = AVATARS[userStats.avatar] || AVATARS['default'];
                displayText = `${avatar}[${user}] ${processedText}`;
            } else {
                displayText = `[${user}] ${processedText}`;
            }
            
            div.textContent = displayText;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
            
            // Save to persistent storage (except system messages)
            if (user !== 'SYSTEM' && user !== 'ERROR') {
                saveMessageToLocal(user, processedText);
            }
            
            // Award XP for various activities
            if (user === username) {
                addXP(1, 'Sending message');
            }
        }

        // --- VOICE TO VOICE (DUPLEX) ---
        let isListening = false;
        let recognition = null;
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
                addMessage('VOICE', `Heard: "${transcript}"`);
                // Auto-send voice input
                setTimeout(() => sendMessage(), 500);
            };
            
            recognition.onerror = function(event) {
                addMessage('ERROR', `Voice recognition error: ${event.error}`);
                isListening = false;
                updateVoiceIndicator();
            };
            
            recognition.onend = function() {
                isListening = false;
                updateVoiceIndicator();
            };
        }
        
        function startVoiceInput() {
            if (recognition && !isListening) {
                isListening = true;
                recognition.start();
                updateVoiceIndicator();
                addMessage('SYSTEM', 'Listening... Speak now!');
            }
        }
        
        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                updateVoiceIndicator();
            }
        }
        
        function updateVoiceIndicator() {
            const indicator = document.getElementById('voice-indicator');
            if (isListening) {
                indicator.textContent = 'ðŸŽ¤ Listening...';
                indicator.classList.add('active');
            } else {
                indicator.textContent = 'ðŸ”Š Speaking...';
                indicator.classList.remove('active');
            }
        }
        
        // Voice Synthesis API
        function speakText(text, lang = 'en-US') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
                return true;
            }
            return false;
        }
        
        // Image Generation Support
        function processImageMarkdown(text) {
            const imageRegex = /!\[([^\]]+)\]/g;
            return text.replace(imageRegex, (match, description) => {
                const imageId = 'img_' + Math.random().toString(36).substr(2, 9);
                // Request image generation from backend
                if (mqttClient) {
                    const imageRequest = {
                        id: username,
                        msg: `generate image: ${description}`,
                        type: 'image_request',
                        timestamp: Date.now()
                    };
                    mqttClient.publish('termchat/input', JSON.stringify(imageRequest));
                }
                return `[ðŸŽ¨ Generating image: ${description}...]`;
            });
        }
        // --- VIRAL GROWTH FEATURES ---
        function shareRoom() {
            const roomCode = Math.random().toString(36).substr(2, 8).toUpperCase();
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                addMessage('SYSTEM', `ðŸ”— Room link copied! Share: ${shareUrl}`);
                addXP(25, 'Creating shareable room');
            }).catch(() => {
                addMessage('SYSTEM', `ðŸ”— Share this room: ${shareUrl}`);
            });
            
            // Switch to the new room
            roomId = roomCode;
            if (mqttClient) {
                mqttClient.subscribe(`termchat/room/${roomId}`);
            }
        }
        
        function showHelp() {
            addMessage('HELP', 'ðŸ“– Available Commands:');
            addMessage('HELP', 'â”œâ”€ /stats         Show your level, XP, and achievements');
            addMessage('HELP', 'â”œâ”€ /avatar        Change your avatar');
            addMessage('HELP', 'â”œâ”€ /share         Share room with others');
            addMessage('HELP', 'â”œâ”€ /voice         Enable voice input');
            addMessage('HELP', 'â”œâ”€ /mute          Disable voice output');
            addMessage('HELP', 'â”œâ”€ /speak         Enable voice output');
            addMessage('HELP', 'â”œâ”€ /help or /?    Show this help message');
            addMessage('HELP', 'â”œâ”€ /room <name>   Switch to another room');
            addMessage('HELP', 'â”œâ”€ /go <name>     Alias for /room');
            addMessage('HELP', 'â””â”€ Available rooms: living_room, library, studio, workshop, think_tank, lounge');
            addMessage('HELP', 'ðŸ’¡ Tip: Use the room buttons on the right panel to switch rooms quickly!');
        }
        
        function showStats() {
            const levelTitle = LEVEL_TITLES[userStats.level - 1] || 'Unknown';
            const nextLevelXP = LEVEL_THRESHOLDS[userStats.level] || 'MAX';
            
            addMessage('STATS', `ðŸ† Your Stats:`);
            addMessage('STATS', `Level: ${userStats.level} (${levelTitle})`);
            addMessage('STATS', `XP: ${userStats.xp}/${nextLevelXP}`);
            addMessage('STATS', `Lines of Code: ${userStats.linesOfCode}`);
            addMessage('STATS', `Quests Completed: ${userStats.questsCompleted}`);
            addMessage('STATS', `Avatar: ${userStats.avatar}`);
        }
        
        function showAvatarMenu() {
            addMessage('AVATAR', 'ðŸŽ­ Available Avatars:');
            Object.keys(AVATARS).forEach(key => {
                const unlocked = (key === 'default') || 
                                (key === 'hacker' && userStats.level >= 3) ||
                                (key === 'wizard' && userStats.level >= 5) ||
                                (key === 'ninja' && userStats.level >= 8) ||
                                (key === 'admin' && userStats.level >= 10);
                
                const status = unlocked ? 'âœ…' : 'ðŸ”’';
                addMessage('AVATAR', `${status} ${key} ${unlocked ? '(type /use ' + key + ')' : '(unlock at level ' + getUnlockLevel(key) + ')'}`);
            });
        }
        
        function getUnlockLevel(avatar) {
            const levels = {'default': 1, 'hacker': 3, 'wizard': 5, 'ninja': 8, 'admin': 10};
            return levels[avatar] || 1;
        }
        function handleAIAction(action) {
            if (action.action === 'play_music') {
                playMusic(action.url, action.title);
                addXP(15, 'Playing music');
            } else if (action.action === 'open_panel') {
                switchMode(action.panel, action.data);
                addXP(10, 'Opening panel');
            } else if (action.action === 'memory_stored') {
                addMessage('SYSTEM', action.message);
                addXP(5, 'Storing memory');
            }
        }
        
        function playMusic(url, title) {
            // Create or update audio element
            let audio = document.getElementById('background-audio');
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = 'background-audio';
                audio.controls = true;
                audio.style.cssText = 'position:fixed; bottom:10px; right:10px; z-index:1001;';
                document.body.appendChild(audio);
            }
            
            audio.src = url;
            audio.play().then(() => {
                addMessage('SYSTEM', `ðŸŽµ Now playing: ${title}`);
            }).catch(err => {
                addMessage('ERROR', `Failed to play music: ${err.message}`);
            });
        }
        
        function acceptTunnel(data) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); display: flex;
                justify-content: center; align-items: center; z-index: 2000;
            `;
            modal.innerHTML = `
                <div style="background: var(--bg-color); border: 2px solid var(--term-color); padding: 20px; text-align: center;">
                    <h3>TUNNEL REQUEST</h3>
                    <p>User ${data.sender} wants to connect</p>
                    <div style="margin-top: 20px;">
                        <button onclick="acceptTunnelConnection('${data.sender}'); this.parentElement.parentElement.parentElement.remove();">ACCEPT</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();">DECLINE</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function acceptTunnelConnection(sender) {
            addMessage('SYSTEM', `Tunnel established with ${sender}`);
            // Additional tunnel logic here
        }

        // --- WEBRTC HANDLER ---
        function handleWebRTC(data) {
            if (data.action === 'offer') {
                addMessage('SYSTEM', `Video call from ${data.sender}`);
                switchMode('video');
            } else if (data.action === 'answer') {
                addMessage('SYSTEM', 'Video call answered');
            } else if (data.action === 'ice-candidate') {
                // Handle ICE candidate
                console.log('ICE candidate received:', data);
            }
        }
        
        // --- ROOM SELECTOR UI ---
        function populateRoomSelector() {
            const panel = document.getElementById('multiverse-panel');
            if (!panel) return;
            
            const rooms = [
                { id: 'living_room', name: 'ðŸ  Living Room', color: '#33ff00' },
                { id: 'library', name: 'ðŸ“š Library', color: '#ffb000' },
                { id: 'studio', name: 'ðŸŽ¨ Studio', color: '#ff00ff' },
                { id: 'workshop', name: 'ðŸ”§ Workshop', color: '#00ffff' },
                { id: 'think_tank', name: 'ðŸ’­ Think Tank', color: '#00ff41' },
                { id: 'lounge', name: 'ðŸŽ­ Lounge', color: '#ff3333' }
            ];
            
            let html = '<div style="padding: 10px; border-bottom: 1px solid #33ff00; margin-bottom: 10px;"><strong>ðŸŒ ROOMS</strong></div>';
            
            rooms.forEach(room => {
                html += `<button 
                    onclick="switchRoomAndSave('${room.id}')" 
                    style="
                        display: block;
                        width: 100%;
                        padding: 8px;
                        margin: 5px 0;
                        background: ${currentRoom === room.id ? room.color : '#0a0a0a'};
                        color: ${currentRoom === room.id ? '#000' : room.color};
                        border: 2px solid ${room.color};
                        cursor: pointer;
                        font-family: var(--term-font);
                        font-size: 12px;
                        font-weight: bold;
                        transition: all 0.3s;
                    "
                    onmouseover="this.style.opacity='0.8'"
                    onmouseout="this.style.opacity='1'"
                >
                    ${room.name}
                </button>`;
            });
            
            panel.innerHTML = html;
        }
        
        function updateRoomButtonStyles() {
            // Update button styles without full repopulation
            const buttons = document.querySelectorAll('#multiverse-panel button');
            const roomMap = {
                'living_room': '#33ff00',
                'library': '#ffb000',
                'studio': '#ff00ff',
                'workshop': '#00ffff',
                'think_tank': '#00ff41',
                'lounge': '#ff3333'
            };
            
            buttons.forEach(btn => {
                // Check each room to match button
                for (const [roomId, color] of Object.entries(roomMap)) {
                    if (btn.getAttribute('onclick').includes(roomId)) {
                        if (currentRoom === roomId) {
                            btn.style.background = color;
                            btn.style.color = '#000';
                        } else {
                            btn.style.background = '#0a0a0a';
                            btn.style.color = color;
                        }
                        break;
                    }
                }
            });
        }
        
        function switchRoomAndSave(room) {
            switchRoom(room);
            localStorage.setItem('lastRoom', room);
            // Update button styles instead of full repopulation
            updateRoomButtonStyles();
            // Format room name properly
            const roomName = room.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            addMessage('SYSTEM', `Switched to: ${roomName}`);
        }
        
        function switchRoom(room) {
            currentRoom = room;
            const themes = {
                'living_room': 'theme-living',
                'library': 'theme-library', 
                'studio': 'theme-studio',
                'workshop': 'theme-workshop',
                'think_tank': 'theme-think',
                'lounge': 'theme-lounge'
            };
            
            // Update theme
            document.body.className = themes[room] || 'theme-living';
            
            // Update header
            const roomNames = {
                'living_room': 'LIVING ROOM',
                'library': 'LIBRARY',
                'studio': 'STUDIO', 
                'workshop': 'WORKSHOP',
                'think_tank': 'THINK TANK',
                'lounge': 'LOUNGE'
            };
            
            document.getElementById('room-header').innerHTML = 
                `TERMCHAT LT - ${roomNames[room] || 'UNKNOWN'}<span class="cursor"></span>`;
        }
    </script>
</body>
</html>
