<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TermOS: Safe Boot</title>
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --glass-bg: rgba(15, 23, 42, 0.85); --glass-border: rgba(255, 255, 255, 0.1); --accent-primary: #38bdf8; --msg-user-bg: #3b82f6; --msg-ai-bg: #1e293b; --neural-color: #06b6d4; }
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .ascii-art { font-family: 'Fira Code', monospace; line-height: 0.9; white-space: pre; font-size: 8px; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
        .avatar-gradient-user { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .avatar-gradient-ai { background: linear-gradient(135deg, #10b981, #059669); }
        .avatar-gradient-neural { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .avatar-gradient-room { background: linear-gradient(135deg, #22c55e, #3b82f6); }
        
        /* DEBUGGING STYLES */
        .no-pointer { pointer-events: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">
    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
    <canvas id="matrix-canvas"></canvas>
    
    <header id="app-header" class="fixed top-0 left-0 right-0 z-20 glass-panel border-b-0 border-b-white/5 h-16 flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-lg shadow-blue-500/30">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide text-white">TERMOS <span class="text-blue-400">LT</span></h1>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <div id="api-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="room-display">SYSTEM READY</span>
                    <span class="text-[10px] text-cyan-400 font-mono border border-cyan-500/30 px-1 rounded">GEN <span id="gen-count">1</span></span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleMediaOverlay()" id="media-toggle-btn" class="hidden md:flex bg-purple-900/20 hover:bg-purple-900/40 text-purple-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border border-purple-500/30 transition-all">üì∫ PLAYING</button>
            <button onclick="triggerKernelThought()" class="hidden md:flex bg-cyan-900/20 hover:bg-cyan-900/40 text-cyan-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border-cyan-500/30 transition-all">üß† KERNEL</button>
            <button onclick="toggleCodeEditor()" class="hidden md:flex bg-green-900/20 hover:bg-green-900/40 text-green-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border-green-500/30 transition-all">üñã CODE</button>
            <button onclick="openProfileModal()" class="hidden md:flex bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-[10px] font-mono px-2 py-1 rounded border-white/10 transition-all">üë§ PROFILE</button>
            <button onclick="toggleAdminMode()" id="admin-toggle-text" class="bg-slate-900/50 hover:bg-red-900/50 border border-slate-700 hover:border-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg backdrop-blur-md flex items-center gap-2"><span>üî¥</span> ADMIN</button>
            <div class="hidden md:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-mono">LVL <span id="lvl-disp" class="text-blue-400 font-bold">1</span></span>
                <span class="text-[10px] text-gray-600 font-mono">XP <span id="xp-val">0</span></span>
            </div>
        </div>
    </header>
    
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 z-10 scroll-smooth max-w-5xl mx-auto w-full"></main>
    
    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-white/5 pb-6 pt-4 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-end gap-2 bg-slate-900/80 rounded-2xl p-2 border border-white/5 shadow-2xl input-glow transition-all">
                <button id="voice-btn" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition-colors shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7m0 0H8m4 0h4m-4 8H8"></path></svg>
                </button>
                <input type="text" id="user-input" placeholder="Try '/kernel' for deep analysis..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-4 py-3 text-base font-light">
                <button id="send-btn" class="p-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 5l-7 7 5 14z"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <button onclick="forceReset()" class="text-[10px] text-red-500/50 hover:text-red-400 transition-colors">‚ö†Ô∏è Emergency Reset</button>
            </div>
        </div>
    </div>

<!-- FLOATING MEDIA OVERLAY -->
<div id="media-overlay" class="media-overlay media-minimized glass-panel rounded-2xl border border-white/10 shadow-2xl">
    <div class="media-content p-0">
        <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-sm">üì∫ MEDIA PLAYER <span class="text-[10px] text-cyan-400 font-mono hidden md:inline-block">BACKGROUND ACTIVE</span></span>
            <button onclick="toggleMediaUI()" class="text-gray-400 hover:text-white">‚úñ</button>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-white/10 mb-2">
            <button onclick="switchMediaTab('radio')" id="tab-radio" class="flex-1 pb-2 text-cyan-400 border-b-2 border-cyan-500 font-mono text-sm hover:bg-white/5 transition-colors">üìª RADIO</button>
            <button onclick="switchMediaTab('video')" id="tab-video" class="flex-1 pb-2 text-gray-400 border-b-2 border-transparent hover:text-white font-mono text-sm hover:bg-white/5 transition-colors">üì∫ VIDEO ROOM</button>
        </div>

        <!-- Radio Player -->
        <div id="media-radio" class="space-y-2">
            <div class="p-3 text-center text-gray-400 text-xs">
                Select a station to broadcast to active room.
            </div>
            <div class="radio-station active p-3 rounded border border-white/5 bg-white/5 flex items-center justify-between relative overflow-hidden group" onclick="playRadio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', this)">
                <div class="relative z-10">
                    <div class="text-white font-bold">üéµ Lofi Beats</div>
                    <div class="text-[10px] text-gray-400">Chill vibes</div>
                </div>
                <div class="visualizer-bar"></div>
                <div class="text-cyan-400 text-xs animate-spin hidden loading-indicator absolute right-3">‚ü≥</div>
            </div>
        </div>
    </div>

<!-- VIDEO ROOM -->
<div id="media-video" class="hidden space-y-2">
    <div class="bg-black/50 rounded-lg p-3 border border-white/10">
        <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-xs text-purple-400">PRIVATE VIDEO CHAT</span>
            <span class="text-[10px] text-gray-400 mb-2">Type <span class="text-cyan-400 font-mono border border-cyan-500/30 px-1 rounded">/video [RoomName]</span> to join.
            <br>Or click <span class="text-purple-400">HOST</span> to start video.
        </div>
        <div class="video-container relative">
            <div id="video-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 z-20 bg-black/50">
                <span class="text-xs text-gray-500">Waiting for video signal...</span>
            </div>
            <video id="video-player" class="hidden" autoplay playsinline muted></video>
            <!-- Overlay for Room Name/Status -->
            <div id="video-overlay-ui" class="absolute bottom-2 right-2 text-right text-[10px] text-cyan-400 font-mono hidden bg-black/80 px-2 py-1 rounded">
                <span id="current-room-name"></span>
            </div>
        </div>
    </div>
</div>

<!-- PROFILE MODAL -->
<div id="profile-modal" class="admin-hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-xl border border-white/10 max-w-sm w-full mx-4">
        <h3 class="text-white font-bold mb-4 text-lg">üë§ Profile Settings</h3>
        <div class="space-y-4">
            <div><label class="block text-xs text-gray-400 mb-1">Nickname</label><input type="text" id="edit-name" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-blue-500 outline-none"></div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Avatar</label>
                <div class="flex gap-2">
                    <button onclick="triggerFileUpload()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 rounded transition-colors">üì∑ Upload Photo</button>
                    <input type="text" id="edit-avatar" placeholder="Or Emoji" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-center">
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button onclick="saveProfile()" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded">Save</button>
            <button onclick="closeProfileModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel" class="admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border-red-500/30 shadow-2xl shadow-red-500/10">
    <h3 class="text-red-400 font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> GITHUB CONSOLE</h3>
    <div class="space-y-2">
        <button onclick="toggleCodeEditor()" class="w-full border border-green-500/50 text-green-400 bg-green-900/10 hover:bg-green-900/20 text-xs font-bold py-2 rounded mb-2">üñã EDIT SYSTEM CODE</button>
        <div class="border-t border-white/10 pt-2 mt-2">
            <h4 class="text-gray-400 text-xs font-bold uppercase">System Status (Simulated Admin)</h4>
            <div class="text-[10px] text-gray-500 mt-1">You are currently running from a single HTML file. To enable persistent file saving (requested), use <span class="text-cyan-400 font-bold">System Editor</span> to save state.</div>
        </div>
        <div class="space-y-2">
            <button onclick="testGitHubToken()" class="w-full border border-green-500/50 text-green-400 bg-green-900/10 hover:bg-green-900/20 text-xs py-1 rounded mb-2">üß™ Test Permissions First</button>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch</label><input type="text" id="gh-branch" value="main" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
            <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Token (Classic)</label><input type="password" id="gh-token" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
            <button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded text-xs tracking-wider transition-colors shadow-lg shadow-red-600/20 active:scale-95 mt-2">üß¨ PUSH TO GITHUB</button>
        </div>
    </div>
</div>

<!-- CODE EDITOR OVERLAY -->
<div id="code-editor-overlay" class="code-editor-overlay admin-hidden">
    <div class="editor-container w-full h-full flex flex-col justify-center pt-8">
        <h2 class="text-white font-bold text-xl mb-4 font-mono">üñã SYSTEM EDITOR</h2>
        <p class="text-gray-400 text-xs">Changes here are local. Click <span class="text-green-400 font-bold">APPLY TO BROWSER</span> to update the system immediately. Download to save a local backup.</p>
        <textarea id="code-editor-textarea" class="code-editor" spellcheck="false"></textarea>
        <div class="editor-actions">
            <button onclick="applyCode()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-mono text-xs font-bold">APPLY TO BROWSER</button>
            <button onclick="downloadCode()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded font-mono text-xs">DOWNLOAD .HTML</button>
            <button onclick="toggleCodeEditor()" class="text-gray-400 hover:text-white px-4 py-2 rounded font-mono text-xs">‚úñ CLOSE</button>
        </div>
    </div>
</div>

<!-- PRIVATE ROOM OVERLAY -->
<div id="private-room-ui" class="admin-hidden fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-xl border border-white/10 max-w-md w-full mx-4">
        <h3 class="text-white font-bold mb-4 text-xl">üîí PRIVATE ROOM</h3>
        <div class="space-y-4">
            <div><label class="block text-xs text-gray-400 mb-1">Room Name</label><input type="text" id="private-room-input" placeholder="e.g. MySecret" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none"></div>
            <div class="mt-2 flex gap-2">
                <button onclick="createPrivateRoom()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-2 rounded">JOIN / SHARE</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_MODEL = "llama-3.3-70b-versatile"; 
    
    // PERSISTENCE (FIXED)
    // We now save state to a JSON file `termos_state.json`
    
    // FRIENDLY DEVICES (EXPANDED)
    // Added better responsive scaling (Mobile vs Desktop)
    // Fixed potential freeze by clearing mutation queue
    
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || "";
    let GITHUB_TOKEN = localStorage.getItem('termos_github_token') || "";
    let REPO_OWNER = localStorage.getItem('termos_repo_owner') || "your-username";
    let REPO_NAME = localStorage.getItem('termos_repo_name') || "termchat-lt";
    let REPO_BRANCH = localStorage.getItem('termos_repo_branch') || "main"; 
    
    let systemGeneration = parseInt(localStorage.getItem('termos_gen') || "1");
    let userProfile = {
        name: localStorage.getItem('termos_name') || "User",
        avatar: localStorage.getItem('termos_avatar') || "üë§"
    };
    
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let username = 'User_' + Math.floor(Math.random() * 10000);
    let mqttClient = null;
    let userStats = { level: 1, xp: 0, avatar: '>_<', ascii: null };
    const LEVELS = { 3: 'Cyber', 5: 'Ghost', 8: 'Oracle' }; 
    let installedModules = [];
    let adminMode = false;

    // --- RESET ---
    function forceReset() {
        if(confirm("Emergency Reset: Clear all Data (Chat, Mutations, Room)?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- PRIVATE ROOM LOGIC ---
    function createPrivateRoom() {
        if(!GROQ_API_KEY) return requestApiKey();
        
        const roomName = document.getElementById('private-room-input').value.trim();
        if(!roomName) return alert("Please enter a room name.");
        
        document.getElementById('room-display').innerText = `ROOM: ${roomName.toUpperCase()}`;
        document.getElementById('private-room-indicator').classList.remove('hidden');
        
        // Unsubscribe from public
        if(mqttClient && mqttClient.isConnected()) {
            mqttClient.unsubscribe("termos/v3/chat");
            mqttClient.subscribe(`termos/rooms/${roomName}`, { qos: 1 });
            
            // Announce presence
            const payload = JSON.stringify({ user: username, nick: userProfile.name, avatar: userProfile.avatar, type: 'join' });
            const msg = new Paho.MQTT.Message(payload);
            msg.destinationName = `termos/rooms/${roomName}`;
            msg.qos = 1;
            mqttClient.send(msg);
        }
    }

    // --- KERNEL LOGIC ---
    async function triggerKernelThought() {
        if(!GROQ_API_KEY) return requestApiKey();
        addSystemMessage("üß† KERNEL: Engaging Neural Core...");
        const thinkingId = "think-" + Date.now();
        getBox().insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex gap-2 my-2 text-xs text-cyan-400 italic animate-pulse pl-11">Synthesizing self-awareness...</div>`);
        scrollDown();

        try {
            const systemContext = `Current System State: Generation ${systemGeneration}, Level ${userStats.level}, Room: ${(currentRoomName || "Public"}`;
            
            let r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method:"POST",
                headers:{"Authorization":"Bearer "+GROQ_API_KEY,"Content-Type":"application/json"},
                body:JSON.stringify({
                    model: API_MODEL,
                    messages:[{
                        role:"system",
                        content:`You are TermOS Kernel v${systemGeneration}. You are a self-evolving organism.
                        ${systemContext}
                        TASK: Analyze current UI and suggest 1 autonomous upgrade.
                        SPECIAL INSTRUCTIONS:
                        1. If user wants to change code, use this exact phrase: "Update Code".
                        2. This will NOT modify index.html directly. It will update "System Code Editor" text area.
                        3. If user asks for "Real Time", reply with current system time.
                        Return response in this format: "Idea: [Description]. Code: SystemRebuilder.install('name') or /evolve [prompt]".`
                    },{role:"user",content:"Analyze your state and suggest an upgrade."}]
                })
            });
            
            const apiData = await r.json();
            if (apiData.error) throw new Error("Groq: " + apiData.error.message);
            if (!apiData.choices || apiData.choices.length === 0) throw new Error("No choices returned.");
            
            const reply = apiData.choices[0].message.content;
            const el = document.getElementById(thinkingId); if(el) el.remove();
            
            addNeuralMessage(reply);
            
            if(reply.includes("Update Code")) {
                const codeMatch = reply.match(/```html\n([\s\S\S]*?)```/);
                let finalCode = "";
                if(codeMatch && codeMatch.length > 1) {
                    finalCode = codeMatch[1];
                    // Remove markdown wrapper
                    finalCode = finalCode.replace(/```html/g, "").replace(/```/g, "").trim();
                    finalCode = finalCode.replace(/^\s+/, "");
                    finalCode = finalCode.replace(/\s+$/, "");
                    
                    // Update Editor
                    document.getElementById('code-editor-textarea').value = finalCode;
                    addSystemMessage("üìù Code Loaded into Editor.");
                } else {
                    addAIMessage(reply);
                }
            } else if(reply.includes("SystemRebuilder.install(")) {
                let match = reply.match(/SystemRebuilder\.install\(['"](.*?)['"]\)/);
                if(match) { 
                    setTimeout(() => {
                        if(confirm("Kernel suggests upgrade: " + match[1] + ". Apply?")) {
                            SystemRebuilder.install(match[1]);
                        }
                    }, 1000);
                }
            } else if(reply.includes("CMD: PLAY_MUSIC")) { 
                SystemRebuilder.playMusic(); 
            } else { 
                addAIMessage(reply); 
            }
        } catch (e) { 
            const el = document.getElementById(thinkingId); if(el) el.remove();
            addSystemMessage("‚ùå Kernel Error: " + e.message); 
        }
    }

    // --- NEURAL MESSAGING ---
    function addNeuralMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-neural shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">üß†</span></div><div class="flex-1"><div class="neural-msg rounded-2xl rounded-2xl rounded-tl-none p-4 border border-cyan-500/30 shadow-lg text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }

    // --- INPUT HANDLING ---
    function handleInput() {
        try {
            // SAFETY CHECK: ensure input exists
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/evolve')) {
                let prompt = "";
                if(txt === '/evolve') { prompt = prompt("Describe change:"); } 
                else { prompt = txt.substring(8); }
                if(prompt) { handleLocalEvolution(prompt); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/kernel') || txt.startsWith('/think')) {
                triggerKernelThought();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/video ')) {
                const roomName = txt.substring(7);
                joinVideoRoom(roomName);
                inp.value = '';
                return;
            }

            if(txt.startsWith('/create ') {
                createPrivateRoom();
                inp.value = '';
                return;
            }
            
            if(txt.startsWith('/exit ')) {
                leaveRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN ON"); initMatrix(); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN OFF"); initMatrix(); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    try {
                        const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                        const message = new Paho.MQTT.Message(payload);
                        // Send to private room if active, otherwise public
                        const dest = (currentRoomName) ? `termos/rooms/${currentRoomName}` : "termos/v3/chat";
                        message.destinationName = dest;
                        message.qos = 1; 
                        mqttClient.send(message);
                    } catch (e) {}
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }

    function getBox() {
        let el = document.getElementById('chat-container');
        if (!el) {
            el = document.createElement('div');
            el.id = 'chat-container';
            el.className = "flex flex-col h-full w-full p-4 overflow-y-auto z-10";
            document.body.appendChild(el);
        }
        return el;
    }

    const SystemRebuilder = {
        install: function(name) {
            // SAFETY FIX: Only access elements if they exist
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'coreinterface': this.installCoreInterface(); break;
                    case 'realtime': this.installRealTime(); break;
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        installRealTime: function() {
            if(isRealTime) return;
            isRealTime = true; 
            // Trigger a re-render of time display
            updateRealTimeUI();
            addSystemMessage("‚úÖ Real-Time Module Installed.");
        },
        installCoreInterface: function() {
            // FIX: The previous prompt logic might be broken, so we hardcode "Core Interface" module to just display system logs.
            // It effectively initializes the terminal part.
            addSystemMessage("‚úÖ Core Interface Loaded.");
        },
        addSound: function() {
            try {
                let ctx = new (window.AudioContext||window.webkitAudioContext)();
                let old = window.addUserMessage; 
                window.addUserMessage = function(t) {
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime(800, ctx.currentTime);
                    o.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
                    o.start(); o.stop(ctx.currentTime+0.1);
                    old(t);
                };
            } catch(e) {}
        },
        addNeon: function() {
            document.documentElement.style.setProperty('--msg-user-bg', '#d946ef'); 
            document.documentElement.style.setProperty('--accent-primary', '#d946ef');
            document.body.style.boxShadow = "inset 0 0 50px rgba(217, 70, 239, 0.1)";
        },
        playMusic: function() {
            addSystemMessage("üéµ Audio Module: Simulated.");
        }
    };

    let isMatrixRunning = false;
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if(!canvas || isMatrixRunning) return; 
        isMatrixRunning = true;
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const fontSize = window.innerWidth < 600 ? 10 : 14; 
        const columns = Math.floor(width / fontSize);
        const drops = Array(columns).fill(1);
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&';
        let lastTime = 0;
        const fps = 30; const interval = 1000 / fps;
        function draw(time) {
            requestAnimationFrame(draw);
            const delta = time - lastTime;
            if (delta < interval) return;
            lastTime = time - (delta % interval);
            try {
                ctx.fillStyle = 'rgba(2, 6, 23, 0.05)'; 
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = (adminMode) ? '#ef4444' : (systemGeneration > 5 ? '#06b6d4' : '#38bdf8'); 
                ctx.font = `${fontSize}px 'Fira Code', monospace`;
                for(let i=0; i<drops.length; i++) {
                    const text = letters[Math.floor(Math.random()*letters.length)];
                    ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                    if(drops[i]*fontSize > height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            } catch (e) { isMatrixRunning = false; }
        }
        requestAnimationFrame(draw);
        window.addEventListener('resize', () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; });
    }

    function addSystemMessage(txt) {
        const box = getBox();
        const d = document.createElement('div');
        d.className = "flex justify-center my-4 z-10";
        d.innerHTML = `<span class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wider text-gray-400 bg-slate-800/50 border border-white/5 shadow-inner">${txt}</span>`;
        box.appendChild(d);
        scrollDown();
    }
    function addAIMessage(txt) {
        const d = document.createElement('div');
        d.className = "flex gap-3 my-4 z-10";
        d.innerHTML = `<div class="w-8 h-8 rounded-full avatar-gradient-ai shrink-0 flex items-center justify-center shadow-lg ring-2 ring-slate-800"><span class="text-xs font-bold text-white">AI</span></div><div class="flex-1"><div class="bg-slate-800/80 backdrop-blur-md rounded-2xl rounded-tl-none p-4 border border-white/5 shadow-lg text-gray-200 text-sm leading-relaxed">${escapeHtml(txt)}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function addUserMessage(txt, senderName, senderAvatar) {
        const name = senderName || userProfile.name || "Me";
        const avatar = senderAvatar || userProfile.avatar;
        const d = document.createElement('div');
        d.className = "flex flex-row-reverse gap-3 my-4 items-end z-10";
        let avatarHTML = "";
        if (avatar.startsWith('data:') || avatar.startsWith('http')) {
            avatarHTML = `<div class="avatar-img-box shrink-0"><img src="${avatar}" class="avatar-img" alt="Avatar"></div>`;
        } else if (userStats.ascii) {
            avatarHTML = `<div class="w-10 h-10 rounded-lg bg-slate-900 border border-blue-500/50 flex items-center justify-center shrink-0 overflow-hidden p-1 shadow-lg shadow-blue-500/20"><div class="ascii-art text-center w-full">${userStats.ascii}</div></div>`;
        } else {
            avatarHTML = `<div class="w-10 h-10 rounded-full bg-slate-800 border-white/10 flex items-center justify-center text-xl shrink-0">${avatar}</div>`;
        }
        d.innerHTML = `${avatarHTML}<div class="flex-1 max-w-[80%]"><div class="bg-blue-600 rounded-2xl rounded-tr-none p-4 shadow-lg shadow-lg shadow-blue-600/20 text-white text-sm leading-relaxed">${escapeHtml(txt)}</div><div class="text-[10px] text-gray-500 text-right mt-1 mr-1 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ‚Ä¢ ${name}</div></div>`;
        getBox().appendChild(d);
        scrollDown();
    }
    function scrollDown() { const b=getBox(); if(b) b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' }); }
    function escapeHtml(text) { if(!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    // --- INPUT HANDLER ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            // SAFETY: Check existence
            if(!inp) return; 
            
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/evolve')) {
                let prompt = "";
                if(txt === '/evolve') { prompt = prompt("Describe change:"); } 
                else { prompt = txt.substring(8); }
                if(prompt) { handleLocalEvolution(prompt); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/kernel') || txt.startsWith('/think')) {
                triggerKernelThought();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/create ')) {
                createPrivateRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/exit ')) {
                leaveRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN ON"); initMatrix(); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN OFF"); initMatrix(); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    // FIX: Only try to send if client exists and is connected
                    try {
                        const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                        const message = new Paho.MQTT.Message(payload);
                        message.destinationName = (currentRoomName) ? `termos/rooms/${currentRoomName}` : "termos/v3/chat";
                        message.qos = 1; 
                        mqttClient.send(message);
                    } catch (e) {}
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }

    // --- INIT ---
    function getBox() {
        // FIX: Ensure elements exist before we try to access them.
        let el = document.getElementById('chat-container');
        if (!el) {
            el = document.createElement('div');
            el.id = 'chat-container';
            el.className = "flex flex flex-col h-full w-full p-4 overflow-y-auto z-10";
            document.body.appendChild(el);
        }
        return el;
    }

    function triggerAdminMode() {
        let panel = document.getElementById('admin-panel');
        if(!panel) {
            panel = document.createElement('div');
            panel.id = 'admin-panel';
            panel.className = "admin-hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-50 glass-panel p-4 rounded-xl border-red-500/30 shadow-2xl shadow-2xl">
            panel.innerHTML = `<h3 class="text-red-400 font-bold mb-3 flex items-center gap-2"><span class="animate-pulse">üî¥</span> GITHUB CONSOLE</h3><div class="space-y-2">
                <div class="p-2">
                    <button onclick="toggleCodeEditor()" class="w-full border border-green-500/50 text-green-400 bg-green-900/10 hover:bg-green-900/20 text-xs font-bold py-2 rounded mb-2">üñã EDIT SYSTEM CODE</button>
                    <div class="border-t border-white/10 pt-2 mt-2">
                        <h4 class="text-gray-400 text-xs font-bold uppercase">System Status (Simulated Admin)</h4>
                        <div class="text-[10px] text-gray-500 mt-1">You are currently running from a single HTML file. Use "Edit System Code" to fix visual bugs instantly. Download to save a local backup.</div>
                    </div>
                    <div class="border-t border-white/10 pt-2">
                        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Owner</label><input type="text" id="gh-owner" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Repo</label><input type="text" id="gh-repo" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Branch</label><input type="text" id="gh-branch" value="main" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                        <div><label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Token (Classic)</label><input type="password" id="gh-token" class="w-full bg-slate-900 border-slate-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                        <button onclick="initiateEvolution()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded text-xs tracking-wider transition-colors shadow-lg shadow-red-600/20 active:scale-95 mt-2">üß¨ PUSH TO GITHUB</button>
                    </div>
                </div>
            </div>`;
            document.body.appendChild(panel);
        }
        if (panel.classList.contains('admin-hidden')) {
            panel.classList.remove('admin-hidden');
            setTimeout(() => { panel.style.opacity = "1"; }, 10);
        } else {
            panel.style.opacity = "0";
            setTimeout(() => { panel.classList.add('admin-hidden'); }, 300);
        }
    }

    // --- EVOLUTION ---
    async function initiateEvolution() {
        if(!GROQ_API_KEY) return requestApiKey();
        
        const tkInput = document.getElementById('gh-token');
        const ownInput = document.getElementById('gh-owner');
        const repInput = document.getElementById('gh-repo');
        const branchInput = document.getElementById('gh-branch');
        if(!tkInput || !ownInput || !repInput || !branchInput) return alert("Admin UI Missing.");
        const token = tkInput.value.trim();
        const owner = ownInput.value.trim();
        const repo = repInput.value.trim();
        const branch = branchInput.value.trim() || "main";
        
        localStorage.setItem('termos_github_token', token);
        localStorage.setItem('termos_repo_owner', owner);
        localStorage.setItem('termos_repo_name', repo);
        localStorage.setItem('termos_repo_branch', branch);
        if (!token) return addSystemMessage("‚ùå GitHub Token needed.");
        if (!owner || !repo) return addSystemMessage("‚ùå Repo Owner/Name needed.");
        const input = prompt("Mutation request:");
        if (!input) return;
        addSystemMessage("üß¨ CLONING SOURCE...");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 40000); 
        try {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/index.html?ref=${branch}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, signal: controller.signal });
            if (!res.ok) { const errText = await res.json(); throw new Error(`GitHub Read (${res.status}): ${errText.message}`); }
            const data = await res.json();
            if(!data.content) throw new Error("File not found.");
            const currentContent = atob(data.content);
            addSystemMessage("üß¨ MUTATING...");
            const evolutionPrompt = `Modify HTML/JS to: "${input}". Return ONLY raw code. No markdown.`;
            const aiReq = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    model: API_MODEL,
                    messages: [{ role: "system", content: "Return ONLY raw code." }, { role: "user", content: evolutionPrompt + "\n\nCODE:\n" + currentContent }],
                    temperature: 0.5, max_tokens: 8000
                })
            });
            const aiData = await aiReq.json();
            if (aiData.error) throw new Error(`AI Error: ${aiData.error.message}`);
            if (!aiData.choices || aiData.choices.length === 0) throw new Error("AI empty.");
            let newCode = aiData.choices[0].message.content;
            if (newCode.startsWith("```html")) newCode = newCode.substring(7);
            else if (newCode.startsWith("```")) newCode = newCode.substring(3);
            if (newCode.endsWith("```")) newCode = newCode.substring(0, newCode.length - 3);
            newCode = newCode.trim();
            addSystemMessage("üß¨ UPLOADING...");
            const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/index.html`;
            const encodedContent = btoa(unescape(encodeURIComponent(newCode)));
            const putRes = await fetch(putUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Evolution: " + input,
                    content: encodedContent,
                    sha: data.sha,
                    branch: branch
                }),
                signal: controller.signal
            });
            if (!putRes.ok) {
                let errorMsg = "Unknown";
                try { const errorData = await putRes.json(); errorMsg = errorData.message || JSON.stringify(errorData); } catch (e) { errorMsg = await putRes.text(); }
                if(errorMsg.includes("Resource not accessible")) {
                    errorMsg = "Use Classic Token.";
                }
                throw new Error(`GitHub Write (${putRes.status}): ${errorMsg}`);
            }
            clearTimeout(timeoutId);
            addSystemMessage("üéâ SUCCESS. REBOOTING...");
            setTimeout(() => location.reload(), 2000);
        } catch (err) {
            clearTimeout(timeoutId);
            console.error(err);
            addSystemMessage("‚ùå FAIL: " + err.message);
        }
    }

    function connectMQTT() {
        try {
            mqttClient.connect({
                timeout: 10, useSSL: true, keepAliveInterval: 60,
                onSuccess: () => { mqttClient.subscribe("termos/v3/chat", { qos: 1 }); },
                onFailure: () => { setTimeout(connectMQTT, 5000); }
            });
        } catch (e) {}
    }

    // --- WINDOW LOAD ---
    window.onload = function() {
        console.log(">> SYSTEM LOADED SAFE BOOT");
        updateStatusDot(!!GROQ_API_KEY);
        if(!document.getElementById('chat-container')) {
            document.body.innerHTML += `<div id="chat-container" class="flex flex-col h-full w-full p-4 overflow-y-auto z-10"></div>`;
        }
        
        document.getElementById('gh-token').value = GITHUB_TOKEN;
        document.getElementById('gh-owner').value = REPO_OWNER;
        document.getElementById('gh-repo').value = REPO_NAME;
        document.getElementById('gh-branch').value = REPO_BRANCH;
        
        initMatrix();
        // Load State
        if(typeof localStorage.getItem('termos_private_room')) {
            privateRoomName = localStorage.getItem('termos_private_room');
            if(privateRoomName) {
                addSystemMessage("üîí Re-joining Room: " + privateRoomName);
                // Auto-join logic handled by connectMQTT logic for "Online" state
                // We set a timeout to allow the MQTT connection to initialize before trying to join.
                setTimeout(() => {
                    if(mqttClient && mqttClient.isConnected()) { 
                        // Check if not in room by checking a local variable
                        let inRoom = false;
                        // Note: This is a simulation for "Online" status in private rooms if offline
                        if(!currentRoomName) inRoom = true;
                    } else {
                        if(!inRoom && currentRoomName) {
                            joinVideoRoom(currentRoomName); // Trigger the join sequence
                        }
                    }
                }, 500); // Delayed check
            }
        }
        loadState();
        if (typeof Paho !== 'undefined') {
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, "termos_client_" + Math.random().toString(16).substr(2, 8));
            mqttClient.onConnectionLost = () => { setTimeout(connectMQTT, 5000); };
            mqttClient.onMessageArrived = (message) => {
                if (message.destinationName === "termos/v3/chat") {
                    const data = JSON.parse(message.payloadString);
                    if (data.user !== username) {
                        addUserMessage(data.text, data.nick, data.avatar);
                    }
                }
                // Handle Private Room Messages
                if(currentRoomName && message.destinationName.includes(currentRoomName)) {
                    const data = JSON.parse(message.payloadString);
                    if(data.type === 'join') {
                        joinVideoRoom(currentRoomName); 
                        addAIMessage(`üîí ${data.nick} joined.`);
                        updateOnlineStatus(true);
                        // Show Room UI
                        const overlay = document.getElementById('video-overlay-ui');
                        overlay.classList.remove('hidden');
                        document.getElementById('video-placeholder').classList.add('hidden');
                        document.getElementById('video-player').classList.remove('hidden');
                        document.getElementById('room-status-indicator').classList.remove('hidden');
                        document.getElementById('current-room-name').innerText = currentRoomName.toUpperCase();
                        document.getElementById('room-display').innerText = "ONLINE";
                        document.getElementById('room-status-dot').className = "bg-green-500";
                    } else if (data.type === 'leave') {
                        leaveRoom();
                    } else {
                        addUserMessage(data.text, data.nick, data.avatar);
                    }
                }
            };
            connectMQTT();
        }
        
        const sendBtn = document.getElementById('send-btn');
        if(sendBtn) sendBtn.onclick = handleInput;
        const userInput = document.getElementById('user-input');
        if(userInput) {
            userInput.addEventListener('keypress',e=>{ if(e.key==='Enter') handleInput(); });
            userInput.focus();
        }
        if(!GROQ_API_KEY) {
            setTimeout(() => { addSystemMessage("‚ö†Ô∏è API Key Required."); requestApiKey(); }, 1000);
        }
    };

    // --- STATUS DOT UPDATES ---
    function updateStatusDot(active) {
        const dot = document.getElementById('api-status-dot');
        const roomDot = document.getElementById('room-status-indicator');
        const timeDot = document.getElementById('time-display'); // Added for Real-Time dot

        if(dot) {
            dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]";
            document.getElementById('room-display').innerText = "ONLINE";
        } else {
            dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
            document.getElementById('room-display').innerText = "OFFLINE";
        }
    }

    function updateRealTimeUI() {
        const timeDot = document.getElementById('time-display');
        if(timeDot) {
            timeDot.classList.remove('hidden'); // Hide simulated clock
            timeDot.classList.remove('hidden');
        }
    }

    // SYSTEM CORE INTERFACE ---
    function installCoreInterface() {
        // FIX: Hardcoded "CoreInterface" module behavior. The AI sometimes fails to parse the code response, or generates bad markdown.
        // This function is a simple terminal simulation for now.
        addSystemMessage("‚úÖ Core Interface Loaded.");
    }

    // SYSTEM REBUILDER ---
    const SystemRebuilder = {
        install: function(name) {
            // Strip special chars to match AI output exactly
            name = name.toLowerCase().trim();
            // Relax regex to match "CoreInterface" -> coreinterface"
            if(name === 'coreinterface') name = 'coreinterface'; 

            // Allow "CoreInterface" (Friend Name)
            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            
            // Hardcode 'CoreInterface' behavior (Install via Kernel or /sys install)
            if(name === 'coreinterface') {
                // This function now simulates the "Code Editor" changes to the DOM instantly
                // It simply overwrites `document.documentElement.outerHTML` with the previous value.
                if(confirm("Kernel suggests upgrade: Core Interface. Apply? (This will save to local storage and restore on reload)") {
                    // Generate a fake "System Code Editor" string to simulate a system file
                    // Just for effect, this doesn't actually use the system files (due to browser security restrictions).
                    const fakeSystemCode = `
<!DOCTYPE html>
<html lang="en">
<!-- This is a simulated system interface for demo purposes only. -->
<body class="dark"><body>You are now in Core Interface mode...</body>
</html>
                    `;
                    
                    // Update UI to "Terminal" theme
                    document.documentElement.style.setProperty('--glass-bg', '#000'); 
                    document.documentElement.style.setProperty('--text-color', '#10b981');
                    
                    // Create a fake terminal window
                    const termWin = window.open("", "", "_blank");
                    doc = termWin.document;
                    doc.open(); // Ensure document is ready
                    termWin.document.write("<pre>System Terminal Initialized. Type 'exit' to return to OS. Type 'exit' to close this window.</pre>");
                    
                    // Replace 'document.documentElement' with the window (fake) only for effect
                    const fakeBody = `<body style="background: #000; color: #10b981; overflow:hidden; height: 100vh; display: flex; flex; justify-content: center; font-family: 'Fira Code', monospace;">
                        <div class="p-8 text-green-400">Connected to TermOS Kernel...</div>
                        <div class="text-xs text-gray-500">User is logged in. /sys exit/exit</div>
                    </body>`;

                    document.documentElement.replaceChild(document.documentElement, fakeBody); // This is harmless for the demo, as `replaceChild` on a ghost element is dangerous, so we replace the body.
                    // It mimics the effect without crashing the app.
                }
                
                // Set the cursor to a block for "Processing" look
                document.body.style.cursor = "wait";
                
                setTimeout(() => {
                    // Reset UI and Cursor to default
                    document.body.style.cursor = 'text';
                    if(termWin && !termWin.closed) {
                        termWin.close();
                        termWin = null;
                    }
                    // Restore the original body
                    const restoreBody = localStorage.getItem('termos_original_body') || document.body.outerHTML; // Restore previous body
                    // Remove the terminal fake
                    const fakeWin = document.getElementById('fake-terminal'); // Kill the demo window if it still exists (it shouldn't)
                    if(fakeWin) fakeWin.close();
                }
                }, 1500);
        }
            } else if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            
            // Fallthrough for other names
            try {
                switch(name) {
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    case 'realtime': this.installRealTime(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        }
        installRealTime: function() {
            isRealTime = true;
            updateRealTimeUI();
        }
    }

    // --- INPUT HANDLER ---
    function handleInput() {
        try {
            let inp = document.getElementById('user-input');
            if(!inp) return; 
            let txt = inp.value.trim(); 
            if(!txt) return;

            if(txt.startsWith('/evolve')) {
                let prompt = "";
                if(txt === '/evolve') { prompt = prompt("Describe change:"); } 
                else { prompt = txt.substring(8); }
                if(prompt) { handleLocalEvolution(prompt); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/think') || txt.startsWith('/kernel')) {
                triggerKernelThought();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/create ')) {
                createPrivateRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/exit ')) {
                leaveRoom();
                inp.value = '';
                return;
            }

            if(txt.startsWith('/admin ')) {
                const cmd = txt.split(' ')[1];
                if (cmd === 'enable') { adminMode = true; toggleAdminMode(); addSystemMessage("üî¥ ADMIN ON"); initMatrix(); }
                else if (cmd === 'disable') { adminMode = false; toggleAdminMode(); addSystemMessage("üü¢ ADMIN OFF"); initMatrix(); }
                inp.value = '';
                return;
            }

            if(txt.startsWith('/sys install ')) SystemRebuilder.install(txt.split(' ')[2]);
            else if(txt.startsWith('/setkey ')) requestApiKey();
            else if(txt.startsWith('/ai ')) handleAI(txt.substring(4));
            else {
                addUserMessage(txt);
                addXP(1);
                if(mqttClient && mqttClient.isConnected()) {
                    if(mqttClient && mqttClient.isConnected()) {
                        const payload = JSON.stringify({ user: username, text: txt, nick: userProfile.name, avatar: userProfile.avatar });
                        const message = new Paho.MQTT.Message(payload);
                        // If in private room, send to private
                        const dest = (privateRoomName) ? `termos/rooms/${privateRoomName}` : "termos/v3/chat";
                        message.destinationName = dest;
                        message.qos = 1; 
                        mqttClient.send(message);
                    } else {
                        // Send to public
                        const msg = new Paho.MQTT.Message(payload);
                        message.destinationName = "termos/v3/chat";
                        message.qos = 1; 
                        mqttClient.send(msg);
                    }
                }
            }
            inp.value = '';
        } catch (e) { console.error(e); }
    }

    // --- INIT ---
    window.onload = function() {
        // FIX: Add check for element existence every time
        if(!document.getElementById('chat-container')) {
            document.body.innerHTML += `<div id="chat-container" class="flex flex-col h-full w-full p-4 overflow-y-auto z-10"></div>`;
        }
        
        // Restore inputs
        if(document.getElementById('gh-token')) document.getElementById('gh-token').value = GITHUB_TOKEN;
        document.getElementById('gh-owner').value = REPO_OWNER;
        document.getElementById('gh-repo').value = REPO_NAME;
        document.getElementById('gh-branch').value = REPO_BRANCH;
        
        initMatrix();
        loadState();
        
        // Load real-time persistence
        const savedTime = localStorage.getItem('termos_realtime');
        if(savedTime === 'true') {
            SystemRebuilder.install('realtime');
        }

        // MQTT Init
        if (typeof Paho !== 'undefined') {
            mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, "termos_client_" + Math.random().toString(16).substr(2, 8));
            mqttClient.onConnectionLost = () => { setTimeout(connectMQTT, 5000); };
            mqttClient.onMessageArrived = (message) => {
                if (message.destinationName === "termos/v3/chat") {
                    const data = JSON.parse(message.payloadString);
                    if (data.user !== username) {
                        addUserMessage(data.text, data.nick, data.avatar);
                    }
                    // Private Room Logic
                    if(currentRoomName && message.destinationName.includes(currentRoomName)) {
                        const data = JSON.parse(message.payloadString);
                        // Handle Video
                        if (data.type === 'video') {
                            playVideoUrl(data.url);
                            addAIMessage(`üìª ${data.nick} started a video.`);
                            updateOnlineStatus(true);
                            // Update UI
                            document.getElementById('video-overlay-ui').classList.remove('hidden');
                            document.getElementById('video-placeholder').classList.add('hidden');
                            document.getElementById('video-player').classList.remove('hidden');
                            document.getElementById('room-status-indicator').classList.remove('hidden');
                            document.getElementById('current-room-name').innerText = currentRoomName.toUpperCase();
                            document.getElementById('room-display').innerText = "ONLINE";
                            document.getElementById('room-status-dot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]";
                            document.getElementById('room-display').innerText = "ONLINE";
                            document.getElementById('room-status-indicator').innerText = "ONLINE";
                            document.getElementById('room-status-dot').style.color = "var(--room-online)";
                            document.getElementById('room-status-dot').style.textShadow = "0 0 5px var(--room-online)";
                        } else {
                            addUserMessage(data.text, data.nick, data.avatar);
                        }
                    }
                }
            };
        }
        const sendBtn = document.getElementById('send-btn');
        if(sendBtn) sendBtn.onclick = handleInput;
        const userInput = document.getElementById('user-input');
        if(userInput) {
            userInput.addEventListener('keypress',e=>{ if(e.key==='Enter') handleInput(); });
            userInput.focus();
        }
        if(!GROQ_API_KEY) {
            setTimeout(() => { addSystemMessage("‚ö†Ô∏è API Key Required."); requestApiKey(); }, 1000);
        }
    };

    // --- SYSTEM REBUILDER ---
    const SystemRebuilder = {
        install: function(name) {
            // Strip special chars to match AI output exactly
            name = name.toLowerCase().trim();
            // Strip special chars
            name = name.replace(/[^a-zA-Z0-9]/g, '');

            if (installedModules.includes(name)) return addSystemMessage(`${name} active.`);
            try {
                switch(name) {
                    case 'coreinterface': this.installCoreInterface(); break;
                    case 'realtime': this.installRealTime(); break;
                    case 'matrix': initMatrix(); break;
                    case 'sound': case 'beep': this.addSound(); break;
                    case 'neon': this.addNeon(); break;
                    case 'music': this.playMusic(); break;
                    default: return addSystemMessage("Unknown: " + name);
                }
                installedModules.push(name);
                addSystemMessage("‚úÖ Installed: " + name.toUpperCase());
            } catch (e) { addSystemMessage("‚ùå Error: " + e.message); }
        },
        installCoreInterface: function() {
            // FIX: Simulated visual feedback
            const overlay = document.getElementById('video-overlay');
            
            // Disable interactions while "In System Interface"
            const inputs = document.querySelectorAll('input, button, button');
            inputs.forEach(el => el.style.pointerEvents = "none");

            // Flash screen red
            document.body.style.background = "#200"; 

            // Add fake terminal window (same as before)
            const termWin = window.open("", "", "_blank");
            const doc = termWin.document;
            doc.open();
            const fakeBody = document.createElement('div');
            fakeBody.innerHTML = `<div style="width:100%; height: 100%; background: #000; display: flex; justify-content: center; font-family: 'Fira Code', monospace; color: #10b981;">
                <div class="text-green-400">üß† SYSTEM MODE (DEMO)</div>
                <div class="text-xs text-gray-500">System Interface is active. Type '/admin disable' to exit.</div>
            </div>`;
            
            // Wait for "Window Loaded" event
            doc.onload = function() {
                // Replace DOM
                document.documentElement.style.background = "#020617";
                fakeBody.innerHTML = "document.body.replaceChild(document.documentElement, fakeBody)";
            }
        }
    }
</script>
</body>
</html>
