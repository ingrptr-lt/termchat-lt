<script>
    <script>
    /**
     * =========================================================================
     *  TERMOS: CONTROLLER KERNEL (MATCHES "TOTAL REBUILD" HTML)
     *  Purpose: Controls logic without breaking the UI structure.
     * =========================================================================
     */

    // --- 0. CONFIGURATION ---
    const CONFIG = {
        mqttBroker: "broker.emqx.io",
        mqttPort: 8084,
        mqttTopic: "termos/v3/chat",
        groqKey: localStorage.getItem('termos_groq_key') || "", 
        username: "Anon_" + Math.floor(Math.random() * 1000)
    };

    const STATE = {
        level: 1, xp: 0, room: "lobby", deferredPrompt: null,
        audioContext: null, installedModules: []
    };

    // --- 1. SECURITY HELPER ---
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // --- 2. DOM HELPERS (Does NOT create elements, only finds them) ---
    function getChatContainer() {
        return document.getElementById('chat-container') || document.getElementById('main-app');
    }

    function addMessage(text, type = 'user', sender = 'SYS') {
        const container = getChatContainer();
        if (!container) return; // Fail silently if UI not ready

        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if (type === 'system') {
            div.className = "text-center text-xs text-gray-500 my-2 border-t border-b border-gray-800 py-1 uppercase tracking-widest";
            div.innerText = text;
        } else if (type === 'ai') {
            div.className = "flex items-start gap-2 animate-[fadeIn_0.3s_ease-out]";
            div.innerHTML = `<div class="w-8 h-8 rounded bg-black border border-cyan-500 flex items-center justify-center text-cyan-400 shrink-0 text-xs">AI</div><div class="msg-bubble ai-bubble bg-black/50 p-3 rounded-tr-lg rounded-br-lg rounded-bl-lg text-sm"><div class="text-[10px] text-cyan-600 mb-1">AI CORE // ${time}</div>${escapeHtml(text)}</div>`;
        } else {
            div.className = "flex items-start gap-2 flex-row-reverse animate-[fadeIn_0.3s_ease-out]";
            div.innerHTML = `<div class="w-8 h-8 rounded bg-green-900 border border-green-500 flex items-center justify-center text-green-100 shrink-0 text-xs">ME</div><div class="msg-bubble bg-green-900/20 p-3 rounded-tl-lg rounded-bl-lg rounded-br-lg text-sm text-right"><div class="text-[10px] text-green-600 mb-1">${time} // ${escapeHtml(sender)}</div><div class="text-left">${escapeHtml(text)}</div></div>`;
        }
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // --- 3. SYSTEM REBUILDER (Injects Visuals) ---
    const SystemRebuilder = {
        install: function(featureName) {
            if (STATE.installedModules.includes(featureName)) {
                addMessage(`Module [${featureName}] already active.`, 'system');
                return;
            }
            console.log(`[KERNEL] Installing: ${featureName}`);
            addMessage(`[KERNEL] Installing: ${featureName.toUpperCase()}...`, 'system');
            
            try {
                switch(featureName) {
                    case 'matrix': this.injectMatrix(); break;
                    case 'crt': this.injectCRT(); break;
                    case 'sound': this.injectSound(); break;
                    case 'neon': this.injectNeon(); break;
                    case 'god': this.injectGodMode(); break;
                    default: throw new Error("Unknown Module");
                }
                STATE.installedModules.push(featureName);
                addMessage(`[SUCCESS] ${featureName.toUpperCase()} INSTALLED.`, 'system');
                if (STATE.audioContext) playSystemSound(880, 'sine', 0.1);
            } catch (e) {
                addMessage(`[ERROR] ${e.message}`, 'system');
            }
        },

        injectMatrix: function() {
            if (document.getElementById('matrix-overlay')) return;
            const canvas = document.createElement('canvas');
            canvas.id = 'matrix-overlay';
            canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.3;pointer-events:none;';
            document.body.prepend(canvas);
            const ctx = canvas.getContext('2d');
            const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            const cols = Math.floor(canvas.width / 20);
            const ypos = Array(cols).fill(0);
            const draw = () => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#0f0';
                ctx.font = '15pt monospace';
                ypos.forEach((y, i) => {
                    const text = String.fromCharCode(Math.random() * 128);
                    ctx.fillText(text, i * 20, y);
                    if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20;
                });
            };
            setInterval(draw, 33);
        },

        injectCRT: function() {
            const scanlines = document.getElementById('scanline-layer');
            const flicker = document.getElementById('flicker-layer');
            if(scanlines) scanlines.style.display = 'block';
            if(flicker) flicker.style.display = 'block';
        },

        injectSound: function() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!STATE.audioContext) STATE.audioContext = new AudioContext();
            const originalAdd = addMessage;
            window.addMessage = function(text, type, sender) {
                if (type !== 'system' && STATE.audioContext) playSystemSound(600, 'square', 0.05);
                originalAdd(text, type, sender);
            };
        },

        injectNeon: function() {
            if (document.getElementById('neon-styles')) return;
            const style = document.createElement('style');
            style.id = 'neon-styles';
            style.innerHTML = `body { text-shadow: 0 0 8px var(--neon-green); } .msg-bubble { box-shadow: 0 0 15px rgba(0,255,65,0.2); }`;
            document.head.appendChild(style);
        },

        injectGodMode: function() {
            if (document.getElementById('god-btn')) return;
            const btn = document.createElement('button');
            btn.id = 'god-btn';
            btn.innerText = "GOD_MODE";
            btn.className = "fixed top-14 right-2 z-50 bg-red-900 text-red-100 text-[10px] border border-red-500 px-2 py-1 font-mono cursor-pointer hover:bg-red-700";
            btn.onclick = () => {
                const cmd = prompt("ROOT COMMAND:");
                if(cmd) handleSend(cmd);
            };
            document.body.appendChild(btn);
        }
    };

    function playSystemSound(freq, type, duration) {
        if (!STATE.audioContext) return;
        const osc = STATE.audioContext.createOscillator();
        const gain = STATE.audioContext.createGain();
        osc.connect(gain);
        gain.connect(STATE.audioContext.destination);
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, STATE.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, STATE.audioContext.currentTime + duration);
        osc.start();
        osc.stop(STATE.audioContext.currentTime + duration);
    }

    // --- 4. BOOT SEQUENCE ---
    async function runBoot() {
        const boot = document.getElementById('boot-screen');
        const bar = document.getElementById('boot-bar');
        const main = document.getElementById('main-interface');
        const txt = document.getElementById('boot-text');
        
        if(boot) boot.classList.remove('hidden');
        
        for(let i=0; i<=100; i+=4) {
            if(bar) bar.style.width = i + '%';
            if(txt) txt.innerText = ["LOADING KERNEL...", "MOUNTING SYSTEM...", "READY"][i/20] || "OK";
            await new Promise(r => setTimeout(r, 20));
        }
        
        if(boot) boot.classList.add('hidden');
        if(main) {
            main.classList.remove('opacity-0');
            main.classList.remove('hidden');
        }
        
        addMessage("SYSTEM ONLINE. TYPE /HELP FOR COMMANDS.", "system");
        initMQTT();
    }

    // --- 5. INPUT HANDLING ---
    function handleSend() {
        const input = document.getElementById('user-input'); // Matches HTML ID
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;

        if (text.startsWith('/sys install ')) {
            const mod = text.split(' ')[2];
            SystemRebuilder.install(mod);
        } else if (text.startsWith('/setkey ')) {
            CONFIG.groqKey = text.substring(8);
            localStorage.setItem('termos_groq_key', CONFIG.groqKey);
            addMessage("API KEY ENCRYPTED.", 'system');
        } else if (text.startsWith('/ai ')) {
            handleAI(text.substring(4));
        } else if (text === '/clear') {
            const container = getChatContainer();
            if(container) container.innerHTML = '';
        } else {
            addMessage(text, 'user', CONFIG.username);
            STATE.xp += 5;
            if (STATE.xp > STATE.level * 100) {
                STATE.level++; addMessage(`LEVEL UP: LVL ${STATE.level}`, 'system');
            }
            const lvlDisp = document.getElementById('lvl-disp');
            if(lvlDisp) lvlDisp.innerText = STATE.level;
            
            if (window.mqttClient && window.mqttClient.isConnected()) {
                const msg = new Paho.MQTT.Message(JSON.stringify({ sender: CONFIG.username, text: text }));
                msg.destinationName = CONFIG.mqttTopic;
                window.mqttClient.send(msg);
            }
        }
        input.value = '';
    }

    // --- 6. AI LOGIC ---
    async function handleAI(prompt) {
        if (!CONFIG.groqKey) {
            addMessage("ERROR: Missing Key. Type /setkey [key]", 'ai');
            return;
        }
        addMessage("Processing...", 'ai');
        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${CONFIG.groqKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [
                        { role: "system", content: "You are TermOS AI. You can install modules using SystemRebuilder.install('name'). Available: matrix, crt, sound, neon, god." },
                        { role: "user", content: prompt }
                    ],
                    model: "llama3-8b-8192"
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            
            // Parse AI commands
            const installRegex = /SystemRebuilder\.install\(['"](.*?)['"]\)/g;
            let match;
            let actionsTaken = false;
            while ((match = installRegex.exec(reply)) !== null) {
                SystemRebuilder.install(match[1]);
                actionsTaken = true;
            }

            if (!actionsTaken) addMessage(reply, 'ai');
            else addMessage("Modules updated by AI.", 'ai');

        } catch (e) {
            addMessage("AI CONNECTION FAILED.", 'ai');
        }
    }

    // --- 7. MQTT LOGIC ---
    function initMQTT() {
        try {
            const client = new Paho.MQTT.Client(CONFIG.mqttBroker, CONFIG.mqttPort, "termos_"+Math.random());
            client.onConnectionLost = () => addMessage("MQTT LOST", "system");
            client.onMessageArrived = (msg) => {
                try {
                    const d = JSON.parse(msg.payloadString);
                    if(d.sender !== CONFIG.username) addMessage(d.text, 'user', d.sender);
                } catch(e) {}
            };
            client.connect({ 
                onSuccess: () => {
                    client.subscribe(CONFIG.mqttTopic);
                    addMessage("LINK ESTABLISHED.", "system");
                }, 
                useSSL: true 
            });
            window.mqttClient = client;
        } catch(e) { console.error(e); }
    }

    // --- 8. INITIALIZATION & EVENTS ---
    window.onload = runBoot;
    
    // Attach listeners safely
    const sendBtn = document.getElementById('send-btn');
    if(sendBtn) sendBtn.onclick = handleSend;
    
    const userInput = document.getElementById('user-input');
    if(userInput) {
        userInput.addEventListener('keypress', (e) => { if(e.key==='Enter') handleSend(); });
    }

    // Voice
    if ('webkitSpeechRecognition' in window) {
        const r = new webkitSpeechRecognition(); r.continuous = false;
        const voiceBtn = document.getElementById('voice-btn');
        if(voiceBtn) {
            voiceBtn.onclick = () => { r.start(); };
            r.onresult = (e) => { userInput.value = e.results[0][0].transcript; };
        }
    }
</script>
    /**
     * =========================================================================
     *  TERMOS LT: SECURE & REPAIRED KERNEL
     *  Fixes: XSS vulnerabilities, Syntax Errors, JSON Safety
     * =========================================================================
     */

    // --- 0. SECURITY HELPER (Prevents XSS) ---
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // --- 1. CONFIGURATION ---
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || ""; 
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let adminMode = false;
    let username = 'Anon_' + Math.floor(Math.random() * 1000);
    let mqttClient = null;
    let currentRoom = 'main'; 
    let userStats = { level: 1, xp: 0, avatar: '>_<', title: 'Newbie' };
    const LEVELS = ['Newbie', 'Apprentice', 'Coder', 'Hacker', 'Architect', 'Wizard', 'Master', 'GOD MODE'];

    // --- 2. SYSTEM REBUILDER (Fixed Syntax & Logic) ---
    const SystemRebuilder = {
        installedModules: [],

        install: function(featureName) {
            if (this.installedModules.includes(featureName)) {
                log(`Module [${featureName}] already active.`, 'sys-msg');
                return;
            }
            console.log(`[KERNEL] Installing: ${featureName}`);
            log(`INITIATING INSTALLATION: ${featureName.toUpperCase()}...`, 'sys-msg');

            switch(featureName) {
                case 'matrix': this.installMatrix(); break;
                case 'crt': this.installCRT(); break;
                case 'sound': this.installSound(); break;
                case 'neon-theme': this.installNeonTheme(); break;
                case 'god-mode': this.installGodMode(); break;
                default: 
                    log(`ERROR: Unknown module '${featureName}'`, 'sys-msg'); 
                    return;
            }
            this.installedModules.push(featureName);
            log(`INSTALLATION COMPLETE: ${featureName.toUpperCase()}`, 'sys-msg');
        },

        installMatrix: function() {
            if (document.getElementById('matrix-canvas')) return;
            const canvas = document.createElement('canvas');
            canvas.id = 'matrix-canvas';
            canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;pointer-events:none;';
            document.body.prepend(canvas);
            const ctx = canvas.getContext('2d');
            
            const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            
            const cols = Math.floor(canvas.width / 20);
            const ypos = Array(cols).fill(0);
            
            const draw = () => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#0f0';
                ctx.font = '15pt monospace';
                ypos.forEach((y, i) => {
                    const text = String.fromCharCode(Math.random() * 128);
                    ctx.fillText(text, i * 20, y);
                    if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20;
                });
            };
            setInterval(draw, 50);
        },

        installCRT: function() {
            if (document.getElementById('crt-overlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'crt-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));background-size:100% 2px, 3px 100%;pointer-events:none;z-index:999;animation:flicker 0.15s infinite;';
            document.body.appendChild(overlay);
            
            if (!document.getElementById('crt-styles')) {
                const style = document.createElement('style');
                style.id = 'crt-styles';
                style.innerHTML = `@keyframes flicker { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.98; } }`;
                document.head.appendChild(style);
            }
        },

        installSound: function() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const originalLog = window.log;
            if (typeof originalLog === 'function') {
                window.log = function(text, type) {
                    if (type !== 'system' && type !== 'sys-msg') {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.type = 'sine'; osc.frequency.value = 800;
                        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                    }
                    originalLog(text, type);
                };
            }
        },

        installNeonTheme: function() {
            if (document.getElementById('neon-styles')) return;
            const style = document.createElement('style');
            style.id = 'neon-styles';
            style.innerHTML = `body { text-shadow: 0 0 5px var(--term-green), 0 0 10px var(--term-green); } #screen { border: 1px solid var(--term-green); box-shadow: 0 0 15px var(--term-green); } .user-msg { color: #e0ffe0; font-weight: bold; }`;
            document.head.appendChild(style);
        },

        installGodMode: function() {
            if (document.getElementById('god-btn')) return;
            const btn = document.createElement('button');
            btn.id = 'god-btn';
            btn.innerText = "SYS_ADMIN";
            btn.style.cssText = "position:fixed;top:10px;right:10px;z-index:1000;background:red;color:white;border:none;padding:5px 10px;font-family:monospace;cursor:pointer;";
            btn.onclick = () => {
                const cmd = prompt("ENTER SYSTEM COMMAND:");
                if(cmd) handleInput(cmd);
            };
            document.body.appendChild(btn);
        }
    };

    // --- 3. INITIALIZATION ---
    window.addEventListener('load', () => {
        console.log(">> SYSTEM INITIALIZING...");
        setTimeout(() => { checkAndRun(); }, 500);
    });

    function checkAndRun() {
        try {
            initMatrix();
        } catch (e) { console.error("Matrix Init Failed:", e); }
        
        try {
            runTerminalBoot();
        } catch (e) {
            console.error("Boot Sequence Failed:", e);
            forceBootMainApp();
        }
    }

    // --- 4. MATRIX (Fallback) ---
    function initMatrix() {
        // If SystemRebuilder hasn't run it yet
        if (!document.getElementById('matrix-canvas')) {
            SystemRebuilder.installMatrix();
        }
    }

    // --- 5. TERMINAL BOOT ---
    function runTerminalBoot() {
        const term = document.getElementById('terminal-content');
        if (!term) {
            term = document.createElement('div');
            term.id = 'terminal-content';
            term.className = "font-mono text-sm text-green-300 mb-4 border-l-2 border-green-800 pl-2 bg-black/50 h-64 overflow-y-auto";
            document.body.appendChild(term);
        }
        
        let lines = [
            "Initializing BIOS...", "Loading Kernel Modules...", "Checking Neural Net...",
            ">>> [1] Multiverse Chat", ">>> [2] AI Assistant", ">>> [3] Local Mode",
            "Type '1', '2', or '3' to start..."
        ];

        let index = 0;
        const typeNextLine = () => {
            if (index < lines.length) {
                const div = document.createElement('div');
                div.className = "opacity-80 animate-fade-in mb-1 font-mono text-sm";
                div.innerText = lines[index];
                term.appendChild(div);
                term.scrollTop = term.scrollHeight;
                index++;
                setTimeout(typeNextLine, 30);
            } else {
                forceBootMainApp();
            }
        };
        typeNextLine();
    }

    // --- 6. MAIN APP BOOT ---
    function forceBootMainApp() {
        console.log("!!! FORCE BOOT TRIGGERED !!!");
        
        let main = document.getElementById('main-app');
        if(!main) {
            main = document.createElement('div');
            main.id = 'main-app';
            main.className = "hidden flex flex-col relative z-10 h-full";
            document.body.appendChild(main);
        }
        
        const boot = document.getElementById('terminal-boot');
        if(boot) boot.style.display = 'none';
        
        main.classList.remove('hidden');
        main.classList.add('flex');

        if (!username || username === 'Guest') username = "Operator_" + Math.floor(Math.random() * 9999);
        const userDisplay = document.getElementById('user-display');
        if(userDisplay) userDisplay.innerText = `@${username.toUpperCase()}`;
        
        loadStats();
        updateStatsUI();
        connectMQTT();
        addSystemMessage("System Initialized (Recovery Mode).");
    }

    // --- 7. UI UPDATES ---
    function updateStatsUI() {
        const titleEl = document.getElementById('lvl-text');
        const xpEl = document.getElementById('xp-disp'); // Corrected ID
        const barEl = document.getElementById('xp-bar');
        
        if(titleEl) titleEl.innerText = `LVL ${userStats.level} ${userStats.title.toUpperCase()}`;
        if(xpEl) xpEl.innerText = `XP: ${userStats.xp.toLocaleString()}`;
        
        const progress = (userStats.xp % 1000) / 10; 
        if(barEl) barEl.style.width = `${progress}%`;
    }

    function loadStats() {
        const saved = localStorage.getItem('termos_stats');
        if(saved) try { userStats = JSON.parse(saved); } catch(e){}
    }

    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 1000)) {
            userStats.level++;
            userStats.title = LEVELS[userStats.level] || 'GOD MODE';
            addSystemMessage(`LEVEL UP! RANK: ${userStats.title}`);
        }
        updateStatsUI();
        localStorage.setItem('termos_stats', JSON.stringify(userStats));
    }

    // --- 8. CHAT RENDERING (SECURE) ---
    function addUserMessage(text) {
        const container = document.getElementById('main-app');
        if(!container) return;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // XSS FIX: Use escapeHtml on user content
        const safeText = escapeHtml(text);
        
        const html = `
        <div class="flex flex-row-reverse items-end gap-3 animate-fade-in-up">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-green-400 to-emerald-600 flex items-center justify-center border border-white/20 font-mono text-black text-xs font-bold">ME</div>
            <div class="p-4 rounded-l-xl rounded-br-xl text-sm text-green-100 shadow-[0_4px_20px_rgba(0,0,0,0.3)] max-w-[80%] bg-gray-900/50 border border-green-900/30">
                <div class="flex items-center gap-2 mb-1 opacity-80 text-xs font-mono text-green-400">
                    <span>@${escapeHtml(username.toUpperCase())}</span>
                    <span>${time}</span>
                </div>
                <div class="text-left">${safeText}</div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function addAIMessage(text, isAction) {
        const container = document.getElementById('main-app');
        if(!container) return;
        const cssClass = isAction ? 'border border-cyan-500/50' : 'border border-white/10 bg-black/60';
        
        // XSS FIX: Escape AI content unless you explicitly trust the AI to render HTML
        const safeText = escapeHtml(text);

        const html = `
        <div class="flex flex-row items-start gap-3 animate-fade-in-up">
            <div class="w-8 h-8 rounded-full bg-black border border-cyan-500 flex items-center justify-center text-cyan-400 font-mono text-[8px] font-bold">AI</div>
            <div class="flex-1">
                <div class="px-2 py-1 text-[10px] text-cyan-600 font-mono">TERM_AI_SYSTEM</div>
                <div class="p-4 rounded-r-xl rounded-bl-xl ${cssClass} text-sm text-gray-200 backdrop-blur-sm border-t-0">
                    <p class="leading-relaxed">${safeText}</p>
                </div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function addSystemMessage(text) {
        const container = document.getElementById('main-app');
        if(!container) return;
        container.insertAdjacentHTML('beforeend', `<div class="p-2 rounded text-xs text-center text-cyan-500 border border-cyan-900/30 bg-black/40 my-1 font-mono">[ SYSTEM: ${escapeHtml(text)} ]</div>`);
        scrollToBottom();
    }

    function scrollToBottom() {
        const c = document.getElementById('main-app');
        if(c) c.scrollTop = c.scrollHeight;
    }

    // --- 9. MQTT (SECURE PARSING) ---
    function connectMQTT() {
        if (typeof Paho === 'undefined') {
            console.warn("MQTT Library missing.");
            return;
        }
        
        const clientId = "termos-" + Math.random().toString(16).substr(2, 8);
        mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, clientId); // Updated for newer Paho API if needed, or keep split

        mqttClient.onConnectionLost = () => {
            addSystemMessage("Connection Lost. Reconnecting...");
            setTimeout(connectMQTT, 5000);
        };

        mqttClient.onMessageArrived = (message) => {
            try {
                // SECURITY: Ensure we are parsing safely
                const payload = JSON.parse(message.payloadString);
                
                // Ensure payload has expected structure
                if (payload && payload.text && payload.user) {
                    const container = document.getElementById('main-app');
                    if (container) {
                        const safeText = escapeHtml(payload.text);
                        const safeUser = escapeHtml(payload.user);
                        
                        container.insertAdjacentHTML('beforeend', `
                        <div class="flex flex-row items-end gap-3 animate-fade-in-up opacity-80">
                            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center border border-white/20 font-mono text-white text-xs">${safeUser.substring(0,2).toUpperCase()}</div>
                            <div class="p-3 rounded-xl bg-slate-800/50 text-sm text-gray-300 max-w-[80%] border border-white/5">
                                <div class="opacity-70 text-[10px] font-mono text-gray-500 mb-1">@${safeUser.toUpperCase()}</div>
                                <p class="leading-relaxed">${safeText}</p>
                            </div>
                        </div>`);
                        scrollToBottom();
                    }
                }
            } catch (e) {
                console.error("MQTT Parse Error", e);
                // Don't crash the app, just log it
            }
        };

        mqttClient.connect({
            onSuccess: () => {
                mqttClient.subscribe(`termchat/messages/${currentRoom}`);
                addSystemMessage("Uplink Established.");
            },
            onFailure: () => { addSystemMessage("MQTT Connection Failed."); },
            useSSL: true
        });
    }

    function publishMessage(text) {
        if (mqttClient && mqttClient.isConnected()) {
            mqttClient.publish(`termchat/messages/${currentRoom}`, JSON.stringify({ user: username, text: text }));
        }
    }

    // --- 10. UTILS ---
    function switchRoom(roomName) {
        if(!roomName) return;
        if (mqttClient && mqttClient.isConnected()) {
            mqttClient.unsubscribe(`termchat/messages/${currentRoom}`);
        }
        currentRoom = roomName;
        const roomTitle = document.getElementById('room-title');
        if(roomTitle) roomTitle.innerText = roomName.toUpperCase().replace('_', ' ');
        if (mqttClient && mqttClient.isConnected()) {
            mqttClient.subscribe(`termchat/messages/${currentRoom}`);
        }
        addSystemMessage(`Joined Room: [${roomName.toUpperCase()}]`);
    }

    function downloadCodeFile(filename, content) {
        // FIXED SYNTAX ERROR HERE
        let mimeType = 'text/plain';
        if(filename.endsWith('.js')) mimeType = 'text/javascript';
        
        const element = document.createElement('a');
        element.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        
        addSystemMessage(`File saved: ${filename}`);
    }

    // --- 11. INPUT HANDLING ---
    function handleInput() {
        const input = document.getElementById('cmd-input');
        if (!input) return;
        
        const text = input.value.trim();
        if (!text) return;

        // System Installer Command
        if (text.startsWith('/sys install ')) {
            const mod = text.split(' ')[2];
            SystemRebuilder.install(mod);
        }
        // API Key
        else if (text.startsWith('/setkey ')) {
            GROQ_API_KEY = text.substring(8);
            localStorage.setItem('termos_groq_key', GROQ_API_KEY);
            addSystemMessage("API KEY SAVED.");
        }
        // Chat
        else {
            addUserMessage(text);
            addXP(1);
            publishMessage(text);
            
            // AI Trigger (Simple version)
            if (text.startsWith('/ai ')) {
                talkToClone(text.substring(4));
            }
        }
        
        input.value = '';
    }

    // Attach Global Listener
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const input = document.getElementById('cmd-input');
            if(input && document.activeElement === input) {
                handleInput();
            }
        }
    });

    // AI Logic Placeholder (Simplified for security)
    async function talkToClone(prompt) {
        if (!GROQ_API_KEY) {
            addAIMessage("Error: API Key missing. Type /setkey [key]", false);
            return;
        }
        addAIMessage("Thinking...", false);
        try {
            // Note: Ensure your fetch logic is here and secure
            // ... (Omitted for brevity, use the logic from previous steps) ...
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ messages: [{role: "user", content: prompt}], model: "llama3-8b-8192" })
            });
            const data = await res.json();
            if(data.choices) addAIMessage(data.choices[0].message.content, false);
            else addAIMessage("AI Error.", false);
        } catch (e) {
            addAIMessage("Connection Failed.", false);
        }
    }

</script>
