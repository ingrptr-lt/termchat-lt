<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TermOS: Neural Link</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --neon-green: #00ff41;
            --neon-cyan: #00f3ff;
            --neon-red: #ff003c;
            --bg-dark: #050505;
        }
        body {
            background-color: var(--bg-dark);
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
        }
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 50; display: none;
        }
        .crt-flicker {
            animation: flicker 0.15s infinite;
            pointer-events: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 16, 16, 0.1); z-index: 49; opacity: 0.1; display: none;
        }
        @keyframes flicker { 0% { opacity: 0.1; } 50% { opacity: 0.2; } 100% { opacity: 0.1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--neon-green); border-radius: 3px; }
        
        /* Animations */
        .msg-bubble {
            max-width: 85%; word-wrap: break-word;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
            backdrop-filter: blur(4px);
        }
        .ai-bubble {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        }
        .install-prompt { animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- VISUAL OVERLAYS -->
    <div id="scanline-layer" class="scanlines"></div>
    <div id="flicker-layer" class="crt-flicker"></div>

    <!-- BOOT LOADER -->
    <div id="boot-screen" class="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center p-4 hidden">
        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-green-500 tracking-widest">TERMOS</h1>
        <div class="w-64 h-2 border border-green-500/50 mt-4 relative overflow-hidden">
            <div id="boot-bar" class="absolute top-0 left-0 h-full bg-green-500 w-0 shadow-[0_0_10px_#00ff41]"></div>
        </div>
        <div id="boot-text" class="mt-2 text-xs text-green-400 font-mono h-4">INITIALIZING KERNEL...</div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="flex flex-col h-full w-full opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="h-14 border-b border-green-500/30 flex items-center justify-between px-4 bg-black/80 backdrop-blur-md shrink-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="font-bold text-lg tracking-widest" id="room-display">LOBBY</span>
            </div>
            <div class="flex items-center gap-3 text-xs md:text-sm">
                <span class="text-cyan-400 hidden md:inline">VER: 3.5 (SECURE)</span>
                <span class="border border-green-500/50 px-2 py-1 rounded">LVL <span id="lvl-disp" class="font-bold text-white">1</span></span>
            </div>
        </header>

        <!-- CHAT SCREEN -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24 scroll-smooth"></main>

        <!-- INPUT AREA -->
        <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black via-black/90 to-transparent z-30">
            <div class="max-w-4xl mx-auto flex gap-2 items-center bg-black/60 border border-green-500/50 rounded-lg p-1 shadow-[0_0_15px_rgba(0,255,65,0.1)]">
                <button id="install-btn" class="hidden bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold px-3 py-2 rounded transition-colors shrink-0">INSTALL</button>
                <button id="voice-btn" class="text-green-500 hover:text-white transition-colors px-2 text-xl">üéôÔ∏è</button>
                <input type="text" id="user-input" placeholder="Type /sys install [module]..." class="bg-transparent border-none outline-none text-green-400 flex-1 px-2 font-mono placeholder-green-800">
                <button id="send-btn" class="bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white border border-green-600 px-4 py-2 rounded text-sm font-bold transition-all">SEND</button>
            </div>
        </div>

        <!-- INSTALL MODAL -->
        <div id="custom-install-modal" class="hidden absolute bottom-24 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-gray-900 border border-cyan-500 p-4 rounded-lg shadow-[0_0_20px_rgba(0,243,255,0.2)] z-40 install-prompt">
            <h3 class="text-cyan-400 font-bold mb-2">üì≤ INSTALL TERMOS</h3>
            <p class="text-xs text-gray-400 mb-3">Add TermOS to your home screen for the full experience.</p>
            <div class="flex gap-2">
                <button id="modal-install-confirm" class="flex-1 bg-cyan-600 text-white text-xs font-bold py-2 rounded hover:bg-cyan-500">INSTALL</button>
                <button id="modal-install-cancel" class="flex-1 border border-gray-600 text-gray-400 text-xs font-bold py-2 rounded hover:bg-gray-800">LATER</button>
            </div>
        </div>
    </div>

<!-- =========================================================== -->
<!--  START OF FIXED SCRIPT (Wrapped in <script> tags)  -->
<!-- =========================================================== -->
<script>
    /**
     * =========================================================================
     *  TERMOS LT: SECURE & REPAIRED KERNEL
     *  Fixes: XSS vulnerabilities, Syntax Errors, JSON Safety
     * =========================================================================
     */

    // --- 0. SECURITY HELPER ---
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // --- 1. CONFIGURATION ---
    let GROQ_API_KEY = localStorage.getItem('termos_groq_key') || ""; 
    const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    let adminMode = false;
    let username = 'Anon_' + Math.floor(Math.random() * 1000);
    let mqttClient = null;
    let currentRoom = 'main'; 
    let userStats = { level: 1, xp: 0, avatar: '>_<', title: 'Newbie' };
    const LEVELS = ['Newbie', 'Apprentice', 'Coder', 'Hacker', 'Architect', 'Wizard', 'Master', 'GOD // --- 2. SYSTEM REBUILDER (UPDATED WITH ALIASES) ---
const SystemRebuilder = {
    installedModules: [],

    install: function(featureName) {
        // Clean input (lowercase, trim)
        const mod = featureName.toLowerCase().trim();

        if (this.installedModules.includes(mod)) {
            log(`Module [${mod}] already active.`, 'sys-msg');
            return;
        }
        console.log(`[KERNEL] Installing module: ${mod}`);
        log(`INITIATING INSTALLATION: ${mod.toUpperCase()}...`, 'sys-msg');

        switch(mod) {
            case 'matrix':
                this.installMatrix();
                break;
            case 'crt':
            case 'scanlines': // Added alias
                this.installCRT();
                break;
            case 'sound':
            case 'beep': // Added alias
                this.installSound();
                break;
            case 'neon':
            case 'neon-theme':
            case 'glow': // Added alias
                this.installNeonTheme();
                break;
            // FIXED: Now accepts 'god', 'admin', 'root', AND 'god-mode'
            case 'god':
            case 'admin':
            case 'root':
            case 'god-mode':
                this.installGodMode();
                break;
            default:
                log(`ERROR: Unknown module '${mod}'`, 'sys-msg');
                log(`TRY: matrix, crt, sound, neon, god`, 'sys-msg');
                return;
        }

        this.installedModules.push(mod);
        log(`INSTALLATION COMPLETE: ${mod.toUpperCase()}`, 'sys-msg');
    },

    installMatrix: function() {
        if (document.getElementById('matrix-canvas')) return;
        const canvas = document.createElement('canvas');
        canvas.id = 'matrix-canvas';
        canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;pointer-events:none;';
        document.body.prepend(canvas);
        const ctx = canvas.getContext('2d');
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.addEventListener('resize', resize); resize();
        const cols = Math.floor(canvas.width / 20);
        const ypos = Array(cols).fill(0);
        const draw = () => {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0f0';
            ctx.font = '15pt monospace';
            ypos.forEach((y, i) => {
                const text = String.fromCharCode(Math.random() * 128);
                ctx.fillText(text, i * 20, y);
                if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20;
            });
        };
        setInterval(draw, 50);
    },

    installCRT: function() {
        let overlay = document.getElementById('crt-overlay');
        if(!overlay) {
             overlay = document.createElement('div');
             overlay.id = 'crt-overlay';
             overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));background-size:100% 2px, 3px 100%;pointer-events:none;z-index:999;animation:flicker 0.15s infinite;';
             document.body.appendChild(overlay);
        } else {
            overlay.style.display = 'block';
        }
        if (!document.getElementById('crt-styles')) {
            const style = document.createElement('style');
            style.id = 'crt-styles';
            style.innerHTML = `@keyframes flicker { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.98; } }`;
            document.head.appendChild(style);
        }
    },

    installSound: function() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const originalLog = window.log;
        if (typeof originalLog === 'function') {
            window.log = function(text, type) {
                if (type !== 'system' && type !== 'sys-msg') {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.type = 'sine'; osc.frequency.value = 800;
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                }
                originalLog(text, type);
            };
        }
    },

    installNeonTheme: function() {
        if (document.getElementById('neon-styles')) return;
        const style = document.createElement('style');
        style.id = 'neon-styles';
        style.innerHTML = `body { text-shadow: 0 0 5px var(--neon-green), 0 0 10px var(--neon-green); } .msg-bubble { box-shadow: 0 0 15px rgba(0,255,65,0.2); }`;
        document.head.appendChild(style);
    },

    installGodMode: function() {
        if (document.getElementById('god-btn')) return;
        const btn = document.createElement('button');
        btn.id = 'god-btn';
        btn.innerText = "GOD_MODE";
        btn.style.cssText = "position:fixed;top:10px;right:10px;z-index:1000;background:red;color:white;border:none;padding:5px 10px;font-family:monospace;cursor:pointer;";
        btn.onclick = () => {
            const cmd = prompt("ENTER SYSTEM COMMAND:");
            if(cmd) handleInput(cmd);
        };
        document.body.appendChild(btn);
    }
};
   // --- 2. SYSTEM REBUILDER (UPDATED WITH ALIASES) ---
const SystemRebuilder = {
    installedModules: [],

    install: function(featureName) {
        // Clean input (lowercase, trim)
        const mod = featureName.toLowerCase().trim();

        if (this.installedModules.includes(mod)) {
            log(`Module [${mod}] already active.`, 'sys-msg');
            return;
        }
        console.log(`[KERNEL] Installing module: ${mod}`);
        log(`INITIATING INSTALLATION: ${mod.toUpperCase()}...`, 'sys-msg');

        switch(mod) {
            case 'matrix':
                this.installMatrix();
                break;
            case 'crt':
            case 'scanlines': // Added alias
                this.installCRT();
                break;
            case 'sound':
            case 'beep': // Added alias
                this.installSound();
                break;
            case 'neon':
            case 'neon-theme':
            case 'glow': // Added alias
                this.installNeonTheme();
                break;
            // FIXED: Now accepts 'god', 'admin', 'root', AND 'god-mode'
            case 'god':
            case 'admin':
            case 'root':
            case 'god-mode':
                this.installGodMode();
                break;
            default:
                log(`ERROR: Unknown module '${mod}'`, 'sys-msg');
                log(`TRY: matrix, crt, sound, neon, god`, 'sys-msg');
                return;
        }

        this.installedModules.push(mod);
        log(`INSTALLATION COMPLETE: ${mod.toUpperCase()}`, 'sys-msg');
    },

    installMatrix: function() {
        if (document.getElementById('matrix-canvas')) return;
        const canvas = document.createElement('canvas');
        canvas.id = 'matrix-canvas';
        canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;pointer-events:none;';
        document.body.prepend(canvas);
        const ctx = canvas.getContext('2d');
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.addEventListener('resize', resize); resize();
        const cols = Math.floor(canvas.width / 20);
        const ypos = Array(cols).fill(0);
        const draw = () => {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0f0';
            ctx.font = '15pt monospace';
            ypos.forEach((y, i) => {
                const text = String.fromCharCode(Math.random() * 128);
                ctx.fillText(text, i * 20, y);
                if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20;
            });
        };
        setInterval(draw, 50);
    },

    installCRT: function() {
        let overlay = document.getElementById('crt-overlay');
        if(!overlay) {
             overlay = document.createElement('div');
             overlay.id = 'crt-overlay';
             overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));background-size:100% 2px, 3px 100%;pointer-events:none;z-index:999;animation:flicker 0.15s infinite;';
             document.body.appendChild(overlay);
        } else {
            overlay.style.display = 'block';
        }
        if (!document.getElementById('crt-styles')) {
            const style = document.createElement('style');
            style.id = 'crt-styles';
            style.innerHTML = `@keyframes flicker { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.98; } }`;
            document.head.appendChild(style);
        }
    },

    installSound: function() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const originalLog = window.log;
        if (typeof originalLog === 'function') {
            window.log = function(text, type) {
                if (type !== 'system' && type !== 'sys-msg') {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.type = 'sine'; osc.frequency.value = 800;
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                }
                originalLog(text, type);
            };
        }
    },

    installNeonTheme: function() {
        if (document.getElementById('neon-styles')) return;
        const style = document.createElement('style');
        style.id = 'neon-styles';
        style.innerHTML = `body { text-shadow: 0 0 5px var(--neon-green), 0 0 10px var(--neon-green); } .msg-bubble { box-shadow: 0 0 15px rgba(0,255,65,0.2); }`;
        document.head.appendChild(style);
    },

    installGodMode: function() {
        if (document.getElementById('god-btn')) return;
        const btn = document.createElement('button');
        btn.id = 'god-btn';
        btn.innerText = "GOD_MODE";
        btn.style.cssText = "position:fixed;top:10px;right:10px;z-index:1000;background:red;color:white;border:none;padding:5px 10px;font-family:monospace;cursor:pointer;";
        btn.onclick = () => {
            const cmd = prompt("ENTER SYSTEM COMMAND:");
            if(cmd) handleInput(cmd);
        };
        document.body.appendChild(btn);
    }
};
    // --- 3. INITIALIZATION ---
    window.addEventListener('load', () => {
        console.log(">> SYSTEM INITIALIZING...");
        setTimeout(() => { checkAndRun(); }, 500);
    });

    function checkAndRun() {
        try { initMatrix(); } catch (e) { console.error("Matrix Init Failed:", e); }
        try { runTerminalBoot(); } catch (e) { console.error("Boot Sequence Failed:", e); forceBootMainApp(); }
    }

    // --- 4. MATRIX (Fallback) ---
    function initMatrix() {
        if (!document.getElementById('matrix-canvas')) {
            SystemRebuilder.installMatrix();
        }
    }

    // --- 5. TERMINAL BOOT ---
    function runTerminalBoot() {
        const term = document.getElementById('terminal-content');
        if (!term) {
            term = document.createElement('div');
            term.id = 'terminal-content';
            term.className = "font-mono text-sm text-green-300 mb-4 border-l-2 border-green-800 pl-2 bg-black/50 h-64 overflow-y-auto";
            document.body.appendChild(term);
        }
        let lines = [
            "Initializing BIOS...", "Loading Kernel Modules...", "Checking Neural Net...",
            ">>> [1] Multiverse Chat", ">>> [2] AI Assistant", ">>> [3] Local Mode",
            "Type '1', '2', or '3' to start..."
        ];
        let index = 0;
        const typeNextLine = () => {
            if (index < lines.length) {
                const div = document.createElement('div');
                div.className = "opacity-80 animate-fade-in mb-1 font-mono text-sm";
                div.innerText = lines[index];
                term.appendChild(div); term.scrollTop = term.scrollHeight;
                index++;
                setTimeout(typeNextLine, 30);
            } else {
                forceBootMainApp();
            }
        };
        typeNextLine();
    }

    // --- 6. MAIN APP BOOT ---
    function forceBootMainApp() {
        console.log("!!! FORCE BOOT TRIGGERED !!!");
        let main = document.getElementById('main-interface'); // Matches new HTML
        if(!main) main = document.getElementById('main-app'); // Fallback to old HTML

        const boot = document.getElementById('boot-screen');
        if(boot) boot.classList.add('hidden');
        
        if(main) {
            main.classList.remove('hidden');
            main.classList.add('flex');
        }

        if (!username || username === 'Guest') username = "Operator_" + Math.floor(Math.random() * 9999);
        
        loadStats();
        updateStatsUI();
        connectMQTT();
        addSystemMessage("System Initialized (Recovery Mode).");
    }

    // --- 7. UI UPDATES ---
    function updateStatsUI() {
        const titleEl = document.getElementById('lvl-text');
        const xpEl = document.getElementById('xp-disp'); 
        const barEl = document.getElementById('xp-bar');
        
        // Try to update new UI elements
        const lvlDisp = document.getElementById('lvl-disp');
        if(lvlDisp) lvlDisp.innerText = userStats.level;

        if(titleEl) titleEl.innerText = `LVL ${userStats.level} ${userStats.title.toUpperCase()}`;
        if(xpEl) xpEl.innerText = `XP: ${userStats.xp.toLocaleString()}`;
        
        const progress = (userStats.xp % 1000) / 10; 
        if(barEl) barEl.style.width = `${progress}%`;
    }

    function loadStats() {
        const saved = localStorage.getItem('termos_stats');
        if(saved) try { userStats = JSON.parse(saved); } catch(e){}
    }

    function addXP(amount) {
        userStats.xp += amount;
        if(userStats.xp > (userStats.level * 1000)) {
            userStats.level++;
            userStats.title = LEVELS[userStats.level] || 'GOD MODE';
            addSystemMessage(`LEVEL UP! RANK: ${userStats.title}`);
        }
        updateStatsUI();
        localStorage.setItem('termos_stats', JSON.stringify(userStats));
    }

    // --- 8. CHAT RENDERING (SECURE) ---
    function getChatContainer() {
        // Fallback for compatibility
        return document.getElementById('chat-container') || document.getElementById('main-app');
    }

    function addUserMessage(text) {
        const container = getChatContainer();
        if(!container) return;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const safeText = escapeHtml(text);
        
        const html = `
        <div class="flex flex-row-reverse items-end gap-3 animate-fade-in-up">
            <div class="w-8 h-8 rounded bg-green-900 border border-green-500 flex items-center justify-center font-mono text-white text-xs">ME</div>
            <div class="msg-bubble bg-green-900/20 p-3 rounded-tl-lg rounded-bl-lg rounded-br-lg text-sm text-right">
                <div class="text-[10px] text-green-600 mb-1">${time} // ${escapeHtml(username.toUpperCase())}</div>
                <div class="text-left">${safeText}</div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function addAIMessage(text, isAction) {
        const container = getChatContainer();
        if(!container) return;
        const cssClass = isAction ? 'border border-cyan-500/50' : 'border border-white/10 bg-black/60';
        const safeText = escapeHtml(text);

        const html = `
        <div class="flex flex-row items-start gap-3 animate-fade-in-up">
            <div class="w-8 h-8 rounded bg-black border border-cyan-500 flex items-center justify-center text-cyan-400 font-mono text-[8px] font-bold">AI</div>
            <div class="flex-1">
                <div class="px-2 py-1 text-[10px] text-cyan-600 font-mono">TERM_AI_SYSTEM</div>
                <div class="msg-bubble ai-bubble p-3 rounded-r-xl rounded-bl-xl ${cssClass} text-sm backdrop-blur-sm">
                    <p class="leading-relaxed">${safeText}</p>
                </div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function addSystemMessage(text) {
        const container = getChatContainer();
        if(!container) return;
        container.insertAdjacentHTML('beforeend', `<div class="p-2 rounded text-xs text-center text-cyan-500 border border-cyan-900/30 bg-black/40 my-1 font-mono">[ SYSTEM: ${escapeHtml(text)} ]</div>`);
        scrollToBottom();
    }

    function scrollToBottom() {
        const c = getChatContainer();
        if(c) c.scrollTop = c.scrollHeight;
    }

    // --- 9. MQTT ---
    function connectMQTT() {
        if (typeof Paho === 'undefined') {
            console.warn("MQTT Library missing.");
            return;
        }
        const clientId = "termos-" + Math.random().toString(16).substr(2, 8);
        mqttClient = new Paho.MQTT.Client(MQTT_BROKER_URL, clientId);
        mqttClient.onConnectionLost = () => {
            addSystemMessage("Connection Lost. Reconnecting...");
            setTimeout(connectMQTT, 5000);
        };
        mqttClient.onMessageArrived = (message) => {
            try {
                const payload = JSON.parse(message.payloadString);
                if (payload && payload.text && payload.user) {
                    const container = getChatContainer();
                    if (container) {
                        const safeText = escapeHtml(payload.text);
                        const safeUser = escapeHtml(payload.user);
                        container.insertAdjacentHTML('beforeend', `
                        <div class="flex flex-row items-end gap-3 animate-fade-in-up opacity-80">
                            <div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center border border-white/20 font-mono text-white text-xs">${safeUser.substring(0,2).toUpperCase()}</div>
                            <div class="p-3 rounded-xl bg-slate-800/50 text-sm text-gray-300 max-w-[80%] border border-white/5">
                                <div class="opacity-70 text-[10px] font-mono text-gray-500 mb-1">@${safeUser.toUpperCase()}</div>
                                <p class="leading-relaxed">${safeText}</p>
                            </div>
                        </div>`);
                        scrollToBottom();
                    }
                }
            } catch (e) { console.error("MQTT Parse Error", e); }
        };
        mqttClient.connect({
            onSuccess: () => {
                mqttClient.subscribe(`termchat/messages/${currentRoom}`);
                addSystemMessage("Uplink Established.");
            },
            onFailure: () => { addSystemMessage("MQTT Connection Failed."); },
            useSSL: true
        });
    }

    function publishMessage(text) {
        if (mqttClient && mqttClient.isConnected()) {
            mqttClient.publish(`termchat/messages/${currentRoom}`, JSON.stringify({ user: username, text: text }));
        }
    }

    // --- 10. UTILS ---
    function downloadCodeFile(filename, content) {
        let mimeType = 'text/plain';
        if(filename.endsWith('.js')) mimeType = 'text/javascript';
        const element = document.createElement('a');
        element.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        addSystemMessage(`File saved: ${filename}`);
    }

    // --- 11. INPUT HANDLING ---
    function handleInput() {
        const input = document.getElementById('user-input') || document.getElementById('cmd-input');
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;

        if (text.startsWith('/sys install ')) {
            const mod = text.split(' ')[2];
            SystemRebuilder.install(mod);
        } else if (text.startsWith('/setkey ')) {
            GROQ_API_KEY = text.substring(8);
            localStorage.setItem('termos_groq_key', GROQ_API_KEY);
            addSystemMessage("API KEY SAVED.");
        } else if (text.startsWith('/ai ')) {
            talkToClone(text.substring(4));
        } else if (text === '/clear') {
            const container = getChatContainer();
            if(container) container.innerHTML = '';
        } else {
            addUserMessage(text);
            addXP(1);
            publishMessage(text);
        }
        input.value = '';
    }

    // Attach Global Listener
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const input = document.getElementById('user-input') || document.getElementById('cmd-input');
            if(input && document.activeElement === input) {
                handleInput();
            }
        }
    });

    // AI Logic
    async function talkToClone(prompt) {
        if (!GROQ_API_KEY) {
            addAIMessage("Error: API Key missing. Type /setkey [key]", false);
            return;
        }
        addAIMessage("Thinking...", false);
        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [{role: "system", content: "You are TermOS AI. You are a creator. Use SystemRebuilder.install('name') to install features."}, {role: "user", content: prompt}],
                    model: "llama3-8b-8192"
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            
            // AI Module Installation Parser
            const installRegex = /SystemRebuilder\.install\(['"](.*?)['"]\)/g;
            let match;
            let actionsTaken = false;
            while ((match = installRegex.exec(reply)) !== null) {
                SystemRebuilder.install(match[1]);
                actionsTaken = true;
            }
            if (!actionsTaken) addAIMessage(reply, false);
            else addAIMessage("Modules updated by AI.", false);
        } catch (e) {
            addAIMessage("Connection Failed.", false);
        }
    }

    // --- 12. BOOT SEQUENCE LOGIC (New UI) ---
    async function runBoot() {
        const boot = document.getElementById('boot-screen');
        const bar = document.getElementById('boot-bar');
        const main = document.getElementById('main-interface');
        const txt = document.getElementById('boot-text');
        
        if(boot) boot.classList.remove('hidden');
        
        for(let i=0; i<=100; i+=4) {
            if(bar) bar.style.width = i + '%';
            if(txt) txt.innerText = ["LOADING KERNEL...", "MOUNTING SYSTEM...", "READY"][i/20] || "OK";
            await new Promise(r => setTimeout(r, 20));
        }
        
        if(boot) boot.classList.add('hidden');
        if(main) {
            main.classList.remove('opacity-0');
            main.classList.remove('hidden');
        }
        
        addMessage("SYSTEM ONLINE. TYPE /HELP FOR COMMANDS.", "system");
        initMQTT();
    }

    // Helper for logging inside SystemRebuilder
    function log(text, type) {
        if(type === 'sys-msg' || type === 'system') addSystemMessage(text);
        else addMessage(text, 'user', 'SYS');
    }

    function addMessage(text, type = 'user', sender = 'SYS') {
        const container = getChatContainer();
        if (!container) return;
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        if (type === 'system') {
            div.className = "text-center text-xs text-gray-500 my-2 border-t border-b border-gray-800 py-1 uppercase tracking-widest";
            div.innerText = text;
        } else if (type === 'ai') {
            div.className = "flex items-start gap-2 animate-[fadeIn_0.3s_ease-out]";
            div.innerHTML = `<div class="w-8 h-8 rounded bg-black border border-cyan-500 flex items-center justify-center text-cyan-400 shrink-0 text-xs">AI</div><div class="msg-bubble ai-bubble bg-black/50 p-3 rounded-tr-lg rounded-br-lg rounded-bl-lg text-sm"><div class="text-[10px] text-cyan-600 mb-1">AI CORE // ${time}</div>${escapeHtml(text)}</div>`;
        } else {
            div.className = "flex items-start gap-2 flex-row-reverse animate-[fadeIn_0.3s_ease-out]";
            div.innerHTML = `<div class="w-8 h-8 rounded bg-green-900 border border-green-500 flex items-center justify-center text-green-100 shrink-0 text-xs">ME</div><div class="msg-bubble bg-green-900/20 p-3 rounded-tl-lg rounded-bl-lg rounded-br-lg text-sm text-right"><div class="text-[10px] text-green-600 mb-1">${time} // ${escapeHtml(sender)}</div><div class="text-left">${escapeHtml(text)}</div></div>`;
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function initMQTT() {
        // Duplicate prevention - wrapped in previous connectMQTT, calling that instead
        connectMQTT(); 
    }

    // --- 13. EVENT LISTENERS ---
    const sendBtn = document.getElementById('send-btn');
    if(sendBtn) sendBtn.onclick = handleInput;
    
    const userInput = document.getElementById('user-input');
    if(userInput) {
        userInput.addEventListener('keypress', (e) => { if(e.key==='Enter') handleInput(); });
    }

    // Voice
    if ('webkitSpeechRecognition' in window) {
        const r = new webkitSpeechRecognition(); r.continuous = false;
        const voiceBtn = document.getElementById('voice-btn');
        if(voiceBtn) {
            voiceBtn.onclick = () => { r.start(); };
            r.onresult = (e) => { userInput.value = e.results[0][0].transcript; };
        }
    }

    // Start the new boot sequence
    window.onload = () => {
        loadStats();
        runBoot();
    };

</script>
</body>
</html>
