<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TermChat LT</title>
    <style>
        body {
            background: #050505;
            color: #33ff00;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
    <script>
        // Boot sequence
        document.addEventListener('DOMContentLoaded', function() {
            showLogin();
        });

        function showLogin() {
            document.body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#050505;">
                    <div style="border: 2px solid #33ff00; padding: 40px; background: rgba(0,20,0,0.9);">
                        <h2 style="color:#33ff00; text-align:center; margin-bottom:20px;">TERMOS LT</h2>
                        <input type="text" id="usernameInput" placeholder="Username" 
                               style="background:#000; border:1px solid #33ff00; color:#33ff00; width:100%; padding:10px; margin-bottom:20px;">
                        <button onclick="login()" 
                                style="background:#33ff00; color:#000; width:100%; padding:10px; border:none; cursor:pointer;">ENTER</button>
                    </div>
                </div>
            `;
        }

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username.length >= 3) {
                loadChat(username);
            } else {
                alert('Username must be at least 3 characters');
            }
        }

        function loadChat(username) {
            document.body.innerHTML = `
                <div style="height:100vh; display:flex; flex-direction:column; background:#050505; color:#33ff00; padding:10px;">
                    <div style="border-bottom:1px solid #33ff00; padding:10px; text-align:center;">
                        <h3>TERMCHAT LT - ${username}</h3>
                    </div>
                    <div id="messages" style="flex:1; overflow-y:auto; padding:10px; background:#000; margin:10px 0; border:1px solid #33ff00;"></div>
                    <div style="display:flex; gap:10px;">
                        <input id="messageInput" type="text" placeholder="Type message..." 
                               style="flex:1; background:#000; border:1px solid #33ff00; color:#33ff00; padding:10px;">
                        <button onclick="sendMessage()" style="background:#33ff00; color:#000; border:none; padding:10px 20px; cursor:pointer;">SEND</button>
                    </div>
                </div>
            `;
            
            window.username = username;
            connectMQTT();
            
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        }

        function connectMQTT() {
            try {
                const client = new Paho.Client("broker.emqx.io", 8084, "client_" + Math.random());
                
                client.onMessageArrived = function(message) {
                    try {
                        const data = JSON.parse(message.payloadString);
                        if (data.user && data.text) {
                            addMessage(data.user, data.text);
                        } else if (data.id && data.msg) {
                            addMessage(data.id, data.msg);
                        }
                    } catch(e) {
                        addMessage('SYSTEM', message.payloadString);
                    }
                };
                
                client.connect({
                    onSuccess: function() {
                        addMessage('SYSTEM', 'Connected to chat!');
                        client.subscribe('termchat/messages');
                        client.subscribe('termchat/output');
                        window.mqttClient = client;
                    },
                    onFailure: function() {
                        addMessage('ERROR', 'Failed to connect');
                    },
                    useSSL: true
                });
            } catch(e) {
                addMessage('ERROR', 'MQTT Error: ' + e.message);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (text && window.mqttClient) {
                const msg = { 
                    id: window.username, 
                    msg: text,
                    timestamp: Date.now()
                };
                
                window.mqttClient.publish('termchat/messages', JSON.stringify({user: window.username, text: text}));
                window.mqttClient.publish('termchat/input', JSON.stringify(msg));
                input.value = '';
            }
        }

        function addMessage(user, text) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.style.color = user === 'SYSTEM' ? '#00ff00' : user === 'ERROR' ? '#ff0000' : user === 'TERMAI' ? '#00ff41' : '#33ff00';
            div.textContent = `[${user}] ${text}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
    </script>
</body>
</html>